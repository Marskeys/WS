<!DOCTYPE html>
<html lang="ko">
  <%- include('partials/head') %>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MarsKeys Variable Grid</title>
    <link rel="stylesheet" href="/assets/css/marskeys.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/table.css" />
    <link rel="stylesheet" href="/assets/css/table.css" />
  </head>
    <body>
      <img src="/assets/images/glow-circuit-bg.webp" style="display:none" alt="preload background">

    <style>
      .bg-preload {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        background-image: url('/assets/images/glow-circuit-bg.webp');
      }
    </style>

    <%- include('partials/header') %>
    <main class="grid">




      <div class="grid-item ultrawide marskeys-intro hologram-border">
        MarsKeys is where sound meets imagination.<br>
        Crafting expressive instruments, visuals, and ideas.<br>
        From virtual tools to sonic art ‚Äî welcome aboard.
      </div>

      <div class="grid-item youtube-carousel hologram-border">
        <div class="corner-ribbon">YouTube</div>
        <div class="carousel-track">
      
          <!-- üé¨ ÌîåÎ†àÏù¥Ïñ¥ 1 -->
          <div class="video-wrapper" data-video-id="dQw4w9WgXcQ" data-player-id="player1">
            <div class="video-thumbnail">
              <img class="thumbnail-img" src="https://img.youtube.com/vi/dQw4w9WgXcQ/hqdefault.jpg" alt="Video Thumbnail">
              <div class="play-button">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="100" cy="100" r="90" fill="rgba(0,0,0,0.6)"/>
                  <polygon points="80,65 140,100 80,135" fill="#ffffff"/>
                </svg>
              </div>
            </div>
            <div id="player1" class="yt-player"></div>
          </div>
      
          <!-- üé¨ ÌîåÎ†àÏù¥Ïñ¥ 2 -->
          <div class="video-wrapper" data-video-id="3tmd-ClpJxA" data-player-id="player2">
            <div class="video-thumbnail">
              <img class="thumbnail-img" src="https://img.youtube.com/vi/3tmd-ClpJxA/hqdefault.jpg" alt="Video Thumbnail">
              <div class="play-button">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="100" cy="100" r="90" fill="rgba(0,0,0,0.6)"/>
                  <polygon points="80,65 140,100 80,135" fill="#ffffff"/>
                </svg>
              </div>
            </div>
            <div id="player2" class="yt-player"></div>
          </div>
      
        </div>
      </div>
      
      
      
      
      

      <div class="grid-item tall soundcloud-box hologram-border">      
        <iframe 
          width="100%" 
          height="300" 
          scrolling="no" 
          frameborder="no" 
          src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/209262931&color=%23ff5500&auto_play=false">
        </iframe>
      </div>
      <div class="grid-item small hologram-border"> <span class="invisible-text">Placeholder</span></div>
      <div class="grid-item small about-me hologram-border" onclick="toggleSize(this)">
        <span class="about-text">About Me</span>
        <picture class="about-image hidden">
          <source srcset="/assets/images/about-me-mobile.svg" media="(max-width: 768px)">
          <img src="/assets/images/about-me.svg" alt="About Me">
        </picture>
      </div>

      <div class="grid-item big hologram-border"> <%- include('partials/table') %> </div>
    
      <div class="grid-item wide hologram-border">Shop</div>
        
        
        
        

  
      <div id="orbit-balls"></div>


 
    </main>

    <script src="https://www.youtube.com/iframe_api"></script>
<script>
  const players = {};

  function onYouTubeIframeAPIReady() {
    document.querySelectorAll('.video-wrapper').forEach(wrapper => {
      const videoId = wrapper.dataset.videoId;
      const playerId = wrapper.dataset.playerId;

      players[playerId] = new YT.Player(playerId, {
        videoId: videoId,
        playerVars: {
          autoplay: 0,
          rel: 0,
          playsinline: 1
        },
        events: {
          'onReady': () => {
            const button = wrapper.querySelector('.play-button');
            button.addEventListener('click', () => {
              wrapper.querySelector('.video-thumbnail').remove();
              players[playerId].playVideo();
            });
          }
        }
      });
    });
  }

  const items = document.querySelectorAll('.grid-item');
  const ballContainer = document.getElementById('orbit-balls');

  const colors = ['#00ffff', '#ff00ff', '#ffff00', '#ffffff', '#ffff00', '#00ff00', '#ff6600'];
  const balls = [];

  colors.forEach((color, i) => {
    const ball = document.createElement('div');
    ball.className = 'orbit-ball';
    ball.style.background = color;
    ball.style.opacity = '0';
    ball.style.transition = 'opacity 0.2s ease-in-out';
    ball.style.zIndex = 1000 + i;

    ball.style.setProperty('--glow-color', color);
    ball.style.boxShadow = `0 0 8px ${color}, 0 0 15px ${color}`;

    const after = document.createElement('style');
    document.head.appendChild(after);
    after.sheet.insertRule(`
      .orbit-ball:nth-child(${i + 1})::after {
        background: ${color};
      }
    `);

    ballContainer.appendChild(ball);
    balls.push(ball);
  });

  function getBoxPath(box) {
    const rect = box.getBoundingClientRect();
    const basePadding = 4;
    const hologramFix = box.classList.contains('hologram-border') ? 6 : 0;
    const radiusFix = box.classList.contains('marskeys-intro') ? 0.5 : 3;

    let x0 = rect.left + window.scrollX - basePadding + hologramFix;
    let y0 = rect.top + window.scrollY - basePadding + hologramFix;
    const w = rect.width + basePadding * 2 - hologramFix * 2;
    const h = rect.height + basePadding * 2 - hologramFix * 2;

    if (box.classList.contains('marskeys-intro')) {
      x0 -= 2;
      y0 += -2;
    }

    return [
      [x0, y0],
      [x0 + w - radiusFix * 2, y0],
      [x0 + w - radiusFix * 2, y0 + h - radiusFix * 2],
      [x0, y0 + h - radiusFix * 2],
      [x0, y0]
    ];
  }

  // ‚úÖ Í≥µÏù¥ Ìó§ÎçîÏóê ÎãøÏïòÎäîÏßÄ Ï∂©Îèå Ï≤¥ÌÅ¨
  function checkCollisionWithHeader(ball) {
    const header = document.getElementById('stickyHeader');
    if (!header) return;
    const headerRect = header.getBoundingClientRect();
    const ballRect = ball.getBoundingClientRect();

    const collided = !(
      ballRect.bottom < headerRect.top ||
      ballRect.top > headerRect.bottom ||
      ballRect.right < headerRect.left ||
      ballRect.left > headerRect.right
    );

    ball.style.opacity = collided ? '0' : '1';
  }

  function moveBall(ball, targetBox, next) {
  if (ball.dataset.busy === "true") return;
  ball.dataset.busy = "true";

  let i = 0;
  const steps = 120;

  function moveSegment() {
    const latestPath = getBoxPath(targetBox);

    if (!latestPath || latestPath.length < 2) {
      // Í≤ΩÎ°úÍ∞Ä ÎÑàÎ¨¥ ÏßßÍ±∞ÎÇò Ïù¥ÏÉÅÌïòÎ©¥ Î∞îÎ°ú Îã§ÏùåÏúºÎ°ú
      ball.dataset.busy = "false";
      return next();
    }

    if (i >= latestPath.length - 1) {
      ball.dataset.busy = "false";
      return next();
    }

    let step = 0;

    function stepMove() {
      const refreshedPath = getBoxPath(targetBox);
      if (!refreshedPath[i + 1]) {
        ball.dataset.busy = "false";
        return next();
      }

      const [x1, y1] = refreshedPath[i];
      const [x2, y2] = refreshedPath[i + 1];
      const dx = (x2 - x1) / steps;
      const dy = (y2 - y1) / steps;

      if (step <= steps) {
        const x = x1 + dx * step;
        const y = y1 + dy * step;

        if (!isFinite(x) || !isFinite(y)) {
          ball.dataset.busy = "false";
          return next();
        }

        ball.style.left = x + 'px';
        ball.style.top = y + 'px';
        ball.dataset.lastMoved = Date.now().toString();

          // ‚úÖ Ïó¨Í∏∞ÏÑú Ìó§Îçî Ï∂©Îèå Í≤ÄÏÇ¨ Ìò∏Ï∂ú!
      checkCollisionWithHeader(ball);

      createTrail(x, y, ball.style.background, ball);
        step++;
        requestAnimationFrame(stepMove);
      } else {
        i++;
        moveSegment();
      }
    }

    stepMove();
  }

  moveSegment();
}

function startLoop(ball, offset = 0) {
  // üëâ ÏõÄÏßÅÏù¥Í∏∞ ÏãúÏûëÌï† Îïå ÌéòÏù¥ÎìúÏù∏
  ball.style.opacity = '1';

  let current = offset % items.length;

  function loop() {
    const box = items[current];
    moveBall(ball, box, () => {
      current = (current + 1) % items.length;
      setTimeout(loop, 300);
    });
  }

  loop();
}

  window.addEventListener('load', () => {
    balls.forEach((ball, i) => {
      const targetBox = items[Math.floor(Math.random() * items.length)];
      const rect = targetBox.getBoundingClientRect();
      const x = rect.left + window.scrollX + Math.random() * rect.width;
      const y = rect.top + window.scrollY + Math.random() * rect.height;
      ball.style.position = 'absolute';
      ball.style.left = `${x}px`;
      ball.style.top = `${y}px`;

      setTimeout(() => startLoop(ball, i), i * 1200);
    });
  });

  // üîÅ trail ÎßåÎì§ Îïå ball IDÎ°ú Ïó∞Í≤∞
function createTrail(x, y, color, ball) {
  const radius = 3;

  const trail = document.createElement('div');
  trail.className = 'trail';
  trail.style.position = 'absolute';
  trail.style.left = `${x + radius}px`;
  trail.style.top = `${y + radius}px`;
  trail.style.width = '2px';
  trail.style.height = '2px';
  trail.style.borderRadius = '50%';
  trail.style.background = color;
  trail.style.opacity = '0.6';
  trail.style.pointerEvents = 'none';
  trail.style.zIndex = '1';
  trail.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';

  // ‚úÖ Ïù¥ Í≥µÏùò Í≥†Ïú† ID ÏßÄÏ†ï
  const ballId = ball.dataset.id || crypto.randomUUID();
  ball.dataset.id = ballId;
  trail.dataset.ballId = ballId;

  document.body.appendChild(trail);

  requestAnimationFrame(() => {
    trail.style.opacity = '0';
    trail.style.transform = 'scale(0.2)';
  });

  setTimeout(() => {
    trail.remove();
  }, 600);
}

  function toggleSize(el) {
  const isExpanded = el.classList.contains('expanded');

  el.classList.toggle("expanded");

  const image = el.querySelector(".about-image");
  if (image) {
    image.classList.toggle("hidden");
    image.style.display = '';
  }

  const text = el.querySelector(".about-text");
if (text) {
  text.classList.toggle("hidden");
}

  if (isExpanded) {
    el.classList.remove('large');
    el.classList.add('about-me', 'small');
    el.style.gridRow = '';
  } else {
    el.classList.remove('small', 'about-me');
    el.classList.add('large');

    const img = el.querySelector('img');
    if (img) {
      if (img.complete) {
        adjustRowSpan(el, img);
      } else {
        img.onload = () => adjustRowSpan(el, img);
      }
    }
  }

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      updateAllBallPaths();
    });
  });

  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updateAllBallPaths() {
  const items = document.querySelectorAll('.grid-item');

  balls.forEach(ball => {
    const targetBox = items[Math.floor(Math.random() * items.length)];
    const path = getBoxPath(targetBox);

    moveBall(ball, path, () => {
      startLoop(ball, Math.floor(Math.random() * items.length));
    });
  });
}


function adjustRowSpan(item, img) {
  const grid = document.querySelector('.grid'); // ‚Üê grid-containerÍ∞Ä ÏïÑÎãàÎùº .grid!
  const rowHeight = parseInt(getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
  const rowGap = parseInt(getComputedStyle(grid).getPropertyValue('gap') || 0);
  const imgHeight = img.getBoundingClientRect().height;

  const total = imgHeight + rowGap;
  const span = Math.ceil(total / (rowHeight + rowGap));

  item.style.gridRow = `span ${span}`;
}

setInterval(() => {
  const now = Date.now();

  for (let i = balls.length - 1; i >= 0; i--) {
    const ball = balls[i];
    const lastMoved = parseInt(ball.dataset.lastMoved || '0', 10);

    if (now - lastMoved > 1000) {
      // üëá Ïó∞Í≤∞Îêú Íº¨Î¶¨Îì§ Ï†úÍ±∞
      const ballId = ball.dataset.id;
      document.querySelectorAll(`.trail[data-ball-id="${ballId}"]`).forEach(trail => {
        trail.remove();
      });

      // Í≥µ ÏÇ≠Ï†ú
      ball.remove();
      balls.splice(i, 1);
    }
  }
}, 500);

</script>





  </body>
  
  </html>