<!DOCTYPE html>
<html lang="<%= lang %>">
<%- include('partials/head') %>
<body>
  <%- include('partials/header') %>
  <% const isEdit = !!post; %>
  <% const currentPost = post?.translations?.[lang] || post || {}; %>

  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

  <div class="editor-container hologram-border">
    <div class="editor-lang-selector">
      <label for="post-lang">ì–¸ì–´ ì„ íƒ:</label>
      <select id="post-lang" name="lang">
        <% supportedLangs.forEach(supportedLang => { %>
          <option value="<%= supportedLang %>" <%= lang === supportedLang ? 'selected' : '' %>>
            <%= supportedLang.toUpperCase() %>
          </option>
        <% }) %>
      </select>
    </div>
    
    <div class="title-wrap">
      <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="<%= currentPost.title || '' %>" />
    </div>

    <div class="toolbar">
      <div class="dropdown">
        <div class="dropdown-toggle" id="currentStyle" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
        <div class="dropdown-menu" id="styleDropdown">
          <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
          <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
          <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
          <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
          <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
          <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
          <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
          <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
          <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
        </div>
      </div>
      <button onclick="insertTOC()" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
      <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
      <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
      <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
      <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
      <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
      <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
      <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
      <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
      <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
      <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
      <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
      <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
      <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
      
      <div class="color-tool" id="foreTool">
        <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
          <i class="fas fa-pencil-alt" id="foreIcon"></i>
        </button>
        <div class="color-palette" id="forePalette">
          <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
          <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
          <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
          <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
          <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
          <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
          <label class="custom-color">
            ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
          </label>
        </div>
      </div>
      
      <div class="color-tool" id="bgTool">
        <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
          <i class="fas fa-fill-drip" id="bgIcon"></i>
        </button>
        <div class="color-palette" id="bgPalette">
          <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
          <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
          <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
          <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
          <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
          <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
          <label class="custom-color">
            ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
          </label>
        </div>
      </div>

      <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
      <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
    </div>

    <% if (user && Number(user.is_admin) === 1) { %>
    <div class="mode-toggle">
      <button onclick="switchToDesignMode()">ë””ìì¸ ëª¨ë“œ</button>
      <button onclick="switchToHtmlMode()">HTML ëª¨ë“œ</button>
    </div>
    <% } %>
    
    <div id="editorWrapper">
      <div id="editor" contenteditable="true" class="editor" spellcheck="false">
        <%- currentPost.content || '<p><br></p>' %>
      </div>
      <textarea id="htmlEditor" class="editor" style="display: none;"></textarea>
    </div>

    <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
      <input type="checkbox" id="isPrivateCheckbox" name="is_private" value="1" <%= post?.is_private ? 'checked' : '' %> />
      ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
    </label>

    <% if (user && Number(user.is_admin) === 1) { %>
      <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
        <input type="checkbox" id="isPinnedCheckbox" name="is_pinned" value="1" <%= post?.is_pinned ? 'checked' : '' %> />
        ìƒë‹¨ì— ê³ ì •í•˜ê¸° ğŸ“Œ
      </label>
    <% } %>

    <div class="category-box">
      <label>ì¹´í…Œê³ ë¦¬:</label>
      <div class="category-list" id="categoryList"></div>
      <button class="add-category-btn" onclick="addCategory()">â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
      <button class="post-btn" onclick="postContent()">ğŸ“¬ í¬ìŠ¤íŒ…</button>
      <button class="save-btn" onclick="saveContent()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>

  <%
    const categoryList = (post && post.categories) ? post.categories.split(',') : ['ì¼ìƒ'];
  %>

  <script>
    // ... (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ) ...
    // ìŠ¤í¬ë¦½íŠ¸ì˜ ì‹œì‘ ë¶€ë¶„ì…ë‹ˆë‹¤.
    // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œëŠ” ëª¨ë‘ ì´ ì•ˆì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    let selectedCategories = <%- JSON.stringify(categoryList) %>;
    let categories = [];
    let savedRange = null;
    
    // openHtmlPopup í•¨ìˆ˜ëŠ” ìˆ˜ì • ì—†ì´ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.
    function openHtmlPopup() {
      showCustomInput("ì‚½ì…í•  HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", async (rawCode) => {
        if (!rawCode) return;
        const encoder = new TextEncoder();
        const encodedUint8 = encoder.encode(rawCode); 
        const base64Code = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const result = reader.result;
                if (typeof result === 'string') {
                    resolve(result.split(',')[1]);
                } else {
                    reject(new Error("FileReader result is not a string."));
                }
            };
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(new Blob([encodedUint8]));
        });
        const wrapper = document.createElement("div");
        wrapper.className = "custom-widget";
        wrapper.setAttribute("data-type", "html-snippet");
        wrapper.setAttribute("data-code", base64Code);
        wrapper.innerHTML = `<div style="border: 1px dashed gray; padding: 0.5rem; color: #666;">[HTML ì½”ë“œ ì‚½ì…ë¨]</div>`;
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(wrapper);
        } else {
          const editor = document.getElementById("editor");
          editor.appendChild(wrapper);
        }
        saveSelection();
      });
    }

    // renderCategories í•¨ìˆ˜
    function renderCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';
        categories.forEach((cat, index) => {
          const item = document.createElement('div');
          item.className = 'category-item';
          if (selectedCategories.includes(cat)) item.classList.add('selected');
          item.innerText = cat;
          item.onclick = () => {
            const i = selectedCategories.indexOf(cat);
            if (i === -1) selectedCategories.push(cat);
            else selectedCategories.splice(i, 1);
            renderCategories();
          };
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.innerText = 'Ã—';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            showCustomMessage(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true, () => {
              fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                method: 'DELETE'
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  categories.splice(index, 1);
                  selectedCategories = selectedCategories.filter(c => c !== cat);
                  renderCategories();
                  showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                  showCustomMessage("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                }
              })
              .catch(err => {
                console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                showCustomMessage("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
            });
          };
          item.appendChild(removeBtn);
          list.appendChild(item);
        });
      }
    
    // addCategory í•¨ìˆ˜
    function addCategory() {
      showCustomInput("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", (newCat) => {
        newCat = newCat?.trim();
        if (!newCat || categories.includes(newCat)) return;
        fetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newCat })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            categories.push(newCat);
            renderCategories();
            showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            showCustomMessage("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
          }
        })
        .catch(err => {
          console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
          showCustomMessage("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
      });
    }
    
    // postContent í•¨ìˆ˜
    function postContent() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('editor').innerHTML.trim();
      const categoriesToSend = selectedCategories;
      const isPrivate = document.getElementById('isPrivateCheckbox').checked ? 1 : 0;
      const isPinned = document.getElementById('isPinnedCheckbox')?.checked ? 1 : 0;
      const lang = document.getElementById('post-lang').value;

      if (!title) return showCustomMessage("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (!content || content === '<div><br></div>' || content === '<p><br></p>') return showCustomMessage("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (!categoriesToSend || categoriesToSend.length === 0) return showCustomMessage("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
  
      fetch("<%= post ? '/' + lang + '/edit/' + post.id : '/' + lang + '/savePost' %>", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          content,
          categories: categoriesToSend,
          is_private: isPrivate,
          is_pinned: isPinned,
          lang
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showCustomMessage("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", false, () => {
            <% if (post) { %>
              window.location.href = "/<%= lang %>/post/<%= post.id %>";
            <% } else { %>
              window.location.href = "/<%= lang %>/";
            <% } %>
          });
        } else {
          showCustomMessage("ì €ì¥ ì‹¤íŒ¨: " + data.error);
        }
      })
      .catch(err => {
        console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
        showCustomMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    }

    // format í•¨ìˆ˜
    function format(command, value = null) {
      document.execCommand("styleWithCSS", false, false);
      document.execCommand(command, false, value);
      setTimeout(detectStyle, 100);
    }
    
    // applyStyle í•¨ìˆ˜
    function applyStyle(tag) {
      const blockTags = ['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'];
      const editor = document.getElementById("editor");
      restoreSelection();
      editor.focus();
      if (blockTags.includes(tag)) {
        document.execCommand("styleWithCSS", false, false);
        document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
        saveSelection();
      } else {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) return;
        const range = sel.getRangeAt(0);
        const tempElement = document.createElement(tag);
        if (tag === 'span') tempElement.classList.add('label');
        if (tag === 'strong') tempElement.classList.add('label', 'label-bold');
        try {
          const contents = range.extractContents();
          tempElement.appendChild(contents);
          range.insertNode(tempElement);
          sel.removeAllRanges();
          const newRange = document.createRange();
          newRange.selectNode(tempElement);
          sel.addRange(newRange);
          saveSelection();
        } catch (e) {
          console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
        }
      }
      setTimeout(detectStyle, 100);
    }

    // insertImage í•¨ìˆ˜
    function insertImage() {
      showCustomInput("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:", (url) => {
        if (url) format('insertImage', url);
      });
    }

    // saveContent í•¨ìˆ˜
    function saveContent() {
      showCustomMessage("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
    }

    // toggleDropdown í•¨ìˆ˜
    function toggleDropdown() {
      document.getElementById('styleDropdown').classList.toggle('show');
    }

    // updateCurrentStyle í•¨ìˆ˜
    function updateCurrentStyle(tagName) {
      const labelMap = {
        h1: "ì œëª©", h2: "ë¶€ì œëª©", h3: "ë¨¸ë¦¬ë§ 1", h4: "ë¹¨ê°„ ë¨¸ë¦¬ë§",
        p: "ë³¸ë¬¸", small: "ì„¤ëª…", footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
        span: "ë ˆì´ë¸”", strong: "ì§„í•œ ë ˆì´ë¸”"
      };
      const label = labelMap[tagName.toLowerCase()] || tagName;
      document.getElementById("currentStyle").innerText = `${label} â–¼`;
    }

    // detectStyle í•¨ìˆ˜
    function detectStyle() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      let node = sel.getRangeAt(0).startContainer;
      if (node.nodeType === 3) node = node.parentNode;
      while (node && node !== document) {
        const tag = node.tagName?.toLowerCase();
        if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
          updateCurrentStyle(tag);
          return;
        }
        node = node.parentNode;
      }
      updateCurrentStyle('p');
    }

    // saveSelection í•¨ìˆ˜
    function saveSelection() {
      const sel = window.getSelection();
      if (sel.rangeCount > 0) {
        savedRange = sel.getRangeAt(0).cloneRange();
      }
    }

    // restoreSelection í•¨ìˆ˜
    function restoreSelection() {
      const sel = window.getSelection();
      if (savedRange) {
        sel.removeAllRanges();
        sel.addRange(savedRange);
      }
    }

    // setColor í•¨ìˆ˜
    function setColor(command, color) {
      restoreSelection();
      const sel = window.getSelection();
      if (!sel.rangeCount || sel.isCollapsed) return;
      const range = sel.getRangeAt(0);
      if (color === "__clear__") {
        const contents = range.cloneContents();
        const spans = contents.querySelectorAll("span");
        spans.forEach(span => {
          if (command === 'foreColor') span.style.color = '';
          else if (command === 'hiliteColor') span.style.backgroundColor = '';
        });
        range.deleteContents();
        range.insertNode(contents);
        return;
      }
      const span = document.createElement("span");
      if (command === "foreColor") span.style.color = color;
      else if (command === "hiliteColor") span.style.backgroundColor = color;
      const contents = range.extractContents();
      span.appendChild(contents);
      range.insertNode(span);
      sel.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNode(span);
      sel.addRange(newRange);
      saveSelection();
      detectStyle();
    }
    
    // getCurrentBlockTag í•¨ìˆ˜
    function getCurrentBlockTag() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return null;
      let node = sel.getRangeAt(0).startContainer;
      while (node && node !== document) {
        if (node.nodeType === 1) {
          const tag = node.tagName.toLowerCase();
          if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
            return tag;
          }
        }
        node = node.parentNode;
      }
      return 'p';
    }

    // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ë° ì…ë ¥ ë°•ìŠ¤ êµ¬í˜„
    function createMessageBox(message, isConfirm = false, onConfirm = null) {
      let modal = document.getElementById('customMessageModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customMessageModal';
        modal.style = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; justify-content: center;
          align-items: center; z-index: 1000;
        `;
        document.body.appendChild(modal);
      }
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
          <p style="color: black;">${message}</p>
          ${isConfirm ? `
              <button id="confirmBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
              <button id="cancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
          ` : `
              <button id="okBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
          `}
        </div>
      `;
      modal.style.display = 'flex';
      if (isConfirm) {
        document.getElementById('confirmBtn').onclick = () => {
          modal.style.display = 'none';
          if (onConfirm) onConfirm();
        };
        document.getElementById('cancelBtn').onclick = () => {
          modal.style.display = 'none';
        };
      } else {
        document.getElementById('okBtn').onclick = () => {
          modal.style.display = 'none';
          if (onConfirm) onConfirm();
        };
      }
    }

    function showCustomMessage(message, isConfirm = false, onConfirm = null) {
      createMessageBox(message, isConfirm, onConfirm);
    }

    function showCustomInput(message, onInput) {
      let modal = document.getElementById('customInputModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customInputModal';
        modal.style = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; justify-content: center;
          align-items: center; z-index: 1000;
        `;
        document.body.appendChild(modal);
      }
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
          <p style="color: black;">${message}</p>
          <input type="text" id="customInput" style="width: calc(100% - 20px); padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;" />
          <button id="inputOkBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
          <button id="inputCancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
        </div>
      `;
      modal.style.display = 'flex';
      document.getElementById('inputOkBtn').onclick = () => {
        const inputValue = document.getElementById('customInput').value;
        modal.style.display = 'none';
        if (onInput) onInput(inputValue);
      };
      document.getElementById('inputCancelBtn').onclick = () => {
        modal.style.display = 'none';
        if (onInput) onInput(null);
      };
      document.getElementById('customInput').focus();
    }
    
    // window.onclick í•¨ìˆ˜
    window.onclick = function(e) {
      if (!e.target.matches('.dropdown-toggle')) {
        const dropdowns = document.getElementsByClassName('dropdown-menu');
        for (let d of dropdowns) d.classList.remove('show');
      }
    };
    
    // insertTOC í•¨ìˆ˜
    function insertTOC() {
      const editor = document.getElementById("editor");
      const headings = editor.querySelectorAll("h1, h2");
      if (!headings.length) {
        showCustomMessage("ì œëª© ë˜ëŠ” ë¶€ì œëª©ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const oldTOC = editor.querySelector(".auto-toc");
      if (oldTOC) oldTOC.remove();
      const tocWrapper = document.createElement("div");
      tocWrapper.className = "auto-toc";
      tocWrapper.contentEditable = "false";
      const tocTitle = `<strong class="toc-title">ğŸ“‘ ëª©ì°¨</strong>`;
      const tocList = document.createElement("ul");
      tocList.className = "toc-list";
      tocList.style.margin = "0";
      tocList.style.padding = "0";
      let h1Count = 0;
      let h2Count = 0;
      headings.forEach((el) => {
        const tag = el.tagName.toLowerCase();
        let number = "";
        if (tag === "h1") {
          h1Count++;
          h2Count = 0;
          number = `${h1Count}.`;
        } else if (tag === "h2") {
          h2Count++;
          number = `${h1Count}.${h2Count}`;
        }
        const id = `toc-${number.replace(/\./g, "-")}`;
        el.id = id;
        const li = document.createElement("li");
        li.className = `toc-item toc-${tag}`;
        li.style.margin = "0.2em 0";
        li.style.lineHeight = "1.2";
        if (tag === "h2") li.style.marginLeft = "1.2rem";
        const a = document.createElement("a");
        a.href = `#${id}`;
        a.textContent = `${number} ${el.textContent.trim()}`;
        a.onclick = function (e) {
          e.preventDefault();
          document.getElementById(id)?.scrollIntoView({ behavior: "smooth" });
        };
        a.style.color = "#0366d6";
        a.style.textDecoration = "none";
        li.appendChild(a);
        tocList.appendChild(li);
      });
      tocWrapper.innerHTML = tocTitle;
      tocWrapper.appendChild(tocList);
      const firstHeading = [...headings][0];
      editor.insertBefore(tocWrapper, firstHeading);
    }
    
    // switchToHtmlMode í•¨ìˆ˜
    function switchToHtmlMode() {
      const editor = document.getElementById("editor");
      const htmlEditor = document.getElementById("htmlEditor");
      htmlEditor.value = editor.innerHTML.trim();
      editor.style.display = "none";
      htmlEditor.style.display = "block";
    }

    // switchToDesignMode í•¨ìˆ˜
    function switchToDesignMode() {
      const editor = document.getElementById("editor");
      const htmlEditor = document.getElementById("htmlEditor");
      editor.innerHTML = htmlEditor.value;
      htmlEditor.style.display = "none";
      editor.style.display = "block";
    }

    // âœ… DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•© ë° ì–¸ì–´ ë³€ê²½ ë¡œì§ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', () => {
      const supportedLangs = <%- JSON.stringify(supportedLangs) %>;
      const langSelect = document.getElementById('post-lang');
      const isEdit = <%= isEdit %>;
      const postId = '<%= post?.id || "" %>';
      const currentPath = window.location.pathname.replace(new RegExp(`^/(${supportedLangs.join('|')})`), '');
      
      if (langSelect) {
        langSelect.addEventListener('change', (e) => {
          const selectedLang = e.target.value;
          if (isEdit && postId) {
            window.location.href = `/${selectedLang}${currentPath}?lang=${selectedLang}`;
          }
        });
      }

      // ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
      fetch('/api/categories')
        .then(res => res.json())
        .then(data => {
          categories = data.categories || [];
          renderCategories();
        })
        .catch(err => {
          console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
          categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°'];
          renderCategories();
        });

      // ì—ë””í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      const editor = document.getElementById('editor');
      if (editor) {
        editor.addEventListener('keyup', detectStyle);
        editor.addEventListener('mouseup', detectStyle);
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('keyup', saveSelection);
      }
      
      // íˆ´ë°” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì„ íƒ ì˜ì—­ ì €ì¥)
      const toolbarButtons = document.querySelectorAll('.toolbar button, .dropdown-toggle');
      toolbarButtons.forEach(button => {
        button.addEventListener('mousedown', saveSelection);
      });
    });
    // ìŠ¤í¬ë¦½íŠ¸ì˜ ë
  </script>
  <%- include('partials/footer') %>
  <%- include('partials/scripts') %>
</body>
</html>