<!-- views/partials/head.ejs -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <% 
    // ---- 안전 가드 & 기본값 ----
    const _page       = (typeof page !== 'undefined' && page) ? page : null;
    const _locale     = (typeof locale !== 'undefined' && locale) ? locale : { seo: { title: 'Blindly Love', description: '' } };
    const _lang       = (typeof lang !== 'undefined' && lang) ? lang : 'en';
    const _noindex    = (typeof noindex !== 'undefined') ? !!noindex : false;
    const _canonHref  = (typeof canonicalHref !== 'undefined' && canonicalHref) ? canonicalHref : '/';
    const _alts       = Array.isArray(alternates) ? alternates : [];

    const _title = (_page && _page.title) ? _page.title : _locale.seo.title;
    const _desc  = (_page && _page.description) ? _page.description : _locale.seo.description;

    const ogLocaleMap = { ko:'ko_KR', en:'en_US', fr:'fr_FR', ja:'ja_JP', zh:'zh_CN' };
    const _ogType  = (_page && _page.type) ? _page.type : 'website';
    const _ogUrl   = _canonHref;
    const _ogTitle = _title;
    const _ogDesc  = _desc;
    const _ogImg   = (_page && _page.ogImage) ? _page.ogImage : 'https://blindly.love/assets/logo.png';
    const _ogLoc   = ogLocaleMap[_lang] || 'en_US';
    const _hasXDef = _alts.some(a => a.lang === 'x-default');
  %>

  <!-- SEO 기본 -->
  <title><%= _title %></title>
  <meta name="description" content="<%= _desc %>">
  <meta name="robots" content="<%= _noindex ? 'noindex, nofollow' : 'index, follow' %>">

  <!-- Canonical (언어별 대표 URL) -->
  <link rel="canonical" href="<%= _canonHref %>" />

  <!-- hreflang (x-default 포함) -->
  <% _alts.forEach(a => { %>
    <link rel="alternate" hreflang="<%= a.lang %>" href="<%= a.href %>"/>
  <% }) %>
  <% if (!_hasXDef && _alts.length) { 
       const current = _alts.find(a => a.lang === _lang) || _alts[0]; %>
    <link rel="alternate" hreflang="x-default" href="<%= current.href %>"/>
  <% } %>

  <!-- Favicon -->
  <link rel="icon" href="/assets/images/favicon.png" type="image/png" sizes="128x128">

  <!-- 성능: 프리커넥트/디엔에스 프리패치 -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">

  <!-- 폰트/아이콘 -->
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Serif+KR&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@6.6.6/css/flag-icons.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- 스타일 -->
  <link rel="stylesheet" href="/assets/css/style.css" />
  <link rel="stylesheet" href="/assets/css/darkmode.css" />

  <!-- Open Graph -->
  <meta property="og:type" content="<%= _ogType %>">
  <meta property="og:site_name" content="Blindly Love">
  <meta property="og:url" content="<%= _ogUrl %>">
  <meta property="og:title" content="<%= _ogTitle %>">
  <meta property="og:description" content="<%= _ogDesc %>">
  <meta property="og:image" content="<%= _ogImg %>">
  <meta property="og:locale" content="<%= _ogLoc %>">
  <% _alts.filter(a => a.lang !== _lang && a.lang !== 'x-default').forEach(a => { %>
    <meta property="og:locale:alternate" content="<%= ogLocaleMap[a.lang] || 'en_US' %>">
  <% }) %>

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= _ogTitle %>">
  <meta name="twitter:description" content="<%= _ogDesc %>">
  <meta name="twitter:image" content="<%= _ogImg %>">

  <!-- 구조화 데이터 (Website) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"Blindly Love",
    "url":"https://blindly.love/",
    "inLanguage":"<%= _lang %>",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://blindly.love/search?q={query}",
      "query-input":"required name=query"
    }
  }
  </script>

  <!-- 테마: FOUC 방지 -->
  <script>
    (function () {
      try {
        var key='theme-mode';
        var saved=localStorage.getItem(key);
        if(!saved){ saved = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'; }
        document.documentElement.classList.toggle('dark', saved==='dark');
        document.documentElement.classList.toggle('light', saved!=='dark');
      } catch(e){}
    })();
  </script>

  <!-- 유틸/광고/태그 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-81ZWTFGSH5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-81ZWTFGSH5');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2585969189290118" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js" defer></script>

  <!-- 프리로드 -->
  <link rel="preload" as="image" href="/assets/images/apps/tetris.png">
  <link rel="preload" as="image" href="/assets/images/apps/sudoku.png">
  <link rel="preload" as="image" href="/assets/images/apps/hearing-test.png">
</head>
