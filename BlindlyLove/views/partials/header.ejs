<div class="header-top">
  <div class="top-controls">
    <div class="left-controls">
      <%
      const pathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)/, '');
      const showLogo = ['/signup', '/editor', '/login', '/write'].includes(pathWithoutLang) ||
                       pathWithoutLang.startsWith('/post') ||
                       pathWithoutLang.startsWith('/edit');
    
      const showHamburger = !showLogo && (pathWithoutLang === '' || pathWithoutLang === '/');
      %>
    
      <% if (showLogo) { %>
        <a href="/<%= lang %>/" class="logo-link">
          <img src="/assets/images/logo.png" alt="로고" class="floating-home-logo" />
        </a>
      <% } %>
    
      <% if (!showLogo) { %>
        <button class="hamburger" id="hamburger-btn" aria-label="메뉴 열기/닫기">
          <span></span>
          <span></span>
          <span></span>
        </button>
      <% } %>

      <div class="desktop-menu">
        <ul class="menu">
          <li class="menu-item">
            <span><%= locale.menu.freeGames %></span>
            <ul class="submenu">
              <li><a href="#" id="sudoku-link"><%= locale.menu.sudoku %></a></li>
            </ul>
          </li>

          <li class="menu-item">
            <span><%= locale.menu.freeTests %></span>
            <ul class="submenu">
              <li><a href="#" id="visual-field-link"><%= locale.menu.visualField %></a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>

    <div class="right-controls">
      <% if (currentPath !== '/signup' && currentPath !== '/login') { %>
        <div class="auth-buttons">
          <% if (user) { %>
            <% if (Number(user.is_admin) === 1) { %>
              <span class="welcome-text"><strong><%= user.nickname %></strong>님 안녕하세요!</span>
              <a href="/<%= lang %>/write" class="auth-btn write-post"><i class="fas fa-pen"></i> 글쓰기</a>
            <% } %>
            <a href="/<%= lang %>/logout" class="auth-btn logout">로그아웃</a>
          <% } else { %>
            <a class="auth-btn signup" onclick="delayNavigation(event, '/<%= lang %>/signup')">회원가입</a>
            <button class="auth-btn login" id="login" type="button">로그인</button>
          <% } %>
        </div>
      <% } %>

      <div class="language-dropdown">
        <button id="langToggle" class="lang-btn">
          <%
            let flagCode = lang;
            switch(lang) {
              case 'ko': flagCode = 'kr'; break;
              case 'en': flagCode = 'gb'; break;
              case 'zh': flagCode = 'cn'; break;
              case 'ja': flagCode = 'jp'; break;
              case 'fr': flagCode = 'fr'; break;
              case 'es': flagCode = 'es'; break;
              default: flagCode = 'kr';
            }
          %>
          <span class="fi fi-<%= flagCode %>"></span>
          <i class="fas fa-caret-down"></i>
        </button>
        <ul id="langMenu" class="lang-menu">
          <%
            const supportedLangs = ['ko', 'en', 'fr', 'zh', 'ja', 'es'];
            const currentPathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)/, '');
          %>
          <% supportedLangs.forEach(langCode => { %>
            <li>
              <a href="/<%= langCode %><%= currentPathWithoutLang %>"
                 class="lang-option <%= langCode === lang ? 'active-lang' : '' %>">
                <span class="fi fi-<%= (langCode === 'ko' ? 'kr' : (langCode === 'en' ? 'gb' : (langCode === 'zh' ? 'cn' : (langCode === 'ja' ? 'jp' : (langCode === 'fr' ? 'fr' : (langCode === 'es' ? 'es' : '')))))) %>"></span>
                <%= {ko: '한국어', en: 'English', fr: 'Français', zh: '简体中文', ja: '日本語', es: 'Español'}[langCode] %>
              </a>
            </li>
          <% }); %>
        </ul>
      </div>

      <div class="light-switch"
           role="switch"
           aria-checked="false"
           aria-label="다크 모드 전환"
           tabindex="0"
           id="mode-toggle-accessible">
        <span class="switch-label"><span class="switch-handle"></span></span>
      </div>
    </div>
  </div>

  <nav class="mobile-menu" id="mobile-menu">
    <div class="mobile-menu-header"></div>
    <ul class="mobile-main-menu">
      <li class="mobile-dropdown">
        <a href="#"><%= locale.menu.freeGames %></a>
        <ul class="mobile-submenu">
          <li><a href="#" id="mobile-sudoku-link"><%= locale.menu.sudoku %></a></li>
        </ul>
      </li>
  
      <li class="mobile-dropdown">
        <a href="#"><%= locale.menu.freeTests %></a>
        <ul class="mobile-submenu">
          <li><a href="#" id="mobile-visual-field-link"><%= locale.menu.visualField %></a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="loginBox" class="login-box" onclick="event.stopPropagation()">
    <form action="/login" method="POST" class="pop-up-form">
      <input type="text" name="id" placeholder="아이디" required>
      <input type="password" name="password" placeholder="비밀번호" required>
      <button type="submit">로그인</button>

      <div class="login-footer-links">
        <small>
          아직 회원이 아니세요? <a href="/<%= lang %>/signup">회원가입</a> <br>
          비밀번호가 기억나지 않으신다면? <a href="/<%= lang %>/reset-password">비밀번호 찾기</a>
        </small>
      </div>
    </form>
  </div>

  <style>
    @media (max-width: 640px) {
      .desktop-menu {
        display: none;
      }

      .auth-buttons {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative;
      }

      .welcome-text {
        position: absolute;
        top: 2.5rem;
        right: -1rem;
        margin-right: -3rem;
        font-size: 0.75rem;
        white-space: nowrap;
        color: #666;
        pointer-events: none;
      }

      .lang-option.active-lang {
        font-weight: bold;
        color: var(--highlight-color);
      }
    }
  </style>

  <script>
    function delayNavigation(e, url) {
      e.preventDefault();
      setTimeout(() => {
        window.location.href = url;
      }, 100);
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('langToggle');
      const menu = document.getElementById('langMenu');

      toggle.addEventListener('click', () => {
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', (e) => {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const lang = '<%= lang %>';

      const sudokuMap = {
        ko: '/assets/games/sudoku/sudoku_ko.html',
        en: '/assets/games/sudoku/sudoku_en.html',
        fr: '/assets/games/sudoku/sudoku_fr.html',
        zh: '/assets/games/sudoku/sudoku_zh.html',
        ja: '/assets/games/sudoku/sudoku_ja.html',
        es: '/assets/games/sudoku/sudoku_es.html'
      };

      const visualFieldMap = {
        ko: '/assets/tests/visual_field_test_ko.html',
        en: '/assets/tests/visual_field_test_en.html',
        fr: '/assets/tests/visual_field_test_fr.html',
        zh: '/assets/tests/visual_field_test_zh.html',
        ja: '/assets/tests/visual_field_test_ja.html',
        es: '/assets/tests/visual_field_test_es.html'
      };

      function addClickHandler(selectors, map) {
        document.querySelectorAll(selectors).forEach(btn => {
          if (!btn) return;
          btn.addEventListener('click', e => {
            e.preventDefault();
            window.location.href = map[lang] || map.ko;
          });
        });
      }

      addClickHandler('#sudoku-link, #mobile-sudoku-link', sudokuMap);
      addClickHandler('#visual-field-link, #mobile-visual-field-link', visualFieldMap);
    });
  </script>
</div>