<!DOCTYPE html>
<html lang="ko">
<head>
  <%- include('partials/head') %>
  <meta charset="UTF-8" />
  <title>BlindLove ì—ë””í„°</title>

  <% if (user) { %>
    <!-- âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¼ë©´ -->
    <meta name="author" content="<%= user.nickname %>">
  <% } %>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/editor.css" />



  
  <style>
    body {
      margin: 0;
      padding: 0;
    }
  
    .header-top {
      margin-top: 0 !important;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined'; %>
  <!-- âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ˆì‹œ (ì›í•˜ë©´ ìƒëµ ê°€ëŠ¥) -->
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

    <div class="editor-container">
        <div class="logo-wrap">
          <img src="/assets/images/1.png" alt="BlindLove ë¡œê³ " />
        </div>
    
        <div class="title-wrap">
          <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="<%= post?.title || '' %>" />
        </div>
    
        <div class="toolbar">
          <div class="dropdown">
            <div class="dropdown-toggle" id="currentStyle" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" id="styleDropdown">
              <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
              <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
              <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
              <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
              <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
              <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
    
          <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
         
          <div class="color-tool" id="foreTool">
            <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-pencil-alt" id="foreIcon"></i>
            </button>
            <div class="color-palette" id="forePalette">
              <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
              <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
              <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
              <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
              <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
              <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" id="bgTool">
            <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-fill-drip" id="bgIcon"></i>
            </button>
            <div class="color-palette" id="bgPalette">
              <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
              <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
              <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
              <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
              <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
              <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
              </label>
            </div>
          </div>
    
          
          
    
          <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <div id="editor" contenteditable="true" class="editor" spellcheck="false">
          <%- post && post.content ? post.content : '<p><br></p>' %>
        </div>        
    
        <div class="category-box">
          <label>ì¹´í…Œê³ ë¦¬:</label>
          <div class="category-list" id="categoryList"></div>
          <button class="add-category-btn" onclick="addCategory()">â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="post-btn" onclick="postContent()">ğŸ“¬ í¬ìŠ¤íŒ…</button>
          <button class="save-btn" onclick="saveContent()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
   
  
    <%
  const categoryList = (post && post.categories) ? post.categories.split(',') : ['ì¼ìƒ'];
  const postUrl = (isEdit && post) ? `/edit/${post.id}` : '/savePost';
  const redirectUrl = (isEdit && post) ? `/post/${post.id}` : '/';
%>

    <script>
      let selectedCategories = <%- JSON.stringify(categoryList) %>;
      let categories = [];
      let savedRange = null;
      
        function renderCategories() {
          const list = document.getElementById('categoryList');
          list.innerHTML = '';
          categories.forEach((cat, index) => {
            const item = document.createElement('div');
            item.className = 'category-item';
            if (selectedCategories.includes(cat)) item.classList.add('selected');
            item.innerText = cat;
      
            item.onclick = () => {
              const i = selectedCategories.indexOf(cat);
              if (i === -1) selectedCategories.push(cat);
              else selectedCategories.splice(i, 1);
              renderCategories();
            };
      
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerText = 'Ã—';
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              if (confirm(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                  method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    categories.splice(index, 1);
                    selectedCategories = selectedCategories.filter(c => c !== cat);
                    renderCategories();
                  } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                  }
                })
                .catch(err => {
                  console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                  alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
              }
            };
      
            item.appendChild(removeBtn);
            list.appendChild(item);
          });
        }
      
        function addCategory() {
          const newCat = prompt("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:")?.trim();
          if (!newCat || categories.includes(newCat)) return;
      
          fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newCat })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              categories.push(newCat);
              renderCategories();
            } else {
              alert("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
            alert("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
        function postContent() {
          const title = document.getElementById('postTitle').value.trim();
          const content = document.getElementById('editor').innerHTML.trim();
          const categoriesToSend = selectedCategories;
      
          if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          if (!content || content === '<div><br></div>' || content === '<p><br></p>') return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          if (!categoriesToSend || categoriesToSend.length === 0) return alert("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      
          fetch("<%= postUrl %>", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              content,
              categories: categoriesToSend,
              user_id: "<%= user?.id %>"
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
    alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    <% if (isEdit && post) { %>
      window.location.href = "/post/<%= post.id %>";
    <% } else { %>
      window.location.href = "/";
    <% } %>
  } else {
    alert("ì €ì¥ ì‹¤íŒ¨: " + data.error);
  }
          })
          .catch(err => {
            console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
        window.onload = () => {
          fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
              categories = data.categories || [];
              renderCategories();
            })
            .catch(err => {
              console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
              categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°']; // fallback
              renderCategories();
            });
        };
      </script>
      
      <%- include('partials/scripts') %>
    </body>
    </html>