<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <meta charset="UTF-8" />
  <title>BlindLove ì—ë””í„°</title>
  <%- include('partials/head') %>
  <% if (user) { %>
    <meta name="author" content="<%= user.nickname %>">
  <% } %>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/editor.css" />
  <link rel="stylesheet" href="/assets/css/style.css" />
</head>
<body>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined' && post !== null; %>
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

  <div class="editor-container">
    <div class="logo-wrap">
      <a href="/<%= lang %>/">
        <img src="/assets/images/logo.png" alt="BlindLove ë¡œê³ " />
      </a>
    </div>

    <div class="lang-selector-wrap">
      <label for="langSelector">í¸ì§‘ ì¤‘ì¸ ì–¸ì–´</label>
      <select id="langSelector">
        <%
          const langLabels = {
              'ko': 'í•œêµ­ì–´',
              'en': 'English',
              'fr': 'FranÃ§ais',
              'zh': 'ä¸­æ–‡',
              'ja': 'æ—¥æœ¬èª'
          };
          supportedLangs.forEach(langCode => {
        %>
          <option value="<%= langCode %>" <%= lang === langCode ? 'selected' : '' %>><%= langLabels[langCode] %></option>
        <%
          });
        %>
      </select>
    </div>

    <%
      const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' }
      ];
    %>

    <% langList.forEach(({ code, label }) => { %>
      <div class="lang-meta-block" data-lang="<%= code %>" style="<%= code === lang ? '' : 'display:none;' %>">
        <div class="title-wrap">
          <input
            type="text"
            name="title_<%= code %>"
            placeholder="<%= label %> ì œëª©"
            value="<%= post?.[code]?.title || '' %>"
          />
        </div>

        <div class="toolbar">
          <div class="dropdown">
            <div class="dropdown-toggle" id="currentStyle_<%= code %>" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" id="styleDropdown">
              <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
              <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
              <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
              <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
              <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
              <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
          <button onclick="insertTOC()" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
          <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
          
          <div class="color-tool" id="foreTool">
            <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-pencil-alt" id="foreIcon"></i>
            </button>
            <div class="color-palette" id="forePalette">
              <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
              <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
              <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
              <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
              <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
              <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" id="bgTool">
            <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-fill-drip" id="bgIcon"></i>
            </button>
            <div class="color-palette" id="bgPalette">
              <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
              <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
              <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
              <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
              <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
              <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
              </label>
            </div>
          </div>
          <button onclick="openHtmlPopup()" data-tooltip="HTML ì‚½ì…"><i class="fas fa-code"></i></button> 
          <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <% if (user && Number(user.is_admin) === 1) { %>
        <div class="mode-toggle">
          <button onclick="switchToDesignMode()">ë””ìì¸ ëª¨ë“œ</button>
          <button onclick="switchToHtmlMode()">HTML ëª¨ë“œ</button>
        </div>
        <% } %>
        
        <div class="editor-area-wrapper">
          <div id="editor_<%= code %>"
               contenteditable="true"
               class="editor language-editor"
               spellcheck="false"
               data-lang-editor="<%= code %>"
               tabindex="0" <% // tabindex ì¶”ê°€ë¡œ í¬ì»¤ìŠ¤ ê°€ëŠ¥í•˜ê²Œ í•¨ %>
               style="<%= code === lang ? '' : 'display:none;' %>"
          >
            <%
              let initialContent = post?.[code]?.content || '<p><br></p>';
              const isWrapped = initialContent.startsWith('<div class="bl-content"');
              if (!isWrapped) {
                initialContent = `
                  <div class="bl-content" style="white-space:normal; line-height: 1.7;">
                    ${initialContent}
                  </div>
                `;
              }
            %>
            <%- initialContent %>
          </div>
          <textarea id="htmlEditor_<%= code %>" class="editor html-editor" style="display: none;"></textarea>
        </div>

        <div class="global-options" style="margin-top: 2rem;">
          <label style="margin-right: 2rem;">
            <input type="checkbox" id="isPrivateCheckbox" name="is_private" value="1" <%= post?.is_private ? 'checked' : '' %> />
            ğŸ”’ ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
          </label>
        
          <% if (user && Number(user.is_admin) === 1) { %>
            <label>
              <input type="checkbox" id="isPinnedCheckbox" name="is_pinned" value="1" <%= post?.is_pinned ? 'checked' : '' %> />
              ğŸ“Œ ìƒë‹¨ì— ê³ ì •í•˜ê¸°
            </label>
          <% } %>
        </div>


      </div>
    <% }) %> 

    <div class="category-box">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ:</label>
      <div class="category-list" id="categoryList"></div>
      <button class="bl-button add" onclick="addCategory()">+ ì¶”ê°€</button>
    </div>

    <div class="save-button-wrap">
      <button type="button" class="bl-button save" onclick="postContent()">ğŸ’¾ ì €ì¥</button>
    </div>

  </div> 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script>
    let selectedCategories = []; // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¹ˆ ë°°ì—´ ì„ ì–¸
    <% if (post && post.categories) { %>
      // post.categoriesê°€ ìˆì„ ê²½ìš°ì—ë§Œ JSON.stringifyë¥¼ ì‚¬ìš©í•˜ì—¬ í• ë‹¹
      selectedCategories = <%- JSON.stringify(post.categories.split(',')) %>;
    <% } %>

    let categories = [];
    let savedRange = null;

    let currentActiveEditor = null; // í˜„ì¬ í™œì„± ë””ìì¸ ëª¨ë“œ ì—ë””í„° div ì—˜ë¦¬ë¨¼íŠ¸
    let currentActiveHtmlEditor = null; // í˜„ì¬ í™œì„± HTML ëª¨ë“œ ì—ë””í„° textarea ì—˜ë¦¬ë¨¼íŠ¸

    const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' }
    ];
    
    const IS_EDIT_PAGE = <%- isEdit ? 'true' : 'false' %>; 
    const POST_ID = <%- post && post.id ? JSON.stringify(post.id) : 'null' %>;
    const CURRENT_PAGE_LANG = '<%= lang %>';

    // ë©”ì‹œì§€ ë°•ìŠ¤ ë° ì…ë ¥ì°½ ê´€ë ¨ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
    function createMessageBox(message, isConfirm = false, onConfirm = null) {
        let modal = document.getElementById('customMessageModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'customMessageModal';
            modal.style = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                <p style="color: black;">${message}</p>
                ${isConfirm ? `
                    <button id="confirmBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                    <button id="cancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
                ` : `
                    <button id="okBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                `}
            </div>
        `;
        modal.style.display = 'flex';

        if (isConfirm) {
            document.getElementById('confirmBtn').onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            document.getElementById('cancelBtn').onclick = () => {
                modal.style.display = 'none';
            };
        } else {
            document.getElementById('okBtn').onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
        }
    }

    function showCustomMessage(message, isConfirm = false, onConfirm = null) {
        createMessageBox(message, isConfirm, onConfirm);
    }

    function showCustomInput(message, onInput) {
        let modal = document.getElementById('customInputModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'customInputModal';
            modal.style = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                <p style="color: black;">${message}</p>
                <input type="text" id="customInput" style="width: calc(100% - 20px); padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;" />
                <button id="inputOkBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                <button id="inputCancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        `;
        modal.style.display = 'flex';

        document.getElementById('inputOkBtn').onclick = () => {
            const inputValue = document.getElementById('customInput').value;
            modal.style.display = 'none';
            if (onInput) onInput(inputValue);
        };
        document.getElementById('inputCancelBtn').onclick = () => {
            const inputValue = document.getElementById('customInput').value;
            modal.style.display = 'none';
            if (onInput) onInput(null);
        };
        document.getElementById('customInput').focus();
    }

    window.onclick = function(e) {
        if (!e.target.matches('.dropdown-toggle')) {
            const dropdowns = document.getElementsByClassName('dropdown-menu');
            for (let d of dropdowns) {
                if (d.classList.contains('show')) {
                    d.classList.remove('show');
                }
            }
        }
    };
    // ì—¬ê¸°ê¹Œì§€ ë©”ì‹œì§€ ë°•ìŠ¤ ë° ì…ë ¥ì°½ ê´€ë ¨ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)

    function renderCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';
        categories.forEach((cat, index) => {
          const item = document.createElement('div');
          item.className = 'category-item';
          if (selectedCategories.includes(cat)) item.classList.add('selected');
          item.innerText = cat;
    
          item.onclick = () => {
            const i = selectedCategories.indexOf(cat);
            if (i === -1) selectedCategories.push(cat);
            else selectedCategories.splice(i, 1);
            renderCategories();
          };
    
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.innerText = 'Ã—';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            showCustomMessage(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true, () => {
              fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                method: 'DELETE'
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  categories.splice(index, 1);
                  selectedCategories = selectedCategories.filter(c => c !== cat);
                  renderCategories();
                  showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                  showCustomMessage("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                }
              })
              .catch(err => {
                console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                showCustomMessage("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
            });
          };
    
          item.appendChild(removeBtn);
          list.appendChild(item);
        });
      }
    
      function addCategory() {
        showCustomInput("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", (newCat) => {
          newCat = newCat?.trim();
          if (!newCat || categories.includes(newCat)) return;
      
          fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newCat })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              categories.push(newCat);
              renderCategories();
              showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              showCustomMessage("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
            showCustomMessage("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        });
      }
    
      function postContent() {
          const postData = {
              categories: selectedCategories,
              is_private: document.getElementById('isPrivateCheckbox')?.checked ? 1 : 0,
              is_pinned: document.getElementById('isPinnedCheckbox')?.checked ? 1 : 0,
              lang_content: {}
          };

          let hasContentForDefaultLang = false;

          langList.forEach(({ code }) => {
              const titleInput = document.querySelector(`input[name="title_${code}"]`);
              const editorDiv = document.getElementById(`editor_${code}`);
              const htmlEditorDiv = document.getElementById(`htmlEditor_${code}`);

              if (!titleInput || !editorDiv || !htmlEditorDiv) {
                  console.warn(`ì–¸ì–´ ì½”ë“œ ${code} ì— ëŒ€í•œ ì…ë ¥ í•„ë“œ ë˜ëŠ” ì—ë””í„° DIVë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                  return;
              }

              let contentToSave = '';
              // í˜„ì¬ í™œì„±í™”ëœ ëª¨ë“œì— ë”°ë¼ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
              if (htmlEditorDiv.style.display === 'block') { 
                  contentToSave = htmlEditorDiv.value.trim();
              } else {
                  const blContent = editorDiv.querySelector('.bl-content');
                  // bl-contentê°€ ì—†ë‹¤ë©´ ì „ì²´ editorDiv.innerHTMLì„ ì‚¬ìš©
                  contentToSave = blContent ? blContent.innerHTML.trim() : editorDiv.innerHTML.trim();
              }

              // ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ ê¸°ë³¸ í”Œë ˆì´ìŠ¤í™€ë” ë‚´ìš©ì¸ ê²½ìš° '<p><br></p>'ë¡œ í†µì¼
              if (!contentToSave || contentToSave === '<div><br></div>' || contentToSave === '<p><br></p>') {
                  contentToSave = '<p><br></p>';
              }

              postData.lang_content[code] = {
                  title: titleInput.value.trim(),
                  content: contentToSave
              };

              if (code === 'ko' && (postData.lang_content[code].title || postData.lang_content[code].content !== '<p><br></p>')) {
                  hasContentForDefaultLang = true;
              }
          });

          if (!postData.categories || postData.categories.length === 0) {
              return showCustomMessage("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }

          if (!hasContentForDefaultLang) {
            return showCustomMessage("í•œêµ­ì–´ ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
      
          const submitUrl = IS_EDIT_PAGE && POST_ID ? `/${CURRENT_PAGE_LANG}/edit/${POST_ID}` : `/${CURRENT_PAGE_LANG}/savePost`;

          fetch(submitUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showCustomMessage("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", false, () => {
                if (IS_EDIT_PAGE && POST_ID) {
                  window.location.href = `/${CURRENT_PAGE_LANG}/post/${POST_ID}`;
                } else if (data.postId) {
                  window.location.href = `/${CURRENT_PAGE_LANG}/post/${data.postId}`;
                } else {
                  window.location.href = `/${CURRENT_PAGE_LANG}/`;
                }
              });
            } else {
              showCustomMessage("ì €ì¥ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
            showCustomMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
    // ** í¬ì»¤ìŠ¤ ì¶©ëŒ í•´ê²°ì„ ìœ„í•œ format í•¨ìˆ˜ ìˆ˜ì • **
    function format(command, value = null) {
        // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œê°€ ì œëª© ì…ë ¥ í•„ë“œì¸ì§€ í™•ì¸
        const activeElement = document.activeElement;
        if (activeElement && activeElement.tagName === 'INPUT' && activeElement.type === 'text' && activeElement.name.startsWith('title_')) {
            // ì œëª© ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆë‹¤ë©´, ì—ë””í„°ì— ê°•ì œ í¬ì»¤ìŠ¤ë¥¼ ì£¼ì§€ ì•Šê³  ë°”ë¡œ ë¦¬í„´
            // íˆ´ë°” ë²„íŠ¼ì„ ëˆ„ë¥´ëŠ” ë™ì‘ì€ ì—ë””í„°ì— ì ìš©ë˜ì–´ì•¼ í•˜ë¯€ë¡œ, ì´ ë¶€ë¶„ì€ ìˆ˜ì •í•˜ì§€ ì•Šê³ 
            // ë‹¨ìˆœíˆ `currentActiveEditor.focus()` í˜¸ì¶œ ì „ì— ê²€ì‚¬ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ë” ì ì ˆí•©ë‹ˆë‹¤.
            // íˆ´ë°” ë²„íŠ¼ì„ ëˆŒë €ë‹¤ëŠ” ê²ƒì€ ì‚¬ìš©ìê°€ ì—ë””í„° ê¸°ëŠ¥ì„ ì“°ë ¤ê³  í•œë‹¤ëŠ” ì˜ë¯¸ì´ë¯€ë¡œ,
            // ì—ë””í„°ì— í¬ì»¤ìŠ¤ë¥¼ ì£¼ëŠ” ê²ƒì´ ë§ìŠµë‹ˆë‹¤.
        }

        if (!currentActiveEditor) return; // í™œì„± ì—ë””í„°ê°€ ì—†ìœ¼ë©´ ë¦¬í„´

        // íˆ´ë°” ë²„íŠ¼ í´ë¦­ ì‹œ, ì—ë””í„°ì— í¬ì»¤ìŠ¤ë¥¼ ì¤ë‹ˆë‹¤.
        // ì´ê²ƒì´ ì œëª© ì…ë ¥ í•„ë“œì˜ í¬ì»¤ìŠ¤ë¥¼ ëºëŠ” ì£¼ëœ ì›ì¸ì´ì—ˆì§€ë§Œ,
        // ì‚¬ìš©ìê°€ íˆ´ë°” ë²„íŠ¼ì„ ëˆŒë €ë‹¤ë©´ ì—ë””í„°ì— ëŒ€í•œ ì˜ë„ê°€ ìˆë‹¤ê³  íŒë‹¨í•©ë‹ˆë‹¤.
        currentActiveEditor.focus();
        document.execCommand("styleWithCSS", false, false);
        document.execCommand(command, false, value);
        setTimeout(detectStyle, 100);
    }

    function applyStyle(tag) {
        if (!currentActiveEditor) return;
        const blockTags = ['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'];

        restoreSelection(); // ì €ì¥ëœ ì„ íƒ ì˜ì—­ ë³µì›
        currentActiveEditor.focus(); // ì—ë””í„°ì— í¬ì»¤ìŠ¤

        if (blockTags.includes(tag)) {
          document.execCommand("styleWithCSS", false, false);
          document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
          saveSelection(); // ë³€ê²½ í›„ ì„ íƒ ì˜ì—­ ë‹¤ì‹œ ì €ì¥
        } else {
          const sel = window.getSelection();
          if (!sel.rangeCount || sel.isCollapsed) return;
          if (!currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

          const range = sel.getRangeAt(0);
          const tempElement = document.createElement(tag);
          if (tag === 'span') tempElement.classList.add('label');
          if (tag === 'strong') tempElement.classList.add('label', 'label-bold');

          try {
            const contents = range.extractContents();
            tempElement.appendChild(contents);
            range.insertNode(tempElement);

            sel.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNode(tempElement);
            sel.addRange(newRange);

            saveSelection(); // ë³€ê²½ í›„ ì„ íƒ ì˜ì—­ ë‹¤ì‹œ ì €ì¥
          } catch (e) {
            console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
          }
        }
        setTimeout(detectStyle, 100);
    }

      function insertImage() {
          showCustomInput("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:", (url) => {
            if (url) format('insertImage', url);
          });
      }

      function saveContent() {
          showCustomMessage("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
      }

      function toggleDropdown() {
          const styleDropdown = currentActiveEditor.closest('.lang-meta-block').querySelector('#styleDropdown');
          if (styleDropdown) {
              styleDropdown.classList.toggle('show');
          }
      }

      function updateCurrentStyle(tagName) {
          const labelMap = {
              h1: "ì œëª©",
              h2: "ë¶€ì œëª©",
              h3: "ë¨¸ë¦¬ë§ 1",
              h4: "ë¹¨ê°„ ë¨¸ë¦¬ë§",
              p: "ë³¸ë¬¸",
              small: "ì„¤ëª…",
              footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
              span: "ë ˆì´ë¸”",
              strong: "ì§„í•œ ë ˆì´ë¸”"
          };
          const label = labelMap[tagName.toLowerCase()] || tagName;
          const currentStyleToggle = currentActiveEditor.closest('.lang-meta-block').querySelector('.dropdown-toggle');
          if (currentStyleToggle) {
              currentStyleToggle.innerText = `${label} â–¼`;
          }
      }

      function detectStyle() {
        if (!currentActiveEditor) return;
        const sel = window.getSelection();
        // ì„ íƒ ì˜ì—­ì´ ì—†ê³ , í˜„ì¬ í™œì„± ì—ë””í„° ë‚´ì— ìˆì§€ ì•Šë‹¤ë©´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ í‘œì‹œ
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
            updateCurrentStyle('p');
            return;
        }
        let node = sel.getRangeAt(0).startContainer;

        if (node.nodeType === 3) node = node.parentNode; // í…ìŠ¤íŠ¸ ë…¸ë“œë©´ ë¶€ëª¨ ìš”ì†Œë¡œ

        while (node && node !== currentActiveEditor) {
          const tag = node.tagName?.toLowerCase();
          if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
            updateCurrentStyle(tag);
            return;
          }
          node = node.parentNode;
        }
        updateCurrentStyle('p');
      }

      function saveSelection() {
          const sel = window.getSelection();
          // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œê°€ currentActiveEditor ë‚´ë¶€ì¼ ë•Œë§Œ ì €ì¥
          if (sel.rangeCount > 0 && currentActiveEditor && currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
              savedRange = sel.getRangeAt(0).cloneRange();
          } else {
              savedRange = null;
          }
      }

      function restoreSelection() {
          const sel = window.getSelection();
          if (savedRange && currentActiveEditor) {
              sel.removeAllRanges();
              sel.addRange(savedRange);
          }
      }

      function setColor(command, color) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

        const range = sel.getRangeAt(0);

        if (color === "__clear__") {
          // ì„ íƒ ì˜ì—­ ë‚´ì—ì„œ íŠ¹ì • ìŠ¤íƒ€ì¼ì„ ì œê±°í•˜ëŠ” ë¡œì§ (execCommand ì‚¬ìš©)
          // foreColorëŠ” 'foreColor', hiliteColorëŠ” 'backColor' ëª…ë ¹ìœ¼ë¡œ ì œê±°
          document.execCommand(command === 'foreColor' ? 'foreColor' : 'backColor', false, 'transparent');
          // 'transparent'ê°€ ëª¨ë“  ê²½ìš°ì— ìƒ‰ìƒ ì œê±°ë¥¼ ë³´ì¥í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
          // CSS ìŠ¤íƒ€ì¼ì„ ì§ì ‘ ì¡°ì‘í•˜ëŠ” ë” ì •êµí•œ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          // ì—¬ê¸°ì„œëŠ” 'removeFormat'ì´ ë” í¬ê´„ì ì¸ ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤.
          
          // ë” í™•ì‹¤í•œ ì œê±°ë¥¼ ì›í•˜ë©´, ì„ íƒ ì˜ì—­ì„ ìˆœíšŒí•˜ë©° style ì†ì„± ì œê±° ë¡œì§ êµ¬í˜„ í•„ìš”
          // ì˜ˆ: ì„ íƒëœ í…ìŠ¤íŠ¸ì˜ spanì„ ì°¾ì•„ color ë˜ëŠ” background-color ì†ì„± ì œê±°
          const contents = range.cloneContents();
          const tempDiv = document.createElement('div');
          tempDiv.appendChild(contents);

          const spans = tempDiv.querySelectorAll("span");
          spans.forEach(span => {
            if (command === 'foreColor') span.style.color = '';
            else if (command === 'hiliteColor') span.style.backgroundColor = '';
            // ìŠ¤íƒ€ì¼ì´ ëª¨ë‘ ì œê±°ëœ spanì´ ìˆë‹¤ë©´ span ìì²´ë¥¼ ì œê±°í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
            if (!span.style.cssText) {
                span.replaceWith(...span.childNodes);
            }
          });
          range.deleteContents();
          range.insertNode(tempDiv.childNodes); // tempDivì˜ ìì‹ ë…¸ë“œë¥¼ ì‚½ì…
          saveSelection();
          detectStyle();
          return;
        }

        // ìƒ‰ìƒ ì ìš©
        document.execCommand(command, false, color);
        saveSelection();
        detectStyle();
      }

      function getCurrentBlockTag() {
        if (!currentActiveEditor) return 'p';
        const sel = window.getSelection();
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return 'p';

        let node = sel.getRangeAt(0).startContainer;
        while (node && node !== currentActiveEditor) {
          if (node.nodeType === 1) {
            const tag = node.tagName.toLowerCase();
            if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
              return tag;
            }
          }
          node = node.parentNode;
        }
        return 'p';
      }

      // ** New function: Auto convert plain text URLs to <a> tags **
      /**
       * ì—ë””í„° ë‚´ì—ì„œ ì¼ë°˜ í…ìŠ¤íŠ¸ URLì„ <a> íƒœê·¸ë¡œ ìë™ ë³€í™˜í•©ë‹ˆë‹¤.
       * @param {HTMLElement} editor - contenteditable ì—ë””í„° ì—˜ë¦¬ë¨¼íŠ¸.
       */
      function autoConvertUrlToLink(editor) {
          if (!editor || editor.style.display === 'none') return; // ì—ë””í„°ê°€ ì—†ê±°ë‚˜ HTML ëª¨ë“œì¼ ë•ŒëŠ” ì‹¤í–‰ ì•ˆ í•¨

          const blContent = editor.querySelector('.bl-content');
          if (!blContent) return;

          // í˜„ì¬ ì„ íƒ ì˜ì—­ì„ ì €ì¥ (ë³€í™˜ í›„ ë³µì›í•˜ì—¬ ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€)
          const selection = window.getSelection();
          let savedRange = null;
          if (selection.rangeCount > 0) {
              savedRange = selection.getRangeAt(0).cloneRange();
          }

          // URLì„ ê°ì§€í•˜ê¸° ìœ„í•œ ì •ê·œì‹ (http, httpsë¡œ ì‹œì‘í•˜ê³  ê³µë°±ì´ ì—†ëŠ” ë¬¸ìì—´ ë˜ëŠ” www.ë¡œ ì‹œì‘)
          // ì´ë©”ì¼ ì£¼ì†ŒëŠ” ì œì™¸í•˜ë„ë¡ ê°œì„ í–ˆìŠµë‹ˆë‹¤.
          const urlRegex = /(?<!\S)((https?:\/\/[^\s<>"']+|www\.[^\s<>"']+\.[a-zA-Z]{2,}))(?!\S)/g;

          // DOM íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ë©° í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¬ê·€ í•¨ìˆ˜
          const processNode = (node) => {
              if (node.nodeType === Node.TEXT_NODE) {
                  const text = node.nodeValue;
                  let match;
                  let lastIndex = 0;
                  const fragment = document.createDocumentFragment();
                  let replaced = false; // ë³€í™˜ì´ ì¼ì–´ë‚¬ëŠ”ì§€ ì¶”ì 

                  // exec()ëŠ” ìƒíƒœë¥¼ ìœ ì§€í•˜ë¯€ë¡œ, ë§¤ë²ˆ ìƒˆë¡œìš´ ì •ê·œì‹ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì•¼ í•¨
                  const currentUrlRegex = /(?<!\S)((https?:\/\/[^\s<>"']+|www\.[^\s<>"']+\.[a-zA-Z]{2,}))(?!\S)/g;

                  while ((match = currentUrlRegex.exec(text)) !== null) {
                      const fullUrl = match[0];
                      let href = fullUrl;

                      // 'www.'ë¡œ ì‹œì‘í•˜ë©´ 'http://'ë¥¼ ë¶™ì—¬ì¤Œ
                      if (href.startsWith('www.') && !href.startsWith('http')) {
                          href = 'http://' + href;
                      }

                      // ë§¤ì¹˜ëœ URL ì•ì˜ í…ìŠ¤íŠ¸ ì¶”ê°€
                      if (match.index > lastIndex) {
                          fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                      }

                      // <a> íƒœê·¸ ìƒì„± ë° ì¶”ê°€
                      const link = document.createElement('a');
                      link.href = href;
                      link.target = "_blank"; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                      link.rel = "noopener noreferrer"; // ë³´ì•ˆ ê¶Œì¥ ì‚¬í•­
                      link.textContent = fullUrl;
                      fragment.appendChild(link);
                      replaced = true;

                      lastIndex = currentUrlRegex.lastIndex;
                  }

                  // ë§ˆì§€ë§‰ ë§¤ì¹˜ ì´í›„ì˜ ë‚¨ì€ í…ìŠ¤íŠ¸ ì¶”ê°€
                  if (lastIndex < text.length) {
                      fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                  }

                  // ë³€ê²½ ì‚¬í•­ì´ ìˆë‹¤ë©´ ë…¸ë“œ êµì²´
                  if (replaced && fragment.hasChildNodes()) {
                      node.replaceWith(fragment);
                  }
              }
              // ìš”ì†Œ ë…¸ë“œì¸ ê²½ìš° (ì´ë¯¸ <a> íƒœê·¸ì¸ ê²½ìš°ëŠ” ê±´ë„ˆë›°ê³ , ìì‹ ë…¸ë“œ ì¬ê·€ ì²˜ë¦¬)
              else if (node.nodeType === Node.ELEMENT_NODE && node.tagName.toLowerCase() !== 'a' && node.tagName.toLowerCase() !== 'iframe') {
                  // NodeListëŠ” ì‹¤ì‹œê°„ ì»¬ë ‰ì…˜ì´ë¯€ë¡œ, Array.fromìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ìˆœíšŒ ì¤‘ ë³€ê²½ì— ëŒ€ë¹„
                  Array.from(node.childNodes).forEach(processNode);
              }
          };

          // bl-content ë‚´ë¶€ì˜ ëª¨ë“  ìì‹ ë…¸ë“œë¶€í„° ì²˜ë¦¬ ì‹œì‘
          Array.from(blContent.childNodes).forEach(processNode);

          // ì €ì¥ëœ ì„ íƒ ì˜ì—­ ë³µì›
          if (savedRange) {
              try {
                  selection.removeAllRanges();
                  selection.addRange(savedRange);
              } catch (e) {
                  // ë³µì› ì‹¤íŒ¨ ì‹œ (ì˜ˆ: DOM êµ¬ì¡°ê°€ í¬ê²Œ ë³€ê²½ë˜ì–´ ê¸°ì¡´ Rangeê°€ ìœ íš¨í•˜ì§€ ì•Šì„ ë•Œ)
                  // ì—ë””í„°ì˜ ëìœ¼ë¡œ ì»¤ì„œ ì´ë™ ì‹œë„
                  const newRange = document.createRange();
                  newRange.selectNodeContents(blContent);
                  newRange.collapse(false); // ëìœ¼ë¡œ ì´ë™
                  selection.removeAllRanges();
                  selection.addRange(newRange);
              }
          }
      }

      // ** Modified function: Auto convert YouTube links to embeds (handles both <a> and raw text) **
      /**
       * ì£¼ì–´ì§„ ì—ë””í„° ë‚´ë¶€ì˜ ìœ íŠœë¸Œ ë§í¬ (<a> íƒœê·¸ ë˜ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸)ë¥¼ ìœ íŠœë¸Œ ì„ë² ë“œ iframeìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
       * @param {HTMLElement} editor - `contenteditable` ì†ì„±ì„ ê°€ì§„ ì—ë””í„° ì—˜ë¦¬ë¨¼íŠ¸ (ì˜ˆ: `editor_ko`).
       */
      function convertYouTubeLinksToEmbeds(editor) {
        if (!editor) return;

        const blContent = editor.querySelector('.bl-content');
        // bl-contentê°€ ì—†ê±°ë‚˜, HTML ëª¨ë“œì—ì„œëŠ” ë³€í™˜í•˜ì§€ ì•ŠìŒ
        if (!blContent || editor.style.display === 'none') return;

        // ìœ íŠœë¸Œ URLì„ ê°ì§€í•˜ê¸° ìœ„í•œ ì •ê·œì‹ (í‘œì¤€ ìœ íŠœë¸Œ URL ë° http://googleusercontent.com/youtube.com/ íŒ¨í„´ í¬í•¨)
        // 11ìë¦¬ì˜ í‘œì¤€ YouTube IDë¥¼ ì •í™•íˆ ìº¡ì²˜í•˜ë„ë¡ ê°œì„ 
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([\w-]{11})(?:\S+)?/i;
        const googleUserContentYoutubeRegex = /(?:https?:\/\/)?googleusercontent\.com\/youtube\.com\/embed\/([\w-]{11})(?:\S+)?/i; // ì´ë¯¸ ë³€í™˜ëœ ì„ë² ë“œ ë§í¬ë„ í¬í•¨

        // í˜„ì¬ ì„ íƒ ì˜ì—­ì„ ì €ì¥
        const selection = window.getSelection();
        let savedRange = null;
        if (selection.rangeCount > 0) {
            savedRange = selection.getRangeAt(0).cloneRange();
        }

        const nodesToProcess = [];
        const treeWalker = document.createTreeWalker(
            blContent,
            NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
            {
                acceptNode: (node) => {
                    // ì´ë¯¸ iframeì´ê±°ë‚˜ contenteditable ìš”ì†Œ ìì²´ëŠ” ê±´ë„ˆë›°ê³ ,
                    // youtubeRegexë‚˜ googleUserContentYoutubeRegexì— ë§¤ì¹˜ë˜ëŠ” hrefë¥¼ ê°€ì§„ <a> íƒœê·¸ëŠ” ì²˜ë¦¬ ëŒ€ìƒì— í¬í•¨
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        if (node.tagName.toLowerCase() === 'iframe' || node === editor) {
                            return NodeFilter.FILTER_SKIP;
                        }
                        // ì´ë¯¸ ë³€í™˜ëœ youtubeusercontent iframe srcë¥¼ ê°€ì§„ <a> íƒœê·¸ëŠ” ê±´ë„ˆëœ€ (ì¤‘ë³µ ë³€í™˜ ë°©ì§€)
                        if (node.tagName.toLowerCase() === 'a' && (node.href.match(youtubeRegex) || node.href.match(googleUserContentYoutubeRegex))) {
                            return NodeFilter.FILTER_ACCEPT; // ë§í¬ ìì²´ë¥¼ ë³€í™˜ ëŒ€ìƒìœ¼ë¡œ í¬í•¨
                        }
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            },
            false
        );

        let currentNode;
        while ((currentNode = treeWalker.nextNode())) {
            nodesToProcess.push(currentNode);
        }

        nodesToProcess.forEach(node => {
            let replaced = false;

            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.nodeValue;
                const fragment = document.createDocumentFragment();
                let lastIndex = 0;
                let currentText = text;

                // ìƒˆë¡œìš´ ì •ê·œì‹ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ì´ˆê¸°í™”
                const tempYoutubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([\w-]{11})(?:\S+)?/i;
                let match;

                while ((match = tempYoutubeRegex.exec(currentText)) !== null) {
                    const videoId = match[1];
                    const fullMatch = match[0];

                    if (match.index > 0) {
                        fragment.appendChild(document.createTextNode(currentText.substring(0, match.index)));
                    }

                    // YouTube iframe ìƒì„±
                    const iframe = document.createElement('iframe');
                    iframe.setAttribute('src', `https://www.youtube.com/embed/${videoId}`);
                    iframe.setAttribute('width', '560'); // ê¸°ë³¸ ë„ˆë¹„
                    iframe.setAttribute('height', '315'); // ê¸°ë³¸ ë†’ì´
                    iframe.setAttribute('frameborder', '0');
                    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                    iframe.setAttribute('allowfullscreen', '');
                    iframe.setAttribute('loading', 'lazy'); // ì§€ì—° ë¡œë”©
                    iframe.classList.add('youtube-embed'); // CSS ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€

                    fragment.appendChild(iframe);
                    replaced = true;
                    currentText = currentText.substring(tempYoutubeRegex.lastIndex);
                    tempYoutubeRegex.lastIndex = 0; // ë‹¤ìŒ ê²€ìƒ‰ì„ ìœ„í•´ lastIndex ì´ˆê¸°í™”
                }

                if (currentText.length > 0) {
                    fragment.appendChild(document.createTextNode(currentText));
                }

                if (replaced && fragment.hasChildNodes()) {
                    node.replaceWith(fragment);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName.toLowerCase() === 'a') {
                const href = node.getAttribute('href');
                if (href) {
                    let match = href.match(youtubeRegex);
                    if (!match) { // googleusercontent.comìœ¼ë¡œ ì´ë¯¸ ë³€í™˜ëœ ë§í¬ë„ ì²˜ë¦¬
                        match = href.match(googleUserContentYoutubeRegex);
                    }

                    if (match) {
                        const videoId = match[1];

                        const iframe = document.createElement('iframe');
                        iframe.setAttribute('src', `https://www.youtube.com/embed/${videoId}`);
                        iframe.setAttribute('width', '560');
                        iframe.setAttribute('height', '315');
                        iframe.setAttribute('frameborder', '0');
                        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                        iframe.setAttribute('allowfullscreen', '');
                        iframe.setAttribute('loading', 'lazy');
                        iframe.classList.add('youtube-embed');

                        node.replaceWith(iframe); // <a> íƒœê·¸ë¥¼ iframeìœ¼ë¡œ ëŒ€ì²´
                    }
                }
            }
        });

        // ì €ì¥ëœ ì„ íƒ ì˜ì—­ ë³µì›
        if (savedRange) {
            try {
                selection.removeAllRanges();
                selection.addRange(savedRange);
            } catch (e) {
                // ë³µì› ì‹¤íŒ¨ ì‹œ, ì—ë””í„°ì˜ ëìœ¼ë¡œ ì»¤ì„œ ì´ë™ ì‹œë„
                const newRange = document.createRange();
                newRange.selectNodeContents(blContent);
                newRange.collapse(false);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }
      }

      // ëª©ì°¨ ì‚½ì… ê¸°ëŠ¥ (insertTOC) - í•„ìš” ì‹œ êµ¬í˜„
      function insertTOC() {
        showCustomMessage("ëª©ì°¨ ì‚½ì… ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        // ì—¬ê¸°ì— ëª©ì°¨ ì‚½ì… ë¡œì§ êµ¬í˜„ (ì˜ˆ: <h1>, <h2> íƒœê·¸ë¥¼ ì°¾ì•„ ëª©ë¡ ìƒì„±)
      }

      // HTML ì‚½ì… íŒì—… (openHtmlPopup) - í•„ìš” ì‹œ êµ¬í˜„
      function openHtmlPopup() {
        showCustomInput("ì‚½ì…í•  HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", (htmlCode) => {
          if (htmlCode) {
            // contenteditable ì—ë””í„°ì— HTML ì‚½ì…
            document.execCommand('insertHTML', false, htmlCode);
          }
        });
      }


    // ** DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì—ë””í„° ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© **
    document.addEventListener('DOMContentLoaded', () => {
        const langSelector = document.getElementById('langSelector');
        if (langSelector) {
            langSelector.addEventListener('change', (event) => {
                const selectedLang = event.target.value;
                initializeEditorForLang(selectedLang);
            });
        }

        // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì–¸ì–´ì— ë§ëŠ” ì—ë””í„° í™œì„±í™”
        initializeEditorForLang(CURRENT_PAGE_LANG);

        // ê° ë””ìì¸ ëª¨ë“œ ì—ë””í„°ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
        document.querySelectorAll('.language-editor').forEach(editor => {
            editor.addEventListener('focus', () => {
                currentActiveEditor = editor;
                detectStyle();
            });
            editor.addEventListener('mouseup', saveSelection); // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ëë‚  ë•Œ ì„ íƒ ì˜ì—­ ì €ì¥
            editor.addEventListener('keyup', (e) => { // í‚¤ ì…ë ¥ ì‹œ
                detectStyle(); // ìŠ¤íƒ€ì¼ ê°ì§€
                // ìŠ¤í˜ì´ìŠ¤ë°”, ì—”í„°, ë§ˆì¹¨í‘œ ë“± ì…ë ¥ ì‹œ URL/YouTube ë§í¬ ìë™ ë³€í™˜ ì‹œë„
                if (e.key === ' ' || e.key === 'Enter' || e.key === '.' || e.key === '/') {
                    autoConvertUrlToLink(currentActiveEditor);
                    convertYouTubeLinksToEmbeds(currentActiveEditor);
                }
                saveSelection(); // í‚¤ ì…ë ¥ í›„ ì„ íƒ ì˜ì—­ ì €ì¥
            });
            editor.addEventListener('paste', (e) => {
                // ë¶™ì—¬ë„£ê¸° ì™„ë£Œ í›„ URL/YouTube ë§í¬ ìë™ ë³€í™˜
                setTimeout(() => {
                    autoConvertUrlToLink(currentActiveEditor);
                    convertYouTubeLinksToEmbeds(currentActiveEditor);
                }, 0);
            });
        });

        // ì œëª© ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.title-wrap input').forEach(titleInput => {
            titleInput.addEventListener('focus', () => {
                // ì œëª© ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ì™”ì„ ë•Œ, í˜„ì¬ ë””ìì¸ ì—ë””í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆì—ˆë‹¤ë©´ í¬ì»¤ìŠ¤ë¥¼ í•´ì œ
                if (currentActiveEditor && document.activeElement !== currentActiveEditor) {
                    currentActiveEditor.blur(); 
                    // currentActiveEditorë¥¼ nullë¡œ ë§Œë“¤ì§€ëŠ” ì•Šê³ , ë‹¨ìˆœíˆ í¬ì»¤ìŠ¤ë§Œ í•´ì œí•©ë‹ˆë‹¤.
                    // ì´ë ‡ê²Œ í•´ì•¼ ì‚¬ìš©ìê°€ ì—ë””í„°ë¥¼ ë‹¤ì‹œ í´ë¦­í–ˆì„ ë•Œ ë°”ë¡œ í¬ì»¤ìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                }
            });
        });
    });

    // ** ì—ë””í„° ì´ˆê¸°í™” ë° ì–¸ì–´ ì „í™˜ì„ ìœ„í•œ í•¨ìˆ˜ **
    function initializeEditorForLang(langCode) {
        // ëª¨ë“  ì–¸ì–´ ë¸”ë¡ ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.lang-meta-block').forEach(block => {
            block.style.display = 'none';
        });

        // ì„ íƒëœ ì–¸ì–´ ë¸”ë¡ í‘œì‹œ
        const currentLangBlock = document.querySelector(`.lang-meta-block[data-lang="${langCode}"]`);
        if (currentLangBlock) {
            currentLangBlock.style.display = '';
        }

        const editorDiv = document.getElementById(`editor_${langCode}`);
        const htmlEditorDiv = document.getElementById(`htmlEditor_${langCode}`);

        // í˜„ì¬ í™œì„± ì—ë””í„° ë° HTML ì—ë””í„° ì—…ë°ì´íŠ¸
        currentActiveEditor = editorDiv;
        currentActiveHtmlEditor = htmlEditorDiv;

        // ë””ìì¸ ëª¨ë“œ ì—ë””í„°ê°€ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ í¬ì»¤ìŠ¤
        if (editorDiv && editorDiv.style.display !== 'none') {
            editorDiv.focus();
            detectStyle(); // í˜„ì¬ ìŠ¤íƒ€ì¼ ê°ì§€
        }
        // HTML ëª¨ë“œ ì—ë””í„°ê°€ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ í¬ì»¤ìŠ¤
        else if (htmlEditorDiv && htmlEditorDiv.style.display !== 'none') {
            htmlEditorDiv.focus();
        }
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì œëª© í•„ë“œì— í¬ì»¤ìŠ¤ë¥¼ ì£¼ì§€ ì•ŠëŠ” ëŒ€ì‹ ,
        // ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ í´ë¦­í•˜ì—¬ ì œëª©ì„ ì…ë ¥í•˜ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤.
    }

    // ** ëª¨ë“œ ì „í™˜ í•¨ìˆ˜ **
    function switchToDesignMode() {
        const currentLang = document.getElementById('langSelector').value;
        const editorDiv = document.getElementById(`editor_${currentLang}`);
        const htmlEditorDiv = document.getElementById(`htmlEditor_${currentLang}`);

        if (editorDiv && htmlEditorDiv) {
            htmlEditorDiv.style.display = 'none';
            
            // HTML ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ ë””ìì¸ ëª¨ë“œ ì—ë””í„°ì— ì„¤ì •
            let content = htmlEditorDiv.value;
            try {
                // HTMLì„ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬
                content = html_beautify(content, { indent_size: 2, wrap_line_length: 80 });
            } catch (e) {
                console.error("HTML beautify error:", e);
            }
            editorDiv.innerHTML = content; // ë””ìì¸ ëª¨ë“œì— ë‚´ìš© ì‚½ì…
            editorDiv.style.display = 'block';
            editorDiv.focus(); // ë””ìì¸ ëª¨ë“œë¡œ ì „í™˜ ì‹œ í¬ì»¤ìŠ¤
            currentActiveEditor = editorDiv;
            currentActiveHtmlEditor = null; // HTML ì—ë””í„°ëŠ” ë¹„í™œì„±í™”
            detectStyle(); // ìŠ¤íƒ€ì¼ ê°ì§€
            showCustomMessage("ë””ìì¸ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    function switchToHtmlMode() {
        const currentLang = document.getElementById('langSelector').value;
        const editorDiv = document.getElementById(`editor_${currentLang}`);
        const htmlEditorDiv = document.getElementById(`htmlEditor_${currentLang}`);

        if (editorDiv && htmlEditorDiv) {
            // ë””ìì¸ ëª¨ë“œ ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ HTML ì—ë””í„°ì— ì„¤ì •
            let content = editorDiv.innerHTML;
            try {
                // HTMLì„ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬
                content = html_beautify(content, { indent_size: 2, wrap_line_length: 80 });
            } catch (e) {
                console.error("HTML beautify error:", e);
            }
            htmlEditorDiv.value = content; // HTML ì—ë””í„°ì— ë‚´ìš© ì‚½ì…
            editorDiv.style.display = 'none';
            htmlEditorDiv.style.display = 'block';
            htmlEditorDiv.focus(); // HTML ëª¨ë“œë¡œ ì „í™˜ ì‹œ í¬ì»¤ìŠ¤
            currentActiveHtmlEditor = htmlEditorDiv;
            currentActiveEditor = null; // ë””ìì¸ ì—ë””í„°ëŠ” ë¹„í™œì„±í™”
            showCustomMessage("HTML ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

  </script>
</body>
</html>