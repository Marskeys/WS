<!DOCTYPE html>
<html lang="ko">
<head>
  <%- include('partials/head') %>
  <meta charset="UTF-8" />
  <title>BlindLove ì—ë””í„°</title>

  <% if (user) { %>
    <!-- âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¼ë©´ -->
    <meta name="author" content="<%= user.nickname %>">
  <% } %>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/editor.css" />
  
  <style>

#editor ul,
#editor ol {
  padding-left: 1.2em; /* í•„ìš”í•˜ë©´ ë„ˆê°€ ì›í•˜ëŠ” ë§Œí¼ */
  margin: 0.5em 0;     /* ì „ì²´ ë¦¬ìŠ¤íŠ¸ì˜ ìƒí•˜ ì—¬ë°± ì¡°ì ˆ */
}

#editor li {
  margin: 0.2em 0;     /* í•­ëª© ê°„ê²© ìµœì†Œí™” */
  padding: 0;
}


.mode-toggle {
  margin-top: 1rem; 
  margin-bottom: 0.5rem;
  text-align: right;
}

.mode-toggle button {
  margin-left: 0.3rem;
  padding: 3px 9px;
  font-size: 0.7rem;
  font-weight: 500;
  border: 1px solid #ccc;
  border-radius: 6px;
  background: linear-gradient(to bottom right, #fdfdfd, #f1f1f1);
  color: #333;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.mode-toggle button:hover {
  background: linear-gradient(to bottom right, #eaeaea, #dcdcdc);
  color: #000;
  transform: scale(1.03);
}

/* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ */
html.dark body .mode-toggle button {
  background: linear-gradient(to bottom right, #2c2f35, #3a3d45);
  color: #eee;
  border: 1px solid #555;
  box-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

html.dark body .mode-toggle button:hover {
  background: linear-gradient(to bottom right, #3a3d45, #4b4e57);
  color: #fff;
  transform: scale(1.03);
}
#htmlEditor {
  width: 100%;
  height: 400px;
  font-family: monospace;
  font-size: 0.9rem;
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

    /* ğŸ“‘ ëª©ì°¨ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.auto-toc {
  background: #f7f9fa;
  border: 1px solid #d0d7de;
  padding: 1rem;
  margin-bottom: 1.5rem;
  border-radius: 6px;
  font-size: 0.95rem;
  line-height: 1.6;
}

.auto-toc .toc-title {
  font-weight: bold;
  margin-bottom: 0.5rem;
  display: block;
}

.auto-toc .toc-list {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.auto-toc .toc-item {
  margin-bottom: 0.3rem;
}

.auto-toc .toc-h1 a {
  color: #0366d6;
  font-weight: 600;
}

.auto-toc .toc-h2 {
  margin-left: 1em;
}

.auto-toc .toc-h2 a {
  color: #0366d6;
  font-weight: 400;
  font-size: 0.94em;
}

/* ğŸŒ™ ë‹¤í¬ëª¨ë“œ ì ìš© */
html.dark .auto-toc {
  background: #1f1f2b;
  border: 1px solid #444;
  color: #ddd;
}

html.dark .auto-toc a {
  color: #6fb7ff;
}


    body {
      margin: 0;
      padding: 0;
    }
  
    .header-top {
      margin-top: 0 !important;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined'; %>
  <!-- âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ˆì‹œ (ì›í•˜ë©´ ìƒëµ ê°€ëŠ¥) -->
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

    <div class="editor-container">
        <div class="logo-wrap">
          <img src="/assets/images/logo.png" alt="BlindLove ë¡œê³ " />
        </div>
    
        <div class="title-wrap">
          <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="<%= post?.title || '' %>" />
        </div>
    
        <div class="toolbar">
          <div class="dropdown">
            <div class="dropdown-toggle" id="currentStyle" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" id="styleDropdown">
              <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
              <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
              <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
              <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
              <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
              <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
          <button onclick="insertTOC()" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
          <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
         
          <div class="color-tool" id="foreTool">
            <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-pencil-alt" id="foreIcon"></i>
            </button>
            <div class="color-palette" id="forePalette">
              <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
              <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
              <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
              <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
              <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
              <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" id="bgTool">
            <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-fill-drip" id="bgIcon"></i>
            </button>
            <div class="color-palette" id="bgPalette">
              <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
              <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
              <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
              <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
              <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
              <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
              </label>
            </div>
          </div>
    
          
          
    
          <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <% if (user && Number(user.is_admin) === 1) { %>
        <div class="mode-toggle">
          <button onclick="switchToDesignMode()">ë””ìì¸ ëª¨ë“œ</button>
          <button onclick="switchToHtmlMode()">HTML ëª¨ë“œ</button>
        </div>
        <% } %>
        
        <div id="editorWrapper">
          <div id="editor" contenteditable="true" class="editor" spellcheck="false">
            <%- post && post.content ? post.content : '<p><br></p>' %>
          </div>
          <textarea id="htmlEditor" class="editor" style="display: none;"></textarea>
        </div>

        <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
          <input type="checkbox" id="isPrivateCheckbox" name="is_private" value="1" <%= post?.is_private ? 'checked' : '' %> />
          ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
        </label>

        <% if (user && Number(user.is_admin) === 1) { %>
          <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
            <input type="checkbox" id="isPinnedCheckbox" name="is_pinned" value="1" <%= post?.is_pinned ? 'checked' : '' %> />
            ìƒë‹¨ì— ê³ ì •í•˜ê¸° ğŸ“Œ
          </label>
        <% } %>

        <div class="category-box">
          <label>ì¹´í…Œê³ ë¦¬:</label>
          <div class="category-list" id="categoryList"></div>
          <button class="add-category-btn" onclick="addCategory()">â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="post-btn" onclick="postContent()">ğŸ“¬ í¬ìŠ¤íŒ…</button>
          <button class="save-btn" onclick="saveContent()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
   
  
    <%
  const categoryList = (post && post.categories) ? post.categories.split(',') : ['ì¼ìƒ'];
  const postUrl = (isEdit && post) ? `/edit/${post.id}` : '/savePost';
  const redirectUrl = (isEdit && post) ? `/post/${post.id}` : '/';
%>

    <script>

// editor.ejs (openHtmlPopup í•¨ìˆ˜) - ìˆ˜ì •ëœ ë¶€ë¶„

// editor.ejs (openHtmlPopup í•¨ìˆ˜) - ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.
function openHtmlPopup() {
  showCustomInput("ì‚½ì…í•  HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", async (rawCode) => {
    if (!rawCode) return;

    // ì‚¬ìš©ì ì…ë ¥ rawCodeë¥¼ ê·¸ëŒ€ë¡œ Base64 ì¸ì½”ë”©í•©ë‹ˆë‹¤.
    const encoder = new TextEncoder();
    const encodedUint8 = encoder.encode(rawCode); 

    const base64Code = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const result = reader.result;
            if (typeof result === 'string') {
                resolve(result.split(',')[1]);
            } else {
                reject(new Error("FileReader result is not a string."));
            }
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(new Blob([encodedUint8]));
    });

    const wrapper = document.createElement("div");
    wrapper.className = "custom-widget";
    wrapper.setAttribute("data-type", "html-snippet");
    wrapper.setAttribute("data-code", base64Code);

    // âœ… ì‚½ì… ë¯¸ë¦¬ë³´ê¸° (ì—ë””í„° ì•ˆì—ëŠ” í‘œì‹œë˜ì§€ë§Œ ì €ì¥ë  ë• ì§„ì§œ ì½”ë“œë¡œ ë“¤ì–´ê°)
    // ì´ divëŠ” ì—ë””í„°ì—ì„œ HTML ìŠ¤ë‹ˆí«ì˜ 'ìë¦¬ í‘œì‹œì' ì—­í• ì„ í•©ë‹ˆë‹¤.
    wrapper.innerHTML = `<div style="border: 1px dashed gray; padding: 0.5rem; color: #666;">[HTML ì½”ë“œ ì‚½ì…ë¨]</div>`;

    // âœ… ì„ íƒí•œ ìœ„ì¹˜ì— ì‚½ì…
    const sel = window.getSelection();
    if (sel && sel.rangeCount > 0) {
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(wrapper);
    } else {
      const editor = document.getElementById("editor");
      editor.appendChild(wrapper);
    }
    // âœ… selection ë³µêµ¬
    saveSelection();
  });
}






      // ëª¨ë“  JavaScript ì½”ë“œë¥¼ í•˜ë‚˜ì˜ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ìœ¼ë¡œ í†µí•©í•©ë‹ˆë‹¤.
      let selectedCategories = <%- JSON.stringify(categoryList) %>;
      let categories = [];
      let savedRange = null;
      
      function renderCategories() {
          const list = document.getElementById('categoryList');
          list.innerHTML = '';
          categories.forEach((cat, index) => {
            const item = document.createElement('div');
            item.className = 'category-item';
            if (selectedCategories.includes(cat)) item.classList.add('selected');
            item.innerText = cat;
      
            item.onclick = () => {
              const i = selectedCategories.indexOf(cat);
              if (i === -1) selectedCategories.push(cat);
              else selectedCategories.splice(i, 1);
              renderCategories();
            };
      
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerText = 'Ã—';
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              // ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ì ì •ì˜ ëª¨ë‹¬ ë˜ëŠ” divë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
              // alert ëŒ€ì‹  ë©”ì‹œì§€ ìƒìë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
              showCustomMessage(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true, () => {
                fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                  method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    categories.splice(index, 1);
                    selectedCategories = selectedCategories.filter(c => c !== cat);
                    renderCategories();
                    showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  } else {
                    showCustomMessage("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                  }
                })
                .catch(err => {
                  console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                  showCustomMessage("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
              });
            };
      
            item.appendChild(removeBtn);
            list.appendChild(item);
          });
        }
      
        function addCategory() {
          // prompt ëŒ€ì‹  ì‚¬ìš©ì ì •ì˜ ì…ë ¥ ëª¨ë‹¬ ë˜ëŠ” divë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          showCustomInput("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", (newCat) => {
            newCat = newCat?.trim();
            if (!newCat || categories.includes(newCat)) return;
        
            fetch('/api/categories', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: newCat })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                categories.push(newCat);
                renderCategories();
                showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                showCustomMessage("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
              }
            })
            .catch(err => {
              console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
              showCustomMessage("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
          });
        }
      
        function postContent() {
          const title = document.getElementById('postTitle').value.trim();
          const content = document.getElementById('editor').innerHTML.trim();
          const categoriesToSend = selectedCategories;
          const isPrivate = document.getElementById('isPrivateCheckbox').checked ? 1 : 0;
          const isPinned = document.getElementById('isPinnedCheckbox')?.checked ? 1 : 0;

          if (!title) return showCustomMessage("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          if (!content || content === '<div><br></div>' || content === '<p><br></p>') return showCustomMessage("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          if (!categoriesToSend || categoriesToSend.length === 0) return showCustomMessage("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      
          fetch("<%= postUrl %>", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              content,
              categories: categoriesToSend,
              is_private: isPrivate, // ë¹„ê³µê°œ ì—¬ë¶€ ì¶”ê°€
              is_pinned: isPinned,
              // user_idëŠ” ì„œë²„ì—ì„œ ì„¸ì…˜ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ë” ì•ˆì „í•˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³ , ì‚¬ìš©ìê°€ 'í™•ì¸'ì„ í´ë¦­í•˜ë©´ í˜ì´ì§€ë¥¼ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
              showCustomMessage("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", false, () => {
                <% if (isEdit && post) { %>
                  window.location.href = "/post/<%= post.id %>";
                <% } else { %>
                  window.location.href = "/";
                <% } %>
              });
            } else {
              showCustomMessage("ì €ì¥ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
            showCustomMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
      // --- ìˆ˜ì •ëœ format í•¨ìˆ˜ ---
      function format(command, value = null) {
          document.execCommand("styleWithCSS", false, false); // í•­ìƒ CSS ì‚¬ìš© ì•ˆí•¨
          document.execCommand(command, false, value);
          setTimeout(detectStyle, 100);
      }
      // -------------------------

      // --- ìˆ˜ì •ëœ applyStyle í•¨ìˆ˜ ---
      function applyStyle(tag) {
        const blockTags = ['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'];
        const editor = document.getElementById("editor");

        restoreSelection();
        editor.focus();

        if (blockTags.includes(tag)) {
          document.execCommand("styleWithCSS", false, false);
          document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
          saveSelection();
        } else {
          const sel = window.getSelection();
          if (!sel.rangeCount || sel.isCollapsed) return;

          const range = sel.getRangeAt(0);
          const tempElement = document.createElement(tag);
          if (tag === 'span') tempElement.classList.add('label');
          if (tag === 'strong') tempElement.classList.add('label', 'label-bold');

          try {
            const contents = range.extractContents();
            tempElement.appendChild(contents);
            range.insertNode(tempElement);

            sel.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNode(tempElement);
            sel.addRange(newRange);

            saveSelection();
          } catch (e) {
            console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
          }
        }
        setTimeout(detectStyle, 100);
      }

      // -------------------------

      function insertImage() {
          // alert ëŒ€ì‹  ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          showCustomInput("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:", (url) => {
            if (url) format('insertImage', url);
          });
      }

      function saveContent() {
          // ì„ì‹œ ì €ì¥ ê¸°ëŠ¥ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë§Œ)
          showCustomMessage("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
      }

      function toggleDropdown() {
          document.getElementById('styleDropdown').classList.toggle('show');
      }

      function updateCurrentStyle(tagName) {
          const labelMap = {
              h1: "ì œëª©",
              h2: "ë¶€ì œëª©",
              h3: "ë¨¸ë¦¬ë§ 1",
              h4: "ë¹¨ê°„ ë¨¸ë¦¬ë§",
              p: "ë³¸ë¬¸",
              small: "ì„¤ëª…",
              footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
              span: "ë ˆì´ë¸”",
              strong: "ì§„í•œ ë ˆì´ë¸”"
          };
          const label = labelMap[tagName.toLowerCase()] || tagName;
          document.getElementById("currentStyle").innerText = `${label} â–¼`;
      }

      function detectStyle() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        let node = sel.getRangeAt(0).startContainer;

        if (node.nodeType === 3) node = node.parentNode;

        while (node && node !== document) {
          const tag = node.tagName?.toLowerCase();
          if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
            updateCurrentStyle(tag);
            return;
          }
          node = node.parentNode;
        }
        updateCurrentStyle('p');
      }

      function saveSelection() {
          const sel = window.getSelection();
          if (sel.rangeCount > 0) {
              savedRange = sel.getRangeAt(0).cloneRange();
          }
      }

      function restoreSelection() {
          const sel = window.getSelection();
          if (savedRange) {
              sel.removeAllRanges();
              sel.addRange(savedRange);
          }
      }

      // --- ìˆ˜ì •ëœ setColor í•¨ìˆ˜ ---
      function setColor(command, color) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) return;

        const range = sel.getRangeAt(0);

        if (color === "__clear__") {
          const contents = range.cloneContents();
          const spans = contents.querySelectorAll("span");

          spans.forEach(span => {
            if (command === 'foreColor') span.style.color = '';
            else if (command === 'hiliteColor') span.style.backgroundColor = '';
          });

          range.deleteContents();
          range.insertNode(contents);
          return;
        }

        const span = document.createElement("span");
        if (command === "foreColor") span.style.color = color;
        else if (command === "hiliteColor") span.style.backgroundColor = color;

        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);

        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNode(span);
        sel.addRange(newRange);

        saveSelection();
        detectStyle();
      }

      function getCurrentBlockTag() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return null;

        let node = sel.getRangeAt(0).startContainer;
        while (node && node !== document) {
          if (node.nodeType === 1) {
            const tag = node.tagName.toLowerCase();
            if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
              return tag;
            }
          }
          node = node.parentNode;
        }
        return 'p';
      }

      // -------------------------
      // âœ… ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ë° ì…ë ¥ ë°•ìŠ¤ êµ¬í˜„ (alert, prompt ëŒ€ì²´)
      function createMessageBox(message, isConfirm = false, onConfirm = null) {
          let modal = document.getElementById('customMessageModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customMessageModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p> <!-- âœ… ê¸€ììƒ‰ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ -->
                  ${isConfirm ? `
                      <button id="confirmBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                      <button id="cancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
                  ` : `
                      <button id="okBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  `}
              </div>
          `;
          modal.style.display = 'flex';

          if (isConfirm) {
              document.getElementById('confirmBtn').onclick = () => {
                  modal.style.display = 'none';
                  if (onConfirm) onConfirm();
              };
              document.getElementById('cancelBtn').onclick = () => {
                  modal.style.display = 'none';
              };
          } else {
              document.getElementById('okBtn').onclick = () => {
                  modal.style.display = 'none';
                  // 'í™•ì¸' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ onConfirm ì½œë°±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
                  if (onConfirm) onConfirm();
              };
          }
      }

      function showCustomMessage(message, isConfirm = false, onConfirm = null) {
          createMessageBox(message, isConfirm, onConfirm);
      }

      function showCustomInput(message, onInput) {
          let modal = document.getElementById('customInputModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customInputModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p> <!-- âœ… ì…ë ¥ì°½ ë©”ì‹œì§€ ê¸€ììƒ‰ë„ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ -->
                  <input type="text" id="customInput" style="width: calc(100% - 20px); padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;" />
                  <button id="inputOkBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  <button id="inputCancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
              </div>
          `;
          modal.style.display = 'flex';

          document.getElementById('inputOkBtn').onclick = () => {
              const inputValue = document.getElementById('customInput').value;
              modal.style.display = 'none';
              if (onInput) onInput(inputValue);
          };
          document.getElementById('inputCancelBtn').onclick = () => {
              modal.style.display = 'none';
              if (onInput) onInput(null); // ì·¨ì†Œ ì‹œ null ì „ë‹¬
          };
          document.getElementById('customInput').focus(); // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
      }
      // -------------------------

      window.onclick = function(e) {
          if (!e.target.matches('.dropdown-toggle')) {
              const dropdowns = document.getElementsByClassName('dropdown-menu');
              for (let d of dropdowns) d.classList.remove('show');
          }
      };

      // `window.onload`ëŠ” í•œ ë²ˆë§Œ í• ë‹¹ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
      // ëª¨ë“  í•¨ìˆ˜ ì •ì˜ë¥¼ ì´ì „ì— ë°°ì¹˜í•˜ì—¬ ì˜¤ë¥˜ ì—†ì´ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
      window.onload = () => {
          // ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
          fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
              categories = data.categories || [];
              renderCategories();
            })
            .catch(err => {
              console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
              categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°']; // ëŒ€ì²´ ì¹´í…Œê³ ë¦¬
              renderCategories();
            });

          // ì—ë””í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const editor = document.getElementById('editor');
          editor.addEventListener('keyup', detectStyle);
          editor.addEventListener('mouseup', detectStyle);
          editor.addEventListener('mouseup', saveSelection);
          editor.addEventListener('keyup', saveSelection);

          // íˆ´ë°” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì„ íƒ ì˜ì—­ ì €ì¥)
          const toolbarButtons = document.querySelectorAll('.toolbar button, .dropdown-toggle');
          toolbarButtons.forEach(button => {
              button.addEventListener('mousedown', saveSelection);
          });
      };

      function insertTOC() {
  const editor = document.getElementById("editor");
  const headings = editor.querySelectorAll("h1, h2");

  if (!headings.length) {
    showCustomMessage("ì œëª© ë˜ëŠ” ë¶€ì œëª©ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ê¸°ì¡´ ëª©ì°¨ ì œê±°
  const oldTOC = editor.querySelector(".auto-toc");
  if (oldTOC) oldTOC.remove();

  const tocWrapper = document.createElement("div");
  tocWrapper.className = "auto-toc";
  tocWrapper.contentEditable = "false";

  const tocTitle = `<strong class="toc-title">ğŸ“‘ ëª©ì°¨</strong>`;
  const tocList = document.createElement("ul");
  tocList.className = "toc-list";
  tocList.style.margin = "0";
  tocList.style.padding = "0";

  let h1Count = 0;
  let h2Count = 0;

  headings.forEach((el) => {
    const tag = el.tagName.toLowerCase();
    let number = "";

    if (tag === "h1") {
      h1Count++;
      h2Count = 0;
      number = `${h1Count}.`;
    } else if (tag === "h2") {
      h2Count++;
      number = `${h1Count}.${h2Count}`;
    }

    const id = `toc-${number.replace(/\./g, "-")}`;
    el.id = id;

    const li = document.createElement("li");
    li.className = `toc-item toc-${tag}`;
    li.style.margin = "0.2em 0";
    li.style.lineHeight = "1.2";
    if (tag === "h2") li.style.marginLeft = "1.2rem";

    const a = document.createElement("a");
    a.href = `#${id}`;
    a.textContent = `${number} ${el.textContent.trim()}`;
    a.onclick = function (e) {
      e.preventDefault();
      document.getElementById(id)?.scrollIntoView({ behavior: "smooth" });
    };
    a.style.color = "#0366d6";
    a.style.textDecoration = "none";

    li.appendChild(a);
    tocList.appendChild(li);
  });

  tocWrapper.innerHTML = tocTitle;
  tocWrapper.appendChild(tocList);

  // h1 ì•ì— ì œëŒ€ë¡œ ì‚½ì…
  const firstHeading = [...headings][0];
  editor.insertBefore(tocWrapper, firstHeading);
}

function switchToHtmlMode() {
  const editor = document.getElementById("editor");
  const htmlEditor = document.getElementById("htmlEditor");

  htmlEditor.value = editor.innerHTML.trim();
  editor.style.display = "none";
  htmlEditor.style.display = "block";
}

function switchToDesignMode() {
  const editor = document.getElementById("editor");
  const htmlEditor = document.getElementById("htmlEditor");

  editor.innerHTML = htmlEditor.value;
  htmlEditor.style.display = "none";
  editor.style.display = "block";
}

    </script>
      
      <%- include('partials/scripts') %>
    </body>
    </html>
