<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="/assets/css/editor.css" />
  <meta charset="UTF-8" />
  <title>BlindLove ì—ë””í„°</title>

  <% if (user) { %>
    <!-- âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¼ë©´ -->
    <meta name="author" content="<%= user.nickname %>">
  <% } %>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <% const isEdit = typeof post !== 'undefined'; %>
  <!-- âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ˆì‹œ (ì›í•˜ë©´ ìƒëµ ê°€ëŠ¥) -->
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

    <div class="editor-container">
        <div class="logo-wrap">
          <img src="assets/images/1.png" alt="BlindLove ë¡œê³ " />
        </div>
    
        <div class="title-wrap">
          <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="<%= post?.title || '' %>" />
        </div>
    
        <div class="toolbar">
          <div class="dropdown">
            <div class="dropdown-toggle" id="currentStyle" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" id="styleDropdown">
              <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
              <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
              <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
              <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
              <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
              <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
    
          <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
         
          <div class="color-tool" id="foreTool">
            <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-pencil-alt" id="foreIcon"></i>
            </button>
            <div class="color-palette" id="forePalette">
              <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
              <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
              <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
              <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
              <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
              <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" id="bgTool">
            <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-fill-drip" id="bgIcon"></i>
            </button>
            <div class="color-palette" id="bgPalette">
              <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
              <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
              <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
              <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
              <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
              <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
              </label>
            </div>
          </div>
    
          
          
    
          <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <div id="editor" contenteditable="true" class="editor" spellcheck="false">
          <%- post?.content || '<p><br></p>' %>
        </div>        
    
        <div class="category-box">
          <label>ì¹´í…Œê³ ë¦¬:</label>
          <div class="category-list" id="categoryList"></div>
          <button class="add-category-btn" onclick="addCategory()">â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="post-btn" onclick="postContent()">ğŸ“¬ í¬ìŠ¤íŒ…</button>
          <button class="save-btn" onclick="saveContent()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    
      <script>
        let categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°'];
        let selectedCategories = <%- JSON.stringify(post?.categories?.split(',') || ['ì¼ìƒ']) %>;

        
        let savedRange = null; // ì „ì—­ ë³€ìˆ˜ë¡œ savedRange ìœ ì§€
    
        function renderCategories() {
            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            categories.forEach((cat, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                if (selectedCategories.includes(cat)) item.classList.add('selected');
                item.innerText = cat;
                item.onclick = () => {
                    const i = selectedCategories.indexOf(cat);
                    if (i === -1) selectedCategories.push(cat);
                    else selectedCategories.splice(i, 1);
                    renderCategories();
                };
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerText = 'Ã—';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        categories.splice(index, 1);
                        selectedCategories = selectedCategories.filter(c => c !== cat);
                        renderCategories();
                    }
                };
                item.appendChild(removeBtn);
                list.appendChild(item);
            });
        }
    
        function addCategory() {
            const newCat = prompt("ì¶”ê°€í•  ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (newCat && !categories.includes(newCat)) {
                categories.push(newCat);
                selectedCategories.push(newCat);
                renderCategories();
            }
        }
    
        function postContent() {
  const title = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('editor').innerHTML.trim(); // ê³µë°± ì œê±°
  const categories = selectedCategories;

  if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  if (!content || content === '<div><br></div>' || content === '<p><br></p>') return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  if (!categories || categories.length === 0) return alert("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

  // âœ… ì„œë²„ë¡œ ì‹¤ì œ ì „ì†¡
  fetch('/savePost', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ title, content, categories })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        window.location.href = '/'; // ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰ì…˜
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨: " + data.error);
      }
    })
    .catch(err => {
      console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}
    
        // --- ìˆ˜ì •ëœ format í•¨ìˆ˜ ---
        // ëª¨ë“  execCommandëŠ” ê¸°ë³¸ì ìœ¼ë¡œ styleWithCSS=falseë¡œ ì‘ë™í•˜ë©°,
        // íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (<b>, <i>, <u> ë“±).
        function format(command, value = null) {
            document.execCommand("styleWithCSS", false, false); // í•­ìƒ CSS ì‚¬ìš© ì•ˆí•¨
            document.execCommand(command, false, value);
            // execCommand í›„ì—ëŠ” detectStyleì„ í˜¸ì¶œí•˜ì—¬ í˜„ì¬ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            setTimeout(detectStyle, 100);
        }
        // -------------------------
    
        // --- ìˆ˜ì •ëœ applyStyle í•¨ìˆ˜ ---
        // ì´ í•¨ìˆ˜ëŠ” ë¸”ë¡ ë ˆë²¨ ìš”ì†Œ (h1, p ë“±) ìƒì„±ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.
        // span/strong ê°™ì€ ì¸ë¼ì¸ ìš”ì†ŒëŠ” format í•¨ìˆ˜ë‚˜ setColor í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ í•©ë‹ˆë‹¤.
        function applyStyle(tag) {
      const blockTags = ['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'];
      const editor = document.getElementById("editor");
    
      // ì„ íƒ ì˜ì—­ ì €ì¥ í›„ ë³µì›
      restoreSelection();
      editor.focus();
    
      if (blockTags.includes(tag)) {
        document.execCommand("styleWithCSS", false, false);
        document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
    
        // ë‹¤ì‹œ ì„ íƒ ì˜ì—­ì„ ì €ì¥í•´ì„œ ì»¤ì„œ ì´ë™ ë°©ì§€
        saveSelection();
      } else {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) return;
    
        const range = sel.getRangeAt(0);
        const tempElement = document.createElement(tag);
        if (tag === 'span') tempElement.classList.add('label');
        if (tag === 'strong') tempElement.classList.add('label', 'label-bold');
    
        try {
          const contents = range.extractContents();
          tempElement.appendChild(contents);
          range.insertNode(tempElement);
    
          // ì„ íƒ ì˜ì—­ ë‹¤ì‹œ ì§€ì •
          sel.removeAllRanges();
          const newRange = document.createRange();
          newRange.selectNode(tempElement);
          sel.addRange(newRange);
    
          saveSelection();
        } catch (e) {
          console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
        }
      }
    
      setTimeout(detectStyle, 100);
    }
    
        // -------------------------
    
        function insertImage() {
            const url = prompt("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (url) format('insertImage', url);
        }
    
        function saveContent() {
            const content = document.getElementById('editor').innerHTML;
            alert("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
        }
    
        function toggleDropdown() {
            document.getElementById('styleDropdown').classList.toggle('show');
        }
    
        function updateCurrentStyle(tagName) {
            const labelMap = {
                h1: "ì œëª©",
                h2: "ë¶€ì œëª©",
                h3: "ë¨¸ë¦¬ë§ 1",
                h4: "ë¹¨ê°„ ë¨¸ë¦¬ë§",
                p: "ë³¸ë¬¸",
                small: "ì„¤ëª…",
                footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
                span: "ë ˆì´ë¸”",
                strong: "ì§„í•œ ë ˆì´ë¸”"
            };
            const label = labelMap[tagName.toLowerCase()] || tagName;
            document.getElementById("currentStyle").innerText = `${label} â–¼`;
        }
    
        function detectStyle() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      let node = sel.getRangeAt(0).startContainer;
    
      // í…ìŠ¤íŠ¸ ë…¸ë“œë©´ ë¶€ëª¨ë¡œ ì´ë™
      if (node.nodeType === 3) node = node.parentNode;
    
      // ê°€ì¥ ê°€ê¹Œìš´ ë¸”ë¡ ìš”ì†Œ íƒìƒ‰
      while (node && node !== document) {
        const tag = node.tagName?.toLowerCase();
        if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
          updateCurrentStyle(tag);
          return;
        }
        node = node.parentNode;
      }
    
      // ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ ë³¸ë¬¸
      updateCurrentStyle('p');
    }
    
    
    
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0).cloneRange(); // Range ê°ì²´ ë³µì‚¬ë³¸ ì €ì¥
            }
        }
    
        function restoreSelection() {
            const sel = window.getSelection();
            if (savedRange) {
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }
    
        // --- ìˆ˜ì •ëœ setColor í•¨ìˆ˜ ---
        // execCommand('foreColor')ì™€ 'hiliteColor'ëŠ” styleWithCSSë¥¼ ëª…ì‹œì ìœ¼ë¡œ trueë¡œ ì„¤ì •í•˜ì—¬
        // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ê³ , ì™„ë£Œ í›„ ë‹¤ì‹œ falseë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
        function setColor(command, color) {
      restoreSelection();
      const sel = window.getSelection();
      if (!sel.rangeCount || sel.isCollapsed) return;
    
      const range = sel.getRangeAt(0);
    
      // "ìƒ‰ ì—†ìŒ" ì²˜ë¦¬
      if (color === "__clear__") {
        // ì„ íƒ ì˜ì—­ ë‚´ spanì— ì ìš©ëœ ìŠ¤íƒ€ì¼ ì œê±°
        const contents = range.cloneContents();
        const spans = contents.querySelectorAll("span");
    
        spans.forEach(span => {
          if (command === 'foreColor') span.style.color = '';
          else if (command === 'hiliteColor') span.style.backgroundColor = '';
        });
    
        range.deleteContents();
        range.insertNode(contents);
        return;
      }
    
      // í…ìŠ¤íŠ¸ ì„ íƒ ë¶€ë¶„ì„ spanìœ¼ë¡œ ê°ì‹¸ê³  ìŠ¤íƒ€ì¼ ì ìš©
      const span = document.createElement("span");
      if (command === "foreColor") span.style.color = color;
      else if (command === "hiliteColor") span.style.backgroundColor = color;
    
      const contents = range.extractContents();
      span.appendChild(contents);
      range.insertNode(span);
    
      // ì„ íƒ ì˜ì—­ ë‹¤ì‹œ ì„¤ì • (ì»¤ì„œê°€ ë°–ìœ¼ë¡œ íŠ€ëŠ” ë¬¸ì œ ë°©ì§€)
      sel.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNode(span);
      sel.addRange(newRange);
    
      saveSelection();
      detectStyle();
    }
    
    
    
    function getCurrentBlockTag() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return null;
    
      let node = sel.getRangeAt(0).startContainer;
      while (node && node !== document) {
        if (node.nodeType === 1) {
          const tag = node.tagName.toLowerCase();
          if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
            return tag;
          }
        }
        node = node.parentNode;
      }
    
      return 'p';
    }
    
    
    
        // -------------------------
    
        window.onclick = function(e) {
            if (!e.target.matches('.dropdown-toggle')) {
                const dropdowns = document.getElementsByClassName('dropdown-menu');
                for (let d of dropdowns) d.classList.remove('show');
            }
        };
    
        window.onload = () => {
            renderCategories();
            // ì—ë””í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const editor = document.getElementById('editor');
            editor.addEventListener('keyup', detectStyle);
            editor.addEventListener('mouseup', detectStyle);
            editor.addEventListener('mouseup', saveSelection);
            editor.addEventListener('keyup', saveSelection);
    
            // íˆ´ë°” ë²„íŠ¼ë“¤ì— mousedown ì´ë²¤íŠ¸ ì¶”ê°€ (í´ë¦­ ì‹œ ì„ íƒ ì˜ì—­ ìœ ì‹¤ ë°©ì§€)
            const toolbarButtons = document.querySelectorAll('.toolbar button, .dropdown-toggle');
            toolbarButtons.forEach(button => {
                button.addEventListener('mousedown', saveSelection);
            });
        };
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const categorySelect = document.getElementById('post-category');
        const input = document.getElementById('new-category-input');
        const addBtn = document.getElementById('add-category-btn');
    
        // âœ… ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCategories() {
          const res = await fetch('/api/categories');
          const data = await res.json();
    
          // ê¸°ì¡´ ì˜µì…˜ ì œê±°
          categorySelect.innerHTML = '';
          document.querySelectorAll('.category-item').forEach(el => el.remove());
    
          data.forEach(category => {
            // <select>ì— ì¶”ê°€
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
    
            // ì‚­ì œ ë²„íŠ¼ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ë¡œë„ ì¶”ê°€
            const item = document.createElement('div');
            item.className = 'category-item';
            item.innerHTML = `
              <span>${category.name}</span>
              <button class="delete-category" data-id="${category.id}">ì‚­ì œ</button>
            `;
            categorySelect.parentElement.appendChild(item);
          });
    
          attachDeleteEvents();
        }
    
        // âœ… ì‚­ì œ ì´ë²¤íŠ¸ ì—°ê²°
        function attachDeleteEvents() {
          document.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              if (confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) {
                await fetch(`/api/categories/${id}`, {
                  method: 'DELETE'
                });
                loadCategories();
              }
            });
          });
        }
    
        // âœ… ì¹´í…Œê³ ë¦¬ ì¶”ê°€
        addBtn.addEventListener('click', async () => {
          const name = input.value.trim();
          if (!name) return alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    
          const res = await fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
          });
    
          const data = await res.json();
          if (data.success) {
            input.value = '';
            loadCategories();
          } else {
            alert('ì¶”ê°€ ì‹¤íŒ¨: ' + (data.error || 'ì¤‘ë³µëœ ì´ë¦„ì¼ ìˆ˜ ìˆì–´ìš”.'));
          }
        });
    
        // âœ… ì´ˆê¸° ë¡œë”©
        loadCategories();
      });
    </script>
    
    </body>
    </html>
    

    