<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BlindLove ì—ë””í„°</title>

  <% if (user) { %>
    <meta name="author" content="<%= user.nickname %>">
  <% } %>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/editor.css" />
  <%- include('partials/head') %>
</head>
<body>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined'; %>
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

  <div class="editor-container">
    <div class="logo-wrap">
      <img src="/assets/images/logo.png" alt="BlindLove ë¡œê³ " />
    </div>

    <div style="text-align: center; margin-top: 1rem;">
      <label for="langSelector">ğŸ—ºï¸ ì–¸ì–´ ì„ íƒ: </label>
      <select id="langSelector">
        <option value="ko">í•œêµ­ì–´</option>
        <option value="en">English</option>
        <option value="fr">FranÃ§ais</option>
        <option value="zh">ä¸­æ–‡</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
    </div>

    <%
      const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' }
      ];
      // `selectedCategories`ëŠ” ì´ì œ JavaScriptì—ì„œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
    %>

    <% langList.forEach(({ code, label }) => { %>
      <div class="lang-meta-block" data-lang="<%= code %>" style="<%= code === 'ko' ? '' : 'display:none;' %>">
        <div class="title-wrap">
          <input
            type="text"
            name="title_<%= code %>"
            placeholder="<%= label %> ì œëª©"
            value="<%= post?.[code]?.title || '' %>"
          />
        </div>

        <div class="toolbar">
          <div class="dropdown">
            <div class="dropdown-toggle" id="currentStyle_<%= code %>" onclick="toggleDropdown()">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" id="styleDropdown">
              <div class="h1" onclick="applyStyle('h1')">ì œëª©</div>
              <div class="h2" onclick="applyStyle('h2')">ë¶€ì œëª©</div>
              <div class="h3" onclick="applyStyle('h3')">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" onclick="applyStyle('h4')">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" onclick="applyStyle('p')">ë³¸ë¬¸</div>
              <div class="desc" onclick="applyStyle('small')">ì„¤ëª…</div>
              <div class="meta" onclick="applyStyle('footer')">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" onclick="applyStyle('span')">ë ˆì´ë¸”</div>
              <div class="label label-bold" onclick="applyStyle('strong')">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
          <button onclick="insertTOC()" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
          <button onclick="format('bold')" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button onclick="format('italic')" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button onclick="format('underline')" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button onclick="format('strikeThrough')" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button onclick="format('justifyLeft')" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button onclick="format('justifyCenter')" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button onclick="format('justifyRight')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button onclick="format('insertOrderedList')" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('insertUnorderedList')" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('outdent')" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button onclick="format('indent')" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button onclick="format('createLink')" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button onclick="format('unlink')" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
          
          <div class="color-tool" id="foreTool">
            <button id="foreColorBtn" data-tooltip="ê¸€ì ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-pencil-alt" id="foreIcon"></i>
            </button>
            <div class="color-palette" id="forePalette">
              <button style="background:black" onclick="setColor('foreColor', 'black')"></button>
              <button style="background:red" onclick="setColor('foreColor', 'red')"></button>
              <button style="background:orange" onclick="setColor('foreColor', 'orange')"></button>
              <button style="background:green" onclick="setColor('foreColor', 'green')"></button>
              <button style="background:blue" onclick="setColor('foreColor', 'blue')"></button>
              <button class="none-icon" onclick="setColor('foreColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('foreColor', this.value)" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" id="bgTool">
            <button id="bgColorBtn" data-tooltip="ë°°ê²½ ìƒ‰ìƒ" onmousedown="saveSelection()">
              <i class="fas fa-fill-drip" id="bgIcon"></i>
            </button>
            <div class="color-palette" id="bgPalette">
              <button style="background:yellow" onclick="setColor('hiliteColor', 'yellow')"></button>
              <button style="background:lightblue" onclick="setColor('hiliteColor', 'lightblue')"></button>
              <button style="background:lightgreen" onclick="setColor('hiliteColor', 'lightgreen')"></button>
              <button style="background:pink" onclick="setColor('hiliteColor', 'pink')"></button>
              <button style="background:#ccc" onclick="setColor('hiliteColor', '#ccc')"></button>
              <button class="none-icon" onclick="setColor('hiliteColor', '__clear__')" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" onchange="setColor('hiliteColor', this.value)" />
              </label>
            </div>
          </div>
          <!-- HTML ì‚½ì… ë²„íŠ¼ ì¶”ê°€ !-->
          <button onclick="openHtmlPopup()" data-tooltip="HTML ì‚½ì…"><i class="fas fa-code"></i></button> 
          <button onclick="insertImage()" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button onclick="format('removeFormat')" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <% if (user && Number(user.is_admin) === 1) { %>
        <div class="mode-toggle">
          <button onclick="switchToDesignMode('<%= code %>')">ë””ìì¸ ëª¨ë“œ</button>
          <button onclick="switchToHtmlMode('<%= code %>')">HTML ëª¨ë“œ</button>
        </div>
        <% } %>
        
        <div class="editor-area-wrapper">
          <div id="editor_<%= code %>"
               contenteditable="true"
               class="editor language-editor"
               spellcheck="false"
               data-lang-editor="<%= code %>"
               style="<%= code === 'ko' ? '' : 'display:none;' %>"
          >
            <%
              let initialContent = post?.[code]?.content || '<p><br></p>';
              const isWrapped = initialContent.startsWith('<div class="bl-content"');
              if (!isWrapped) {
                initialContent = `
                  <div class="bl-content" style="white-space:normal; line-height: 1.7;">
                    ${initialContent}
                  </div>
                `;
              }
            %>
            <%- initialContent %>
          </div>
          <textarea id="htmlEditor_<%= code %>" class="editor html-editor" style="display: none;"></textarea>
        </div>

        <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
          <input type="checkbox" id="isPrivateCheckbox_<%= code %>" name="is_private_<%= code %>" value="1" <%= post?.[code]?.is_private ? 'checked' : '' %> />
          ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
        </label>

        <% if (user && Number(user.is_admin) === 1) { %>
          <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
            <input type="checkbox" id="isPinnedCheckbox_<%= code %>" name="is_pinned_<%= code %>" value="1" <%= post?.[code]?.is_pinned ? 'checked' : '' %> />
            ìƒë‹¨ì— ê³ ì •í•˜ê¸° ğŸ“Œ
          </label>
        <% } %>

       
      </div>
    <% }) %> 

    <div class="category-box">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ:</label>
      <div class="category-list" id="categoryList"></div>
      <button onclick="addCategory()">â• ì¶”ê°€</button>
    </div>

    <button type="button" onclick="postContent()">ì €ì¥</button>

  </div> <%-- end of editor-container --%>
  
  <%
    // `categoryList` ìƒìˆ˜ëŠ” ì´ì œ JavaScriptì—ì„œ ì´ˆê¸°í™”ë˜ë¯€ë¡œ í•„ìš” ì—†ì–´ì¡ŒìŠµë‹ˆë‹¤.
    const postUrl = (isEdit && post) ? `/edit/${post.id}` : '/savePost';
    const redirectUrl = (isEdit && post) ? `/post/${post.id}` : '/';
  %>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script>
    // âœ… selectedCategories ì´ˆê¸°í™” ë°©ì‹ ë³€ê²½
    // ğŸš¨ğŸš¨ğŸš¨ ì´ ë¶€ë¶„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
    let selectedCategories = []; // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¹ˆ ë°°ì—´ ì„ ì–¸
    <% if (post && post.categories) { %>
      // post.categoriesê°€ ìˆì„ ê²½ìš°ì—ë§Œ JSON.stringifyë¥¼ ì‚¬ìš©í•˜ì—¬ í• ë‹¹
      selectedCategories = <%- JSON.stringify(post.categories.split(',')) %>;
    <% } %>

    let categories = [];
    let savedRange = null;

    // í˜„ì¬ í™œì„±í™”ëœ ì—ë””í„° ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€
    let currentActiveEditor = null;
    let currentActiveHtmlEditor = null; // HTML ëª¨ë“œ textareaë„ ì¶”ì 

    const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' }
    ];
    
    // ğŸš¨ğŸš¨ğŸš¨ ì´ ë¶€ë¶„ë„ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”. (ì´ì „ app.js ìˆ˜ì • ì œì•ˆê³¼ ë™ì¼) ğŸš¨ğŸš¨ğŸš¨
    const IS_EDIT_PAGE = <%- isEdit ? 'true' : 'false' %>; 
    const POST_ID = <%- post && post.id ? JSON.stringify(post.id) : 'null' %>;

    function renderCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';
        categories.forEach((cat, index) => {
          const item = document.createElement('div');
          item.className = 'category-item';
          if (selectedCategories.includes(cat)) item.classList.add('selected');
          item.innerText = cat;
    
          item.onclick = () => {
            const i = selectedCategories.indexOf(cat);
            if (i === -1) selectedCategories.push(cat);
            else selectedCategories.splice(i, 1);
            renderCategories();
            // âœ… updateTranslationFields() í˜¸ì¶œ ì œê±°ë¨
          };
    
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.innerText = 'Ã—';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            showCustomMessage(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true, () => {
              fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                method: 'DELETE'
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  categories.splice(index, 1);
                  selectedCategories = selectedCategories.filter(c => c !== cat);
                  renderCategories();
                  // âœ… updateTranslationFields() í˜¸ì¶œ ì œê±°ë¨
                  showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                  showCustomMessage("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                }
              })
              .catch(err => {
                console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                showCustomMessage("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
            });
          };
    
          item.appendChild(removeBtn);
          list.appendChild(item);
        });
      }
    
      function addCategory() {
        showCustomInput("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", (newCat) => {
          newCat = newCat?.trim();
          if (!newCat || categories.includes(newCat)) return;
      
          fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newCat })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              categories.push(newCat);
              renderCategories();
              // âœ… updateTranslationFields() í˜¸ì¶œ ì œê±°ë¨
              showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              showCustomMessage("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
            showCustomMessage("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        });
      }
    
      function postContent() {
          const postData = {
              categories: selectedCategories,
              // is_privateì™€ is_pinnedëŠ” ê° ì–¸ì–´ë³„ë¡œ ì €ì¥í•˜ì§€ ì•Šê³  ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•œë‹¤ê³  ê°€ì •
              is_private: document.getElementById('isPrivateCheckbox_ko')?.checked ? 1 : 0, // í•œêµ­ì–´ ì²´í¬ë°•ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ëŒ€í‘œê°’ ê°€ì ¸ì˜´
              is_pinned: document.getElementById('isPinnedCheckbox_ko')?.checked ? 1 : 0, // í•œêµ­ì–´ ì²´í¬ë°•ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ëŒ€í‘œê°’ ê°€ì ¸ì˜´
              lang_content: {}
          };

          let hasContentForDefaultLang = false;

          langList.forEach(({ code }) => {
              const titleInput = document.querySelector(`input[name="title_${code}"]`);
              const editorDiv = document.getElementById(`editor_${code}`);
              const htmlEditorDiv = document.getElementById(`htmlEditor_${code}`); // HTML ì—ë””í„° ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
              // âœ… categoryTranslateBlock ê´€ë ¨ ë³€ìˆ˜ ì„ ì–¸ ë° ì‚¬ìš© ì œê±°ë¨
              // const categoryTranslateBlock = document.querySelector(`.category-translate-block[data-lang="${code}"]`);

              if (!titleInput || !editorDiv || !htmlEditorDiv) {
                  console.warn(`ì–¸ì–´ ì½”ë“œ ${code} ì— ëŒ€í•œ ì…ë ¥ í•„ë“œ ë˜ëŠ” ì—ë””í„° DIVë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                  return;
              }

              let contentToSave = '';
              // HTML ëª¨ë“œì¼ ê²½ìš° textareaì˜ ê°’, ë””ìì¸ ëª¨ë“œì¼ ê²½ìš° contenteditable divì˜ ê°’
              if (htmlEditorDiv.style.display === 'block') {
                  contentToSave = htmlEditorDiv.value.trim();
              } else {
                  contentToSave = editorDiv.innerHTML.trim();
              }

              // ë¹ˆ ë‚´ìš©ì„ <p><br></p>ë¡œ í‘œì¤€í™” (bl-content ë˜í¼ëŠ” ì„œë²„ì—ì„œ ë‹¤ì‹œ ì²˜ë¦¬ë  ìˆ˜ ìˆë„ë¡)
              if (!contentToSave || contentToSave === '<div><br></div>' || contentToSave === '<p><br></p>') {
                  contentToSave = '<p><br></p>';
              }

              // âœ… translatedCategories ê´€ë ¨ ë¡œì§ ë° í•„ë“œ ì œê±°ë¨
              // const translatedCategories = {};
              // if (categoryTranslateBlock) {
              //     categoryTranslateBlock.querySelectorAll('.translated-category input').forEach(input => {
              //         const catName = input.name.split('[')[2].replace(']', '');
              //         translatedCategories[catName] = input.value.trim();
              //     });
              // }

              postData.lang_content[code] = {
                  title: titleInput.value.trim(),
                  content: contentToSave
                  // âœ… translated_categories í•„ë“œ ì œê±°ë¨
                  // translated_categories: translatedCategories
              };

              if (code === 'ko' && (postData.lang_content[code].title || postData.lang_content[code].content !== '<p><br></p>')) {
                  hasContentForDefaultLang = true;
              }
          });

          if (!postData.categories || postData.categories.length === 0) {
              return showCustomMessage("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }

          if (!hasContentForDefaultLang) {
            return showCustomMessage("í•œêµ­ì–´ ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
      
          fetch("<%= postUrl %>", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showCustomMessage("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", false, () => {
                // ì´ ë‘ ì¤„ì€ EJS í…œí”Œë¦¿ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ìˆ˜ì •ëœ ë¶€ë¶„ì…ë‹ˆë‹¤.
                // ğŸš¨ğŸš¨ğŸš¨ ì´ ë¶€ë¶„ë„ í™•ì¸í•˜ì„¸ìš”.
                <script>
  const isEditPage = <%= isEdit ? 'true' : 'false' %>;
  const postId = <%= (post && post.id) ? JSON.stringify(post.id) : 'null' %>;
</script>
                if (isEditPage && postId) {
                  window.location.href = "/post/" + postId;
                } else {
                  window.location.href = "/";
                }
              });
            } else {
              showCustomMessage("ì €ì¥ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
            showCustomMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
      function format(command, value = null) {
          if (!currentActiveEditor) return;
          currentActiveEditor.focus();
          document.execCommand("styleWithCSS", false, false);
          document.execCommand(command, false, value);
          setTimeout(detectStyle, 100);
      }

      function applyStyle(tag) {
        if (!currentActiveEditor) return;
        const blockTags = ['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'];

        restoreSelection();
        currentActiveEditor.focus();

        if (blockTags.includes(tag)) {
          document.execCommand("styleWithCSS", false, false);
          document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
          saveSelection();
        } else {
          const sel = window.getSelection();
          if (!sel.rangeCount || sel.isCollapsed) return;
          if (!currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return; // í˜„ì¬ ì—ë””í„° ë²”ìœ„ í™•ì¸

          const range = sel.getRangeAt(0);
          const tempElement = document.createElement(tag);
          if (tag === 'span') tempElement.classList.add('label');
          if (tag === 'strong') tempElement.classList.add('label', 'label-bold');

          try {
            const contents = range.extractContents();
            tempElement.appendChild(contents);
            range.insertNode(tempElement);

            sel.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNode(tempElement);
            sel.addRange(newRange);

            saveSelection();
          } catch (e) {
            console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
          }
        }
        setTimeout(detectStyle, 100);
      }

      function insertImage() {
          showCustomInput("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:", (url) => {
            if (url) format('insertImage', url);
          });
      }

      function saveContent() {
          showCustomMessage("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
      }

      function toggleDropdown() {
          // í˜„ì¬ í™œì„± ì—ë””í„°ì˜ ë“œë¡­ë‹¤ìš´ì„ í† ê¸€
          const styleDropdown = currentActiveEditor.closest('.lang-meta-block').querySelector('#styleDropdown');
          if (styleDropdown) {
              styleDropdown.classList.toggle('show');
          }
      }

      function updateCurrentStyle(tagName) {
          const labelMap = {
              h1: "ì œëª©",
              h2: "ë¶€ì œëª©",
              h3: "ë¨¸ë¦¬ë§ 1",
              h4: "ë¹¨ê°„ ë¨¸ë¦¬ë§",
              p: "ë³¸ë¬¸",
              small: "ì„¤ëª…",
              footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
              span: "ë ˆì´ë¸”",
              strong: "ì§„í•œ ë ˆì´ë¸”"
          };
          const label = labelMap[tagName.toLowerCase()] || tagName;
          // í˜„ì¬ í™œì„± ì—ë””í„°ì˜ ìŠ¤íƒ€ì¼ í† ê¸€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          const currentStyleToggle = currentActiveEditor.closest('.lang-meta-block').querySelector('.dropdown-toggle');
          if (currentStyleToggle) {
              currentStyleToggle.innerText = `${label} â–¼`;
          }
      }

      function detectStyle() {
        if (!currentActiveEditor) return;
        const sel = window.getSelection();
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
            updateCurrentStyle('p'); // ì„ íƒ ì˜ì—­ì´ ì—ë””í„° ë°–ì— ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            return;
        }
        let node = sel.getRangeAt(0).startContainer;

        if (node.nodeType === 3) node = node.parentNode;

        while (node && node !== currentActiveEditor) {
          const tag = node.tagName?.toLowerCase();
          if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
            updateCurrentStyle(tag);
            return;
          }
          node = node.parentNode;
        }
        updateCurrentStyle('p');
      }

      function saveSelection() {
          const sel = window.getSelection();
          if (sel.rangeCount > 0 && currentActiveEditor && currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
              savedRange = sel.getRangeAt(0).cloneRange();
          } else {
              savedRange = null;
          }
      }

      function restoreSelection() {
          const sel = window.getSelection();
          if (savedRange && currentActiveEditor) {
              sel.removeAllRanges();
              sel.addRange(savedRange);
          }
      }

      function setColor(command, color) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

        const range = sel.getRangeAt(0);

        if (color === "__clear__") {
          const contents = range.cloneContents();
          const spans = contents.querySelectorAll("span");

          spans.forEach(span => {
            if (command === 'foreColor') span.style.color = '';
            else if (command === 'hiliteColor') span.style.backgroundColor = '';
          });

          range.deleteContents();
          range.insertNode(contents);
          return;
        }

        const span = document.createElement("span");
        if (command === "foreColor") span.style.color = color;
        else if (command === "hiliteColor") span.style.backgroundColor = color;

        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);

        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNode(span);
        sel.addRange(newRange);

        saveSelection();
        detectStyle();
      }

      function getCurrentBlockTag() {
        if (!currentActiveEditor) return 'p';
        const sel = window.getSelection();
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return 'p';

        let node = sel.getRangeAt(0).startContainer;
        while (node && node !== currentActiveEditor) {
          if (node.nodeType === 1) {
            const tag = node.tagName.toLowerCase();
            if (['h1', 'h2', 'h3', 'h4', 'p', 'small', 'footer'].includes(tag)) {
              return tag;
            }
          }
          node = node.parentNode;
        }
        return 'p';
      }

      // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ë° ì…ë ¥ ë°•ìŠ¤ êµ¬í˜„ (alert, prompt ëŒ€ì²´)
      function createMessageBox(message, isConfirm = false, onConfirm = null) {
          let modal = document.getElementById('customMessageModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customMessageModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p>
                  ${isConfirm ? `
                      <button id="confirmBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                      <button id="cancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
                  ` : `
                      <button id="okBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  `}
              </div>
          `;
          modal.style.display = 'flex';

          if (isConfirm) {
              document.getElementById('confirmBtn').onclick = () => {
                  modal.style.display = 'none';
                  if (onConfirm) onConfirm();
              };
              document.getElementById('cancelBtn').onclick = () => {
                  modal.style.display = 'none';
              };
          } else {
              document.getElementById('okBtn').onclick = () => {
                  modal.style.display = 'none';
                  if (onConfirm) onConfirm();
              };
          }
      }

      function showCustomMessage(message, isConfirm = false, onConfirm = null) {
          createMessageBox(message, isConfirm, onConfirm);
      }

      function showCustomInput(message, onInput) {
          let modal = document.getElementById('customInputModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customInputModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p>
                  <input type="text" id="customInput" style="width: calc(100% - 20px); padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;" />
                  <button id="inputOkBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  <button id="inputCancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
              </div>
          `;
          modal.style.display = 'flex';

          document.getElementById('inputOkBtn').onclick = () => {
              const inputValue = document.getElementById('customInput').value;
              modal.style.display = 'none';
              if (onInput) onInput(inputValue);
          };
          document.getElementById('inputCancelBtn').onclick = () => {
              const inputValue = document.getElementById('customInput').value;
              modal.style.display = 'none';
              if (onInput) onInput(null);
          };
          document.getElementById('customInput').focus();
      }

      window.onclick = function(e) {
          // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ê°€ ì—´ë ¤ìˆì„ ë•Œ, ë“œë¡­ë‹¤ìš´ í† ê¸€ì´ë‚˜ ë©”ë‰´ ë°–ì„ í´ë¦­í•˜ë©´ ë‹«ê¸°
          if (!e.target.matches('.dropdown-toggle')) {
              const dropdowns = document.getElementsByClassName('dropdown-menu');
              for (let d of dropdowns) {
                  if (d.classList.contains('show')) {
                      d.classList.remove('show');
                  }
              }
          }
      };

      window.onload = () => {
          // ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
          // âœ… fetch('/api/categories')ë¥¼ fetch('/api/categories?lang=ko')ë¡œ ë³€ê²½
          fetch('/api/categories?lang=ko')
            .then(res => res.json())
            .then(data => {
              categories = data.categories || [];
              renderCategories();
              // âœ… updateTranslationFields() í˜¸ì¶œ ì œê±°ë¨
            })
            .catch(err => {
              console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
              categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°']; // ëŒ€ì²´ ì¹´í…Œê³ ë¦¬
              renderCategories();
              // âœ… updateTranslationFields() í˜¸ì¶œ ì œê±°ë¨
            });

          // ëª¨ë“  ì–¸ì–´ ì—ë””í„°ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const languageEditors = document.querySelectorAll('.language-editor');
          languageEditors.forEach(editor => {
              editor.addEventListener('keyup', detectStyle);
              editor.addEventListener('mouseup', detectStyle);
              editor.addEventListener('mouseup', saveSelection);
              editor.addEventListener('keyup', saveSelection);
              // ì—ë””í„°ê°€ í¬ì»¤ìŠ¤ë¥¼ ì–»ì„ ë•Œ currentActiveEditor ì—…ë°ì´íŠ¸
              editor.addEventListener('focus', () => {
                  currentActiveEditor = editor;
                  currentActiveHtmlEditor = document.getElementById(`htmlEditor_${editor.dataset.langEditor}`);
                  // HTML ëª¨ë“œì—ì„œ ë””ìì¸ ëª¨ë“œë¡œ ì „í™˜ë  ë•Œ í˜„ì¬ ì—ë””í„° ë‚´ìš© ë™ê¸°í™”
                  if (currentActiveHtmlEditor && currentActiveHtmlEditor.style.display !== 'none') {
                      currentActiveEditor.innerHTML = currentActiveHtmlEditor.value;
                      currentActiveHtmlEditor.style.display = 'none';
                      currentActiveEditor.style.display = 'block';
                  }
                  detectStyle(); // í¬ì»¤ìŠ¤ ì‹œ ìŠ¤íƒ€ì¼ ê°ì§€
              });
          });

          // íˆ´ë°” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì„ íƒ ì˜ì—­ ì €ì¥)
          const toolbarButtons = document.querySelectorAll('.toolbar button, .dropdown-toggle');
          toolbarButtons.forEach(button => {
              button.addEventListener('mousedown', saveSelection);
          });

          // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì–¸ì–´ (í•œêµ­ì–´) ì—ë””í„°ë¥¼ í™œì„±í™”
          currentActiveEditor = document.getElementById('editor_ko');
          currentActiveHtmlEditor = document.getElementById('htmlEditor_ko');
          
          if (!currentActiveEditor) { // 'ko' ì—ë””í„°ê°€ ì—†ëŠ” ê²½ìš° ì²« ë²ˆì§¸ ì—ë””í„°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
              currentActiveEditor = document.querySelector('.language-editor');
              currentActiveHtmlEditor = document.getElementById(`htmlEditor_${currentActiveEditor.dataset.langEditor}`);
          }
          if (currentActiveEditor) {
              currentActiveEditor.style.display = 'block'; // ê¸°ë³¸ ì—ë””í„°ë§Œ ë³´ì´ê²Œ
              currentActiveEditor.focus();
              detectStyle(); // ì´ˆê¸° ìŠ¤íƒ€ì¼ ê°ì§€
          }
      };

      // âœ… updateTranslationFields() í•¨ìˆ˜ ì „ì²´ ì‚­ì œë¨
      // function updateTranslationFields() { /* ... */ }

      function insertTOC() {
        if (!currentActiveEditor) return showCustomMessage("ì—ë””í„°ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        const blContentDiv = currentActiveEditor.querySelector('.bl-content'); 

        if (!blContentDiv) {
          showCustomMessage("ì—ë””í„° ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì— ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }

        const headings = blContentDiv.querySelectorAll("h1, h2");

        if (!headings.length) {
          showCustomMessage("ì œëª© ë˜ëŠ” ë¶€ì œëª©ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const oldTOC = blContentDiv.querySelector(".auto-toc");
        if (oldTOC) oldTOC.remove();

        const tocWrapper = document.createElement("div");
        tocWrapper.className = "auto-toc";
        tocWrapper.contentEditable = "false";

        const tocTitle = `<strong class="toc-title">ğŸ“‘ ëª©ì°¨</strong>`;
        const tocList = document.createElement("ul");
        tocList.className = "toc-list";
        tocList.style.margin = "0";
        tocList.style.padding = "0";

        let h1Count = 0;
        let h2Count = 0;

        headings.forEach((el) => {
          const tag = el.tagName.toLowerCase();
          let number = "";

          if (tag === "h1") {
            h1Count++;
            h2Count = 0; // H1ì´ ë‚˜ì˜¤ë©´ H2 ì¹´ìš´íŠ¸ ë¦¬ì…‹
            number = `${h1Count}.`;
          } else if (tag === "h2") {
            h2Count++;
            number = `${h1Count}.${h2Count}.`;
          }

          const listItem = document.createElement("li");
          listItem.innerHTML = `<a href="#${el.id || el.innerText.replace(/\s+/g, '-')}" style="text-decoration:none; color:inherit;">${number} ${el.innerText}</a>`;
          tocList.appendChild(listItem);

          if (!el.id) {
            el.id = el.innerText.replace(/\s+/g, '-') + '-' + Math.random().toString(36).substring(2, 8); // ê³ ìœ  ID ë¶€ì—¬
          }
        });

        tocWrapper.innerHTML = tocTitle;
        tocWrapper.appendChild(tocList);

        // ì²« ë²ˆì§¸ h1 ë˜ëŠ” h2 ìš”ì†Œ ë°”ë¡œ ì•ì— ëª©ì°¨ ì‚½ì…
        if (headings.length > 0) {
            headings[0].parentNode.insertBefore(tocWrapper, headings[0]);
        } else {
            // ì œëª©ì´ ì—†ì„ ê²½ìš° bl-contentì˜ ë§¨ ìœ„ì— ì¶”ê°€
            blContentDiv.prepend(tocWrapper);
        }
      }

      function switchToHtmlMode(code) {
          const editorDiv = document.getElementById(`editor_${code}`);
          const htmlEditor = document.getElementById(`htmlEditor_${code}`);
          if (editorDiv && htmlEditor) {
              editorDiv.style.display = 'none';
              htmlEditor.style.display = 'block';
              htmlEditor.value = js_beautify.html_beautify(editorDiv.innerHTML, { indent_size: 2 });
          }
      }

      function switchToDesignMode(code) {
          const editorDiv = document.getElementById(`editor_${code}`);
          const htmlEditor = document.getElementById(`htmlEditor_${code}`);
          if (editorDiv && htmlEditor) {
              editorDiv.style.display = 'block';
              htmlEditor.style.display = 'none';
              editorDiv.innerHTML = htmlEditor.value;
          }
      }

      // ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
      document.getElementById('langSelector').addEventListener('change', function() {
          const selectedLang = this.value;
          document.querySelectorAll('.lang-meta-block').forEach(block => {
              if (block.dataset.lang === selectedLang) {
                  block.style.display = ''; // ì„ íƒëœ ì–¸ì–´ ë¸”ë¡ í‘œì‹œ
                  // ì—ë””í„°ë„ í™œì„±í™”
                  const editorDiv = document.getElementById(`editor_${selectedLang}`);
                  const htmlEditorDiv = document.getElementById(`htmlEditor_${selectedLang}`);
                  if (editorDiv) {
                      editorDiv.style.display = 'block';
                      currentActiveEditor = editorDiv; // í˜„ì¬ í™œì„± ì—ë””í„° ì—…ë°ì´íŠ¸
                      currentActiveHtmlEditor = htmlEditorDiv;
                      editorDiv.focus();
                      detectStyle();
                  }
              } else {
                  block.style.display = 'none'; // ë‹¤ë¥¸ ì–¸ì–´ ë¸”ë¡ ìˆ¨ê¹€
                  // ìˆ¨ê²¨ì§€ëŠ” ì—ë””í„°ë„ í•¨ê»˜ ìˆ¨ê¹€
                  const editorDiv = document.getElementById(`editor_${block.dataset.lang}`);
                  const htmlEditorDiv = document.getElementById(`htmlEditor_${block.dataset.lang}`);
                  if (editorDiv) editorDiv.style.display = 'none';
                  if (htmlEditorDiv) htmlEditorDiv.style.display = 'none';
              }
          });
      });
  </script>
</body>
</html>