<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <title><%= post.title %> | Bug Loop</title>
  <link rel="stylesheet" href="/assets/css/post-view.css" />
  
  <%- include('partials/head') %>

  <% if (canonicalUrl) { %>
    <link rel="canonical" href="<%= canonicalUrl %>">
  <% } %>

  <% if (alternateLinks && alternateLinks.length > 0) { %>
    <% alternateLinks.forEach(link => { %>
      <link rel="alternate" hreflang="<%= link.lang %>" href="<%= link.href %>">
    <% }); %>
    <link rel="alternate" hreflang="x-default" href="https://bugloop.dev/<%= lang %>/post/<%= post.id %>">
  <% } %>

  <% const testKeywords = ['í…ŒìŠ¤íŠ¸', 'test', 'ãƒ†ã‚¹ãƒˆ', 'æµ‹è¯•']; %>
<% if (post.categories.some(cat => testKeywords.includes(cat))) { %>
  <meta name="robots" content="noindex">
<% } %>

  <meta name="description" content="<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,150) %>">

  <meta property="og:title" content="<%= post.title %> | Bug Loop">
  <meta property="og:description" content="<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,150) %>">
  <meta property="og:type" content="article">
  <meta property="og:url" content="<%= canonicalUrl %>">
  <meta property="og:image" content="https://bugloop.dev/assets/images/BugLoop.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= post.title %> | Bug Loop">
  <meta name="twitter:description" content="<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,150) %>">
  <meta name="twitter:image" content="https://bugloop.dev/assets/images/BugLoop.png">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "<%= post.title %>",
    "author": {
      "@type": "Person",
      "name": "<%= post.author %>"
    },
    "datePublished": "<%= new Date(post.created_at).toISOString() %>",
    "mainEntityOfPage": "<%= canonicalUrl %>",
    "image": "https://bugloop.dev/assets/images/BugLoop.png",
    "articleBody": "<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,600) %>"
  }
  </script>
  
  <style>
    /* 1. í˜ì´ì§€ í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ (ë°”ë‹¥ì— ë¶™ëŠ” ë¬¸ì œ í•´ê²°) */
    body {
      padding-bottom: 50px; /* ì ë‹¹í•œ ì—¬ë°± ìœ ì§€ */
    }

    /* 2. í•˜ë‹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .back-home-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%; /* ë„ˆë¹„ë¥¼ ê½‰ ì±„ìš°ë„ë¡ ì„¤ì • */
      max-width: 400px; /* ë²„íŠ¼ì˜ ìµœëŒ€ ë„ˆë¹„ ì œí•œ (ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ” ê²ƒì„ ë°©ì§€) */
      padding: 12px 20px;
      margin-top: 10px;
      border-radius: 6px; /* ëª¨ì„œë¦¬ë¥¼ ì•½ê°„ë§Œ ë‘¥ê¸€ê²Œ */
      font-weight: 600; /* ì¡°ê¸ˆ êµµì€ ê¸€ì”¨ */
      text-decoration: none;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      border: 1px solid; /* ì–‡ì€ í…Œë‘ë¦¬ */
      font-size: 1rem;
      letter-spacing: 0.5px;
    }

    /* â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ ìŠ¤íƒ€ì¼ (ê¸°ë³¸) */
    .back-home-btn {
      color: #333333;
      background-color: #f7f7f7;
      border-color: #e0e0e0;
    }

    .back-home-btn:hover {
      background-color: #e0e0e0;
      color: #000000;
      border-color: #cccccc;
    }

    /* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ (html.dark) */
    html.dark .back-home-btn {
      color: #e0e0e0;
      background-color: #2c2c2c;
      border-color: #444444;
    }

    html.dark .back-home-btn:hover {
      background-color: #3a3a3a;
      color: #ffffff;
      border-color: #666666;
    }

    /* ë²„íŠ¼ ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
    .back-home-btn span {
        margin-left: 8px;
    }
  </style>
  
</head>

<body class="no-fixed-footer">
  <amp-auto-ads type="adsense"
        data-ad-client="ca-pub-2585969189290118">
</amp-auto-ads>
  <%- include('partials/header') %>

  <div class="postview-container">

    <h1 class="post-title"><%= post.title %></h1>

    <div class="post-meta">
      <span>ì¹´í…Œê³ ë¦¬: <%= post.categories.join(', ') %></span><br>
      <span>ì‘ì„±ì: <%= post.author %></span><br>
      <span>ì‘ì„±ì¼: <%= new Date(post.created_at).toLocaleString() %></span>
    </div>

    <div class="post-content">
      <%- post.content %>
    </div>

    <% if (user && post.user_id == user.id) { %>
      <div class="post-actions" style="text-align: center; margin-top: 1.5rem;">
        <a href="/<%= lang %>/edit/<%= post.id %>" class="edit-btn">âœï¸ ìˆ˜ì •í•˜ê¸°</a>
        <form action="/<%= lang %>/delete/<%= post.id %>" method="POST" style="display: inline;">
          <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?');">ğŸ—‘ ì‚­ì œí•˜ê¸°</button>
        </form>
      </div>
    <% } %>

    <div class="extra" style="margin-top: 3rem; text-align: center;">
      <a href="/<%= lang %>/" class="back-home-btn">
        â†<span>í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
      </a>
    </div>
  </div>

  <div class="floating-toc" id="floatingToc"></div>
<div class="mobile-toc-button" id="mobileTocBtn"><%= locale.ui.tocButton %></div>
<div class="mobile-toc-modal" id="mobileTocModal">
  <div class="mobile-toc-content" id="mobileTocContent"></div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const postContent = document.querySelector('.post-content');
    const floatingToc = document.getElementById('floatingToc');
    const mobileTocBtn = document.getElementById('mobileTocBtn');
    const mobileTocModal = document.getElementById('mobileTocModal');
    const mobileTocContent = document.getElementById('mobileTocContent');
    const mobileTocCloseBtn = document.getElementById('mobileTocCloseBtn');

    if (!postContent) return;

    // 1. ëª©ì°¨ ìƒì„± ë° ID ë¶€ì—¬
    function generateToc() {
      const headings = postContent.querySelectorAll('h1, h2');
      if (headings.length === 0) {
        // ëª©ì°¨ê°€ ì—†ìœ¼ë©´ ëª©ì°¨ ê´€ë ¨ ìš”ì†Œ ìˆ¨ê¸°ê¸°
        if (floatingToc) floatingToc.style.display = 'none';
        if (mobileTocBtn) mobileTocBtn.style.display = 'none';
        return;
      }

      // ğŸ“Œ ë³€ê²½ ì‚¬í•­: localeì—ì„œ ëª©ì°¨ ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜´ (ì´ì „ì—ëŠ” í•˜ë“œì½”ë”©ëœ 'ëª©ì°¨')
      let tocHtml = '<strong><%= locale.ui.tocButton %></strong><ul style="padding-left: 1.2em;">';
      let h1Count = 0;
      let h2Count = 0;

      headings.forEach((heading, index) => {
        const tag = heading.tagName.toLowerCase();
        let sectionNumber = '';
        
        // ê¸°ì¡´ IDê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        if (!heading.id || !heading.id.startsWith('toc-')) {
            heading.id = `toc-${tag}-${index}`;
        }

        if (tag === 'h1') {
          h1Count++;
          h2Count = 0; // Reset h2 count for new h1
          sectionNumber = `${h1Count}.`;
          tocHtml += `<li class="toc-${tag}"><a href="#${heading.id}">${sectionNumber} ${heading.textContent}</a></li>`;
        } else if (tag === 'h2') {
          h2Count++;
          // H1ì´ ì—†ì´ H2ê°€ ë¨¼ì € ë‚˜ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„ (ì„ íƒ ì‚¬í•­)
          if (h1Count === 0) h1Count = 1; 
          sectionNumber = `${h1Count}.${h2Count}`;
          tocHtml += `<li class="toc-${tag}"><a href="#${heading.id}">${sectionNumber} ${heading.textContent}</a></li>`;
        }
      });
      tocHtml += '</ul>';

      if (floatingToc) {
        floatingToc.innerHTML = tocHtml;
        floatingToc.style.display = 'block'; // ëª©ì°¨ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë³´ì´ê²Œ
      }
      if (mobileTocContent) {
        mobileTocContent.innerHTML = tocHtml;
        mobileTocBtn.style.display = 'block'; // ëª¨ë°”ì¼ ë²„íŠ¼ ë³´ì´ê²Œ
      }
    }

    // 2. ìŠ¤í¬ë¡¤ ê°ì§€ ë° í”Œë¡œíŒ… ëª©ì°¨ í‘œì‹œ/ìˆ¨ê¹€ (ë°ìŠ¤í¬í†±ìš©)
    function handleScroll() {
      const scrollThreshold = 300; // ìŠ¤í¬ë¡¤ì´ ì´ ê°’(px) ì´ìƒ ë‚´ë ¤ê°€ë©´ ëª©ì°¨ í‘œì‹œ
      if (window.innerWidth > 768) { // ë°ìŠ¤í¬í†±ì—ì„œë§Œ ì‘ë™í•˜ë„ë¡ (ëª¨ë°”ì¼ì—ì„œëŠ” ë²„íŠ¼ì´ ë”°ë¡œ ìˆìœ¼ë¯€ë¡œ)
        if (window.scrollY > scrollThreshold) {
          if (floatingToc) floatingToc.classList.add('show');
        } else {
          if (floatingToc) floatingToc.classList.remove('show');
        }
      }
    }

    // 3. ëª¨ë°”ì¼ ëª©ì°¨ ëª¨ë‹¬ í† ê¸€
    if (mobileTocBtn) {
      mobileTocBtn.addEventListener('click', function() {
        if (mobileTocModal) mobileTocModal.classList.add('show');
      });
    }

    if (mobileTocCloseBtn) {
      mobileTocCloseBtn.addEventListener('click', function() {
        if (mobileTocModal) mobileTocModal.classList.remove('show');
      });
    }

    // ëª¨ë°”ì¼ ëª©ì°¨ ë§í¬ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
    if (mobileTocContent) {
      mobileTocContent.addEventListener('click', function(event) {
        if (event.target.tagName === 'A' && mobileTocModal) {
          mobileTocModal.classList.remove('show');
        }
      });
    }

    // ì´ˆê¸° ëª©ì°¨ ìƒì„±
    generateToc();
    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    window.addEventListener('scroll', handleScroll);
    // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ë„ ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬ ì¬ì‹¤í–‰ (ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼ ì „í™˜ ëŒ€ì‘)
    window.addEventListener('resize', handleScroll);
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const toc = document.querySelector(".auto-toc");
  const floatingToc = document.getElementById("floatingToc");
  const mobileBtn = document.getElementById("mobileTocBtn");
  const mobileModal = document.getElementById("mobileTocModal");
  const mobileContent = document.getElementById("mobileTocContent");

  if (!toc) return;

  // ğŸ“Œ ë‚´ìš© ë³µì‚¬ (floating & ëª¨ë°”ì¼ modal)
  floatingToc.innerHTML = toc.innerHTML;
  mobileContent.innerHTML = toc.innerHTML;

  // ğŸ“± ëª¨ë°”ì¼ íŒì—… ì—´ê¸°
  mobileBtn.addEventListener("click", () => {
    mobileModal.style.display = "flex";
    document.body.classList.add("modal-open");
  });

  // ğŸ“± ëª¨ë°”ì¼ íŒì—… ë‹«ê¸° (ë°°ê²½ í´ë¦­ ì‹œ)
  mobileModal.addEventListener("click", (e) => {
    if (e.target === mobileModal) {
      mobileModal.style.display = "none";
      document.body.classList.remove("modal-open");
    }
  });

  // ğŸ“± ëª¨ë°”ì¼ í•­ëª© í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ & ëª¨ë‹¬ ë‹«ê¸°
  mobileContent.addEventListener("click", (e) => {
    if (e.target.tagName === "A") {
      e.preventDefault();
      const targetId = e.target.getAttribute("href").replace("#", "");
      const el = document.getElementById(targetId);
      if (el) {
        el.scrollIntoView({ behavior: "smooth" });
        mobileModal.style.display = "none";
        document.body.classList.remove("modal-open");
      }
    }
  });

  // ğŸ§· ì„¼í‹°ë„¬ ìš”ì†Œ ìƒì„± (ëª©ì°¨ ìœ„/ì•„ë˜ ê¸°ì¤€ì )
  const topSentinel = document.createElement("div");
  topSentinel.style.height = "1px";
  toc.before(topSentinel);

  const bottomSentinel = document.createElement("div");
  bottomSentinel.style.height = "1px";
  toc.after(bottomSentinel);

  // ğŸ‘ï¸ ìŠ¤í¬ë¡¤ ê¸°ì¤€ ëª©ì°¨ í‘œì‹œ ê°ì§€
  const checkFloatingToc = () => {
    const top = topSentinel.getBoundingClientRect().top;
    const bottom = bottomSentinel.getBoundingClientRect().top;

    const isTocFullyPassed = top < 0 && bottom < 0;

      // ëª¨ë°”ì¼ ì „ìš©
  if (window.innerWidth <= 768 && isTocFullyPassed) {
    floatingToc.style.display = "none"; // ëª¨ë°”ì¼ì—ì„  floating ìˆ¨ê¹€
    mobileBtn.classList.add("show");
  } else {
    mobileBtn.classList.remove("show");
    // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ì¡´ floatingToc í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
    floatingToc.style.display = isTocFullyPassed ? "block" : "none";
  }
};


  window.addEventListener("scroll", checkFloatingToc);
  window.addEventListener("resize", checkFloatingToc);
  checkFloatingToc();
});

</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const floatingToc = document.getElementById("floatingToc");
  
    if (window.innerWidth > 768 && floatingToc) {
      let isDragging = false;
      let offsetX = 0;
      let offsetY = 0;
  
      floatingToc.style.position = "fixed";
      floatingToc.style.cursor = "move";
  
      floatingToc.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - floatingToc.getBoundingClientRect().left;
        offsetY = e.clientY - floatingToc.getBoundingClientRect().top;
        document.body.style.userSelect = "none";
      });
  
      document.addEventListener("mousemove", (e) => {
        if (isDragging) {
          floatingToc.style.left = e.clientX - offsetX + "px";
          floatingToc.style.top = e.clientY - offsetY + "px";
        }
      });
  
      document.addEventListener("mouseup", () => {
        isDragging = false;
        document.body.style.userSelect = "";
      });
    }
  });
  </script>
  
  <style>
    .in-article-ad {
      margin: 24px auto;
      text-align: center;
      max-width: 100%;
    }
    .in-article-ad ins {
      display: block;
      width: 100%;
    }
  </style>
  
  <style>
    .in-article-ad{ margin:24px auto; text-align:center; max-width:100%; }
    .in-article-ad ins{ display:block; width:100%; }
  </style>
  
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('.post-content');
    if (!container) return;
  
    const paragraphs = Array.from(container.querySelectorAll('p'));
    if (!paragraphs.length) return;
  
    const isLongEnough = (p) => (p.textContent||'').trim().length > 50;
    const adPositions = [2,5,8].filter(i => i < paragraphs.length && isLongEnough(paragraphs[i]));
  
    adPositions.forEach((pos) => {
      const p = paragraphs[pos];
  
      const wrap = document.createElement('div');
      wrap.className = 'in-article-ad';
  
      const ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.display = 'block';
      ins.setAttribute('data-ad-client', 'ca-pub-2585969189290118');
      ins.setAttribute('data-ad-slot',   '2419246715');
      ins.setAttribute('data-ad-format', 'auto');
      ins.setAttribute('data-full-width-responsive', 'true');
  
      wrap.appendChild(ins);
      p.insertAdjacentElement('afterend', wrap);
  
      try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
    });
  });
  </script>

<%- include('partials/scripts') %>
</body>
</html>