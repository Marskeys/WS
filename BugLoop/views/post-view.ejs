<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <link rel="stylesheet" href="/assets/css/post-view.css" />

  <% const langs = ['ko','en','fr','zh','ja','es']; %>
  <% langs.forEach(l => { %>
    <link rel="alternate" hreflang="<%= l %>" href="https://bugloop.dev/<%= l %>/post/<%= post.id %>">
  <% }) %>
  <link rel="alternate" hreflang="x-default" href="https://bugloop.dev/post/<%= post.id %>">

  <%
    const publishedDate = new Date(post.created_at).toISOString();
    const modifiedDate = post.updated_at
      ? new Date(post.updated_at).toISOString()
      : publishedDate;
  %>

  <%- include('partials/head', {
    metaTitle: `${post.title} | BugLoop`,
    metaDescription: summary,
    metaImage: "https://bugloop.dev/assets/images/BugLoop.png",
    canonical: `https://bugloop.dev/${lang}/post/${post.id}`,
    currentPath: `/${lang}/post/${post.id}`,
    articleModifiedTime: modifiedDate
  }) %>

  <% const testKeywords = ['ÌÖåÏä§Ìä∏', 'test', '„ÉÜ„Çπ„Éà', 'ÊµãËØï']; %>
  <% if (post.categories.some(cat => testKeywords.includes(cat))) { %>
    <meta name="robots" content="noindex">
  <% } %>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "<%= post.title %>",
    "author": {
      "@type": "Person",
      "name": "<%= post.author %>"
    },
    "datePublished": "<%= publishedDate %>",
    "dateModified": "<%= modifiedDate %>",
    "mainEntityOfPage": "https://bugloop.dev/<%= lang %>/post/<%= post.id %>",
    "image": "https://bugloop.dev/assets/images/BugLoop.png",
    "articleBody": "<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,600) %>"
  }
  </script>
</head>

<body
  class="no-fixed-footer post-view"
  data-toc-title="<%= locale.ui.tocButton %>"
  oncontextmenu="return false"
  ondragstart="return false"
  onselectstart="return false"
>


  <div class="postview-container">
    <h1 class="post-title"><%= post.title %></h1>

    <div class="post-meta">
      <span><%= locale.ui.category %>: <%= post.categories.join(', ') %></span><br>
      <span><%= locale.ui.author %>: <%= post.author %></span><br>
      <span><%= locale.ui.date %>: <%= new Date(post.created_at).toLocaleString() %></span>
      <% if (post.updated_at && post.created_at !== post.updated_at) { %>
        <br>
        <span><%= locale.ui.modified || 'Modified' %>: <%= new Date(post.updated_at).toLocaleString() %></span>
      <% } %>
    </div>

    <div class="tts-wrapper">
      <button
        id="ttsBtn"
        class="tts-btn"
        data-listen="<%= locale.ui.listen || 'Listen' %>"
        data-stop="<%= locale.ui.stop || 'Stop' %>"
      >
        üîä <%= locale.ui.listen || "Listen" %>
      </button>
    </div>

    <div id="toc-sentinel" style="height:1px;"></div>

    <div class="post-content">
      <%- post.content %>
    </div>

    <% if (user && post.user_id == user.id) { %>
      <div class="post-actions" style="text-align:center; margin-top:1.5rem;">
        <a href="/<%= lang %>/edit/<%= post.id %>" class="edit-btn">
          ‚úèÔ∏è <%= locale.ui.editButton %>
        </a>
        <form action="/<%= lang %>/delete/<%= post.id %>" method="POST" style="display:inline;">
          <button type="submit" onclick="return confirm('<%= locale.ui.deleteConfirm %>');">
            üóë <%= locale.ui.deleteButton %>
          </button>
        </form>
      </div>
    <% } %>

    <% if (recommended && recommended.length > 0) { %>
      <div class="recommended-posts">
        <h2 class="recommended-title"><%= locale.ui.recommendedPosts || "Ï∂îÏ≤ú Í∏Ä" %></h2>
        <ul class="recommended-list">
          <% recommended.forEach(item => { %>
            <li class="recommended-item">
              <a href="/<%= lang %>/post/<%= item.id %>"><%= item.title %></a>
            </li>
          <% }) %>
        </ul>
      </div>
    <% } %>

    <div class="extra" style="margin-top:3rem; text-align:center;">
      <a href="/<%= lang %>/" class="back-home-btn">
        ‚Üê <span><%- locale.ui.backToHome || 'ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞' %></span>
      </a>
    </div>
  </div>

  <div class="floating-toc" id="floatingToc"></div>

  <div class="mobile-toc-button" id="mobileTocBtn">
    <%= locale.ui.tocButton %>
  </div>

  <div class="mobile-toc-modal" id="mobileTocModal">
    <div class="mobile-toc-content" id="mobileTocContent"></div>
  </div>

  <script src="/assets/js/post-view.js" defer></script>
  <%- include('partials/scripts') %>
</body>
</html>