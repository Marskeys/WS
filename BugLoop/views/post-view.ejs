<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <link rel="stylesheet" href="/assets/css/post-view.css" />

  <%- include('partials/head', {
        metaTitle: `${post.title} | Bug Loop`,
        metaDescription: summary,
        metaImage: "https://bugloop.dev/assets/images/BugLoop.png",
        canonical: canonicalUrl,
        currentPath: `/${lang}/post/${post.id}`
  }) %>

  <% if (alternateLinks && alternateLinks.length > 0) { %>
    <% alternateLinks.forEach(link => { %>
      <link rel="alternate" hreflang="<%= link.lang %>" href="<%= link.href %>">
    <% }); %>
    <link rel="alternate" hreflang="x-default" href="https://bugloop.dev/<%= lang %>/post/<%= post.id %>">
  <% } %>

  <% const testKeywords = ['í…ŒìŠ¤íŠ¸', 'test', 'ãƒ†ã‚¹ãƒˆ', 'æµ‹è¯•']; %>
  <% if (post.categories.some(cat => testKeywords.includes(cat))) { %>
    <meta name="robots" content="noindex">
  <% } %>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "<%= post.title %>",
    "author": {
      "@type": "Person",
      "name": "<%= post.author %>"
    },
    "datePublished": "<%= new Date(post.created_at).toISOString() %>",
    "mainEntityOfPage": "<%= canonicalUrl %>",
    "image": "https://bugloop.dev/assets/images/BugLoop.png",
    "articleBody": "<%= (post.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,600) %>"
  }
  </script>

  <style>


/* ---- í”Œë¡œíŒ… ëª©ì°¨ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬ ---- */
#floatingToc, #floatingToc * {
  pointer-events: auto !important;
  -webkit-user-select: auto !important;
  user-select: auto !important;
  -webkit-user-drag: auto !important;
  cursor: move !important;
}
    /* [ê°•ë ¥ ì°¨ë‹¨] ëª¨ë“  ìš”ì†Œ ë“œë˜ê·¸ ë° ì„ íƒ ë°©ì§€ (ìµœìš°ì„  ìˆœìœ„ ì ìš©) */
    *, *:before, *:after {
      -webkit-user-select: none !important;  /* í¬ë¡¬, ì‚¬íŒŒë¦¬ */
      -moz-user-select: none !important;     /* íŒŒì´ì–´í­ìŠ¤ */
      -ms-user-select: none !important;      /* IE */
      user-select: none !important;          /* í‘œì¤€ */
      -webkit-user-drag: none !important;    /* ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€ */
    }

    /* ì˜ˆì™¸: ê²€ìƒ‰ì°½ì´ë‚˜ ëŒ“ê¸€ ì…ë ¥ì°½, ì½”ë“œë¸”ëŸ­ ë‚´ë¶€ëŠ” ê¸€ì”¨ë¥¼ ì“¸ ìˆ˜ ìˆì–´ì•¼ í•  ìˆ˜ë„ ìˆìŒ (í•„ìš”ì‹œ ì¡°ì •) */
    input, textarea, [contenteditable] {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      -webkit-user-drag: auto !important; 
      cursor: auto;
    }

    /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .post-content img,
    .post-content video {
      max-width: 100%;       
      height: auto;          
      display: block;        
      margin: 0 auto;        
      border-radius: 8px;
      pointer-events: none; /* ì´ë¯¸ì§€ í´ë¦­/í˜¸ë²„ ì´ë²¤íŠ¸ ì°¨ë‹¨ (ì €ì¥ ë©”ë‰´ ë°©ì§€) */
    }

    /* ì´ë¯¸ì§€/ë™ì˜ìƒì„ ê°ì‹¸ëŠ” div(.img-wrap) ìŠ¤íƒ€ì¼ */
    .img-wrap {
      width: 100%;
      margin: 2rem 0;        
      text-align: center;    
    }

    /* ìº¡ì…˜ ìŠ¤íƒ€ì¼ */
    .img-caption {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
    
    html.dark .img-caption {
      color: #aaa;
    }

    body { padding-bottom: 50px; }

    .post-content a,
    .post-content a:visited {
      color: #1a73e8 !important;
      text-decoration: underline;
      cursor: pointer !important; /* ë§í¬ í´ë¦­ì€ ê°€ëŠ¥í•˜ê²Œ */
    }
    html.dark .post-content a,
    html.dark .post-content a:visited {
      color: #8ab4ff !important;
    }
    .post-content a:hover {
      opacity: 0.85;
    }

    .back-home-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 400px;
      padding: 12px 20px;
      margin-top: 10px;
      border-radius: 6px;
      font-weight: 600;
      border: 1px solid;
      font-size: 1rem;
      letter-spacing: 0.5px;
      color: #333;
      background: #f7f7f7;
      border-color: #e0e0e0;
      cursor: pointer !important;
    }
    .back-home-btn:hover {
      background: #e0e0e0;
      color: #000;
      border-color: #ccc;
    }

    html.dark .back-home-btn {
      color: #e0e0e0;
      background: #2c2c2c;
      border-color: #444;
    }
    html.dark .back-home-btn:hover {
      background: #3a3a3a;
      color: #fff;
      border-color: #666;
    }

    .back-home-btn span { margin-left: 8px; }

    .tts-wrapper { text-align: right; margin: 20px 0 10px; }
    .tts-btn {
      padding: 8px 14px;
      border-radius: 6px;
      background: var(--panel);
      border: 1px solid var(--accent);
      cursor: pointer !important;
      font-size: 0.9rem;
    }
    html.dark .tts-btn {
      background: #2c2c2c;
      border-color: #555;
      color: #ddd;
    }

    img[data-heic-loading] {
      opacity: 0.4;
      filter: blur(3px);
    }

    /* ë³¸ë¬¸ ë‚´ ê´‘ê³  ìŠ¤íƒ€ì¼ */
    .in-article-ad {
      margin: 24px auto;
      text-align: center;
      max-width: 100%;
    }
    .in-article-ad ins {
      display: block;
      width: 100%;
    }
  </style>
</head>


<body class="no-fixed-footer" oncontextmenu="return false" ondragstart="return false" onselectstart="return false">
  <amp-auto-ads type="adsense"
        data-ad-client="ca-pub-2585969189290118">
  </amp-auto-ads>
  
  <%- include('partials/header') %>

  <div class="postview-container">

    <h1 class="post-title"><%= post.title %></h1>

    <div class="post-meta">
      <span><%= locale.ui.category %>: <%= post.categories.join(', ') %></span><br>
      <span><%= locale.ui.author %>: <%= post.author %></span><br>
      <span><%= locale.ui.date %>: <%= new Date(post.created_at).toLocaleString() %></span>
    </div>

    <div class="tts-wrapper">
      <button id="ttsBtn" class="tts-btn">ğŸ”Š <%= locale.ui.listen || "Listen" %></button>
    </div>

    <div class="post-content">
      <%- post.content %>
    </div>

    <% if (user && post.user_id == user.id) { %>
      <div class="post-actions" style="text-align: center; margin-top: 1.5rem;">
        <a href="/<%= lang %>/edit/<%= post.id %>" class="edit-btn">âœï¸ <%= locale.ui.editButton %></a>
        <form action="/<%= lang %>/delete/<%= post.id %>" method="POST" style="display: inline;">
          <button type="submit" onclick="return confirm('<%= locale.ui.deleteConfirm %>');">ğŸ—‘ <%= locale.ui.deleteButton %></button>
        </form>
      </div>
    <% } %>

     <% if (recommended && recommended.length > 0) { %>
      <div class="recommended-posts">
        <h2 class="recommended-title">
          <%= locale.ui.recommendedPosts || "ì¶”ì²œ ê¸€" %>
        </h2>

        <ul class="recommended-list">
          <% recommended.forEach(item => { %>
            <li class="recommended-item">
              <a href="/<%= lang %>/post/<%= item.id %>">
                <%= item.title %>
              </a>
            </li>
          <% }) %>
        </ul>
      </div>
    <% } %>

    <div class="extra" style="margin-top: 3rem; text-align: center;">
      <a href="/<%= lang %>/" class="back-home-btn">
        â†<span><%- locale.ui.backToHome || 'í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°' %></span>
      </a>
    </div>
  </div>

  <div class="floating-toc" id="floatingToc"></div>
  <div class="mobile-toc-button" id="mobileTocBtn"><%= locale.ui.tocButton %></div>
  <div class="mobile-toc-modal" id="mobileTocModal">
    <div class="mobile-toc-content" id="mobileTocContent"></div>
  </div>

<script>
  // ==========================================
  // [ë³´ì•ˆ ê¸°ëŠ¥ ê°•í™”] ë“œë˜ê·¸/ë³µì‚¬/ìš°í´ë¦­ ë°©ì§€ ë¡œì§
  // ==========================================

  // 1. ìš°í´ë¦­ ì™„ì „ ì°¨ë‹¨
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });

  // 2. ë“œë˜ê·¸ ì‹œì‘ ì°¨ë‹¨ (ì´ë¯¸ì§€ ë“±)
  document.addEventListener('dragstart', function(e) {
    // ì…ë ¥ì°½ì´ ì•„ë‹ˆë©´ ì°¨ë‹¨
    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        return false;
    }
  });

  // 3. í…ìŠ¤íŠ¸ ì„ íƒ ì‹œì‘ ì°¨ë‹¨
  document.addEventListener('selectstart', function(e) {
    // ì…ë ¥ì°½ì´ ì•„ë‹ˆë©´ ì°¨ë‹¨
    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        return false;
    }
  });

  // 4. (ì¤‘ìš”) ë§ˆìš°ìŠ¤ ë²„íŠ¼ì„ ë—„ ë•Œ, í˜¹ì‹œë¼ë„ ì¡íŒ ì„ íƒ ì˜ì—­ì´ ìˆë‹¤ë©´ ê°•ì œë¡œ í•´ì œ
  document.addEventListener('mouseup', function() {
    const selection = window.getSelection();
    if (selection && selection.toString().length > 0) {
      // ì…ë ¥ì°½ ë‚´ì˜ ì„ íƒì¸ì§€ í™•ì¸ í›„ ì²˜ë¦¬í•´ë„ ë˜ì§€ë§Œ, ê°•ë ¥ ì°¨ë‹¨ì„ ìœ„í•´ ì¼ë‹¨ í•´ì œ
      const active = document.activeElement;
      if (active.tagName !== 'INPUT' && active.tagName !== 'TEXTAREA') {
          selection.removeAllRanges();
      }
    }
  });

  // 5. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì°¨ë‹¨ (ë³µì‚¬, ì €ì¥, ê°œë°œìë„êµ¬ ë“±)
  document.addEventListener('keydown', function(e) {
    // F12 (ê°œë°œì ë„êµ¬)
    if (e.key === "F12") {
      e.preventDefault();
      return false;
    }

    // Ctrl ë˜ëŠ” Meta(Mac Command) í‚¤ ì¡°í•©
    if (e.ctrlKey || e.metaKey) {
      const key = e.key.toLowerCase();
      // c:ë³µì‚¬, a:ì „ì²´ì„ íƒ, s:ì €ì¥, p:ì¸ì‡„, u:ì†ŒìŠ¤ë³´ê¸°, x:ì˜ë¼ë‚´ê¸°
      if (['c', 'a', 's', 'p', 'u', 'x'].includes(key)) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+Shift+I / J / C (ê°œë°œì ë„êµ¬)
      if (e.shiftKey && (key === 'i' || key === 'j' || key === 'c')) {
        e.preventDefault();
        return false;
      }
    }
  });
</script>

<script>
  // ==========================================
  // ëª©ì°¨(TOC) ìƒì„± ë° ë™ì‘ ë¡œì§
  // ==========================================
  document.addEventListener('DOMContentLoaded', function() {
    const postContent = document.querySelector('.post-content');
    const floatingToc = document.getElementById('floatingToc');
    const mobileTocBtn = document.getElementById('mobileTocBtn');
    const mobileTocModal = document.getElementById('mobileTocModal');
    const mobileTocContent = document.getElementById('mobileTocContent');
    const mobileTocCloseBtn = document.getElementById('mobileTocCloseBtn');

    if (!postContent) return;

    // ëª©ì°¨ HTML ìƒì„± í•¨ìˆ˜
    function generateToc() {
      const headings = postContent.querySelectorAll('h1, h2');
      if (headings.length === 0) {
        if (floatingToc) floatingToc.style.display = 'none';
        if (mobileTocBtn) mobileTocBtn.style.display = 'none';
        return;
      }

      let tocHtml = '<strong><%= locale.ui.tocButton %></strong><ul style="padding-left: 1.2em;">';
      let h1Count = 0;
      let h2Count = 0;

      headings.forEach((heading, index) => {
        const tag = heading.tagName.toLowerCase();
        let sectionNumber = '';
        
        if (!heading.id || !heading.id.startsWith('toc-')) {
            heading.id = `toc-${tag}-${index}`;
        }

        if (tag === 'h1') {
          h1Count++;
          h2Count = 0; 
          sectionNumber = `${h1Count}.`;
          tocHtml += `<li class="toc-${tag}"><a href="#${heading.id}">${sectionNumber} ${heading.textContent}</a></li>`;
        } else if (tag === 'h2') {
          h2Count++;
          if (h1Count === 0) h1Count = 1; 
          sectionNumber = `${h1Count}.${h2Count}`;
          tocHtml += `<li class="toc-${tag}"><a href="#${heading.id}">${sectionNumber} ${heading.textContent}</a></li>`;
        }
      });
      tocHtml += '</ul>';

      if (floatingToc) {
        floatingToc.innerHTML = tocHtml;
        floatingToc.style.display = 'block'; 
      }
      if (mobileTocContent) {
        mobileTocContent.innerHTML = tocHtml;
        mobileTocBtn.style.display = 'block'; 
      }
    }

    // ìŠ¤í¬ë¡¤ ì‹œ í”Œë¡œíŒ… ëª©ì°¨ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° (ë°ìŠ¤í¬í†±)
    function handleScroll() {
      const scrollThreshold = 300; 
      if (window.innerWidth > 768) { 
        if (window.scrollY > scrollThreshold) {
          if (floatingToc) floatingToc.classList.add('show');
        } else {
          if (floatingToc) floatingToc.classList.remove('show');
        }
      }
    }

    // ëª¨ë°”ì¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (mobileTocBtn) {
      mobileTocBtn.addEventListener('click', function() {
        if (mobileTocModal) mobileTocModal.classList.add('show');
      });
    }

    if (mobileTocCloseBtn) {
      mobileTocCloseBtn.addEventListener('click', function() {
        if (mobileTocModal) mobileTocModal.classList.remove('show');
      });
    }

    // ëª¨ë°”ì¼ ëª©ì°¨ ë§í¬ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
    if (mobileTocContent) {
      mobileTocContent.addEventListener('click', function(event) {
        if (event.target.tagName === 'A' && mobileTocModal) {
          mobileTocModal.classList.remove('show');
        }
      });
    }

    generateToc();
    window.addEventListener('scroll', handleScroll);
    window.addEventListener('resize', handleScroll);
  });
</script>

<script>
  // ==========================================
  // ëª¨ë°”ì¼ ëª©ì°¨ ëª¨ë‹¬ ì œì–´ ë° ì„¼í‹°ë„¬ ë¡œì§
  // ==========================================
  document.addEventListener("DOMContentLoaded", () => {
    const toc = document.querySelector(".auto-toc");
    const floatingToc = document.getElementById("floatingToc");
    const mobileBtn = document.getElementById("mobileTocBtn");
    const mobileModal = document.getElementById("mobileTocModal");
    const mobileContent = document.getElementById("mobileTocContent");

    if (!toc) return; // ë³¸ë¬¸ì— .auto-toc ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

    // ë‚´ìš© ë³µì‚¬
    if (floatingToc) floatingToc.innerHTML = toc.innerHTML;
    if (mobileContent) mobileContent.innerHTML = toc.innerHTML;

    if (mobileBtn) {
      mobileBtn.addEventListener("click", () => {
        mobileModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });
    }

    if (mobileModal) {
      mobileModal.addEventListener("click", (e) => {
        if (e.target === mobileModal) {
          mobileModal.style.display = "none";
          document.body.classList.remove("modal-open");
        }
      });
    }

    if (mobileContent) {
      mobileContent.addEventListener("click", (e) => {
        if (e.target.tagName === "A") {
          e.preventDefault();
          const targetId = e.target.getAttribute("href").replace("#", "");
          const el = document.getElementById(targetId);
          if (el) {
            el.scrollIntoView({ behavior: "smooth" });
            mobileModal.style.display = "none";
            document.body.classList.remove("modal-open");
          }
        }
      });
    }

    // ì„¼í‹°ë„¬ ìƒì„± (ëª©ì°¨ ìœ„ì¹˜ ê°ì§€ìš©)
    const topSentinel = document.createElement("div");
    topSentinel.style.height = "1px";
    toc.before(topSentinel);

    const bottomSentinel = document.createElement("div");
    bottomSentinel.style.height = "1px";
    toc.after(bottomSentinel);

    const checkFloatingToc = () => {
      const top = topSentinel.getBoundingClientRect().top;
      const bottom = bottomSentinel.getBoundingClientRect().top;
      const isTocFullyPassed = top < 0 && bottom < 0;

      if (window.innerWidth <= 768 && isTocFullyPassed) {
        if (floatingToc) floatingToc.style.display = "none"; 
        if (mobileBtn) mobileBtn.classList.add("show");
      } else {
        if (mobileBtn) mobileBtn.classList.remove("show");
        if (floatingToc) floatingToc.style.display = isTocFullyPassed ? "block" : "none";
      }
    };

    window.addEventListener("scroll", checkFloatingToc);
    window.addEventListener("resize", checkFloatingToc);
    checkFloatingToc();
  });
</script>

<script>
  // ==========================================
  // í”Œë¡œíŒ… ëª©ì°¨ ë“œë˜ê·¸ ì´ë™ (ë°ìŠ¤í¬í†±)
  // ==========================================
  document.addEventListener("DOMContentLoaded", () => {
    const floatingToc = document.getElementById("floatingToc");
  
    if (window.innerWidth > 768 && floatingToc) {
      let isDragging = false;
      let offsetX = 0;
      let offsetY = 0;
  
      floatingToc.style.position = "fixed";
      // ì»¤ì„œëŠ” moveë¡œ ì„¤ì •í•˜ë˜, !important CSS ë•Œë¬¸ì— ë“œë˜ê·¸ê°€ ì”¹í ìˆ˜ ìˆìŒ.
      // í•„ìš”ì‹œ JSë¡œ styleì„ ì§ì ‘ ì£¼ì…
      floatingToc.style.cursor = "move";
  
      floatingToc.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - floatingToc.getBoundingClientRect().left;
        offsetY = e.clientY - floatingToc.getBoundingClientRect().top;
      });
  
      document.addEventListener("mousemove", (e) => {
        if (isDragging) {
          floatingToc.style.left = e.clientX - offsetX + "px";
          floatingToc.style.top = e.clientY - offsetY + "px";
        }
      });
  
      document.addEventListener("mouseup", () => {
        isDragging = false;
      });
    }
  });
</script>
  
<script>
  // ==========================================
  // ë³¸ë¬¸ ë‚´ ê´‘ê³  ìë™ ì‚½ì…
  // ==========================================
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('.post-content');
    if (!container) return;
  
    const paragraphs = Array.from(container.querySelectorAll('p'));
    if (!paragraphs.length) return;
  
    const isLongEnough = (p) => (p.textContent||'').trim().length > 50;
    const adPositions = [2,5,8].filter(i => i < paragraphs.length && isLongEnough(paragraphs[i]));
  
    adPositions.forEach((pos) => {
      const p = paragraphs[pos];
  
      const wrap = document.createElement('div');
      wrap.className = 'in-article-ad';
  
      const ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.display = 'block';
      ins.setAttribute('data-ad-client', 'ca-pub-2585969189290118');
      ins.setAttribute('data-ad-slot',   '2419246715');
      ins.setAttribute('data-ad-format', 'auto');
      ins.setAttribute('data-full-width-responsive', 'true');
  
      wrap.appendChild(ins);
      p.insertAdjacentElement('afterend', wrap);
  
      try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
    });
  });
</script>

<script>
// ==========================================
// TTS (ìŒì„± ë“£ê¸°) ê¸°ëŠ¥
// ==========================================
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("ttsBtn");
  if (!btn) return;

  let isReading = false;
  const synth = window.speechSynthesis;

  btn.addEventListener("click", () => {
    if (isReading) {
      synth.cancel();
      btn.innerText = "ğŸ”Š <%= locale.ui.listen || 'Listen' %>";
      isReading = false;
      return;
    }

    const text = document.querySelector(".post-content").innerText;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = document.documentElement.lang; 

    synth.speak(utter);
    btn.innerText = "â¹ <%= locale.ui.stop || 'Stop' %>";
    isReading = true;

    utter.onend = () => {
      btn.innerText = "ğŸ”Š <%= locale.ui.listen || 'Listen' %>";
      isReading = false;
    };
  });
});
</script>

<%- include('partials/scripts') %>
</body>
</html>