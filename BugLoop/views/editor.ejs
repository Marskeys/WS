<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="/assets/css/editor.css" />
  <title>BlindLove ì—ë””í„°</title>
  <%- include('partials/head') %>
  <% if (user) { %>
    <meta name="author" content="<%= user.nickname %>">
  <% } %>
<style>
/* strong/b êµµê²Œ ì ìš© ì‹œ ê¸€ì í¬ê¸° ì¶•ì†Œ ë°©ì§€ */
.editor .bl-content strong,
.editor .bl-content b {
  font-size: inherit;
  font-weight: 700;
}

/* "ì§„í•œ ë ˆì´ë¸”"ë„ ë³¸ë¬¸ê³¼ ê°™ì€ í¬ê¸°ë¡œ */
.editor .bl-content .label,
.editor .bl-content .label-bold {
  font-size: inherit;
  font-weight: 700;
}
</style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/style.css" />
</head>
<body class="edit-body">
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined' && post !== null; %>
  <% if (user) { %>
    <div style="text-align: center; font-weight: bold; margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

  <div class="editor-container">
    <div class="logo-wrap">
      <a href="/<%= lang %>/">
    
      </a>
    </div>

    <div class="lang-selector-wrap">
      <label for="langSelector">í¸ì§‘ ì¤‘ì¸ ì–¸ì–´</label>
      <select id="langSelector">
        <%
          const langLabels = {
              'ko': 'í•œêµ­ì–´',
              'en': 'English',
              'fr': 'FranÃ§ais',
              'zh': 'ä¸­æ–‡',
              'ja': 'æ—¥æœ¬èª',
              // ğŸ“Œ ë³€ê²½ ì‚¬í•­: ìŠ¤í˜ì¸ì–´ ë ˆì´ë¸” ì¶”ê°€
              'es': 'EspaÃ±ol'
          };
          supportedLangs.forEach(langCode => {
        %>
          <option value="<%= langCode %>" <%= lang === langCode ? 'selected' : '' %>><%= langLabels[langCode] %></option>
        <%
          });
        %>
      </select>
    </div>

    <%
      // ğŸ“Œ ë³€ê²½ ì‚¬í•­: langList ë°°ì—´ì— ìŠ¤í˜ì¸ì–´ ì˜µì…˜ ì¶”ê°€
      const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' },
        { code: 'es', label: 'EspaÃ±ol' } // ìŠ¤í˜ì¸ì–´ ì¶”ê°€
      ];
    %>

    <% langList.forEach(({ code, label }) => { %>
      <div class="lang-meta-block" data-lang="<%= code %>" style="<%= code === lang ? '' : 'display:none;' %>">
        <div class="title-wrap">
          <input
            type="text"
            name="title_<%= code %>"
            placeholder="<%= label %> ì œëª©"
            value="<%= post?.[code]?.title || '' %>"
          />
        </div>

        <div class="toolbar" data-lang-toolbar="<%= code %>">
          <div class="dropdown">
            <div class="dropdown-toggle" data-style-toggle="<%= code %>">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" data-style-dropdown="<%= code %>">
              <div class="h2" data-style-command="h2">ì œëª©</div>
              <div class="h3" data-style-command="h3">ë¶€ì œëª©</div>
              <div class="h4" data-style-command="h4">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" data-style-command="h5">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" data-style-command="p">ë³¸ë¬¸</div>
              <div class="desc" data-style-command="small">ì„¤ëª…</div>
              <div class="meta" data-style-command="footer">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" data-style-command="span">ë ˆì´ë¸”</div>
              <div class="label label-bold" data-style-command="strong">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
          <button data-command="insertTOC" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
          <button data-command="bold" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button data-command="italic" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button data-command="underline" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button data-command="strikeThrough" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button data-command="justifyLeft" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button data-command="justifyCenter" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button data-command="justifyRight" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button data-command="insertOrderedList" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button data-command="insertUnorderedList" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button data-command="outdent" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button data-command="indent" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button data-command="createLink" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button data-command="unlink" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>
          
          <div class="color-tool" data-color-tool="foreColor">
            <button data-color-btn="foreColor" data-tooltip="ê¸€ì ìƒ‰ìƒ">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <div class="color-palette" data-color-palette="foreColor">
              <button style="background:black" data-color-value="black"></button>
              <button style="background:red" data-color-value="red"></button>
              <button style="background:orange" data-color-value="orange"></button>
              <button style="background:green" data-color-value="green"></button>
              <button style="background:blue" data-color-value="blue"></button>
              <button class="none-icon" data-color-value="__clear__" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" data-color-input="foreColor" />
              </label>
            </div>
          </div>
          
          <div class="color-tool" data-color-tool="hiliteColor">
            <button data-color-btn="hiliteColor" data-tooltip="ë°°ê²½ ìƒ‰ìƒ">
              <i class="fas fa-fill-drip"></i>
            </button>
            <div class="color-palette" data-color-palette="hiliteColor">
              <button style="background:yellow" data-color-value="yellow"></button>
              <button style="background:lightblue" data-color-value="lightblue"></button>
              <button style="background:lightgreen" data-color-value="lightgreen"></button>
              <button style="background:pink" data-color-value="pink"></button>
              <button style="background:#ccc" data-color-value="#ccc"></button>
              <button class="none-icon" data-color-value="__clear__" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">
                ğŸ¨<input type="color" data-color-input="hiliteColor" />
              </label>
            </div>
          </div>
          <button data-command="openHtmlPopup" data-tooltip="HTML ì‚½ì…"><i class="fas fa-code"></i></button> 
          <button data-command="insertImage" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button data-command="insertVideo" data-tooltip="ë™ì˜ìƒ ì‚½ì…">
  <i class="fas fa-video"></i>
</button>
          <button data-command="removeFormat" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>
    
        <% if (user && Number(user.is_admin) === 1) { %>
        <div class="mode-toggle">
          <button data-mode-toggle="design">ë””ìì¸ ëª¨ë“œ</button>
          <button data-mode-toggle="html">HTML ëª¨ë“œ</button>
        </div>
        <% } %>
        
        <div class="editor-area-wrapper">
          <div id="editor_<%= code %>"
               contenteditable="true"
               class="editor language-editor"
               spellcheck="false"
               data-lang-editor="<%= code %>"
               style="<%= code === lang ? '' : 'display:none;' %>"
          >
            <%
              let initialContent = post?.[code]?.content || '<p><br></p>';
              const isWrapped = initialContent.startsWith('<div class="bl-content"');
              if (!isWrapped) {
                initialContent = `
                  <div class="bl-content" style="white-space:normal; line-height: 1.7;">
                    ${initialContent}
                  </div>
                `;
              }
            %>
            <%- initialContent %>
          </div>
          <textarea id="htmlEditor_<%= code %>" class="editor html-editor" style="display: none;"></textarea>
        </div>

        <div class="global-options" style="margin-top: 2rem;">
          <label style="margin-right: 2rem;">
            <input type="checkbox" id="isPrivateCheckbox" name="is_private" value="1" <%= post?.is_private ? 'checked' : '' %> />
            ğŸ”’ ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
          </label>
        
          <% if (user && Number(user.is_admin) === 1) { %>
            <label>
              <input type="checkbox" id="isPinnedCheckbox" name="is_pinned" value="1" <%= post?.is_pinned ? 'checked' : '' %> />
              ğŸ“Œ ìƒë‹¨ì— ê³ ì •í•˜ê¸°
            </label>
          <% } %>
        </div>
      </div>
    <% }) %> 

    <div class="category-box">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ:</label>
      <div class="category-list" id="categoryList"></div>
      <button class="bl-button add" onclick="addCategory()">+ ì¶”ê°€</button>
    </div>

    <div class="save-button-wrap">
      <button type="button" class="bl-button save" onclick="postContent()">ğŸ’¾ ì €ì¥</button>
    </div>

  </div> 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script>
    let selectedCategories = [];
    <% if (post && post.categories) { %>
      selectedCategories = <%- JSON.stringify(post.categories.split(',')) %>;
    <% } %>

    let categories = [];
    let savedRange = null;
    let currentActiveEditor = null;
    let currentActiveHtmlEditor = null;
    let currentActiveToolbar = null;

    // ğŸ“Œ ë³€ê²½ ì‚¬í•­: langList ë°°ì—´ì— ìŠ¤í˜ì¸ì–´ ì˜µì…˜ ì¶”ê°€
    const langList = [
        { code: 'ko', label: 'í•œêµ­ì–´' },
        { code: 'en', label: 'English' },
        { code: 'fr', label: 'FranÃ§ais' },
        { code: 'zh', label: 'ç®€ä½“ä¸­æ–‡' },
        { code: 'ja', label: 'æ—¥æœ¬èª' },
        { code: 'es', label: 'EspaÃ±ol' } // ìŠ¤í˜ì¸ì–´ ì¶”ê°€
    ];
    
    const IS_EDIT_PAGE = <%- isEdit ? 'true' : 'false' %>; 
    const POST_ID = <%- post && post.id ? JSON.stringify(post.id) : 'null' %>;
    const CURRENT_PAGE_LANG = '<%= lang %>';

    /* ---------- ì¹´í…Œê³ ë¦¬ ë Œë”/ì¶”ê°€ (ìƒëµ ì—†ëŠ” ì›ë³¸ ìœ ì§€) ---------- */
    function renderCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';
        categories.forEach((cat, index) => {
          const item = document.createElement('div');
          item.className = 'category-item';
          if (selectedCategories.includes(cat)) item.classList.add('selected');
          item.innerText = cat;
    
          item.onclick = () => {
            const i = selectedCategories.indexOf(cat);
            if (i === -1) selectedCategories.push(cat);
            else selectedCategories.splice(i, 1);
            renderCategories();
          };
    
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.innerText = 'Ã—';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            showCustomMessage(`'${cat}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true, () => {
              fetch(`/api/categories/${encodeURIComponent(cat)}`, {
                method: 'DELETE'
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  categories.splice(index, 1);
                  selectedCategories = selectedCategories.filter(c => c !== cat);
                  renderCategories();
                  showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                  showCustomMessage("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                }
              })
              .catch(err => {
                console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
                showCustomMessage("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
            });
          };
    
          item.appendChild(removeBtn);
          list.appendChild(item);
        });
      }
    
      function addCategory() {
        showCustomInput("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", (newCat) => {
          newCat = newCat?.trim();
          if (!newCat || categories.includes(newCat)) return;
      
          fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newCat })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              categories.push(newCat);
              renderCategories();
              showCustomMessage("ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              showCustomMessage("ì¶”ê°€ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì¶”ê°€ ì˜¤ë¥˜:", err);
            showCustomMessage("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        });
      }
    
      function postContent() {
          const postData = {
              categories: selectedCategories,
              is_private: document.getElementById('isPrivateCheckbox')?.checked ? 1 : 0,
              is_pinned: document.getElementById('isPinnedCheckbox')?.checked ? 1 : 0,
              lang_content: {}
          };
          let hasContentForDefaultLang = false;

          langList.forEach(({ code }) => {
              const titleInput = document.querySelector(`input[name="title_${code}"]`);
              const editorDiv = document.getElementById(`editor_${code}`);
              const htmlEditorDiv = document.getElementById(`htmlEditor_${code}`);

              if (!titleInput || !editorDiv || !htmlEditorDiv) {
                  console.warn(`ì–¸ì–´ ì½”ë“œ ${code} ì— ëŒ€í•œ ì…ë ¥ í•„ë“œ ë˜ëŠ” ì—ë””í„° DIVë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                  return;
              }

              let contentToSave = '';
              if (htmlEditorDiv.style.display === 'block') {
                  contentToSave = htmlEditorDiv.value.trim();
              } else {
                  const blContent = editorDiv.querySelector('.bl-content');
                  contentToSave = blContent ? blContent.innerHTML.trim() : editorDiv.innerHTML.trim();
              }

              if (!contentToSave || contentToSave === '<div><br></div>' || contentToSave === '<p><br></p>') {
                  contentToSave = '<p><br></p>';
              }

              postData.lang_content[code] = {
                  title: titleInput.value.trim(),
                  content: contentToSave
              };

              if (code === 'ko' && (postData.lang_content[code].title || postData.lang_content[code].content !== '<p><br></p>')) {
                  hasContentForDefaultLang = true;
              }
          });

          if (!postData.categories || postData.categories.length === 0) {
              return showCustomMessage("ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }

          if (!hasContentForDefaultLang) {
            return showCustomMessage("í•œêµ­ì–´ ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
      
          const submitUrl = IS_EDIT_PAGE && POST_ID ? `/edit/${POST_ID}` : `/savePost`;

          fetch(submitUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showCustomMessage("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", false, () => {
                if (IS_EDIT_PAGE && POST_ID) {
                  window.location.href = `/${CURRENT_PAGE_LANG}/post/${POST_ID}`;
                } else if (data.postId) {
                  window.location.href = `/${CURRENT_PAGE_LANG}/post/${data.postId}`;
                } else {
                  window.location.href = `/${CURRENT_PAGE_LANG}/`;
                }
              });
            } else {
              showCustomMessage("ì €ì¥ ì‹¤íŒ¨: " + data.error);
            }
          })
          .catch(err => {
            console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
            showCustomMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
        }
      
      /* ---------- ì„œì‹ ëª…ë ¹ (ë¸”ë¡/ê¸°íƒ€) ---------- */
      function format(command, value = null) {
          if (!currentActiveEditor) return; 
          currentActiveEditor.focus();
          restoreSelection();
          document.execCommand(command, false, value);
          setTimeout(detectStyle, 100);
      }

      /* =========[ í•µì‹¬ ì¶”ê°€: ì—­ë°©í–¥ ì„ íƒ ì‹ ë¢° ë³´ì¥ + ì¸ë¼ì¸ í† ê¸€ ]========= */

      // ì„ íƒë²”ìœ„ ì €ì¥
      function saveSelection() {
          const sel = window.getSelection();
          if (sel.rangeCount > 0 && currentActiveEditor && currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
              savedRange = sel.getRangeAt(0).cloneRange();
          } else {
              savedRange = null;
          }
      }

      // selectionchangeë¡œ í•­ìƒ ìµœì‹  ì„ íƒë²”ìœ„ ë³´ì¡´ (ì—­ë°©í–¥ í¬í•¨)
      document.addEventListener('selectionchange', () => {
        if (!currentActiveEditor) return;
        const sel = window.getSelection();
        if (sel.rangeCount === 0) return;
        const ca = sel.getRangeAt(0).commonAncestorContainer;
        if (currentActiveEditor.contains(ca)) {
          saveSelection();
        }
      });

      // ë³µì›
      function restoreSelection() {
        if (!savedRange) return;
        const sel = window.getSelection();
        if (!currentActiveEditor || 
            !currentActiveEditor.contains(savedRange.startContainer) || 
            !currentActiveEditor.contains(savedRange.endContainer)) {
          savedRange = null;
          return;
        }
        sel.removeAllRanges();
        sel.addRange(savedRange);
      }

      // ì¡°ê°ì—ì„œ íŠ¹ì • íƒœê·¸ ì–¸ë©
      function unwrapTagFromFragment(fragment, tag) {
        const nodes = fragment.querySelectorAll(tag);
        nodes.forEach(el => {
          const parent = el.parentNode;
          while (el.firstChild) parent.insertBefore(el.firstChild, el);
          parent.removeChild(el);
        });
      }

      // ì„ íƒì˜ì—­ì´ ì „ë¶€ í•´ë‹¹ íƒœê·¸ ì•ˆì¸ê°€ ëŒ€ëµ í™•ì¸
      function selectionAllInsideTag(range, tag) {
        const frag = range.cloneContents();
        const walker = document.createTreeWalker(frag, NodeFilter.SHOW_TEXT, null);
        let hasText = false;
        let allInside = true;
        while (walker.nextNode()) {
          const t = walker.currentNode;
          if (!t.nodeValue || !t.nodeValue.trim()) continue;
          hasText = true;
          let n = t.parentNode;
          let inside = false;
          while (n && n !== frag) {
            if (n.nodeName && n.nodeName.toLowerCase() === tag) { inside = true; break; }
            n = n.parentNode;
          }
          if (!inside) { allInside = false; break; }
        }
        return hasText && allInside;
      }

      const INLINE_MAP = {
        bold: 'strong',
        italic: 'em',
        underline: 'u',
        strikeThrough: 's'
      };

      // ì¸ë¼ì¸ ì„œì‹ í† ê¸€ (ì—­ë°©í–¥/ì •ë°©í–¥ ë™ì¼ ë™ì‘)
      function applyInlineToggle(command) {
        if (!currentActiveEditor) return;
        currentActiveEditor.focus();
        restoreSelection();

        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

        const tag = INLINE_MAP[command];
        if (!tag) return;

        const range = sel.getRangeAt(0);

        // ì´ë¯¸ ì „ë¶€ í•´ë‹¹ íƒœê·¸ë©´ ì–¸ë©, ì•„ë‹ˆë©´ ë©
        if (selectionAllInsideTag(range, tag)) {
          const fragment = range.extractContents();
          unwrapTagFromFragment(fragment, tag);
          range.insertNode(fragment);
        } else {
          const fragment = range.extractContents();
          const wrapper = document.createElement(tag);
          wrapper.appendChild(fragment);
          range.insertNode(wrapper);
          
          // ì„ íƒì„ ë˜í•‘ëœ ë…¸ë“œë¡œ ê°±ì‹ 
          sel.removeAllRanges();
          const newRange = document.createRange();
          newRange.selectNodeContents(wrapper);
          sel.addRange(newRange);
        }

        saveSelection();
        detectStyle();
      }

      /* =========[ ë¸”ë¡ ìŠ¤íƒ€ì¼ ì ìš© (h1 -> h2, h2 -> h3, h3 -> h4, h4 -> h5ë¡œ ë³€ê²½) ]========= */
      function applyStyle(tag) {
        if (!currentActiveEditor) return;
        // h1 ì œê±°, h2ë¶€í„° ì‹œì‘í•˜ë„ë¡ ë³€ê²½
        const blockTags = ['h2', 'h3', 'h4', 'h5', 'p', 'small', 'footer'];

        currentActiveEditor.focus();
        restoreSelection(); 

        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
            document.execCommand("styleWithCSS", false, false);
            document.execCommand('formatBlock', false, `<${tag.toUpperCase()}>`);
            saveSelection();
            setTimeout(detectStyle, 100);
            return;
        }

        const range = sel.getRangeAt(0);
        let commonAncestor = range.commonAncestorContainer;

        if (commonAncestor.nodeType === 3) {
            commonAncestor = commonAncestor.parentNode;
        }

        let targetBlock = commonAncestor;
        while (targetBlock && targetBlock !== currentActiveEditor && !blockTags.includes(targetBlock.tagName.toLowerCase())) {
            targetBlock = targetBlock.parentNode;
        }

        if (targetBlock && targetBlock !== currentActiveEditor && blockTags.includes(targetBlock.tagName.toLowerCase())) {
            const currentTag = targetBlock.tagName.toLowerCase();
            if (currentTag === tag) {
                if (tag === 'p' && sel.isCollapsed) {
                    document.execCommand("styleWithCSS", false, false);
                    document.execCommand("formatBlock", false, '<p>');
                } else if (tag !== 'p') {
                    document.execCommand("styleWithCSS", false, false);
                    document.execCommand("formatBlock", false, '<p>');
                }
                saveSelection();
                setTimeout(detectStyle, 100);
                return;
            }

            document.execCommand("styleWithCSS", false, false);
            document.execCommand("formatBlock", false, `<${tag.toUpperCase()}>`);
        } else {
            try {
                const fragment = range.extractContents(); 
                const newBlock = document.createElement(tag); 
                newBlock.appendChild(fragment); 

                range.insertNode(newBlock); 

                sel.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(newBlock); 
                sel.addRange(newRange);
            } catch (e) {
                console.warn("applyStyle (DOM ì¡°ì‘) ì‹¤íŒ¨, fallback to execCommand:", e);
                document.execCommand("styleWithCSS", false, false);
                document.execCommand("formatBlock", false, `<${tag.toUpperCase()}>`);
            }
        }
        
        saveSelection();
        setTimeout(detectStyle, 100);

        if (!blockTags.includes(tag)) {
            const tempElement = document.createElement(tag);
            if (tag === 'span') tempElement.classList.add('label');
            if (tag === 'strong') tempElement.classList.add('label', 'label-bold');

            const selAfterBlockFormat = window.getSelection();
            if (!selAfterBlockFormat.rangeCount || selAfterBlockFormat.isCollapsed) return;
            const rangeAfterBlockFormat = selAfterBlockFormat.getRangeAt(0);

            try {
                const contents = rangeAfterBlockFormat.extractContents();
                tempElement.appendChild(contents);
                rangeAfterBlockFormat.insertNode(tempElement);

                selAfterBlockFormat.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNode(tempElement);
                selAfterBlockFormat.addRange(newRange);

                saveSelection();
            } catch (e) {
                console.error("applyStyle(span/strong) ì˜¤ë¥˜:", e);
            }
        }
      }

// ğŸ’¡ ìˆ˜ì •ëœ insertImage í•¨ìˆ˜ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„)
function insertImage() {
  const fileInput = document.getElementById('imageUploader');
  // onchange ë¦¬ìŠ¤ë„ˆê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë“±ë¡í•©ë‹ˆë‹¤.
  if (!fileInput.dataset.listenerAttached) {
    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      
      // íŒŒì¼ ì„ íƒ ì·¨ì†Œ ë˜ëŠ” íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°, input ì´ˆê¸°í™” í›„ ì¢…ë£Œ
      if (!file) {
        fileInput.value = ''; 
        return;
      }

      const formData = new FormData();
      formData.append('image', file);

      showCustomMessage("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘..."); // ì—…ë¡œë“œ ì•Œë¦¼ í‘œì‹œ

      try {
        const res = await fetch('/upload/image', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        
        if (!data.success || !data.url) {
          showCustomMessage("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + (data.error || "ì„œë²„ ì˜¤ë¥˜"));
          return;
        }

        // ì´ë¯¸ì§€ ì‚½ì… ë¡œì§
        const blContent = currentActiveEditor.querySelector('.bl-content');
        if (!blContent) {
          showCustomMessage("ì—ë””í„° êµ¬ì¡° ì˜¤ë¥˜: .bl-contentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        restoreSelection(); // ì €ì¥ëœ ì»¤ì„œ ìœ„ì¹˜ ë³µì›

        const img = document.createElement('img');
        img.src = data.url;
        img.alt = file.name; // ì ‘ê·¼ì„± ê°œì„ 
        img.style.maxWidth = "100%";
        img.style.display = "block";
        img.style.margin = "1.2rem 0";

        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          
          // ì´ë¯¸ì§€ ë’¤ì— ìƒˆë¡œìš´ <p> íƒœê·¸ë¥¼ ìƒì„±í•˜ê³  ì»¤ì„œë¥¼ ê·¸ ì•ˆìœ¼ë¡œ ì´ë™
          const p = document.createElement('p');
          p.innerHTML = '<br>';
          
          // ì´ë¯¸ì§€ê°€ ë§ˆì§€ë§‰ ìš”ì†Œê°€ ì•„ë‹ˆë©´ ë‹¤ìŒ ìš”ì†Œ ì•ì— ì‚½ì…
          if (img.nextSibling) {
              img.parentNode.insertBefore(p, img.nextSibling);
          } else {
              img.parentNode.appendChild(p);
          }
          
          // ìƒˆë¡œ ì‚½ì…ëœ <p> íƒœê·¸ ì•ˆìœ¼ë¡œ ì»¤ì„œ ì´ë™
          range.setStart(p.firstChild || p, 0); 
          range.setEnd(p.firstChild || p, 0);
          sel.removeAllRanges();
          sel.addRange(range);
          
        } else {
          // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ bl-content ë§¨ ì•„ë˜ì— ì¶”ê°€
          blContent.appendChild(img);
          blContent.appendChild(document.createElement('p')).innerHTML = '<br>';
        }

        saveSelection();
        showCustomMessage("ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì… ì™„ë£Œ");

      } catch (err) {
        console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", err);
        showCustomMessage("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        // [ê°€ì¥ ì¤‘ìš”] íŒŒì¼ ì…ë ¥ ê°’ ì´ˆê¸°í™”: ì—°ì† ì—…ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡ í•¨
        fileInput.value = ''; 
      }
    };
    // ë¦¬ìŠ¤ë„ˆê°€ ë“±ë¡ë˜ì—ˆìŒì„ í‘œì‹œ
    fileInput.dataset.listenerAttached = 'true';
  }
  
  // onchange ë¦¬ìŠ¤ë„ˆëŠ” ì´ë¯¸ ë“±ë¡ë˜ì—ˆìœ¼ë¯€ë¡œ, clickë§Œ í˜¸ì¶œí•˜ì—¬ íŒŒì¼ ì„ íƒ ì°½ì„ ì—½ë‹ˆë‹¤.
  fileInput.click();
}

// ğŸ’¡ ë™ì˜ìƒ ì—…ë¡œë“œ + ì—ë””í„° ì‚½ì… í•¨ìˆ˜
function insertVideo() {
  const fileInput = document.getElementById('videoUploader');

  if (!fileInput.dataset.listenerAttached) {
    fileInput.onchange = async () => {
      const file = fileInput.files[0];

      if (!file) {
        fileInput.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('video', file);

      showCustomMessage("ë™ì˜ìƒ ì—…ë¡œë“œ ì¤‘...");

      try {
        const res = await fetch('/upload/video', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!data.success || !data.url) {
          showCustomMessage("ë™ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + (data.error || "ì„œë²„ ì˜¤ë¥˜"));
          return;
        }

        restoreSelection();
        const blContent = currentActiveEditor.querySelector('.bl-content');

        const video = document.createElement('video');
        video.src = data.url;
        video.controls = true;
        video.style.maxWidth = "100%";
        video.style.display = "block";
        video.style.margin = "1.4rem 0";

        const sel = window.getSelection();
        const range = sel.rangeCount > 0 ? sel.getRangeAt(0) : null;

        if (range) {
          range.deleteContents();
          range.insertNode(video);

          const p = document.createElement('p');
          p.innerHTML = '<br>';

          if (video.nextSibling)
            video.parentNode.insertBefore(p, video.nextSibling);
          else
            video.parentNode.appendChild(p);

          const newRange = document.createRange();
          newRange.setStart(p.firstChild, 0);
          newRange.collapse(true);
          sel.removeAllRanges();
          sel.addRange(newRange);

        } else {
          blContent.appendChild(video);
          blContent.appendChild(document.createElement('p')).innerHTML = '<br>';
        }

        saveSelection();
        showCustomMessage("ë™ì˜ìƒ ì—…ë¡œë“œ ë° ì‚½ì… ì™„ë£Œ!");

      } catch (err) {
        console.error("ë™ì˜ìƒ ì—…ë¡œë“œ ì˜¤ë¥˜:", err);
        showCustomMessage("ë™ì˜ìƒ ì—…ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ");
      } finally {
        fileInput.value = '';
      }
    };

    fileInput.dataset.listenerAttached = 'true';
  }

  fileInput.click();
}



      function saveContent() {
          showCustomMessage("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
      }

      function toggleDropdown() {
        if (!currentActiveToolbar) return;
        const styleDropdown = currentActiveToolbar.querySelector('.dropdown-menu');
        if (styleDropdown) {
            styleDropdown.classList.toggle('show');
        }
      }

      function updateCurrentStyle(tagName) {
          if (!currentActiveToolbar) return;
          const labelMap = {
              // h1 ì œê±°
              h2: "ì œëª©", // h1 -> h2 (ì œëª©)
              h3: "ë¶€ì œëª©", // h2 -> h3 (ë¶€ì œëª©)
              h4: "ë¨¸ë¦¬ë§ 1", // h3 -> h4
              h5: "ë¹¨ê°„ ë¨¸ë¦¬ë§", // h4 -> h5
              p: "ë³¸ë¬¸",
              small: "ì„¤ëª…",
              footer: "ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§",
              span: "ë ˆì´ë¸”",
              strong: "ì§„í•œ ë ˆì´ë¸”"
          };
          const label = labelMap[tagName.toLowerCase()] || tagName;
          const currentStyleToggle = currentActiveToolbar.querySelector('.dropdown-toggle');
          if (currentStyleToggle) {
              currentStyleToggle.innerText = `${label} â–¼`;
          }
      }

      function detectStyle() {
        if (!currentActiveEditor) return;
        const sel = window.getSelection();
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) {
            updateCurrentStyle('p');
            return;
        }
        let node = sel.getRangeAt(0).startContainer;

        if (node.nodeType === 3) node = node.parentNode;

        while (node && node !== currentActiveEditor) {
          const tag = node.tagName?.toLowerCase();
          // h1 ì œê±°, h2, h3, h4, h5ë¡œ ë³€ê²½
          if (['h2', 'h3', 'h4', 'h5', 'p', 'small', 'footer'].includes(tag)) {
            updateCurrentStyle(tag);
            return;
          }
          node = node.parentNode;
        }
        updateCurrentStyle('p');
      }

      function setColor(command, color) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;

        const range = sel.getRangeAt(0);

        if (color === "__clear__") {
          const tempDiv = document.createElement('div');
          tempDiv.appendChild(range.extractContents());
          
          const spans = tempDiv.querySelectorAll("span");
          spans.forEach(span => {
            if (command === 'foreColor') {
              span.style.color = '';
              if (!span.style.backgroundColor && !span.style.color && !span.classList.length) {
                span.outerHTML = span.innerHTML;
              }
            } else if (command === 'hiliteColor') {
              span.style.backgroundColor = '';
              if (!span.style.backgroundColor && !span.style.color && !span.classList.length) {
                span.outerHTML = span.innerHTML;
              }
            }
          });
          range.insertNode(tempDiv.firstChild);
          return;
        }

        const span = document.createElement("span");
        if (command === "foreColor") span.style.color = color;
        else if (command === "hiliteColor") span.style.backgroundColor = color;

        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);

        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNode(span);
        sel.addRange(newRange);

        saveSelection();
        detectStyle();
      }

      function getCurrentBlockTag() {
        if (!currentActiveEditor) return 'p';
        const sel = window.getSelection();
        if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return 'p';

        let node = sel.getRangeAt(0).startContainer;
        while (node && node !== currentActiveEditor) {
          if (node.nodeType === 1) {
            const tag = node.tagName.toLowerCase();
            // h1 ì œê±°, h2, h3, h4, h5ë¡œ ë³€ê²½
            if (['h2', 'h3', 'h4', 'h5', 'p', 'small', 'footer'].includes(tag)) {
              return tag;
            }
          }
          node = node.parentNode;
        }
        return 'p';
      }

      function createMessageBox(message, isConfirm = false, onConfirm = null) {
          let modal = document.getElementById('customMessageModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customMessageModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p>
                  ${isConfirm ? `
                      <button id="confirmBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                      <button id="cancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
                  ` : `
                      <button id="okBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  `}
              </div>
          `;
          modal.style.display = 'flex';

          if (isConfirm) {
              document.getElementById('confirmBtn').onclick = () => {
                  modal.style.display = 'none';
                  if (onConfirm) onConfirm();
              };
              document.getElementById('cancelBtn').onclick = () => {
                  modal.style.display = 'none';
              };
          } else {
              document.getElementById('okBtn').onclick = () => {
                  modal.style.display = 'none';
                  if (onConfirm) onConfirm();
              };
          }
      }

      function showCustomMessage(message, isConfirm = false, onConfirm = null) {
          createMessageBox(message, isConfirm, onConfirm);
      }

      function showCustomInput(message, onInput) {
          let modal = document.getElementById('customInputModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'customInputModal';
              modal.style = `
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                  align-items: center; z-index: 1000;
              `;
              document.body.appendChild(modal);
          }
          modal.innerHTML = `
              <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
                  <p style="color: black;">${message}</p>
                  <input type="text" id="customInput" style="width: calc(100% - 20px); padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;" />
                  <button id="inputOkBtn" style="padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
                  <button id="inputCancelBtn" style="padding: 8px 15px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
              </div>
          `;
          modal.style.display = 'flex';

          document.getElementById('inputOkBtn').onclick = () => {
              const inputValue = document.getElementById('customInput').value;
              modal.style.display = 'none';
              if (onInput) onInput(inputValue);
          };
          document.getElementById('inputCancelBtn').onclick = () => {
              modal.style.display = 'none';
              if (onInput) onInput(null);
          };
          document.getElementById('customInput').focus();
      }

      window.onclick = function(e) {
          const dropdowns = document.querySelectorAll('.dropdown-menu');
          dropdowns.forEach(d => {
              if (d.classList.contains('show') && !e.target.closest('.dropdown')) {
                  d.classList.remove('show');
              }
          });
      };

      function activateEditor(langCode) {
        // 1) ëª¨ë“  ì–¸ì–´ ë¸”ë¡ ìˆ¨ê¹€ (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ê°•ì œ)
        document.querySelectorAll('.lang-meta-block').forEach(block => {
          block.style.display = 'none';
        });

        // 2) ì„ íƒí•œ ì–¸ì–´ ë¸”ë¡ë§Œ í‘œì‹œ
        const activeLangBlock = document.querySelector(`.lang-meta-block[data-lang="${langCode}"]`);
        if (!activeLangBlock) {
          console.warn('í™œì„±í™”í•  ì–¸ì–´ ë¸”ë¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', langCode);
          return;
        }
        activeLangBlock.style.display = '';

        // 3) í•´ë‹¹ ì–¸ì–´ì˜ ì—ë””í„°/íˆ´ë°”ë§Œ í™œì„±í™”
        const editorDiv = activeLangBlock.querySelector(`#editor_${langCode}`);
        const htmlEditorDiv = activeLangBlock.querySelector(`#htmlEditor_${langCode}`);
        const toolbarDiv = activeLangBlock.querySelector(`.toolbar[data-lang-toolbar="${langCode}"]`);

        currentActiveEditor = editorDiv || null;
        currentActiveHtmlEditor = htmlEditorDiv || null;
        currentActiveToolbar = toolbarDiv || null;

        if (editorDiv) {
          editorDiv.style.display = 'block';
          if (htmlEditorDiv) htmlEditorDiv.style.display = 'none';
          editorDiv.focus();
          detectStyle();
        }
      }


      window.addEventListener('DOMContentLoaded', () => {
          fetch(`/api/categories?lang=${CURRENT_PAGE_LANG}`)
            .then(res => res.json())
            .then(data => {
              categories = data.categories || [];
              renderCategories();
            })
            .catch(err => {
              console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
              categories = ['ì¼ìƒ', 'ê¸°ë¡', 'ë¦¬ë·°'];
              renderCategories();
            });
          document.getElementById('langSelector').value = CURRENT_PAGE_LANG;
          activateEditor(CURRENT_PAGE_LANG);

          const languageEditors = document.querySelectorAll('.language-editor');
          languageEditors.forEach(editor => {
              editor.addEventListener('keyup', detectStyle);
              editor.addEventListener('mouseup', detectStyle);
              editor.addEventListener('mouseup', saveSelection);
              editor.addEventListener('keyup', saveSelection);
              editor.addEventListener('focus', () => {
                  const langCode = editor.dataset.langEditor;
                  currentActiveEditor = editor;
                  currentActiveHtmlEditor = document.getElementById(`htmlEditor_${langCode}`);
                  currentActiveToolbar = document.querySelector(`.toolbar[data-lang-toolbar="${langCode}"]`);
                  if (currentActiveHtmlEditor && currentActiveHtmlEditor.style.display !== 'none') {
                      switchToDesignMode(); 
                  }
                  detectStyle();
              });

              // [ì¶”ê°€] ì–¸ì–´ ë³€ê²½ ì‹œ í•´ë‹¹ ë¸”ë¡ë§Œ ë³´ì´ë„ë¡ í˜¸ì¶œ
              const langSelectorEl = document.getElementById('langSelector');
              if (langSelectorEl) {
                langSelectorEl.addEventListener('change', (e) => {
                  activateEditor(e.target.value);
                });
              }
          });

          document.querySelectorAll('.toolbar').forEach(toolbar => {
            toolbar.addEventListener('mousedown', (event) => {
                const button = event.target.closest('button, .dropdown-toggle, [data-style-command], [data-color-btn]');
                if (button) {
                    event.preventDefault(); // í¬ì»¤ìŠ¤ ì´ë™ìœ¼ë¡œ ì„ íƒë²”ìœ„ ë‚ ì•„ê°€ëŠ” ê²ƒ ë°©ì§€
                    saveSelection();       // ë²„íŠ¼ ëˆ„ë¥´ëŠ” ì°°ë‚˜ì˜ ì„ íƒë²”ìœ„ ì €ì¥ (ì •/ì—­ë°©í–¥ ëª¨ë‘)
                }
            });
            toolbar.addEventListener('click', (event) => {
                const styleDropdownToggle = event.target.closest('.dropdown-toggle');
                const commandButton = event.target.closest('button[data-command]');
                const styleCommandElement = event.target.closest('[data-style-command]');
                const colorButton = event.target.closest('[data-color-btn]');

                if (currentActiveEditor) {
                    currentActiveEditor.focus();
                    restoreSelection();
                }

                if (styleCommandElement) {
                    const styleCommand = styleCommandElement.dataset.styleCommand;
                    applyStyle(styleCommand);
                    const styleDropdown = styleCommandElement.closest('.dropdown-menu');
                    if (styleDropdown) styleDropdown.classList.remove('show');
                } else if (commandButton) {
                    const command = commandButton.dataset.command;

                    // ì¸ë¼ì¸ ëª…ë ¹ì€ ì»¤ìŠ¤í…€ í† ê¸€ ì‚¬ìš© (ì—­ë°©í–¥ ì„ íƒ ì´ìŠˆ í•´ê²°)
                    if (['bold','italic','underline','strikeThrough'].includes(command)) {
                      applyInlineToggle(command);
                    } else {
                      switch (command) {
                        case 'insertTOC':
                            insertTOC();
                            break;
                        case 'createLink':
                            showCustomInput("ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:", (url) => {
                                if (url) format('createLink', url);
                            });
                            break;
                        case 'insertImage':
                            insertImage();
                            break;
                        case 'insertVideo':
                            insertVideo();
                            break;
                        case 'openHtmlPopup':
                            showCustomMessage("HTML ì‚½ì… ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                            break;
                        case 'removeFormat':
                            format('removeFormat');
                            break;
                        default:
                            format(command);
                            break;
                      }
                    }
                } else if (styleDropdownToggle) {
                    toggleDropdown();
                }

                const clickedColorBtn = event.target.closest('[data-color-btn]');
                if (clickedColorBtn) {
                    const colorPalette = clickedColorBtn.closest('[data-color-tool]').querySelector('[data-color-palette]');
                    if (colorPalette) colorPalette.classList.toggle('show');
                    event.stopPropagation();
                }
            });

            toolbar.querySelectorAll('[data-color-palette] button').forEach(colorBtn => {
                colorBtn.addEventListener('click', (e) => {
                    const command = colorBtn.closest('[data-color-tool]').dataset.colorTool;
                    const value = colorBtn.dataset.colorValue;
                    setColor(command, value);
                    e.target.closest('[data-color-palette]').classList.remove('show'); 
                });
            });
            toolbar.querySelectorAll('[data-color-input]').forEach(colorInput => {
                colorInput.addEventListener('change', (e) => {
                    const command = colorInput.closest('[data-color-tool]').dataset.colorTool;
                    setColor(command, e.target.value);
                    e.target.closest('[data-color-palette]').classList.remove('show'); 
                });
            });
          });

          document.querySelectorAll('[data-mode-toggle]').forEach(button => {
            button.addEventListener('click', (event) => {
              const mode = event.target.dataset.modeToggle;
              if (mode === 'design') {
                switchToDesignMode();
              } else if (mode === 'html') {
                switchToHtmlMode();
              }
            });
          });
      });

      function insertTOC() {
        if (!currentActiveEditor) {
            showCustomMessage("ì—ë””í„°ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }
        const blContentDiv = currentActiveEditor.querySelector('.bl-content');
        if (!blContentDiv) {
            showCustomMessage("ì—ë””í„° ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return;
        }
        // h1 ëŒ€ì‹  h2, h3ë¥¼ ëª©ì°¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
        const headings = blContentDiv.querySelectorAll("h2, h3");
        if (!headings.length) {
            showCustomMessage("ì œëª©(h2)ì´ë‚˜ ë¶€ì œëª©(h3)ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        const oldTOC = blContentDiv.querySelector(".auto-toc");
        if (oldTOC) oldTOC.remove();
        const tocWrapper = document.createElement("div");
        tocWrapper.className = "auto-toc";
        tocWrapper.contentEditable = "false";
        const tocTitle = document.createElement("strong");
        tocTitle.className = "toc-title";
        tocTitle.textContent = "ğŸ“‘ ëª©ì°¨";
        const tocList = document.createElement("ul");
        tocList.className = "toc-list";
        tocList.style.margin = "0";
        tocList.style.padding = "0";
        let h2Count = 0; // ìµœìƒìœ„ ì œëª©ì€ h2
        let h3Count = 0;
        headings.forEach(el => {
            const tag = el.tagName.toLowerCase();
            let number = "";
            if (tag === "h2") {
                h2Count++;
                h3Count = 0;
                number = `${h2Count}.`;
            } else if (tag === "h3") {
                h3Count++;
                number = `${h2Count}.${h3Count}`;
            }
            const id = `toc-${number.replace(/\./g, "-")}`;
            el.id = id;
            const li = document.createElement("li");
            li.className = `toc-item toc-${tag}`;
            const a = document.createElement("a");
            a.href = `#${id}`;
            a.textContent = `${number} ${el.textContent.trim()}`;
            a.onclick = function(e) {
                e.preventDefault();
                document.getElementById(id)?.scrollIntoView({ behavior: "smooth" });
            };
            li.appendChild(a);
            tocList.appendChild(li);
        });
        tocWrapper.appendChild(tocTitle);
        tocWrapper.appendChild(tocList);
        blContentDiv.prepend(tocWrapper);
      }

      function switchToHtmlMode() {
        if (!currentActiveEditor || !currentActiveHtmlEditor || !currentActiveToolbar) {
            console.error("HTML ëª¨ë“œ ì „í™˜ ì‹¤íŒ¨: í™œì„± ì—ë””í„° ë˜ëŠ” íˆ´ë°” ì—†ìŒ");
            return;
        }
        let currentContent = currentActiveEditor.innerHTML.trim();
        const isWrapped = currentContent.startsWith('<div class="bl-content"');
        if (!isWrapped) {
            if (!currentContent || currentContent === '<p><br></p>' || currentContent === '<div><br></div>') {
                currentContent = '<p><br></p>';
            }
            currentContent = `
<div class="bl-content" style="white-space:normal; line-height: 1.7;">
${currentContent}
</div>`.trim();
        }
        currentActiveHtmlEditor.value = html_beautify(currentContent, {
            indent_size: 2,
            wrap_attributes: 'auto',
            indent_with_tabs: false
        });
        currentActiveEditor.style.display = 'none';
        currentActiveHtmlEditor.style.display = 'block';
        currentActiveToolbar.style.display = 'none';
      }

      function switchToDesignMode() {
        if (!currentActiveEditor || !currentActiveHtmlEditor || !currentActiveToolbar) {
            console.error("ë””ìì¸ ëª¨ë“œ ì „í™˜ ì‹¤íŒ¨: í™œì„± ì—ë””í„° ë˜ëŠ” íˆ´ë°” ì—†ìŒ");
            return;
        }
        let rawHtml = currentActiveHtmlEditor.value.trim();
        if (!rawHtml.startsWith('<div class="bl-content"')) {
            rawHtml = `<div class="bl-content" style="white-space:normal; line-height: 1.7;">${rawHtml}</div>`;
        }
        currentActiveEditor.innerHTML = rawHtml;
        currentActiveHtmlEditor.style.display = 'none';
        currentActiveEditor.style.display = 'block';
        currentActiveToolbar.style.display = 'flex';
        currentActiveEditor.focus();
        detectStyle();
      }
  </script>
<%- include('partials/footer') %>
<%- include('partials/scripts') %>
<input type="file" id="imageUploader" accept="image/*" style="display:none;">
<input type="file" id="videoUploader" accept="video/*" style="display:none;">
</body>
</html>