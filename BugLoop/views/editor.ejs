<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="/assets/css/editor.css" />
  <title>BlindLove ì—ë””í„°</title>
  <%- include('partials/head') %>
  <% if (user) { %>
    <meta name="author" content="<%= user.nickname %>">
  <% } %>
  <style>
    .editor-toolbar.is-hidden { display: none !important; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/style.css" />
</head>
<body class="edit-body">
  <div id="preloader"><div class="spinner"></div></div>
  <%- include('partials/header') %>
  <% const isEdit = typeof post !== 'undefined' && post !== null; %>

  <% if (user) { %>
    <div style="text-align:center;font-weight:bold;margin-top:3rem;">
      <%= user.nickname %>ë‹˜, ì—ë””í„°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!
    </div>
  <% } %>

  <div class="editor-container">
    <div class="logo-wrap">
      <a href="/<%= lang %>/"><img src="/assets/images/logo.png" alt="BlindLove ë¡œê³ " /></a>
    </div>

    <div class="lang-selector-wrap">
      <label for="langSelector">í¸ì§‘ ì¤‘ì¸ ì–¸ì–´</label>
      <select id="langSelector">
        <%
          const langLabels = { ko:'í•œêµ­ì–´', en:'English', fr:'FranÃ§ais', zh:'ä¸­æ–‡', ja:'æ—¥æœ¬èª' };
          supportedLangs.forEach(function(langCode){
        %>
          <option value="<%= langCode %>" <%= lang === langCode ? 'selected' : '' %>><%= langLabels[langCode] %></option>
        <% }); %>
      </select>
    </div>

    <%
      const langList = [
        { code:'ko', label:'í•œêµ­ì–´' },
        { code:'en', label:'English' },
        { code:'fr', label:'FranÃ§ais' },
        { code:'zh', label:'ç®€ä½“ä¸­æ–‡' },
        { code:'ja', label:'æ—¥æœ¬èª' }
      ];
    %>

    <% langList.forEach(function(_l){ const code=_l.code; const label=_l.label; %>
      <div class="lang-meta-block" data-lang="<%= code %>" style="<%= code === lang ? '' : 'display:none;' %>">
        <div class="title-wrap">
          <input type="text" name="title_<%= code %>" placeholder="<%= label %> ì œëª©" value="<%= post && post[code] ? (post[code].title || '') : '' %>" />
        </div>

        <div class="toolbar editor-toolbar" data-lang-toolbar="<%= code %>">
          <div class="dropdown">
            <div class="dropdown-toggle" data-style-toggle="<%= code %>">ë³¸ë¬¸ â–¼</div>
            <div class="dropdown-menu" data-style-dropdown="<%= code %>">
              <div class="h1" data-style-command="h1">ì œëª©</div>
              <div class="h2" data-style-command="h2">ë¶€ì œëª©</div>
              <div class="h3" data-style-command="h3">ë¨¸ë¦¬ë§ 1</div>
              <div class="red" data-style-command="h4">ë¹¨ê°„ ë¨¸ë¦¬ë§</div>
              <div class="p" data-style-command="p">ë³¸ë¬¸</div>
              <div class="desc" data-style-command="small">ì„¤ëª…</div>
              <div class="meta" data-style-command="footer">ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§</div>
              <div class="label" data-style-command="span">ë ˆì´ë¸”</div>
              <div class="label label-bold" data-style-command="strong">ì§„í•œ ë ˆì´ë¸”</div>
            </div>
          </div>
          <button data-command="insertTOC" data-tooltip="ëª©ì°¨ ì‚½ì…">ğŸ“‘ ëª©ì°¨</button>
          <button data-command="bold" data-tooltip="êµµê²Œ"><b>B</b></button>
          <button data-command="italic" data-tooltip="ê¸°ìš¸ì´ê¸°"><i>I</i></button>
          <button data-command="underline" data-tooltip="ë°‘ì¤„"><u>U</u></button>
          <button data-command="strikeThrough" data-tooltip="ì·¨ì†Œì„ "><s>S</s></button>
          <button data-command="justifyLeft" data-tooltip="ì™¼ìª½ ì •ë ¬"><i class="fas fa-align-left"></i></button>
          <button data-command="justifyCenter" data-tooltip="ê°€ìš´ë° ì •ë ¬"><i class="fas fa-align-center"></i></button>
          <button data-command="justifyRight" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fas fa-align-right"></i></button>
          <button data-command="insertOrderedList" data-tooltip="ë²ˆí˜¸ ëª©ë¡"><i class="fas fa-list-ol"></i></button>
          <button data-command="insertUnorderedList" data-tooltip="ê¸€ë¨¸ë¦¬ ê¸°í˜¸"><i class="fas fa-list-ul"></i></button>
          <button data-command="outdent" data-tooltip="ë‚´ì–´ì“°ê¸°"><i class="fas fa-outdent"></i></button>
          <button data-command="indent" data-tooltip="ë“¤ì—¬ì“°ê¸°"><i class="fas fa-indent"></i></button>
          <button data-command="createLink" data-tooltip="ë§í¬ ì‚½ì…"><i class="fas fa-link"></i></button>
          <button data-command="unlink" data-tooltip="ë§í¬ ì œê±°"><i class="fas fa-unlink"></i></button>

          <div class="color-tool" data-color-tool="foreColor">
            <button data-color-btn="foreColor" data-tooltip="ê¸€ì ìƒ‰ìƒ"><i class="fas fa-pencil-alt"></i></button>
            <div class="color-palette" data-color-palette="foreColor">
              <button style="background:black" data-color-value="black"></button>
              <button style="background:red" data-color-value="red"></button>
              <button style="background:orange" data-color-value="orange"></button>
              <button style="background:green" data-color-value="green"></button>
              <button style="background:blue" data-color-value="blue"></button>
              <button class="none-icon" data-color-value="__clear__" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">ğŸ¨<input type="color" data-color-input="foreColor" /></label>
            </div>
          </div>

          <div class="color-tool" data-color-tool="hiliteColor">
            <button data-color-btn="hiliteColor" data-tooltip="ë°°ê²½ ìƒ‰ìƒ"><i class="fas fa-fill-drip"></i></button>
            <div class="color-palette" data-color-palette="hiliteColor">
              <button style="background:yellow" data-color-value="yellow"></button>
              <button style="background:lightblue" data-color-value="lightblue"></button>
              <button style="background:lightgreen" data-color-value="lightgreen"></button>
              <button style="background:pink" data-color-value="pink"></button>
              <button style="background:#ccc" data-color-value="#ccc"></button>
              <button class="none-icon" data-color-value="__clear__" title="ìƒ‰ ì—†ìŒ"></button>
              <label class="custom-color">ğŸ¨<input type="color" data-color-input="hiliteColor" /></label>
            </div>
          </div>
          <button data-command="openHtmlPopup" data-tooltip="HTML ì‚½ì…"><i class="fas fa-code"></i></button>
          <button data-command="insertImage" data-tooltip="ì´ë¯¸ì§€ ì‚½ì…"><i class="fas fa-image"></i></button>
          <button data-command="removeFormat" data-tooltip="í˜•ì‹ ì œê±°">ì§€ìš°ê¸°</button>
        </div>

        <% if (user && Number(user.is_admin) === 1) { %>
        <div class="mode-toggle">
          <button data-mode-toggle="design">ë””ìì¸ ëª¨ë“œ</button>
          <button data-mode-toggle="html">HTML ëª¨ë“œ</button>
        </div>
        <% } %>

        <div class="editor-area-wrapper">
          <div id="editor_<%= code %>"
               contenteditable="true"
               class="editor language-editor"
               spellcheck="false"
               data-lang-editor="<%= code %>"
               style="<%= code === lang ? '' : 'display:none;' %>">
            <%
              var initialContent = (post && post[code] && post[code].content) ? post[code].content : '<p><br></p>';
              var isWrapped = initialContent.indexOf('<div class="bl-content"') === 0;
              if (!isWrapped) {
                initialContent =
                  '<div class="bl-content" style="white-space:normal; line-height: 1.7;">' +
                  initialContent +
                  '</div>';
              }
            %>
            <%- initialContent %>
          </div>
          <textarea id="htmlEditor_<%= code %>" class="editor html-editor" style="display:none;"></textarea>
        </div>

        <div class="global-options" style="margin-top:2rem;">
          <label style="margin-right:2rem;">
            <input type="checkbox" id="isPrivateCheckbox" name="is_private" value="1" <%= post && post.is_private ? 'checked' : '' %> />
            ğŸ”’ ë¹„ê³µê°œ ê¸€ë¡œ ì„¤ì •
          </label>
          <% if (user && Number(user.is_admin) === 1) { %>
          <label>
            <input type="checkbox" id="isPinnedCheckbox" name="is_pinned" value="1" <%= post && post.is_pinned ? 'checked' : '' %> />
            ğŸ“Œ ìƒë‹¨ì— ê³ ì •í•˜ê¸°
          </label>
          <% } %>
        </div>
      </div>
    <% }); %>

    <div class="category-box">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ:</label>
      <div class="category-list" id="categoryList"></div>
      <button class="bl-button add" onclick="addCategory()">+ ì¶”ê°€</button>
    </div>

    <div class="save-button-wrap">
      <button type="button" class="bl-button save" onclick="postContent()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script>
    // --- ì´ˆê¸° ì„ íƒ ì¹´í…Œê³ ë¦¬ (ë¬¸ìì—´/ë°°ì—´ ëª¨ë‘ ì§€ì›)
    var selectedCategories = [];
    <% if (post && post.categories) { %>
      (function(){
        var __postCats = <%- JSON.stringify(post.categories) %>;
        selectedCategories = (Array.isArray(__postCats) ? __postCats : String(__postCats).split(','))
          .map(function(s){ return String(s).trim(); })
          .filter(function(v){ return !!v; });
      })();
    <% } %>

    // --- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ì¹´í…Œê³ ë¦¬(ë²ˆì—­ ë¬¸ìì—´). categories ë¯¸ì „ë‹¬ ëŒ€ë¹„ ë°©ì–´
    var categories = <%- JSON.stringify((typeof categories !== 'undefined' && categories
      ? categories.map(function(c){ return c.translated; })
      : [])) %>;

    var savedRange = null;
    var currentActiveEditor = null;
    var currentActiveHtmlEditor = null;
    var currentActiveToolbar = null;

    var langList = [
      { code:'ko', label:'í•œêµ­ì–´' },
      { code:'en', label:'English' },
      { code:'fr', label:'FranÃ§ais' },
      { code:'zh', label:'ç®€ä½“ä¸­æ–‡' },
      { code:'ja', label:'æ—¥æœ¬èª' }
    ];

    var IS_EDIT_PAGE = <%- isEdit ? 'true' : 'false' %>;
    var POST_ID = <%- (post && post.id) ? JSON.stringify(post.id) : 'null' %>;
    var CURRENT_PAGE_LANG = '<%= lang %>';

    function hidePreloader(){
      var preloader = document.getElementById('preloader');
      if (preloader) preloader.style.display = 'none';
    }

    function createMessageBox(message, isConfirm, onConfirm){
      var modal = document.getElementById('customMessageModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customMessageModal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;width:100%;height:100%;' +
          'background:rgba(0,0,0,0.5);display:none;justify-content:center;' +
          'align-items:center;z-index:1000;';
        document.body.appendChild(modal);
      }
      var inner = ''
        + '<div style="background:white;padding:20px;border-radius:8px;'
        + 'box-shadow:0 4px 8px rgba(0,0,0,0.1);max-width:400px;width:90%;text-align:center;">'
        +   '<p style="color:black;">' + String(message) + '</p>'
        +   (isConfirm
              ? ('<button id="confirmBtn" style="padding:8px 15px;margin:5px;background-color:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">í™•ì¸</button>'
                + '<button id="cancelBtn" style="padding:8px 15px;margin:5px;background-color:#6c757d;color:white;border:none;border-radius:5px;cursor:pointer;">ì·¨ì†Œ</button>')
              : ('<button id="okBtn" style="padding:8px 15px;margin:5px;background-color:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">í™•ì¸</button>')
            )
        + '</div>';
      modal.innerHTML = inner;
      modal.style.display = 'flex';

      if (isConfirm){
        document.getElementById('confirmBtn').onclick = function(){
          modal.style.display = 'none';
          if (onConfirm) onConfirm();
        };
        document.getElementById('cancelBtn').onclick = function(){
          modal.style.display = 'none';
        };
      } else {
        document.getElementById('okBtn').onclick = function(){
          modal.style.display = 'none';
          if (onConfirm) onConfirm();
        };
      }
    }
    function showCustomMessage(msg, isConfirm, onConfirm){ createMessageBox(msg, !!isConfirm, onConfirm); }

    function showCustomInput(message, onInput){
      var modal = document.getElementById('customInputModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customInputModal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;width:100%;height:100%;' +
          'background:rgba(0,0,0,0.5);display:none;justify-content:center;' +
          'align-items:center;z-index:1000;';
        document.body.appendChild(modal);
      }
      var inner = ''
        + '<div style="background:white;padding:20px;border-radius:8px;'
        + 'box-shadow:0 4px 8px rgba(0,0,0,0.1);max-width:400px;width:90%;text-align:center;">'
        +   '<p style="color:black;">' + String(message) + '</p>'
        +   '<input type="text" id="customInput" style="width:calc(100% - 20px);padding:8px;margin:10px 0;border:1px solid #ccc;border-radius:4px;" />'
        +   '<button id="inputOkBtn" style="padding:8px 15px;margin:5px;background-color:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">í™•ì¸</button>'
        +   '<button id="inputCancelBtn" style="padding:8px 15px;margin:5px;background-color:#6c757d;color:white;border:none;border-radius:5px;cursor:pointer;">ì·¨ì†Œ</button>'
        + '</div>';
      modal.innerHTML = inner;
      modal.style.display = 'flex';

      document.getElementById('inputOkBtn').onclick = function(){
        var inputValue = document.getElementById('customInput').value;
        modal.style.display = 'none';
        if (onInput) onInput(inputValue);
      };
      document.getElementById('inputCancelBtn').onclick = function(){
        modal.style.display = 'none';
        if (onInput) onInput(null);
      };
      document.getElementById('customInput').focus();
    }

    function renderCategories(){
      var list = document.getElementById('categoryList');
      list.innerHTML = '';
      categories.forEach(function(cat, index){
        var item = document.createElement('div');
        item.className = 'category-item';
        if (selectedCategories.indexOf(cat) !== -1) item.classList.add('selected');
        item.innerText = cat;

        item.onclick = function(){
          var i = selectedCategories.indexOf(cat);
          if (i === -1) selectedCategories.push(cat);
          else selectedCategories.splice(i, 1);
          renderCategories();
        };

        var removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerText = 'Ã—';
        removeBtn.onclick = function(e){
          e.stopPropagation();
          showCustomMessage("'" + cat + "' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", true, function(){
            fetch('/api/categories/' + encodeURIComponent(cat), { method:'DELETE' })
              .then(function(res){ if(!res.ok) throw new Error('Network response was not ok'); return res.json(); })
              .then(function(data){
                if (data && data.success){
                  categories.splice(index, 1);
                  selectedCategories = selectedCategories.filter(function(c){ return c !== cat; });
                  renderCategories();
                  showCustomMessage('ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                  showCustomMessage('ì‚­ì œ ì‹¤íŒ¨: ' + (data && data.error ? data.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
              })
              .catch(function(err){
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                showCustomMessage('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              });
          });
        };

        item.appendChild(removeBtn);
        list.appendChild(item);
      });
    }

    function addCategory(){
      showCustomInput('ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', function(newCat){
        newCat = newCat ? String(newCat).trim() : '';
        if (!newCat || categories.indexOf(newCat) !== -1) return;

        fetch('/api/categories', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ name:newCat })
        })
        .then(function(res){ if(!res.ok) throw new Error('Network response was not ok'); return res.json(); })
        .then(function(data){
          if (data && data.success){
            categories.push(newCat);
            renderCategories();
            showCustomMessage('ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            showCustomMessage('ì¶”ê°€ ì‹¤íŒ¨: ' + (data && data.error ? data.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        })
        .catch(function(err){
          console.error('ì¶”ê°€ ì˜¤ë¥˜:', err);
          showCustomMessage('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      });
    }

    function postContent(){
      var postData = {
        categories: selectedCategories,
        is_private: document.getElementById('isPrivateCheckbox') && document.getElementById('isPrivateCheckbox').checked ? 1 : 0,
        is_pinned: document.getElementById('isPinnedCheckbox') && document.getElementById('isPinnedCheckbox').checked ? 1 : 0,
        lang_content: {}
      };

      langList.forEach(function(l){
        var code = l.code;
        var titleInput = document.querySelector('input[name="title_' + code + '"]');
        var editorDiv = document.getElementById('editor_' + code);
        var htmlEditorDiv = document.getElementById('htmlEditor_' + code);
        if (!titleInput || !editorDiv || !htmlEditorDiv) return;

        var contentToSave = '';
        if (htmlEditorDiv.style.display === 'block'){
          contentToSave = (htmlEditorDiv.value || '').trim();
        } else {
          var blContent = editorDiv.querySelector('.bl-content');
          contentToSave = blContent ? (blContent.innerHTML || '').trim() : (editorDiv.innerHTML || '').trim();
        }
        if (!contentToSave || contentToSave === '<div><br></div>' || contentToSave === '<p><br></p>'){
          contentToSave = '';
        }
        postData.lang_content[code] = { title: (titleInput.value || '').trim(), content: contentToSave };
      });

      // í•œêµ­ì–´ ì œëª© í•„ìˆ˜
      var defaultLangTitle = (postData.lang_content['ko'] && postData.lang_content['ko'].title) ? postData.lang_content['ko'].title : '';
      if (!defaultLangTitle){ return showCustomMessage('í•œêµ­ì–´ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); }

      if (!postData.categories || postData.categories.length === 0){
        return showCustomMessage('ìµœì†Œ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }

      // ì„œë²„ ë¼ìš°íŠ¸ì— ë§ê²Œ ì–¸ì–´ ì ‘ë‘ì–´ ì œê±°
      var submitUrl = (IS_EDIT_PAGE && POST_ID) ? ('/edit/' + POST_ID) : '/savePost';

      fetch(submitUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        credentials:'same-origin',
        body: JSON.stringify(postData)
      })
      .then(function(res){ return res.json().then(function(j){ return { ok:res.ok, data:j }; }); })
      .then(function(r){
        if (!r.ok || !r.data || !r.data.success){
          throw new Error(r.data && r.data.error ? r.data.error : 'ì €ì¥ ì‹¤íŒ¨');
        }
        showCustomMessage('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', false, function(){
          if (IS_EDIT_PAGE && POST_ID){
            window.location.href = r.data.redirect || ('/' + CURRENT_PAGE_LANG + '/post/' + POST_ID);
          } else if (r.data.postId){
            window.location.href = '/' + CURRENT_PAGE_LANG + '/post/' + r.data.postId;
          } else {
            window.location.href = '/' + CURRENT_PAGE_LANG + '/';
          }
        });
      })
      .catch(function(err){
        console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', err);
        showCustomMessage(err && err.message ? err.message : 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    function format(command, value){
      if (!currentActiveEditor) return;
      currentActiveEditor.focus();
      document.execCommand(command, false, value || null);
      setTimeout(detectStyle, 100);
    }

    function applyStyle(tag){
      if (!currentActiveEditor) return;
      var blockTags = ['h1','h2','h3','h4','p','small','footer'];
      var inlineTags = ['span','strong'];

      currentActiveEditor.focus();
      restoreSelection();

      var sel = window.getSelection();
      var range = sel.rangeCount > 0 ? sel.getRangeAt(0) : null;
      if (!range || sel.isCollapsed || !currentActiveEditor.contains(range.commonAncestorContainer)){
        document.execCommand('styleWithCSS', false, false);
        document.execCommand('formatBlock', false, '<' + tag.toUpperCase() + '>');
        saveSelection();
        setTimeout(detectStyle, 100);
        return;
      }

      document.execCommand('styleWithCSS', false, false);
      if (blockTags.indexOf(tag) !== -1){
        document.execCommand('formatBlock', false, '<' + tag.toUpperCase() + '>');
      } else if (inlineTags.indexOf(tag) !== -1){
        if (tag === 'span'){ document.execCommand('bold', false, null); }
        else { format(tag); }
      }
      saveSelection();
      setTimeout(detectStyle, 100);
    }

    function insertImage(){
      showCustomInput('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:', function(url){
        if (url) format('insertImage', url);
      });
    }

    function toggleDropdown(){
      if (!currentActiveToolbar) return;
      var styleDropdown = currentActiveToolbar.querySelector('.dropdown-menu');
      if (styleDropdown){ styleDropdown.classList.toggle('show'); }
      document.querySelectorAll('.dropdown-menu').forEach(function(d){
        if (d !== styleDropdown) d.classList.remove('show');
      });
    }

    function updateCurrentStyle(tagName){
      if (!currentActiveToolbar) return;
      var labelMap = { h1:'ì œëª©', h2:'ë¶€ì œëª©', h3:'ë¨¸ë¦¬ë§ 1', h4:'ë¹¨ê°„ ë¨¸ë¦¬ë§', p:'ë³¸ë¬¸', small:'ì„¤ëª…', footer:'ë¨¸ë¦¬ë§ ë° ê¼¬ë¦¬ë§', span:'ë ˆì´ë¸”', strong:'ì§„í•œ ë ˆì´ë¸”' };
      var label = labelMap[String(tagName).toLowerCase()] || tagName;
      var currentStyleToggle = currentActiveToolbar.querySelector('.dropdown-toggle');
      if (currentStyleToggle){ currentStyleToggle.innerText = label + ' â–¼'; }
    }

    function detectStyle(){
      if (!currentActiveEditor) return;
      var sel = window.getSelection();
      if (!sel.rangeCount || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)){
        updateCurrentStyle('p'); return;
      }
      var node = sel.getRangeAt(0).startContainer;
      if (node.nodeType === 3) node = node.parentNode;
      while (node && node !== currentActiveEditor){
        var tag = node.tagName ? node.tagName.toLowerCase() : '';
        if (['h1','h2','h3','h4','p','small','footer','div'].indexOf(tag) !== -1){
          updateCurrentStyle(tag); return;
        }
        node = node.parentNode;
      }
      updateCurrentStyle('p');
    }

    function saveSelection(){
      var sel = window.getSelection();
      if (sel.rangeCount > 0 && currentActiveEditor && currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)){
        savedRange = sel.getRangeAt(0).cloneRange();
      } else { savedRange = null; }
    }
    function restoreSelection(){
      var sel = window.getSelection();
      if (savedRange && currentActiveEditor){ sel.removeAllRanges(); sel.addRange(savedRange); }
    }

    function setColor(command, color){
      restoreSelection();
      var sel = window.getSelection();
      if (!sel.rangeCount || sel.isCollapsed || !currentActiveEditor || !currentActiveEditor.contains(sel.getRangeAt(0).commonAncestorContainer)) return;
      if (color === '__clear__'){ document.execCommand(command, false, 'transparent'); return; }
      document.execCommand('styleWithCSS', false, true);
      document.execCommand(command, false, color);
      document.execCommand('styleWithCSS', false, false);
      saveSelection(); detectStyle();
    }

    function insertTOC(){
      if (!currentActiveEditor){ showCustomMessage('ì—ë””í„°ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
      var blContentDiv = currentActiveEditor.querySelector('.bl-content');
      if (!blContentDiv){ showCustomMessage('ì—ë””í„° ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

      var headings = blContentDiv.querySelectorAll('h1, h2');
      if (!headings.length){ showCustomMessage('ì œëª©(h1)ì´ë‚˜ ë¶€ì œëª©(h2)ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      var oldTOC = blContentDiv.querySelector('.auto-toc');
      if (oldTOC) oldTOC.parentNode.removeChild(oldTOC);

      var tocWrapper = document.createElement('div');
      tocWrapper.className = 'auto-toc';
      tocWrapper.contentEditable = 'false';

      var tocTitle = document.createElement('strong');
      tocTitle.className = 'toc-title';
      tocTitle.textContent = 'ğŸ“‘ ëª©ì°¨';

      var tocList = document.createElement('ul');
      tocList.className = 'toc-list';
      tocList.style.margin = '0';
      tocList.style.padding = '0';

      var h1Count = 0, h2Count = 0;
      Array.prototype.forEach.call(headings, function(el){
        var tag = el.tagName.toLowerCase();
        var number = '';
        if (tag === 'h1'){ h1Count++; h2Count = 0; number = h1Count + '.'; }
        else if (tag === 'h2'){ h2Count++; number = h1Count + '.' + h2Count; }
        var id = 'toc-' + number.replace(/\./g, '-');
        el.id = id;

        var li = document.createElement('li');
        li.className = 'toc-item toc-' + tag;

        var a = document.createElement('a');
        a.href = '#' + id;
        a.textContent = number + ' ' + (el.textContent || '').trim();
        a.onclick = function(e){ e.preventDefault(); var t=document.getElementById(id); if(t){ t.scrollIntoView({behavior:'smooth'});} };
        li.appendChild(a);
        tocList.appendChild(li);
      });

      tocWrapper.appendChild(tocTitle);
      tocWrapper.appendChild(tocList);
      blContentDiv.insertBefore(tocWrapper, blContentDiv.firstChild);
    }

    function activateEditor(langCode){
      Array.prototype.forEach.call(document.querySelectorAll('.lang-meta-block'), function(block){ block.style.display='none'; });
      var activeLangBlock = document.querySelector('.lang-meta-block[data-lang="' + langCode + '"]');
      if (activeLangBlock){
        activeLangBlock.style.display = '';
        var editorDiv = document.getElementById('editor_' + langCode);
        var htmlEditorDiv = document.getElementById('htmlEditor_' + langCode);
        var toolbarDiv = document.querySelector('.toolbar[data-lang-toolbar="' + langCode + '"]');

        currentActiveEditor = editorDiv;
        currentActiveHtmlEditor = htmlEditorDiv;
        currentActiveToolbar = toolbarDiv;

        if (editorDiv){
          editorDiv.style.display='block';
          htmlEditorDiv.style.display='none';
          if (toolbarDiv){ toolbarDiv.classList.remove('is-hidden'); }
          editorDiv.focus(); detectStyle();
        }
      }
    }

    window.addEventListener('DOMContentLoaded', function(){
      renderCategories();
      hidePreloader();
      document.getElementById('langSelector').value = CURRENT_PAGE_LANG;
      activateEditor(CURRENT_PAGE_LANG);

      document.getElementById('langSelector').addEventListener('change', function(e){
        activateEditor(e.target.value);
      });

      Array.prototype.forEach.call(document.querySelectorAll('.language-editor'), function(editor){
        editor.addEventListener('keyup', detectStyle);
        editor.addEventListener('mouseup', detectStyle);
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('keyup', saveSelection);
        editor.addEventListener('focus', function(){
          var langCode = editor.getAttribute('data-lang-editor');
          currentActiveEditor = editor;
          currentActiveHtmlEditor = document.getElementById('htmlEditor_' + langCode);
          currentActiveToolbar = document.querySelector('.toolbar[data-lang-toolbar="' + langCode + '"]');
          if (currentActiveHtmlEditor && currentActiveHtmlEditor.style.display !== 'none'){ switchToDesignMode(); }
          detectStyle();
        });
      });

      Array.prototype.forEach.call(document.querySelectorAll('.toolbar'), function(toolbar){
        toolbar.addEventListener('mousedown', function(event){
          var styleDropdownToggle = event.target.closest('.dropdown-toggle');
          var commandButton = event.target.closest('button[data-command]');
          var styleCommandElement = event.target.closest('[data-style-command]');
          var colorButton = event.target.closest('[data-color-btn]');
          if (styleDropdownToggle || styleCommandElement || commandButton || colorButton){
            event.preventDefault();
            if (currentActiveEditor && !savedRange){ saveSelection(); }
          }
        });

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape'){
            Array.prototype.forEach.call(document.querySelectorAll('.dropdown-menu'), function(d){ d.classList.remove('show'); });
            Array.prototype.forEach.call(document.querySelectorAll('.color-palette'), function(cp){ cp.classList.remove('show'); });
          }
        });

        toolbar.addEventListener('click', function(event){
          if (currentActiveEditor){ currentActiveEditor.focus(); restoreSelection(); }

          var styleCommandElement = event.target.closest('[data-style-command]');
          if (styleCommandElement){
            var styleCommand = styleCommandElement.getAttribute('data-style-command');
            applyStyle(styleCommand);
            var styleDropdown = styleCommandElement.closest('.dropdown-menu');
            if (styleDropdown){ styleDropdown.classList.remove('show'); }
            event.stopPropagation(); return;
          }

          var button = event.target.closest('button[data-command], .dropdown-toggle');
          if (!button) return;

          if (button.classList.contains('dropdown-toggle')){
            toggleDropdown(); event.stopPropagation(); return;
          }

          var command = button.getAttribute('data-command');
          if (!command) return;

          switch (command){
            case 'insertTOC': insertTOC(); break;
            case 'createLink':
              showCustomInput('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:', function(url){ if (url) format('createLink', url); });
              break;
            case 'insertImage': insertImage(); break;
            case 'openHtmlPopup': showCustomMessage('HTML ì‚½ì… ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); break;
            case 'removeFormat': format('removeFormat'); break;
            default: format(command); break;
          }
        });

        Array.prototype.forEach.call(toolbar.querySelectorAll('[data-color-btn]'), function(btn){
          btn.addEventListener('click', function(e){
            if (currentActiveEditor){ currentActiveEditor.focus(); restoreSelection(); }
            var colorPalette = btn.closest('[data-color-tool]').querySelector('[data-color-palette]');
            if (colorPalette){
              Array.prototype.forEach.call(document.querySelectorAll('.color-palette'), function(cp){ if (cp !== colorPalette) cp.classList.remove('show'); });
              colorPalette.classList.toggle('show');
            }
            e.stopPropagation();
          });
        });

        Array.prototype.forEach.call(toolbar.querySelectorAll('[data-color-palette] button'), function(colorBtn){
          colorBtn.addEventListener('click', function(e){
            var command = colorBtn.closest('[data-color-tool]').getAttribute('data-color-tool');
            var value = colorBtn.getAttribute('data-color-value');
            setColor(command, value);
            var pal = e.target.closest('[data-color-palette]'); if (pal) pal.classList.remove('show');
          });
        });

        Array.prototype.forEach.call(toolbar.querySelectorAll('[data-color-input]'), function(colorInput){
          colorInput.addEventListener('change', function(e){
            var command = colorInput.closest('[data-color-tool]').getAttribute('data-color-tool');
            setColor(command, e.target.value);
            var pal = e.target.closest('[data-color-palette]'); if (pal) pal.classList.remove('show');
          });
        });
      });

      Array.prototype.forEach.call(document.querySelectorAll('[data-mode-toggle]'), function(button){
        button.addEventListener('click', function(event){
          var mode = event.target.getAttribute('data-mode-toggle');
          if (mode === 'design'){ switchToDesignMode(); }
          else if (mode === 'html'){ switchToHtmlMode(); }
        });
      });
    });

    function switchToHtmlMode(){
      if (!currentActiveEditor || !currentActiveHtmlEditor || !currentActiveToolbar){ console.error('HTML ëª¨ë“œ ì „í™˜ ì‹¤íŒ¨: í™œì„± ìš”ì†Œ ì—†ìŒ'); return; }
      var currentContent = (currentActiveEditor.innerHTML || '').trim();
      var isWrapped = currentContent.indexOf('<div class="bl-content"') === 0;
      if (!isWrapped){
        if (!currentContent || currentContent === '<p><br></p>' || currentContent === '<div><br></div>'){ currentContent = ''; }
        currentContent =
          '<div class="bl-content" style="white-space:normal; line-height: 1.7;">\n' +
          currentContent + '\n</div>';
      }
      var beautify = window.html_beautify || function(h){ return h; };
      currentActiveHtmlEditor.value = beautify(currentContent, { indent_size:2, wrap_attributes:'auto', indent_with_tabs:false });
      currentActiveEditor.style.display='none';
      currentActiveHtmlEditor.style.display='block';
      currentActiveToolbar.classList.add('is-hidden');
    }

    function switchToDesignMode(){
      if (!currentActiveEditor || !currentActiveHtmlEditor || !currentActiveToolbar){ console.error('ë””ìì¸ ëª¨ë“œ ì „í™˜ ì‹¤íŒ¨: í™œì„± ìš”ì†Œ ì—†ìŒ'); return; }
      var rawHtml = (currentActiveHtmlEditor.value || '').trim();
      if (rawHtml.indexOf('<div class="bl-content"') !== 0){
        rawHtml = '<div class="bl-content" style="white-space:normal; line-height: 1.7;">' + rawHtml + '</div>';
      }
      currentActiveEditor.innerHTML = rawHtml;
      currentActiveHtmlEditor.style.display='none';
      currentActiveEditor.style.display='block';
      currentActiveToolbar.classList.remove('is-hidden');
      currentActiveEditor.focus(); detectStyle();
    }
  </script>

  <%- include('partials/footer') %>
  <%- include('partials/scripts') %>
</body>
</html>
