<% const h = locale.header; %>

<div class="full-header-container" style="z-index:20000;">
  <div class="header-top">
    <div class="top-controls">
      <div class="left-controls">
        <%
          // 1. 현재 경로에서 언어 코드를 제거하고, 뒤에 붙는 슬래시도 함께 제거합니다.
          const pathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)\/?/, '');

          // 2. 로고 표시 조건 (변경 없음)
          const showLogo = ['/signup', '/editor', '/login', '/write'].includes(pathWithoutLang) ||
                           pathWithoutLang.startsWith('/post') ||
                           pathWithoutLang.startsWith('/edit');
          
          // 3. ✨ 메뉴 표시 조건: 'post'가 포함되어 있지 않을 때만 메뉴를 표시합니다.
          const shouldShowMenu = !pathWithoutLang.includes('post');
        %>
        <% if (showLogo || shouldShowMenu) { %>
          <a href="/<%= lang %>/" class="logo-link" data-panel-link aria-label="BugLoop 홈"></a>
        <% } %>
      </div>

    <% if (shouldShowMenu) { %>
    <nav class="header-menu" aria-label="<%= h.mainMenu || 'Main Menu' %>">
      <ul class="main-menu-container">
        <a href="https://www.youtube.com/@ebook.bugloop"
           target="_blank"
           aria-label="<%= h.youtubeLink || 'YouTube' %>">
          <img src="/assets/images/youtube.png"
               alt="YouTube"
               style="height:28px; width:auto; vertical-align:middle; margin-left:3px; margin-right:3px;">
        </a>

        <li class="menu-item-wrapper">
          <span class="menu-label"><%= h.recentVideos %></span>
          <ul class="submenu">
            <li><a href="/<%= lang %>/review/choroideremia" data-panel-link><%= h.choroideremia %></a></li>
            <li><a href="/<%= lang %>/review/book" data-panel-link><%= h.palma2pro %></a></li>
      
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
          </ul>
        </li>

        <li class="menu-item-wrapper">
          <span class="menu-label"><%= h.audiobook %></span>
          <ul class="submenu">
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.cuteacoustics %></span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.producer %></span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.unfinished %></span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.warmth %></span></li>
          </ul>
        </li>

        <li class="menu-item-wrapper">
          <span class="menu-label"><%= h.music %></span>
          <ul class="submenu">
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (4)</span></li>
          </ul>
        </li>

        <li class="menu-item-wrapper">
          <span class="menu-label"><%= h.game %></span>
          <ul class="submenu">
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
            <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
          </ul>
        </li>

        <li class="menu-item-wrapper special-label">
          <span class="menu-label">
            <i class="fas fa-rocket" style="color:#00c6ff; margin-right:6px;"></i>
            <%= h.futureService %>
          </span>
        </li>
      </ul>
    </nav>
    <% } %> <div class="right-controls" id="right-controls" hidden></div>
    </div>
  </div>

  <aside class="side-panel main-panel-only">
    <div class="sidebar-wrapper">
      <nav class="vscode-sidebar" aria-label="패널 사이드바" role="tablist">
        <a href="#" class="sidebar-icon toggle-extension blink-highlight" title="패널 열기/닫기" aria-label="패널 열기/닫기">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </a>

        <a href="/<%= lang %>/" class="sidebar-icon logo" data-tab="home" title="BugLoop 홈" aria-label="BugLoop 홈" aria-selected="false">
          <img src="/assets/images/BugLoop.png" alt="BugLoop">
        </a>
        <a href="/<%= lang %>/" class="sidebar-icon" data-tab="home" title="홈" aria-selected="false">
          <i class="fas fa-home" aria-hidden="true"></i>
        </a>

        <a href="#" class="sidebar-icon" data-tab="profile" title="프로필" aria-selected="false" role="tab">
          <i class="fas fa-user" aria-hidden="true"></i>
        </a>
        <a href="#" class="sidebar-icon" data-tab="search" title="검색" aria-selected="false" role="tab">
          <i class="fas fa-search" aria-hidden="true"></i>
        </a>

        <% if (user) { %>
          <% if (Number(user.is_admin) === 1) { %>
            <a href="/<%= lang %>/write" class="sidebar-icon" data-tab="write" title="글쓰기" aria-selected="false">
              <i class="fas fa-pen" aria-hidden="true"></i>
            </a>
          <% } %>
        <% } %>

        <div class="sidebar-lang-theme">
          <div class="language-dropdown">
            <button id="langToggleSidebar" class="lang-btn" aria-haspopup="menu" aria-expanded="false" aria-controls="langMenuSidebar">
              <%
                let flagCode = lang;
                switch(lang) {
                  case 'ko': flagCode = 'kr'; break;
                  case 'en': flagCode = 'gb'; break;
                  case 'zh': flagCode = 'cn'; break;
                  case 'ja': flagCode = 'jp'; break;
                  case 'fr': flagCode = 'fr'; break;
                  case 'es': flagCode = 'es'; break;
                  default: flagCode = 'kr';
                }
              %>
              <span class="fi fi-<%= flagCode %>"></span>
            </button>

            <ul id="langMenuSidebar" class="lang-menu" role="menu" aria-hidden="true">
              <%
                const currentPathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)/, '');
                const langNames = { ko:'한국어', en:'English', fr:'Français', zh:'简体中文', ja:'日本語', es:'Español' };
              %>
              <% (supportedLangs || ['ko','en','fr','zh','ja','es']).forEach(function(langCode){ %>
                <li role="none">
                  <a href="/<%= langCode %><%= currentPathWithoutLang %>"
                     class="lang-option <%= langCode === lang ? 'active-lang' : '' %>"
                     role="menuitem" tabindex="-1">
                    <span class="fi fi-<%= (langCode==='ko'?'kr':(langCode==='en'?'gb':(langCode==='zh'?'cn':(langCode==='ja'?'jp':langCode)))) %>"></span>
                    <%= langNames[langCode] || langCode %>
                  </a>
                </li>
              <% }); %>
            </ul>
          </div>
          
          <button id="theme-toggle-sidebar" class="theme-toggle-btn" aria-label="테마 전환: 라이트/다크 모드" title="테마 전환">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </button>
        </div>
        </nav>

      <div class="sidebar-extension-panel">
        <div class="panel-logo">
          <img src="/assets/images/BugLoop.png" alt="BugLoop" loading="lazy" />
        </div>
        <div class="tab-container"></div>

        <div class="tab-content" data-tab="profile" style="display: none;">
          <%- include('./profile', { locale }) %>
        </div>

        <% if (typeof posts !== 'undefined') { %>
          <div class="tab-content" data-tab="search" style="display: none;">
            <section class="search-tab">
              <div id="sidebar-table-template" data-lang="<%= lang %>">
                <%- include('table') %>
              </div>
            </section>
          </div>
        <% } %>

        <div class="panel-footer">
          <% if (user) { %>
            <div class="greeting" style="text-align:center; margin-top:10px; font-weight:bold;">
              <%= user.nickname %>님, 안녕하세요!
            </div>
          <% } %>

          <% if (currentPath !== '/signup' && currentPath !== '/login') { %>
            <div class="auth-buttons">
              <% if (user) { %>
                <a href="/<%= lang %>/logout" class="auth-btn logout">로그아웃</a>
              <% } else { %>
                <a class="auth-btn signup" onclick="return false;" style="pointer-events:none; opacity:.5; cursor:not-allowed;">회원가입</a>
                <button class="auth-btn login" id="login" type="button">로그인</button>
              <% } %>
            </div>
          <% } %>

          <div id="login-form-container" class="login-form-container hidden">
            <form id="login-form" method="POST" action="/login">
              <input type="text" name="id" placeholder="아이디" required />
              <input type="password" name="password" placeholder="비밀번호" required />
              <button type="submit">로그인</button>
            </form>
          </div>

          <div class="real-footer"><small>© 2025 Bug Loop</small></div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script src="/assets/js/header.js"></script>
<script src="/assets/js/global.js"></script>