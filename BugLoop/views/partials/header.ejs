<% const h = locale.header; %>

<div class="full-header-container" style="z-index:20000;">
  <div class="header-top">
    <div class="top-controls">
      <div class="left-controls">
        <%
          const pathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)\/?/, '');
          const showLogo = ['/signup', '/editor', '/login', '/write'].includes(pathWithoutLang) ||
                           pathWithoutLang.startsWith('/post') ||
                           pathWithoutLang.startsWith('/edit');
          const shouldShowMenu = !pathWithoutLang.includes('post');
        %>
        <% if (showLogo || shouldShowMenu) { %>
          <a href="/<%= lang %>/" class="logo-link" data-panel-link aria-label="BugLoop 홈"></a>
        <% } %>
      </div>

      <% if (shouldShowMenu) { %>
      <nav class="header-menu" aria-label="<%= h.mainMenu || 'Main Menu' %>">
        <ul class="main-menu-container">
          <a href="https://www.youtube.com/@eBook.bugloop" target="_blank" aria-label="<%= h.youtubeLink || 'YouTube' %>">
            <img src="/assets/images/youtube.png" alt="YouTube" style="height:28px; width:auto; vertical-align:middle; margin-left:3px; margin-right:3px;">
          </a>

          <li class="menu-item-wrapper">
            <span class="menu-label"><%= h.recentVideos %></span>
            <ul class="submenu">
              <li><a href="/<%= lang %>/review/choroideremia" data-panel-link><%= h.choroideremia %></a></li>
              <li><a href="/<%= lang %>/review/book" data-panel-link><%= h.palma2pro %></a></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
            </ul>
          </li>

          <li class="menu-item-wrapper">
            <span class="menu-label"><%= h.audiobook %></span>
            <ul class="submenu">
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.cuteacoustics %></span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.producer %></span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.unfinished %></span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.warmth %></span></li>
            </ul>
          </li>

          <li class="menu-item-wrapper">
            <span class="menu-label"><%= h.music %></span>
            <ul class="submenu">
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (4)</span></li>
            </ul>
          </li>

          <li class="menu-item-wrapper">
            <span class="menu-label"><%= h.game %></span>
            <ul class="submenu">
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (1)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (2)</span></li>
              <li><span class="disabled-menu" style="color:#aaa; cursor:not-allowed;"><%= h.coming %> (3)</span></li>
            </ul>
          </li>

          <li class="menu-item-wrapper special-label">
            <span class="menu-label">
              <i class="fas fa-rocket" style="color:#00c6ff; margin-right:6px;"></i>
              <%= h.futureService %>
            </span>
          </li>
        </ul>
      </nav>
      <% } %>
      <div class="right-controls" id="right-controls" hidden></div>
    </div>
  </div>

  <aside class="side-panel main-panel-only">
    <div class="sidebar-wrapper">
      <nav class="vscode-sidebar" aria-label="패널 사이드바" role="tablist">
        <a href="#" class="sidebar-icon toggle-extension blink-highlight" title="패널 열기/닫기" aria-label="패널 열기/닫기">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </a>

        <% if (!user || Number(user.is_admin) !== 1) { %>
          <a href="/<%= lang %>/" class="sidebar-icon logo" data-tab="home">
            <img src="/assets/images/BugLoop.png" alt="BugLoop">
          </a>
        <% } %>

        <a href="/<%= lang %>/" class="sidebar-icon home-tab" data-tab="home" title="홈">
          <i class="fas fa-home"></i>
        </a>

        <a href="#" class="sidebar-icon" data-tab="profile" title="프로필">
          <i class="fas fa-user"></i>
        </a>

        <a href="#" class="sidebar-icon" data-tab="search" title="검색">
          <i class="fas fa-search"></i>
        </a>

        <% if (user && Number(user.is_admin) === 1) { %>
          <a href="/<%= lang %>/write" class="sidebar-icon" data-tab="write" title="글쓰기">
            <i class="fas fa-pen"></i>
          </a>
          <a href="/admin/logs/googlebot" class="sidebar-icon admin-log-icon" title="Googlebot 로그">
            <i class="fas fa-robot"></i>
          </a>
        <% } %>

        <div class="sidebar-lang-theme">
          <div class="language-dropdown">
            <button id="langToggleSidebar" class="lang-btn">
              <%
                let flagCode = lang;
                switch(lang) {
                  case 'ko': flagCode = 'kr'; break;
                  case 'en': flagCode = 'gb'; break;
                  case 'zh': flagCode = 'cn'; break;
                  case 'ja': flagCode = 'jp'; break;
                  case 'fr': flagCode = 'fr'; break;
                  case 'es': flagCode = 'es'; break;
                }
              %>
              <span class="fi fi-<%= flagCode %>"></span>
            </button>

            <ul id="langMenuSidebar" class="lang-menu">
              <%
                const currentPathWithoutLang = currentPath.replace(/^\/(ko|en|fr|zh|ja|es)/, '');
                const langNames = { ko:'한국어', en:'English', fr:'Français', zh:'简体中文', ja:'日本語', es:'Español' };
              %>
              <% (supportedLangs || ['ko','en','fr','zh','ja','es']).forEach(function(langCode){ %>
                <li>
                  <a href="/<%= langCode %><%= currentPathWithoutLang %>" class="lang-option <%= langCode === lang ? 'active-lang' : '' %>">
                    <span class="fi fi-<%= (langCode==='ko'?'kr':(langCode==='en'?'gb':(langCode==='zh'?'cn':(langCode==='ja'?'jp':langCode)))) %>"></span>
                    <%= langNames[langCode] || langCode %>
                  </a>
                </li>
              <% }); %>
            </ul>
          </div>

          <button id="theme-toggle-sidebar" class="theme-toggle-btn" title="테마 전환">
            <i class="fas fa-moon"></i>
          </button>

          <button id="font-toggle-sidebar" class="font-toggle-btn" title="글씨 크기">
            <i class="fas fa-text-height"></i>
          </button>
        </div>
      </nav>

      <div class="sidebar-extension-panel">
        <div class="panel-logo">
          <img src="/assets/images/BugLoop.png" alt="BugLoop" loading="lazy">
        </div>

        <div class="tab-container"></div>

        <div class="tab-content" data-tab="profile" style="display:none;">
          <%- include('./profile', { locale }) %>
        </div>

        <% if (typeof posts !== 'undefined') { %>
          <div class="tab-content" data-tab="search" style="display:none;">
            <section class="search-tab">
              <div id="sidebar-table-template" data-lang="<%= lang %>">
                <%- include('table') %>
              </div>
            </section>
          </div>
        <% } %>

        <div class="panel-footer">
          <% if (user) { %>
            <div class="greeting" style="text-align:center; margin-top:10px; font-weight:bold;">
              <%= user.nickname %>님, 안녕하세요!
            </div>
          <% } %>

          <% if (currentPath !== '/signup' && currentPath !== '/login') { %>
            <div class="auth-buttons">
              <% if (user) { %>
                <a href="/<%= lang %>/logout" class="auth-btn logout">로그아웃</a>
              <% } else { %>
                <a class="auth-btn signup" style="pointer-events:none; opacity:.5;">회원가입</a>
                <button class="auth-btn login" id="login">로그인</button>
              <% } %>
            </div>
          <% } %>

          <div id="login-form-container" class="login-form-container hidden">
            <form id="login-form" method="POST" action="/login">
              <input type="text" name="id" placeholder="아이디" required>
              <input type="password" name="password" placeholder="비밀번호" required>
              <button type="submit">로그인</button>
            </form>
          </div>

          <div class="real-footer"><small>© 2025 Bug Loop</small></div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script src="/assets/js/header.js"></script>
