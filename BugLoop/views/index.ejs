<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/assets/css/index.css" />
</head>

<body>
  <div id="preloader"><div class="spinner"></div></div>
  <%- include('partials/header') %>

  <div id="panel-root" data-pjax-scope>
    <%- include('partials/panel') %>
  </div>


  <div class="app-shell">
  
    <div class="section-title-wrapper">
        <h1 class="section-title"><%= locale.index.ongoing %></h1>
    </div>

    <div class="carousel">

    <% 
      // ğŸ’¡ ëª©ì°¨ í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •ì„ ìœ„í•œ ë²”ìš© í•¨ìˆ˜
      const ITEMS_PER_PAGE = 3;
      
      const getPaginatedToc = (tocData) => {
        if (!tocData) return { paginatedToc: [], totalPages: 0, totalSections: 0 };
        const totalSections = tocData.length;
        const totalPages = Math.ceil(totalSections / ITEMS_PER_PAGE);
        const paginatedToc = [];

        for (let i = 0; i < totalPages; i++) {
          const start = i * ITEMS_PER_PAGE;
          const end = start + ITEMS_PER_PAGE;
          paginatedToc.push(tocData.slice(start, end));
        }
        return { paginatedToc, totalPages, totalSections };
      };
      
      // ğŸ’¡ ëª©ì°¨ HTML ë Œë”ë§ í•¨ìˆ˜ (EJS ì„œë²„ ì¸¡)
      // â­ [ìˆ˜ì •ë¨] í…œí”Œë¦¿ ë³€ìˆ˜ê°€ ë‚¨ì§€ ì•Šë„ë¡ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const renderTocHtmlSSR = (sections, bookKey) => {
        if (!sections || sections.length === 0) return '';
        let html = '<ul>';
        sections.forEach(section => {
          // âš ï¸ EJS ì„œë²„ ì¸¡: ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½ ì™„ë£Œ.
          html += '<li><h5>' + section.section + '</h5><ul>'; 
          section.chapters.forEach(ch => {
            html += '<li>'; 
            
            // â­ï¸ [ìˆ˜ì •] URL Path ìƒì„± ì‹œ ëª…ì‹œì  ë¬¸ìì—´ í•©ì¹˜ê¸°
            const urlPath = '/books/' + bookKey + '/contents/' + ch.id; 

            if (ch.url) {
              // â­ï¸ [ìˆ˜ì •] href ì†ì„±ì— í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ëŒ€ì‹  ë¬¸ìì—´ í•©ì¹˜ê¸° ì‚¬ìš©
              html += '<a href="/' + lang + urlPath + '" class="toc-link active">' + ch.title + '</a>';
            } else {
              // âš ï¸ EJS ì„œë²„ ì¸¡: ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½ ì™„ë£Œ.
              html += '<span class="toc-link disabled">' + ch.title + '</span>';
            }

            if (ch.sub) {
              html += '<ul>';
              ch.sub.forEach(sub => {
                html += '<li>';
                const subUrlPath = '/books/' + bookKey + '/contents/' + sub.id;
                
                if (sub.url) {
                  // â­ï¸ [ìˆ˜ì •] href ì†ì„±ì— í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ëŒ€ì‹  ë¬¸ìì—´ í•©ì¹˜ê¸° ì‚¬ìš©
                  html += '<a href="/' + lang + subUrlPath + '" class="toc-link active">' + sub.title + '</a>';
                } else {
                  // âš ï¸ EJS ì„œë²„ ì¸¡: ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½ ì™„ë£Œ.
                  html += '<span class="toc-link disabled">' + sub.title + '</span>';
                }
                html += '</li>';
              });
              html += '</ul>';
            }

            html += '</li>';
          });
          html += '</ul></li>';
        });
        html += '</ul>';
        return html;
      };

      // ğŸ“š 1. ê·€ì—¬ìš´ ìŒí–¥í•™ (cuteAcoustics)
      const cuteAcoustics = locale.books.cuteAcoustics;
      const caData = getPaginatedToc(cuteAcoustics.toc);
    %>

   <div class="book-card" data-index="0" data-book-key="cuteAcoustics">

<% if (cuteAcoustics.updated) { %>
  <div class="book-updated-badge">
    <%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %>
  </div>
<% } %>

<div class="book-content-wrapper"> 
  <div class="book-cover-wrapper">
    <img class="book-cover" src="/assets/images/book1.gif" alt="<%= cuteAcoustics.title %>" loading="lazy">
  </div>

  <div class="book-info">
    <div class="book-title"><%= cuteAcoustics.title %></div>
    <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
      <%= locale.ui["book-author"] %> : <%= cuteAcoustics.author %>
    </div>
  </div>

  <div class="book-toc"> 
    <h4> <%= locale.ui["tocButton"] %></h4>

    <div class="pagination" data-book-id="cuteAcoustics-pagination">
      <% for(let i = 1; i <= caData.totalPages; i++) { %>
        <span class="pagination-number <%= i === 1 ? 'active' : '' %>" 
              onclick="changePage(event, 'cuteAcoustics', <%= i %>)">
          <%= i %>
        </span>
        <% if (i < caData.totalPages) { %>
          <span class="pagination-divider">|</span>
        <% } %>
      <% } %>
    </div>

    <div class="paginated-toc" data-book-id="cuteAcoustics-toc">
      <%- renderTocHtmlSSR(caData.paginatedToc[0], 'cuteAcoustics') %>
    </div>

    <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
     
    </div>
  </div>
</div>
</div>

    
    <% 
      // ğŸ“š 2. ë¯¸ì™„ì„± ê³ í†µ (unfinishedPain)
      const unfinishedPain = locale.books.unfinishedPain;
      const upData = getPaginatedToc(unfinishedPain.toc);
    %>
    <div class="book-card" data-index="1" data-book-key="unfinishedPain">
      <% if (unfinishedPain.updated) { %>
          <div class="book-updated-badge"><%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %></div>
      <% } %>
      <div class="book-content-wrapper">
        <div class="book-cover-wrapper">
          <img class="book-cover" src="/assets/images/book2.gif" alt="<%= unfinishedPain.title %>" loading="lazy">
        </div>
        <div class="book-info">
            <div class="book-title"><%= unfinishedPain.title %></div>
            <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
              <%= locale.ui["book-author"] %>: <%= unfinishedPain.author %>
            </div>
        </div>
        <div class="book-toc">
          <h4><%= locale.ui["tocButton"] %></h4>
          
          <div class="pagination" data-book-id="unfinishedPain-pagination">
            <% for(let i = 1; i <= upData.totalPages; i++) { %>
              <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'unfinishedPain', <%= i %>)">
                <%= i %>
              </span>
              <% if (i < upData.totalPages) { %><span class="pagination-divider">|</span><% } %>
            <% } %>
          </div>

          <div class="paginated-toc" data-book-id="unfinishedPain-toc">
            <%- renderTocHtmlSSR(upData.paginatedToc[0], 'unfinishedPain') %>
          </div>
          <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
           
          </div>
        </div>
      </div>
    </div>
    
    <% 
      // ğŸ“š 3. í”¼ì•„ë…¸ ì¹˜ëŠ” í”„ë¡œë“€ì„œ: ì‹ ë¹„í•œ ë°˜ì£¼ë²• (pianistProducer)
      const pianistProducer = locale.books.pianistProducer;
      const ppData = getPaginatedToc(pianistProducer.toc);
    %>
    <div class="book-card" data-index="2" data-book-key="pianistProducer">
      <% if (pianistProducer.updated) { %>
          <div class="book-updated-badge"><%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %></div>
      <% } %>
      <div class="book-content-wrapper">
        <div class="book-cover-wrapper">
          <img class="book-cover" src="/assets/images/book3.gif" alt="<%= pianistProducer.title %>" loading="lazy">
        </div>
        <div class="book-info">
            <div class="book-title"><%= pianistProducer.title %></div>
            <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
              <%= locale.ui["book-author"] %>: <%= pianistProducer.author %>
            </div>
        </div>
        <div class="book-toc">
          <h4><%= locale.ui["tocButton"] %></h4>
          
          <div class="pagination" data-book-id="pianistProducer-pagination">
            <% for(let i = 1; i <= ppData.totalPages; i++) { %>
              <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'pianistProducer', <%= i %>)">
                <%= i %>
              </span>
              <% if (i < ppData.totalPages) { %><span class="pagination-divider">|</span><% } %>
            <% } %>
          </div>

          <div class="paginated-toc" data-book-id="pianistProducer-toc">
            <%- renderTocHtmlSSR(ppData.paginatedToc[0], 'pianistProducer') %>
          </div>
          <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
           
          </div>
        </div>
      </div>
    </div>

    <% 
      // ğŸ“š 4. ê³„ì‚°ì˜ ì˜¨ê¸° (warmthOfCalc)
      const warmthOfCalc = locale.books.warmthOfCalc;
      const wcData = getPaginatedToc(warmthOfCalc.toc);
    %>
    <div class="book-card" data-index="3" data-book-key="warmthOfCalc">
       <% if (warmthOfCalc.updated) { %>
          <div class="book-updated-badge"><%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %></div>
      <% } %>
      <div class="book-content-wrapper">
        <div class="book-cover-wrapper">
          <img class="book-cover" src="/assets/images/book4.gif" alt="<%= warmthOfCalc.title %>" loading="lazy">
        </div>
        <div class="book-info">
            <div class="book-title"><%= warmthOfCalc.title %></div>
            <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
            <%= locale.ui["book-author"] %>: <%= warmthOfCalc.author %>
            </div>
        </div>
        <div class="book-toc">
          <h4><%= locale.ui["tocButton"] %></h4>
          
          <div class="pagination" data-book-id="warmthOfCalc-pagination">
            <% for(let i = 1; i <= wcData.totalPages; i++) { %>
              <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'warmthOfCalc', <%= i %>)">
                <%= i %>
              </span>
              <% if (i < wcData.totalPages) { %><span class="pagination-divider">|</span><% } %>
            <% } %>
          </div>

          <div class="paginated-toc" data-book-id="warmthOfCalc-toc">
            <%- renderTocHtmlSSR(wcData.paginatedToc[0], 'warmthOfCalc') %>
          </div>
          <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
           
          </div>
        </div>
      </div>
    </div>
    
    </div>
    

    <div class="recent-posts-wrapper section-title-wrapper" style="margin-bottom: 0; margin-top: 30px;">
        <h2 class="section-title"><%= locale.index.recentPosts || "ìµœê·¼ ê²Œì‹œë¬¼" %></h2>
    </div>

    <div class="recent-posts" id="posts-container">
  <% posts.slice(0, 5).forEach(post => { %>
    <div class="recent-post-item">

      <%
        const now = new Date();
        const createdAt = new Date(post.created_at);
        const updatedAt = new Date(post.updated_at);
        const oneDay = 1000 * 60 * 60 * 24;
        const isNewPost = (now - createdAt) < oneDay;
        const wasEdited = updatedAt > createdAt;
        const isRecentlyEdited = wasEdited && (now - updatedAt < oneDay);
        const showEditedLabel = !isNewPost && isRecentlyEdited;

        // ë‹¤êµ­ì–´ ë¼ë²¨ í…ìŠ¤íŠ¸ ì •ì˜ (locale.uiì— í‚¤ê°€ ìˆë‹¤ê³  ê°€ì •)
        const newLabelText = locale.ui.newPost || 'NEW';
        const editedLabelText = locale.ui.editedPost || 'UPDATED';
      %>

<a href="/<%= lang %>/post/<%= post.id %>" class="recent-post-title">
<% if (isNewPost) { %>
  <span class="label-icon new-icon"><%= newLabelText %></span>
<% } else if (showEditedLabel) { %>
  <span class="label-icon edited-icon"><%= editedLabelText %></span>
<% } %>

<% if (post.is_pinned) { %>
  <span class="badge-pinned">ğŸ“Œ</span>
<% } %>

<% if (post.is_private) { %>
  <span class="badge-private">ğŸ”’</span>
<% } %>

<%= post.title %>
</a>

      <div class="recent-post-meta">
        <span><%= post.author %></span>
        <span>Â·</span>
        <span><%= format(new Date(post.created_at), 'yyyy.MM.dd') %></span>
      </div>

      <div class="recent-post-preview">
        <% 
          // ğŸ“Œ ìˆ˜ì •ëœ ë¡œì§: ëª©ì°¨, ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±° ë° í…ìŠ¤íŠ¸ ì •ì œ
          let cleanContent = post.content.replace(/<div class="auto-toc"[\s\S]*?<\/div>/gi, '');
          cleanContent = cleanContent.replace(/<style\b[^>]*>[\s\S]*?<\/style>/gi, '');
          
          let plainText = cleanContent.replace(/<[^>]+>/gi, '');
          plainText = plainText.replace(/\s+/g, ' ').trim();

          const decodedText = plainText
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&');
      
          const previewText = decodedText.slice(0, 120);
        %>
        <%= previewText %>...
      </div>

    </div>
  <% }) %>
</div>

<button id="load-more-btn" onclick="loadMorePosts()">
  <%= locale.index.loadMore || "ë”ë³´ê¸°" %>
</button>


  </div>
  
  <footer class="app-footer">
    Â© 2025 Bug Loop
  </footer>
  <%- include('partials/scripts') %>

<script>
const getLang = () =>
  document.documentElement.getAttribute('lang') || 'ko';

window.booksData = <%- JSON.stringify(locale.books) %>;// ëª¨ë“  ì±… ë°ì´í„°ë¥¼ JSë¡œ ê°€ì ¸ì˜´

let offset = 5;   
let loading = false;

async function loadMorePosts() {
  if (loading) return;
  loading = true;

  try {
    const res = await fetch(`/api/recent-posts?offset=${offset}&limit=5&lang=${lang}`);
    const data = await res.json();
    
    if (!data.posts || data.posts.length === 0) {
      document.getElementById("load-more-btn").style.display = "none";
      loading = false; 
      return;
    }
  
    offset += data.posts.length;
  
    const container = document.getElementById("posts-container");
    if (!container) {
      console.error("Posts container not found! (EJS ID í™•ì¸ ìš”ë§)");
      loading = false;
      return;
    }
  
    data.posts.forEach(post => {
      const el = document.createElement("div");
      el.className = "recent-post-item"; 
      
      const now = new Date();
      const createdAt = new Date(post.created_at);
      const updatedAt = new Date(post.updated_at);
      const oneDay = 1000 * 60 * 60 * 24;
      const isNewPost = (now - createdAt) < oneDay;
      const wasEdited = updatedAt > createdAt;
      const isRecentlyEdited = wasEdited && (now - updatedAt < oneDay);
      const showEditedLabel = !isNewPost && isRecentlyEdited;

      const newLabelText = "<%= locale.ui.newPost || 'NEW' %>";
      const editedLabelText = "<%= locale.ui.editedPost || 'UPDATED' %>";
      
      let labelHtml = '';
      if (isNewPost) {
          // â­ [ìˆ˜ì •] loadMorePosts ë‚´ë¶€: ë°±í‹± ì œê±° ë° ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
          labelHtml = '<span class="label-icon new-icon">' + newLabelText + '</span>';
      } else if (showEditedLabel) {
          // â­ [ìˆ˜ì •] loadMorePosts ë‚´ë¶€: ë°±í‹± ì œê±° ë° ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
          labelHtml = '<span class="label-icon edited-icon">' + editedLabelText + '</span>';
      }
      
      const formattedDate = post.created_fmt; 
      
      let previewText = '';
      if (post.content) {
        let cleanContent = post.content.replace(/<div class="auto-toc"[\s\S]*?<\/div>/gi, '');
        cleanContent = cleanContent.replace(/<style\b[^>]*>[\s\S]*?<\/style>/gi, '');
        
        let plainText = cleanContent.replace(/<[^>]+>/gi, '');
        
        plainText = plainText.replace(/\s+/g, ' ').trim();

        const decodedText = plainText
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
    
        previewText = decodedText.slice(0, 120);
      } else if (post.preview) {
        let decodedPreview = post.preview
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        previewText = decodedPreview.slice(0, 120);
      }
  
      // â­ [ì¤‘ìš” ìˆ˜ì •] el.innerHTML ë¶€ë¶„: ë°±í‹±(í…œí”Œë¦¿ ë¦¬í„°ëŸ´)ì„ ë¬¸ìì—´ í•©ì¹˜ê¸°(+)ë¡œ ì™„ì „íˆ ë³€ê²½
      let innerHtml = '<a href="/' + lang + '/post/' + post.id + '" class="recent-post-title">';
      innerHtml += labelHtml;
      innerHtml += (post.is_pinned ? '<span class="badge-pinned">ğŸ“Œ</span>' : '');
      innerHtml += post.title;
      innerHtml += '</a>';

      innerHtml += '<div class="recent-post-meta">';
      innerHtml += '<span>' + post.author + '</span>';
      innerHtml += '<span>Â·</span>';
      innerHtml += '<span>' + formattedDate + '</span>';
      innerHtml += '</div>';

      innerHtml += '<div class="recent-post-preview">';
      innerHtml += previewText + '...';
      innerHtml += '</div>';

      el.innerHTML = innerHtml;
      
      container.appendChild(el);
    });
  
    loading = false;
  } catch (error) {
      console.error("Error loading more posts or processing JSON (DOM/Parsing Error):", error);
      loading = false;
  }
}


window.loadMorePosts = loadMorePosts;

</script>



  <script>
  (() => {
    // ----------------------------------------------------
    // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    // ----------------------------------------------------
    const booksData = window.booksData;
    const itemsPerPage = 3;
    
    // ----------------------------------------------------
    // ëª©ì°¨ ë Œë”ë§ ë¡œì§ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
    // ----------------------------------------------------
    // â­ [ìˆ˜ì •] í´ë¼ì´ì–¸íŠ¸ ì¸¡ renderTocHtml í•¨ìˆ˜: ë°±í‹± í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì„ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½í•˜ì—¬ ì•ˆì „ì„± í™•ë³´
    const getPaginatedToc = (tocData) => {
      if (!tocData) return { paginatedToc: [], totalPages: 0, totalSections: 0 };
      const totalSections = tocData.length;
      const totalPages = Math.ceil(totalSections / itemsPerPage);
      const paginatedToc = [];

      for (let i = 0; i < totalPages; i++) {
        const start = i * itemsPerPage;
        const end = start + itemsPerPage;
        paginatedToc.push(tocData.slice(start, end));
      }
      return { paginatedToc, totalPages, totalSections };
    };

    const renderTocHtmlCSR = (sections, bookKey) => {
      if (!sections || sections.length === 0) return '';
      let html = '<ul>';
      
      const snakeToCamel = (s) => s.replace(/(_\w)/g, k => k[1].toUpperCase());
      const camelCaseKey = snakeToCamel(bookKey);

      sections.forEach(section => {
        // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
        html += '<li><h5>' + section.section + '</h5><ul>'; 
        section.chapters.forEach(ch => {
          // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
          html += '<li>';
          
          // â­ [ì¤‘ìš” ìˆ˜ì •] URL ìƒì„± ì‹œ ë¬¸ìì—´ í•©ì¹˜ê¸°(+) ì‚¬ìš©
          const urlPath = '/books/' + camelCaseKey + '/contents/' + ch.id; 

          if (ch.url) {
            // â­ [ìˆ˜ì •] ì•µì»¤ íƒœê·¸ ì „ì²´ë¥¼ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
            html += '<a href="/' + lang + urlPath + '" class="toc-link active">';
            html += ch.title;
            html += '</a>';
          } else {
            // â­ [ìˆ˜ì •] <span> íƒœê·¸ë¥¼ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
            html += '<span class="toc-link disabled">' + ch.title + '</span>';
          }

          if (ch.sub) {
            html += '<ul>';
            ch.sub.forEach(sub => {
              // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
              html += '<li>';
              
              // â­ [ì¤‘ìš” ìˆ˜ì •] ì„œë¸Œ ì±•í„° URLë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
              const subUrlPath = '/books/' + camelCaseKey + '/contents/' + sub.id;
              
              if (sub.url) {
                // â­ [ìˆ˜ì •] ì•µì»¤ íƒœê·¸ ì „ì²´ë¥¼ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
                html += '<a href="/' + lang + subUrlPath + '" class="toc-link active">';
                html += sub.title;
                html += '</a>';
              } else {
                // â­ [ìˆ˜ì •] <span> íƒœê·¸ë¥¼ ë¬¸ìì—´ í•©ì¹˜ê¸°ë¡œ ë³€ê²½
                html += '<span class="toc-link disabled">' + sub.title + '</span>'; 
              }
              html += '</li>';
            });
            html += '</ul>';
          }

          html += '</li>';
        });
        html += '</ul></li>';
      });
      html += '</ul>';
      return html;
    };


    window.changePage = (event, bookKey, pageNumber) => {
      event.stopPropagation();
      
      const bookData = booksData[bookKey];
      if (!bookData) return;
      
      const card = document.querySelector(`[data-book-key="${bookKey}"]`);
      const tocContainer = card.querySelector(`[data-book-id="${bookKey}-toc"]`);
      const paginationContainer = card.querySelector(`[data-book-id="${bookKey}-pagination"]`);
      const tocElement = card.querySelector('.book-toc');
      
      if (tocContainer && paginationContainer) {
        const { paginatedToc } = getPaginatedToc(bookData.toc);
        const sections = paginatedToc[pageNumber - 1];

        // ë Œë”ë§
        tocContainer.innerHTML = renderTocHtmlCSR(sections, bookKey);
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        paginationContainer.querySelectorAll('.pagination-number').forEach(btn => {
          btn.classList.remove('active');
          // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
          if (parseInt(btn.textContent.trim()) === pageNumber) btn.classList.add('active');
        });

        // ëª©ì°¨ ë†’ì´ ì¬ê³„ì‚° ë° ì ìš©
        if (card.classList.contains('expanded') && tocElement) {
            tocElement.style.height = 'auto';
            const contentHeight = tocElement.scrollHeight; 
            // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
            tocElement.style.height = contentHeight + 'px'; 
        }
      }
    };
    
    // ----------------------------------------------------
    // ë¶ì¹´ë“œ í† ê¸€ ë¡œì§
    // ----------------------------------------------------
    document.querySelectorAll('.book-card').forEach(card => {
      card.addEventListener('click', () => {
          const isCurrentlyExpanded = card.classList.contains('expanded');
          const tocElement = card.querySelector('.book-toc');
          const transitionDuration = 500; // CSS transition time in ms
          
          const contentPaddingTop = '26px';
          const contentPaddingBottom = '16px';

          // 1. ëª¨ë“  ì¹´ë“œì˜ expanded í´ë˜ìŠ¤ ì œê±° (ë‹¤ë¥¸ ì¹´ë“œ ë‹«ê¸°)
          document.querySelectorAll('.book-card').forEach(c => {
              const otherToc = c.querySelector('.book-toc');
              if (c !== card) {
                  c.classList.remove('expanded'); 
                  
                  if (otherToc) {
                      otherToc.style.height = '0px'; 
                      otherToc.style.paddingTop = '0';
                      otherToc.style.paddingBottom = '0';
                      otherToc.classList.add('closed');
                  }
              }
          });
          
          // 2. í˜„ì¬ í´ë¦­ëœ ì¹´ë“œì˜ expanded ìƒíƒœ í† ê¸€
          card.classList.toggle('expanded', !isCurrentlyExpanded);

          // 3. ëª©ì°¨ ë†’ì´ ì¡°ì ˆ
          if (!isCurrentlyExpanded && tocElement) {
              // í¼ì³ì§ˆ ë•Œ
              tocElement.classList.remove('closed');
              
              tocElement.style.paddingTop = contentPaddingTop;
              tocElement.style.paddingBottom = contentPaddingBottom;
              
              tocElement.style.height = 'auto';
              
              const contentHeight = tocElement.scrollHeight; 
              
              tocElement.style.height = '0px';
              requestAnimationFrame(() => {
                  // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
                  tocElement.style.height = contentHeight + 'px';
              });

          } else if (isCurrentlyExpanded && tocElement) {
              // ë‹«í ë•Œ
              // â­ [ìˆ˜ì •] ë°±í‹±(`) ì œê±°
              tocElement.style.height = tocElement.scrollHeight + 'px';
              tocElement.style.paddingTop = contentPaddingTop;
              tocElement.style.paddingBottom = contentPaddingBottom;

              requestAnimationFrame(() => {
                  tocElement.style.height = '0px';
                  tocElement.style.paddingTop = '0';
                  tocElement.style.paddingBottom = '0';

                  setTimeout(() => {
                      tocElement.classList.add('closed');
                  }, transitionDuration); 
              });
          }

          // 4. ìºëŸ¬ì…€ ìŠ¤í¬ë¡¤ ì´ë™
          if (!isCurrentlyExpanded) {
              const carousel = card.closest('.carousel');
              if (carousel) {
                  const cardLeft = card.offsetLeft;
                  const carouselWidth = carousel.clientWidth;
                  
                  let expandedCardWidth;
                  
                  if (window.innerWidth <= 640) {
                      expandedCardWidth = 250; 
                  } else {
                      expandedCardWidth = 300; 
                  }

                  const scrollTarget = cardLeft + (expandedCardWidth / 2) - (carouselWidth / 2);
                  
                  carousel.scrollTo({
                      left: scrollTarget,
                      behavior: 'smooth'
                  });
              }
          }
      });
    });
  })();
  </script>
</body>
</html>