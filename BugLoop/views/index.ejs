<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('partials/head') -%>
  <link rel="stylesheet" href="/assets/css/index.css" />
</head>
<body>
  <div id="preloader"><div class="spinner"></div></div>
  <%- include('partials/header') -%>
  <div id="panel-root" data-pjax-scope><%- include('partials/panel') -%></div>

  <div class="app-shell">
    <div class="section-title-wrapper">
      <h1 class="section-title"><%= locale.index.ongoing %></h1>
    </div>

    <div class="carousel">
      <% 
        const ITEMS_PER_PAGE = 3;
        const getPaginatedToc = (tocData) => {
          if (!tocData) return { paginatedToc: [], totalPages: 0 };
          const totalPages = Math.ceil(tocData.length / ITEMS_PER_PAGE);
          const paginatedToc = Array.from({ length: totalPages }, (_, i) => 
            tocData.slice(i * ITEMS_PER_PAGE, (i + 1) * ITEMS_PER_PAGE)
          );
          return { paginatedToc, totalPages };
        };
        
        const renderTocHtmlSSR = (sections, bookKey) => {
          if (!sections) return '';
          let html = '<ul>';
          sections.forEach(s => {
            html += `<li><h5>${s.section}</h5><ul>`;
            s.chapters.forEach(ch => {
              const url = `/${lang}/books/${bookKey}/contents/${ch.id}`;
              html += `<li>${ch.url ? `<a href="${url}" class="toc-link active">${ch.title}</a>` : `<span class="toc-link disabled">${ch.title}</span>`}`;
              if (ch.sub) {
                html += '<ul>';
                ch.sub.forEach(sub => {
                  const subUrl = `/${lang}/books/${bookKey}/contents/${sub.id}`;
                  html += `<li>${sub.url ? `<a href="${subUrl}" class="toc-link active">${sub.title}</a>` : `<span class="toc-link disabled">${sub.title}</span>`}</li>`;
                });
                html += '</ul>';
              }
              html += '</li>';
            });
            html += '</ul></li>';
          });
          return html + '</ul>';
        };

        const bookKeys = ['cuteAcoustics', 'unfinishedPain', 'pianistProducer', 'warmthOfCalc'];
        bookKeys.forEach((key, idx) => {
          const book = locale.books[key];
          const { paginatedToc, totalPages } = getPaginatedToc(book.toc);
      -%>
      <div class="book-card" data-index="<%= idx %>" data-book-key="<%= key %>">
        <% if (book.updated) { -%><div class="book-updated-badge"><%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %></div><% } -%>
        <div class="book-content-wrapper">
          <div class="book-cover-wrapper">
            <img class="book-cover" src="/assets/images/book<%= idx + 1 %>.webm" alt="<%= book.title %>" loading="lazy">
          </div>
          <div class="book-info">
            <div class="book-title"><%= book.title %></div>
            <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;"><%= locale.ui["book-author"] %> : <%= book.author %></div>
          </div>
          <div class="book-toc">
            <h4><%= locale.ui["tocButton"] %></h4>
            <div class="pagination" data-book-id="<%= key %>-pagination">
              <% for(let i = 1; i <= totalPages; i++) { -%>
              <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, '<%= key %>', <%= i %>)"><%= i %></span>
              <% if (i < totalPages) { -%><span class="pagination-divider">|</span><% } -%>
              <% } -%>
            </div>
            <div class="paginated-toc" data-book-id="<%= key %>-toc"><%- renderTocHtmlSSR(paginatedToc[0], key) %></div>
          </div>
        </div>
      </div>
      <% }) -%>
    </div>

    <div class="recent-posts-wrapper section-title-wrapper" style="margin-top:30px; margin-bottom:0;">
      <h2 class="section-title"><%= locale.index.recentPosts || "ìµœê·¼ ê²Œì‹œë¬¼" %></h2>
    </div>

    <div class="recent-posts" id="posts-container">
      <% posts.slice(0, 5).forEach(post => { 
        const now = new Date(), cAt = new Date(post.created_at), uAt = new Date(post.updated_at), oneDay = 86400000;
        const isNew = (now - cAt) < oneDay, isEdit = uAt > cAt && (now - uAt < oneDay) && !isNew;
      -%>
      <div class="recent-post-item">
        <a href="/<%= lang %>/post/<%= post.id %>" class="recent-post-title">
          <% if (isNew) { -%><span class="label-icon new-icon"><%= locale.ui.newPost || 'NEW' %></span>
          <% } else if (isEdit) { -%><span class="label-icon edited-icon"><%= locale.ui.editedPost || 'UPDATED' %></span><% } -%>
          <% if (post.is_pinned) { -%><span class="badge-pinned">ðŸ“Œ</span><% } -%>
          <% if (post.is_private) { -%><span class="badge-private">ðŸ”’</span><% } -%>
          <%= post.title %>
        </a>
        <div class="recent-post-meta"><span><%= post.author %></span><span>Â·</span><span><%= format(cAt, 'yyyy.MM.dd') %></span></div>
        <div class="recent-post-preview">
          <% 
            const preview = post.content.replace(/<div class="auto-toc"[\s\S]*?<\/div>|<style\b[^>]*>[\s\S]*?<\/style>|<[^>]+>/gi, '')
              .replace(/\s+/g, ' ').trim().slice(0, 120);
          -%><%= preview %>...
        </div>
      </div>
      <% }) -%>
    </div>
    <button id="load-more-btn" onclick="loadMorePosts()"><%= locale.index.loadMore || "ë”ë³´ê¸°" %></button>
  </div>

  <footer class="app-footer">Â© 2025 Bug Loop</footer>
  <%- include('partials/scripts') -%>
  <script>
    window.__APP__ = { lang: "<%= lang %>", locale: <%- JSON.stringify(locale.ui || {}) %>, books: <%- JSON.stringify(locale.books || {}) %> };
  </script>
  <script src="/assets/js/index.js" defer></script>
</body>
</html>