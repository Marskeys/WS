<!DOCTYPE html>
<html lang="<%= lang %>">

<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/assets/css/index.css" />
</head>

<body>
  <div id="preloader">
    <div class="spinner"></div>
  </div>

  <%- include('partials/header') %>

  <div id="panel-root" data-pjax-scope>
    <%- include('partials/panel') %>
  </div>

  <div class="app-shell">

    <div class="section-title-wrapper">
      <h1 class="section-title"><%= locale.index.ongoing %></h1>
    </div>

    <div class="carousel">
      <% 
        const ITEMS_PER_PAGE = 3;

        const getPaginatedToc = (tocData) => {
          if (!tocData) return { paginatedToc: [], totalPages: 0 };
          const totalPages = Math.ceil(tocData.length / ITEMS_PER_PAGE);
          const paginatedToc = [];
          for (let i = 0; i < totalPages; i++) {
            paginatedToc.push(tocData.slice(i * ITEMS_PER_PAGE, i * ITEMS_PER_PAGE + ITEMS_PER_PAGE));
          }
          return { paginatedToc, totalPages };
        };

        const renderTocHtmlSSR = (sections, bookKey) => {
          if (!sections) return '';
          let html = '<ul>';
          sections.forEach(section => {
            html += `<li><h5>${section.section}</h5><ul>`;
            section.chapters.forEach(ch => {
              html += '<li>';
              if (ch.url) {
                html += `<a href="/${lang}/books/${bookKey}/contents/${ch.id}" class="toc-link active">${ch.title}</a>`;
              } else {
                html += `<span class="toc-link disabled">${ch.title}</span>`;
              }
              html += '</li>';
            });
            html += '</ul></li>';
          });
          html += '</ul>';
          return html;
        };
      %>

      <% Object.entries(locale.books).forEach(([bookKey, book], index) => {
          const data = getPaginatedToc(book.toc);
      %>

      <div class="book-card" data-index="<%= index %>" data-book-key="<%= bookKey %>">
        <% if (book.updated) { %>
          <div class="book-updated-badge"><%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %></div>
        <% } %>

        <div class="book-content-wrapper">
          <div class="book-cover-wrapper">
            <img
              class="book-cover"
              src="/assets/images/book<%= index + 1 %>.gif"
              alt="<%= book.title %>"
              loading="lazy"
            >
          </div>

          <div class="book-info">
            <div class="book-title"><%= book.title %></div>
            <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
              <%= locale.ui["book-author"] %> : <%= book.author %>
            </div>
          </div>

          <div class="book-toc">
            <h4><%= locale.ui["tocButton"] %></h4>

            <div class="pagination" data-book-id="<%= bookKey %>-pagination">
              <% for (let i = 1; i <= data.totalPages; i++) { %>
                <span
                  class="pagination-number <%= i === 1 ? 'active' : '' %>"
                  onclick="changePage(event, '<%= bookKey %>', <%= i %>)"
                ><%= i %></span>
                <% if (i < data.totalPages) { %>
                  <span class="pagination-divider">|</span>
                <% } %>
              <% } %>
            </div>

            <div class="paginated-toc" data-book-id="<%= bookKey %>-toc">
              <%- renderTocHtmlSSR(data.paginatedToc[0], bookKey) %>
            </div>
          </div>
        </div>
      </div>

      <% }) %>
    </div>

    <div class="recent-posts-wrapper section-title-wrapper" style="margin-top:30px;">
      <h2 class="section-title"><%= locale.index.recentPosts || "ìµœê·¼ ê²Œì‹œë¬¼" %></h2>
    </div>

    <div class="recent-posts" id="posts-container">
      <% posts.slice(0, 5).forEach(post => { %>
        <div class="recent-post-item">
          <a href="/<%= lang %>/post/<%= post.id %>" class="recent-post-title">
            <%= post.title %>
          </a>

          <div class="recent-post-meta">
            <span><%= post.author %></span>
            <span>Â·</span>
            <span><%= format(new Date(post.created_at), 'yyyy.MM.dd') %></span>
          </div>

          <div class="recent-post-preview">
            <%= post.preview %>...
          </div>
        </div>
      <% }) %>
    </div>

    <button id="load-more-btn" onclick="loadMorePosts()">
      <%= locale.index.loadMore || "ë”ë³´ê¸°" %>
    </button>

  </div>

  <footer class="app-footer">
    Â© 2025 Bug Loop
  </footer>

  <%- include('partials/scripts') %>

  <!-- ðŸ”‘ Client Data Bridge -->
  <script>
    window.booksData = <%- JSON.stringify(locale.books) %>;
    window.lang = "<%= lang %>";
  </script>

  <!-- ðŸ”— Index Page Script -->
  <script src="/assets/js/index.js" defer></script>

</body>
</html>
