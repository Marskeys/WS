<!DOCTYPE html>
  <html class="dark" lang="<%= lang %>">
  <head>
    <%- include('partials/head') %>
    <link rel="stylesheet" href="/assets/css/index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bug Loop</title>
    <style>

      /* ---------------------------------------------------- */
      /* ğŸ¯ [ìˆ˜ì •] í‘ë°± ì •ì§€í™”ë©´(Canvas) ìŠ¤íƒ€ì¼ */
      /* ---------------------------------------------------- */
      /* ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ìƒì„±í•  ìº”ë²„ìŠ¤(ì •ì§€í™”ë©´)ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. */
      .book-cover-static {
        width: 100%;
        height: 290px; 
        object-fit: cover;
        display: block;
        
        /* í‘ë°± ì²˜ë¦¬ ë° ì•½ê°„ ì–´ë‘¡ê²Œ */
        filter: grayscale(100%) brightness(0.95);
        
        /* ê¸°ì¡´ ì´ë¯¸ì§€ì™€ ìœ„ì¹˜ë¥¼ ë˜‘ê°™ì´ ë§ì¶¤ */
        position: absolute; 
        top: 0;
        left: 0;
        z-index: 5;
        border-radius: var(--radius) var(--radius) 0 0; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ìœ ì§€ */
      }
      
      @media (max-width: 640px){
        .book-cover-static {
          height: 220px; 
        }
      }

      /* ---------------------------------------------------- */
      /* ğŸ’¡ CSS ë³€ìˆ˜ ì„¤ì • (ê¸°ì¡´ ìœ ì§€) */
      /* ---------------------------------------------------- */
      :root{
        --chrome-gap:50px;
        --panel-gap:16px;
        --radius:12px;
        /* Light Mode Colors */
        --border:#d9d9d9;
        --bg:#f5f4d2;
        --panel:#ffffff;
        --panel-2:#f0f0ff;
        --ink:#1f1f1f;
        --ink-2:#5a5a5a;
        --accent:#cfcfd0;
        --primary:#217ee8;
        --primary-ink:#ffffff;
        --primary-rgb: 33, 126, 232; 

        --section-title-bg-light: #ffffff; 
        --section-title-bg-dark: #1b1b1b;  
        --section-title-border-light: #e0e0e0; 
        --section-title-border-dark: #2b2b2b;  
      }

      html.dark{
        --border:#2b2b2b;
        --bg:#121212;
        --panel:#1b1b1b;
        --panel-2:#0e0e0e;
        --ink:#eaeaea;
        --ink-2:#b7b7b7;
        --accent:#faffca;
        --primary:#217ee8;
        --primary-ink:#608b42; 
        --primary-rgb: 33, 126, 232; 
      }

      html { height: 100%; } 

      body {
        background: var(--bg);
        color: var(--ink);
        min-height: 100vh; 
        height: 100%; 
        display: flex;
        flex-direction: column;
        transition: background 0.3s, color 0.3s;
      }

      .app-shell{
        padding: 16px 16px 16px calc(var(--chrome-gap) + 16px);
        padding-top: calc(50px + 16px);
        margin-top: 180px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        margin-bottom: 20px; 
      }

      @media (max-width: 640px){
        .app-shell{
          padding-left: 16px;
          padding-bottom: 70px; 
          margin-top: 250px;
          margin-bottom: 0;
        }
      }

      .spacer {
        height: 50vh;
        min-height: 300px;
        width: 100%;
        background: transparent;
      }

      /* ---------------------------------------------------- */
      /* ğŸ“Œ ì„¹ì…˜ ì œëª©, ìºëŸ¬ì…€ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
      /* ---------------------------------------------------- */

      .section-title-wrapper {
          width: 100vw;
          margin-left: calc(-1 * (var(--chrome-gap) + 16px)); 
          background: var(--section-title-bg-light); 
          border-top: 1px solid var(--section-title-border-light);
          border-bottom: 1px solid var(--section-title-border-light);
          margin-bottom: 16px; 
          padding: 8px 0; 
      }

      html.dark .section-title-wrapper {
          background: var(--section-title-bg-dark); 
          border-top: 1px solid var(--section-title-border-dark);
          border-bottom: 1px solid var(--section-title-border-dark);
      }
      
      @media (max-width: 640px){
          .section-title-wrapper {
              margin-left: -16px; 
          }
      }

      .section-title {
        margin-left: calc(var(--chrome-gap) + 16px); 
        color: var(--ink);
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0; 
        margin-top: 0;
        letter-spacing: 0.5px;
      }
      
      @media (max-width: 640px){
          .section-title {
              margin-left: 16px; 
          }
      }


      html.dark .section-title {
          color: var(--accent);
          text-shadow: 0 0 10px var(--accent), 0 0 20px rgba(0, 245, 212, 0.2);
      }

      .carousel {
        display: flex;
        margin-top:12px;
        gap: 16px; 
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 10px 0 8px 0; 
      }

      .carousel::-webkit-scrollbar { display: none; }

      /* ---------------------------------------------------- */
      /* âœ… ë¶ì¹´ë“œ: ê¸°ë³¸ í¬ê¸° ì¶•ì†Œ ë° í™•ì¥ ìŠ¤íƒ€ì¼ ì¬ì •ì˜ */
      /* ---------------------------------------------------- */
      .book-card {
        flex-shrink: 0;
        width: 180px; 
        background: var(--panel);
        border-radius: var(--radius);
        color: var(--ink);
        transition: all 0.3s ease, width 0.4s ease, height 0.4s ease; 
        scroll-snap-align: start;
        cursor: pointer;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
        z-index: 1; 
        border: 2px solid transparent; 
        padding: 0; 
      }

      .book-card:hover {
        background: var(--panel-2); 
      }

      /* â­ í´ë¦­ ì‹œ ì¹´ë“œ ì „ì²´ê°€ ì»¤ì§€ê³  í™œì„±í™” íš¨ê³¼ ì ìš© */
      .book-card.expanded {
          width: 300px; 
          transform: translateY(-8px); 
          background: var(--panel);
          
          /* ğŸ¯ í™œì„±í™” í…Œë‘ë¦¬ ë° ê·¸ë¦¼ì (ë¼ì´íŠ¸ ëª¨ë“œ) - ê¹”ë”í•˜ê³  ë°ê²Œ */
          border-color: var(--primary); 
          box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3), 
                      0 0 0 3px rgba(var(--primary-rgb), 0.1); 
          
          z-index: 10; 
      }

      html.dark .book-card.expanded {
          /* ğŸ¯ í™œì„±í™” í…Œë‘ë¦¬ ë° ê·¸ë¦¼ì (ë‹¤í¬ ëª¨ë“œ) - ë°ê³  ê¹”ë”í•˜ê²Œ */
          border-color: #55aaff; 
          box-shadow: 0 5px 15px rgba(33, 126, 232, 0.9), 
                      0 0 0 3px rgba(33, 126, 232, 0.5); 
      }


      /* ì¹´ë“œ ë‚´ë¶€ ì»¨í…ì¸  ë˜í¼: ì „ì²´ ë‘¥ê·¼ ëª¨ì„œë¦¬ë¥¼ ë‹´ë‹¹ */
      .book-content-wrapper {
          border-radius: var(--radius);
          overflow: hidden; 
      }


      .book-cover-wrapper {
          overflow: hidden;
          /* ê¸°ë³¸ ìƒíƒœ: ìƒë‹¨ ëª¨ì„œë¦¬ë§Œ ë‘¥ê¸€ê²Œ (--radius) */
          border-radius: var(--radius) var(--radius) 0 0; 
          background: var(--panel-2); 
          transition: border-radius 0.4s ease;
          position: relative; /* Canvas ìœ„ì¹˜ ì¡ê¸° ìœ„í•´ ì¶”ê°€ */
      }
      
      /* í¼ì³ì§„ ìƒíƒœì¼ ë•Œ ì´ë¯¸ì§€ ë˜í¼ì˜ í•˜ë‹¨ ëª¨ì„œë¦¬ë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ì–´ ëª©ì°¨ì™€ ê¹”ë”í•˜ê²Œ ì—°ê²° */
      .book-card.expanded .book-cover-wrapper {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }
      
      /* í¼ì³ì§€ë©´ Canvasë„ ì•„ë˜ìª½ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
      .book-card.expanded .book-cover-static {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }


      .book-cover {
        width: 100%;
        height: 290px; 
        object-fit: cover;
        display: block;
        transition: all 0.3s ease; 
        /* ğŸ¯ í‹ˆìƒˆ ì œê±° íŠ¸ë¦­ ìœ ì§€ */
        transform: scale(1.01); 
      }
      
      @media (max-width: 640px){
        .book-cover {
          height: 220px; 
        }
      }


      .book-info {
        padding: 12px 8px; 
        text-align: center;
        border-top: 1px solid var(--border); 
        background: var(--panel-2);
      }

      .book-title {
        font-weight: 600;
        font-size: 1rem; 
        color: var(--ink);
        line-height: 1.4;
        white-space: normal;
        word-break: keep-all;
        letter-spacing: 0.3px;
      }

      .book-title::after {
        content: "";
        display: block;
        width: 40%;
        height: 2px;
        background: var(--primary);
        margin: 6px auto 0; 
        border-radius: 1px;
        opacity: 0.7;
      }

      /* ---------------------------------------------------- */
      /* âœ… ëª©ì°¨ ìŠ¤íƒ€ì¼: JSë¡œ height ì œì–´ ë° CSS padding ê³ ì • */
      /* ---------------------------------------------------- */
      .book-toc {
        background: var(--panel-2);
        color: var(--ink-2);
        font-size: 0.9rem;
        border-top: 1px solid var(--border);
        
        height: 0; 
        overflow: hidden; 
        /* ğŸ¯ íŒ¨ë”©ì„ CSSì— ê³ ì •í•˜ê³  height íŠ¸ëœì§€ì…˜ì„ ë¶„ë¦¬ */
        padding: 16px; 
        
        /* ì´ˆê¸°ì—ëŠ” íŒ¨ë”©ì„ 0ìœ¼ë¡œ ì‹œì‘ */
        padding-top: 0;
        padding-bottom: 0;
        
        /* GPU ê°€ì† ìœ ë„ */
        will-change: height, opacity, transform; 
        /* heightì™€ opacityì—ë§Œ íŠ¸ëœì§€ì…˜ ì ìš© */
        transition: height 0.5s ease-out, opacity 0.5s ease-out; 
        opacity: 0;
      }
      
      /* ë‹«íŒ ìƒíƒœë¥¼ ìœ„í•œ í´ë˜ìŠ¤ (JSì—ì„œ ì ìš©) */
      .book-toc.closed {
          padding-top: 0 !important;
          padding-bottom: 0 !important;
          opacity: 0;
          height: 0px !important;
      }
      
      /* ì—´ë¦° ìƒíƒœ (JSê°€ heightë¥¼ ì½˜í…ì¸  ë†’ì´ë¡œ ì„¤ì •) */
      .book-card.expanded .book-toc {
        opacity: 1;
        /* heightëŠ” JSì—ì„œ ì„¤ì •ë¨ */
      }
      /* ---------------------------------------------------- */

      .book-toc h4 {
        margin: 0 0 8px 0;
        color: var(--primary);
        font-size: 0.95rem;
        text-align: center;
      }

      .book-toc h5 {
        margin: 12px 0 6px 0;
        color: var(--ink);
        font-size: 1rem;
        font-weight: 600;
      }

      .book-toc ul {
        margin: 0 0 12px 0;
        padding-left: 0;
        list-style: none;
      }

      .book-toc > .paginated-toc > ul > li > ul {
        margin: 0;
        padding-left: 14px;
        list-style: none;
      }

      .book-toc > .paginated-toc > ul > li > ul > li {
        color: var(--ink-2);
        font-weight: 500;
      }

      .book-toc > .paginated-toc > ul > li > ul > li > ul {
        margin: 4px 0 0 0;
        padding-left: 18px;
        list-style: disc;
      }
      
      .book-toc li {
        margin-bottom: 4px;
        line-height: 1.4;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      .pagination-number {
        padding: 0 8px;
        cursor: pointer;
        color: var(--ink-2);
        transition: color 0.2s;
      }

      .pagination-number:hover { color: var(--primary); }
      .pagination-number.active {
        color: var(--primary);
        font-weight: 700;
      }

      .pagination-divider {
        color: var(--border);
        margin: 0 2px;
      }

      /* âœ… ë§í¬ í™œì„±/ë¹„í™œì„± ìŠ¤íƒ€ì¼ */
      .toc-link {
        text-decoration: none;
        transition: color 0.2s, opacity 0.2s;
      }
      .toc-link.active {
        color: var(--primary);
        cursor: pointer;
      }
      .toc-link.active:hover {
        color: var(--accent);
        text-decoration: underline;
      }
      .toc-link.disabled {
        color: var(--ink-2);
        opacity: 0.6;
        cursor: default;
        pointer-events: none;
      }

      /* ---------------------------------------------------- */
      /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” (640px ì´í•˜) - ë¶ì¹´ë“œ í¬ê¸° */
      /* ---------------------------------------------------- */
      @media (max-width: 640px){
        .carousel {
          gap: 12px; 
        }
        .book-card {
          width: 140px; 
        }
        .book-card.expanded {
          width: 250px; 
        }
        .book-info {
          padding: 10px 6px; 
        }
        .book-title {
          font-size: 0.9rem; 
        }
      }
      
      /* ---------------------------------------------------- */
      /* â¬‡ï¸ ì´í•˜ ê¸°ì¡´ CSSëŠ” ìœ ì§€ â¬‡ï¸ */
      /* ---------------------------------------------------- */

      .recent-posts {
          display: flex;
          flex-direction: column;
          gap: 12px; 
          margin-top: 12px; 
          padding: 0; 
      }

      .recent-post-item {
          background: var(--panel);
          border-radius: 8px;
          padding: 15px 20px;
          transition: background 0.2s, border-color 0.2s; 
          cursor: pointer;
          border: 1px solid transparent; 
      }

      .recent-post-item:hover {
          background: var(--panel-2);
          border-color: var(--primary); 
      }
      html.dark .recent-post-item {
          border: 1px solid transparent;
      }
      html.dark .recent-post-item:hover {
          background: var(--panel-2);
          border-color: var(--primary);
      }

      .recent-post-title {
          font-size: 1.1rem;
          font-weight: 600;
          color: var(--ink);
          text-decoration: none;
          display: flex;
          align-items: center;
          margin-bottom: 6px;
      }
      
      @keyframes wiggle-float {
        0% { transform: translateY(0) rotate(0deg); }
        25% { transform: translateY(-1px) rotate(-2deg); }
        60% { transform: translateY(0) rotate(1deg); }
        80% { transform: translateY(1px) rotate(-1deg); }
        100% { transform: translateY(0) rotate(0deg); }
      }

      .label-icon {
        display: inline-block;
        padding: 3px 6px; 
        margin-right: 8px; 
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white !important; 
        line-height: 1.2;
        vertical-align: middle;
        text-transform: uppercase;
        background-image: none;
        width: auto;
        height: auto;
        flex-shrink: 0;
        animation: wiggle-float 0.9s ease-in-out infinite; 
      }

      .new-icon { background-color: #ff4757; }
      .edited-icon { background-color: #2e86de; }

      html.dark .new-icon { background-color: #e84118; }
      html.dark .edited-icon { background-color: #1e3799; }

      .badge-pinned {
          margin-right: 5px; 
          font-size: 0.9em; 
      }

      .recent-post-meta {
          font-size: 0.85rem;
          color: var(--ink-2);
      }

      .recent-post-preview {
          font-size: 0.9rem;
          color: var(--ink-2);
          margin-top: 8px;
          line-height: 1.5;
      }

      #load-more-btn {
          display: block; 
          width: 200px; 
          margin: 0 auto 16px; 
          padding: 12px 20px;
          border-radius: 25px; 
          
          background: linear-gradient(135deg, #A8E063, #56AB2F); 
          
          border: none; 
          color: #ffffff; 
          
          font-weight: 700;
          cursor: pointer;
          font-size: 1rem;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
          transition: transform 0.15s, opacity 0.15s, box-shadow 0.15s, background 0.3s, color 0.3s; 
          letter-spacing: 0.5px;
      }

      #load-more-btn:hover {
          opacity: 0.9;
          transform: translateY(-1px);
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      html.dark #load-more-btn {
          background: transparent; 
          color: #ffffff; 
          border: 2px solid #ffffff; 
          box-shadow: 0 4px 6px rgba(255, 255, 255, 0.15); 
      }
      
      html.dark #load-more-btn:hover {
          background: #ffffff; 
          color: var(--bg); 
          border-color: var(--bg);
          box-shadow: 0 6px 12px rgba(255, 255, 255, 0.3);
          transform: translateY(-2px); 
      }

      .app-footer {
          width: 100%;
          margin-top: auto; 
          padding: 20px 16px;
          text-align: center;
          color: var(--ink-2);
          font-size: 0.85rem;
          border-top: 1px solid var(--border);
          background: var(--panel-2);
          z-index: 10; 
          flex-shrink: 0; 
      }
      
      @media (min-width: 641px) {
          .recent-posts {
              max-width: 800px; 
              margin-left: 0; 
              margin-right: auto;
              padding-left: 0; 
          }
          
          .recent-posts-wrapper .section-title {
              margin-left: calc(var(--chrome-gap) + 16px); 
              margin-right: auto;
          }

          #load-more-btn {
              margin-left: auto;
              margin-right: auto;
          }
      }
    </style>
  </head>

  <body class="light">
    <div id="preloader"><div class="spinner"></div></div>
    <%- include('partials/header') %>

    <div id="panel-root" data-pjax-scope>
      <%- include('partials/panel') %>
    </div>

  
    <div class="app-shell">
    
      <div class="section-title-wrapper">
          <h1 class="section-title"><%= locale.index.ongoing %></h1>
      </div>

      <div class="carousel">

      <% 
        // ğŸ’¡ ëª©ì°¨ í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •ì„ ìœ„í•œ ë²”ìš© í•¨ìˆ˜
        const ITEMS_PER_PAGE = 3;
        
        const getPaginatedToc = (tocData) => {
          if (!tocData) return { paginatedToc: [], totalPages: 0, totalSections: 0 };
          const totalSections = tocData.length;
          const totalPages = Math.ceil(totalSections / ITEMS_PER_PAGE);
          const paginatedToc = [];

          for (let i = 0; i < totalPages; i++) {
            const start = i * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            paginatedToc.push(tocData.slice(start, end));
          }
          return { paginatedToc, totalPages, totalSections };
        };
        
        // ğŸ’¡ ëª©ì°¨ HTML ë Œë”ë§ í•¨ìˆ˜ (JSì™€ EJSì—ì„œ ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¸ë¼ì¸ìœ¼ë¡œ ì •ì˜)
        const renderTocHtml = (sections, bookKey) => {
          if (!sections || sections.length === 0) return '';
          let html = '<ul>';
          sections.forEach(section => {
            html += `<li><h5>${section.section}</h5><ul>`;
            section.chapters.forEach(ch => {
              html += `<li>`;
              
              // ë§í¬ URLì€ bookKeyë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ ìƒì„±
              const urlPath = `/books/${bookKey}/contents/${ch.id}`; 

              if (ch.url) {
                html += `<a 
                  href="/${lang}${urlPath}" 
                  class="toc-link active"
                >
                  ${ch.title}
                </a>`;
              } else {
                html += `<span class="toc-link disabled">${ch.title}</span>`;
              }

              if (ch.sub) {
                html += '<ul>';
                ch.sub.forEach(sub => {
                  html += `<li>`;
                  const subUrlPath = `/books/${bookKey}/contents/${sub.id}`;
                  
                  if (sub.url) {
                    html += `<a 
                      href="/${lang}${subUrlPath}" 
                      class="toc-link active"
                    >
                      ${sub.title}
                    </a>`;
                  } else {
                    html += `<span class="toc-link disabled">${sub.title}</span>`;
                  }
                  html += '</li>';
                });
                html += '</ul>';
              }

              html += '</li>';
            });
            html += '</ul></li>';
          });
          html += '</ul>';
          return html;
        };

        // ğŸ“š 1. ê·€ì—¬ìš´ ìŒí–¥í•™ (cuteAcoustics)
        const cuteAcoustics = locale.books.cuteAcoustics;
        const caData = getPaginatedToc(cuteAcoustics.toc);
      %>

     <div class="book-card" data-index="0" data-book-key="cuteAcoustics">

  <% if (cuteAcoustics.updated) { %>
    <div class="book-updated-badge">
      <%= locale.ui.bookUpdatedBadge || 'ìƒˆ ì±•í„°!' %>
    </div>
  <% } %>

  <div class="book-content-wrapper"> 
    <div class="book-cover-wrapper">
      <img class="book-cover" src="/assets/images/book1.gif" alt="<%= cuteAcoustics.title %>" loading="lazy">
    </div>

    <div class="book-info">
      <div class="book-title"><%= cuteAcoustics.title %></div>
      <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
        <%= locale.ui["book-author"] %> : <%= cuteAcoustics.author %>
      </div>
    </div>

    <div class="book-toc"> 
      <h4><%= cuteAcoustics.title %> ëª©ì°¨</h4>

      <div class="pagination" data-book-id="cuteAcoustics-pagination">
        <% for(let i = 1; i <= caData.totalPages; i++) { %>
          <span class="pagination-number <%= i === 1 ? 'active' : '' %>" 
                onclick="changePage(event, 'cuteAcoustics', <%= i %>)">
            <%= i %>
          </span>
          <% if (i < caData.totalPages) { %>
            <span class="pagination-divider">|</span>
          <% } %>
        <% } %>
      </div>

      <div class="paginated-toc" data-book-id="cuteAcoustics-toc">
        <%- renderTocHtml(caData.paginatedToc[0], 'cuteAcoustics') %>
      </div>

      <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
        ì´ <%= caData.totalSections %>ê°œ ì„¹ì…˜
      </div>
    </div>
  </div>
</div>

      
      <% 
        // ğŸ“š 2. ë¯¸ì™„ì„± ê³ í†µ (unfinished_pain)
        const unfinishedPain = locale.books.unfinished_pain;
        const upData = getPaginatedToc(unfinishedPain.toc);
      %>
      <div class="book-card" data-index="1" data-book-key="unfinished_pain">
        <div class="book-content-wrapper">
          <div class="book-cover-wrapper">
            <img class="book-cover" src="/assets/images/book2.gif" alt="<%= unfinishedPain.title %>" loading="lazy">
          </div>
          <div class="book-info">
              <div class="book-title"><%= unfinishedPain.title %></div>
              <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
                <%= locale.ui["book-author"] %>: <%= unfinishedPain.author %>
              </div>
          </div>
          <div class="book-toc">
            <h4><%= unfinishedPain.title %> ëª©ì°¨</h4>
            
            <div class="pagination" data-book-id="unfinished_pain-pagination">
              <% for(let i = 1; i <= upData.totalPages; i++) { %>
                <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'unfinished_pain', <%= i %>)">
                  <%= i %>
                </span>
                <% if (i < upData.totalPages) { %><span class="pagination-divider">|</span><% } %>
              <% } %>
            </div>

            <div class="paginated-toc" data-book-id="unfinished_pain-toc">
              <%- renderTocHtml(upData.paginatedToc[0], 'unfinishedPain') %>
            </div>
            <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
              ì´ <%= upData.totalSections %>ê°œ ì„¹ì…˜
            </div>
          </div>
        </div>
      </div>
      
      <% 
        // ğŸ“š 3. í”¼ì•„ë…¸ ì¹˜ëŠ” í”„ë¡œë“€ì„œ: ì‹ ë¹„í•œ ë°˜ì£¼ë²• (pianist_producer)
        const pianistProducer = locale.books.pianist_producer;
        const ppData = getPaginatedToc(pianistProducer.toc);
      %>
      <div class="book-card" data-index="2" data-book-key="pianist_producer">
        <div class="book-content-wrapper">
          <div class="book-cover-wrapper">
            <img class="book-cover" src="/assets/images/book3.gif" alt="<%= pianistProducer.title %>" loading="lazy">
          </div>
          <div class="book-info">
              <div class="book-title"><%= pianistProducer.title %></div>
              <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
                <%= locale.ui["book-author"] %>: <%= pianistProducer.author %>
              </div>
          </div>
          <div class="book-toc">
            <h4><%= pianistProducer.title %> ëª©ì°¨</h4>
            
            <div class="pagination" data-book-id="pianist_producer-pagination">
              <% for(let i = 1; i <= ppData.totalPages; i++) { %>
                <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'pianist_producer', <%= i %>)">
                  <%= i %>
                </span>
                <% if (i < ppData.totalPages) { %><span class="pagination-divider">|</span><% } %>
              <% } %>
            </div>

            <div class="paginated-toc" data-book-id="pianist_producer-toc">
              <%- renderTocHtml(ppData.paginatedToc[0], 'pianistProducer') %>
            </div>
            <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
              ì´ <%= ppData.totalSections %>ê°œ ì„¹ì…˜
            </div>
          </div>
        </div>
      </div>

      <% 
        // ğŸ“š 4. ê³„ì‚°ì˜ ì˜¨ê¸° (warmth_of_calc)
        const warmthOfCalc = locale.books.warmth_of_calc;
        const wcData = getPaginatedToc(warmthOfCalc.toc);
      %>
      <div class="book-card" data-index="3" data-book-key="warmth_of_calc">
        <div class="book-content-wrapper">
          <div class="book-cover-wrapper">
            <img class="book-cover" src="/assets/images/book4.gif" alt="<%= warmthOfCalc.title %>" loading="lazy">
          </div>
          <div class="book-info">
              <div class="book-title"><%= warmthOfCalc.title %></div>
              <div style="font-size:0.85rem; color:var(--ink-2); margin-top:4px;">
              <%= locale.ui["book-author"] %>: <%= warmthOfCalc.author %>
              </div>
          </div>
          <div class="book-toc">
            <h4><%= warmthOfCalc.title %> ëª©ì°¨</h4>
            
            <div class="pagination" data-book-id="warmth_of_calc-pagination">
              <% for(let i = 1; i <= wcData.totalPages; i++) { %>
                <span class="pagination-number <%= i === 1 ? 'active' : '' %>" onclick="changePage(event, 'warmth_of_calc', <%= i %>)">
                  <%= i %>
                </span>
                <% if (i < wcData.totalPages) { %><span class="pagination-divider">|</span><% } %>
              <% } %>
            </div>

            <div class="paginated-toc" data-book-id="warmth_of_calc-toc">
              <%- renderTocHtml(wcData.paginatedToc[0], 'warmthOfCalc') %>
            </div>
            <div style="text-align:center; margin-top: 10px; color: var(--ink-2); font-size: 0.8rem;">
              ì´ <%= wcData.totalSections %>ê°œ ì„¹ì…˜
            </div>
          </div>
        </div>
      </div>
      
      </div>
      

      <div class="recent-posts-wrapper section-title-wrapper" style="margin-bottom: 0; margin-top: 30px;">
          <h2 class="section-title"><%= locale.index.recentPosts || "ìµœê·¼ ê²Œì‹œë¬¼" %></h2>
      </div>

      <div class="recent-posts" id="posts-container">
    <% posts.slice(0, 5).forEach(post => { %>
      <div class="recent-post-item">

        <%
          const now = new Date();
          const createdAt = new Date(post.created_at);
          const updatedAt = new Date(post.updated_at);
          const oneDay = 1000 * 60 * 60 * 24;
          const isNewPost = (now - createdAt) < oneDay;
          const wasEdited = updatedAt > createdAt;
          const isRecentlyEdited = wasEdited && (now - updatedAt < oneDay);
          const showEditedLabel = !isNewPost && isRecentlyEdited;

          // ë‹¤êµ­ì–´ ë¼ë²¨ í…ìŠ¤íŠ¸ ì •ì˜ (locale.uiì— í‚¤ê°€ ìˆë‹¤ê³  ê°€ì •)
          const newLabelText = locale.ui.newPost || 'NEW';
          const editedLabelText = locale.ui.editedPost || 'UPDATED';
        %>

 <a href="/<%= lang %>/post/<%= post.id %>" class="recent-post-title">
  <% if (isNewPost) { %>
    <span class="label-icon new-icon"><%= newLabelText %></span>
  <% } else if (showEditedLabel) { %>
    <span class="label-icon edited-icon"><%= editedLabelText %></span>
  <% } %>

  <% if (post.is_pinned) { %>
    <span class="badge-pinned">ğŸ“Œ</span>
  <% } %>

  <% if (post.is_private) { %>
    <span class="badge-private">ğŸ”’</span>
  <% } %>

  <%= post.title %>
</a>

        <div class="recent-post-meta">
          <span><%= post.author %></span>
          <span>Â·</span>
          <span><%= format(new Date(post.created_at), 'yyyy.MM.dd') %></span>
        </div>

        <div class="recent-post-preview">
          <% 
            // ğŸ“Œ ìˆ˜ì •ëœ ë¡œì§: ëª©ì°¨, ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±° ë° í…ìŠ¤íŠ¸ ì •ì œ
            // 1. ë¶ˆí•„ìš”í•œ HTML ë©ì–´ë¦¬ ì œê±°: ëª©ì°¨ ì˜ì—­ (div.auto-toc)ê³¼ ìŠ¤íƒ€ì¼ ì˜ì—­ (style)
            let cleanContent = post.content.replace(/<div class="auto-toc"[\s\S]*?<\/div>/gi, '');
            cleanContent = cleanContent.replace(/<style\b[^>]*>[\s\S]*?<\/style>/gi, '');
            
            // 2. ëª¨ë“  ë‚¨ì€ HTML íƒœê·¸ ì œê±° (íƒœê·¸ ì‚¬ì´ì˜ í…ìŠ¤íŠ¸ë§Œ ë‚¨ê¹€)
            let plainText = cleanContent.replace(/<[^>]+>/gi, '');
            
            // 3. í…ìŠ¤íŠ¸ ì •ë¦¬: ì—°ì†ëœ ê³µë°±(ì¤„ë°”ê¿ˆ í¬í•¨)ì„ í•˜ë‚˜ì˜ ê³µë°±ìœ¼ë¡œ ì¹˜í™˜í•˜ê³ , ì•ë’¤ ê³µë°± ì œê±°
            plainText = plainText.replace(/\s+/g, ' ').trim();

            // 4. HTML ì—”í‹°í‹° ì½”ë“œë¥¼ ì¼ë°˜ ë¬¸ìë¡œ ë³€í™˜
            const decodedText = plainText
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&');
        
            // 5. ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì—ì„œ 120ìë§Œ ìŠ¬ë¼ì´ìŠ¤
            const previewText = decodedText.slice(0, 120);
          %>
          <%= previewText %>...
        </div>

      </div>
    <% }) %>
  </div>

  <button id="load-more-btn" onclick="loadMorePosts()">
    <%= locale.index.loadMore || "ë”ë³´ê¸°" %>
  </button>


    </div>
    
    <footer class="app-footer">
      Â© 2025 Bug Loop
    </footer>
    <%- include('partials/scripts') %>

  <script>
  const lang = "<%= lang %>";
  const booksData = <%- JSON.stringify(locale.books) %>; // ëª¨ë“  ì±… ë°ì´í„°ë¥¼ JSë¡œ ê°€ì ¸ì˜´

  let offset = 5;   
  let loading = false;

  async function loadMorePosts() {
    if (loading) return;
    loading = true;

    try {
      const res = await fetch(`/api/recent-posts?offset=${offset}&limit=5&lang=${lang}`);
      const data = await res.json();
      
      if (!data.posts || data.posts.length === 0) {
        document.getElementById("load-more-btn").style.display = "none";
        loading = false; 
        return;
      }
    
      offset += data.posts.length;
    
      const container = document.getElementById("posts-container");
      if (!container) {
        console.error("Posts container not found! (EJS ID í™•ì¸ ìš”ë§)");
        loading = false;
        return;
      }
    
      data.posts.forEach(post => {
        const el = document.createElement("div");
        el.className = "recent-post-item"; 
        
        // âœ… AJAX ë¡œë“œ ì‹œ ë‚ ì§œ ë¹„êµ ë¡œì§ ì¶”ê°€
        const now = new Date();
        const createdAt = new Date(post.created_at);
        const updatedAt = new Date(post.updated_at);
        const oneDay = 1000 * 60 * 60 * 24;
        const isNewPost = (now - createdAt) < oneDay;
        const wasEdited = updatedAt > createdAt;
        const isRecentlyEdited = wasEdited && (now - updatedAt < oneDay);
        const showEditedLabel = !isNewPost && isRecentlyEdited;

        // âœ… ë‹¤êµ­ì–´ ë¼ë²¨ í…ìŠ¤íŠ¸ ë° HTML ìƒì„±
        const newLabelText = "<%= locale.ui.newPost || 'NEW' %>";
        const editedLabelText = "<%= locale.ui.editedPost || 'UPDATED' %>";
        
        let labelHtml = '';
        if (isNewPost) {
            labelHtml = `<span class="label-icon new-icon">${newLabelText}</span>`;
        } else if (showEditedLabel) {
            labelHtml = `<span class="label-icon edited-icon">${editedLabelText}</span>`;
        }
        
        const formattedDate = post.created_fmt; 
        
        // ğŸ“Œ í•µì‹¬ ìˆ˜ì •: ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ì •ì œ (post.contentê°€ ìˆëŠ” ê²½ìš° ì²˜ë¦¬)
        let previewText = '';
        if (post.content) {
          // 1. ë¶ˆí•„ìš”í•œ HTML ë©ì–´ë¦¬ ì œê±°: ëª©ì°¨ ì˜ì—­ê³¼ ìŠ¤íƒ€ì¼ ì˜ì—­
          let cleanContent = post.content.replace(/<div class="auto-toc"[\s\S]*?<\/div>/gi, '');
          cleanContent = cleanContent.replace(/<style\b[^>]*>[\s\S]*?<\/style>/gi, '');
          
          // 2. ëª¨ë“  ë‚¨ì€ HTML íƒœê·¸ ì œê±°
          let plainText = cleanContent.replace(/<[^>]+>/gi, '');
          
          // 3. í…ìŠ¤íŠ¸ ì •ë¦¬: ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ì˜ ê³µë°±ìœ¼ë¡œ ì¹˜í™˜í•˜ê³  ì•ë’¤ ê³µë°± ì œê±°
          plainText = plainText.replace(/\s+/g, ' ').trim();

          // 4. HTML ì—”í‹°í‹° ì½”ë“œë¥¼ ì¼ë°˜ ë¬¸ìë¡œ ë³€í™˜
          const decodedText = plainText
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&');
      
          // 5. ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì—ì„œ 120ìë§Œ ìŠ¬ë¼ì´ìŠ¤
          previewText = decodedText.slice(0, 120);
        } else if (post.preview) {
          // post.contentê°€ ì—†ê³  post.previewê°€ ìˆë‹¤ë©´ ê·¸ê±¸ ì‚¬ìš© (ì„œë²„ì—ì„œ ì´ë¯¸ ì •ì œí–ˆì„ ê²½ìš° ëŒ€ë¹„)
          let decodedPreview = post.preview
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&');
          previewText = decodedPreview.slice(0, 120);
        }
        // ----------------------------------------
    
        el.innerHTML = `
          <a href="/${lang}/post/${post.id}" class="recent-post-title">
            ${labelHtml}  
            ${post.is_pinned ? '<span class="badge-pinned">ğŸ“Œ</span>' : ''}
            ${post.title}
          </a>
    
          <div class="recent-post-meta">
            <span>${post.author}</span>
            <span>Â·</span>
            <span>${formattedDate}</span>
          </div>
    
          <div class="recent-post-preview">
            ${previewText}... 
          </div>
        `;
        
        container.appendChild(el);
      });
    
      loading = false;
    } catch (error) {
        console.error("Error loading more posts or processing JSON (DOM/Parsing Error):", error);
        loading = false;
    }
  }


  window.loadMorePosts = loadMorePosts;

  </script>



    <script>
    (() => {
      // ----------------------------------------------------
      // ì „ì—­ ë³€ìˆ˜ ì„¤ì •: booksDataë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
      // ----------------------------------------------------
      const booksData = <%- JSON.stringify(locale.books) %>; // ëª¨ë“  ì±… ë°ì´í„°ë¥¼ JSë¡œ ê°€ì ¸ì˜´
      const itemsPerPage = 3;
      
      // ----------------------------------------------------
      // ëª©ì°¨ ë Œë”ë§ ë¡œì§ (ë²”ìš©ì ìœ¼ë¡œ ìˆ˜ì •)
      // ----------------------------------------------------
      const getPaginatedToc = (tocData) => {
        if (!tocData) return { paginatedToc: [], totalPages: 0, totalSections: 0 };
        const totalSections = tocData.length;
        const totalPages = Math.ceil(totalSections / itemsPerPage);
        const paginatedToc = [];

        for (let i = 0; i < totalPages; i++) {
          const start = i * itemsPerPage;
          const end = start + itemsPerPage;
          paginatedToc.push(tocData.slice(start, end));
        }
        return { paginatedToc, totalPages, totalSections };
      };

      const renderTocHtml = (sections, bookKey) => {
        if (!sections || sections.length === 0) return '';
        let html = '<ul>';
        
        // bookKeyë¥¼ ì‚¬ìš©í•˜ì—¬ URL ê²½ë¡œ ìƒì„± (JS í•¨ìˆ˜ì´ë¯€ë¡œ EJS ë³€ìˆ˜ì™€ëŠ” ë‹¤ë¥¸ bookKeyë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
        // ì˜ˆ: cuteAcoustics -> cuteAcoustics
        const snakeToCamel = (s) => s.replace(/(_\w)/g, k => k[1].toUpperCase());
        const camelCaseKey = snakeToCamel(bookKey);

        sections.forEach(section => {
          html += `<li><h5>${section.section}</h5><ul>`;
          section.chapters.forEach(ch => {
            html += `<li>`;
            
            const urlPath = `/books/${camelCaseKey}/contents/${ch.id}`; 

            if (ch.url) {
              html += `<a 
                href="/${lang}${urlPath}" 
                class="toc-link active"
              >
                ${ch.title}
              </a>`;
            } else {
              html += `<span class="toc-link disabled">${ch.title}</span>`;
            }

            if (ch.sub) {
              html += '<ul>';
              ch.sub.forEach(sub => {
                html += `<li>`;
                const subUrlPath = `/books/${camelCaseKey}/contents/${sub.id}`;
                
                if (sub.url) {
                  html += `<a 
                    href="/${lang}${subUrlPath}" 
                    class="toc-link active"
                  >
                    ${sub.title}
                  </a>`;
                } else {
                  html += `<span class="toc-link disabled">${sub.title}</span>`; 
                }
                html += '</li>';
              });
              html += '</ul>';
            }

            html += '</li>';
          });
          html += '</ul></li>';
        });
        html += '</ul>';
        return html;
      };


      window.changePage = (event, bookKey, pageNumber) => {
        event.stopPropagation();
        
        const bookData = booksData[bookKey];
        if (!bookData) return;
        
        const card = document.querySelector(`[data-book-key="${bookKey}"]`);
        const tocContainer = card.querySelector(`[data-book-id="${bookKey}-toc"]`);
        const paginationContainer = card.querySelector(`[data-book-id="${bookKey}-pagination"]`);
        const tocElement = card.querySelector('.book-toc');
        
        if (tocContainer && paginationContainer) {
          const { paginatedToc } = getPaginatedToc(bookData.toc);
          const sections = paginatedToc[pageNumber - 1];

          // ë Œë”ë§
          tocContainer.innerHTML = renderTocHtml(sections, bookKey);
          
          // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
          paginationContainer.querySelectorAll('.pagination-number').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.textContent.trim()) === pageNumber) btn.classList.add('active');
          });

          // ğŸ’¡ í˜ì´ì§€ ë³€ê²½ í›„ ëª©ì°¨ ë†’ì´ ì¬ê³„ì‚° ë° ì ìš© (í•µì‹¬)
          if (card.classList.contains('expanded') && tocElement) {
              // 1. ë†’ì´ë¥¼ autoë¡œ ì„¤ì •í•˜ì—¬ íŒ¨ë”© í¬í•¨ ì‹¤ì œ ì½˜í…ì¸  ë†’ì´ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.
              tocElement.style.height = 'auto';
              
              // 2. ì •í™•í•œ scrollHeightë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
              const contentHeight = tocElement.scrollHeight; 
              
              // 3. ì¸¡ì •ëœ ë†’ì´ë¡œ ë‹¤ì‹œ ì„¤ì •í•©ë‹ˆë‹¤.
              tocElement.style.height = `${contentHeight}px`;
          }
        }
      };
      
      // ----------------------------------------------------
      // ğŸ¯ [ìˆ˜ì •] GIF ì œì–´ í•¨ìˆ˜: ìº”ë²„ìŠ¤ë¡œ ë°”ê¿”ì¹˜ê¸° (ì™„ë²½í•œ ì •ì§€ êµ¬í˜„)
      // ----------------------------------------------------
      function freezeGif(card) {
          const wrapper = card.querySelector('.book-cover-wrapper');
          const img = wrapper.querySelector('img.book-cover');
          
          // ì´ë¯¸ ìº”ë²„ìŠ¤ê°€ ìˆë‹¤ë©´ ë¬´ì‹œ
          if (wrapper.querySelector('canvas.book-cover-static')) return;

          // 1. ìº”ë²„ìŠ¤ ìƒì„±
          const canvas = document.createElement('canvas');
          canvas.className = 'book-cover-static';
          
          // 2. ì´ë¯¸ì§€ í¬ê¸° ë§ì¶¤
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;

          // 3. í˜„ì¬ ì´ë¯¸ì§€(ë³´í†µ ì²« í”„ë ˆì„)ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¼
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // 4. ì›ë³¸ GIF ìˆ¨ê¸°ê³  ìº”ë²„ìŠ¤ ì¶”ê°€
          img.style.display = 'none';
          wrapper.appendChild(canvas);
      }

      function unfreezeGif(card) {
          const wrapper = card.querySelector('.book-cover-wrapper');
          const img = wrapper.querySelector('img.book-cover');
          const canvas = wrapper.querySelector('canvas.book-cover-static');

          // 1. ìº”ë²„ìŠ¤ ì œê±°
          if (canvas) {
              canvas.remove();
          }

          // 2. ì›ë³¸ GIF ë‹¤ì‹œ í‘œì‹œ (ì²˜ìŒë¶€í„° ì¬ìƒë¨)
          if (img) {
              img.style.display = 'block';
          }
      }

      // ----------------------------------------------------
      // ë¶ì¹´ë“œ í† ê¸€ ë¡œì§ (ì˜ë¦¼/ì—¬ë°±/ìŠ¤í¬ë¡¤ í•´ê²° + GIF ì •ì§€)
      // ----------------------------------------------------
      document.querySelectorAll('.book-card').forEach(card => {
        card.addEventListener('click', () => {
            const isCurrentlyExpanded = card.classList.contains('expanded');
            const tocElement = card.querySelector('.book-toc');
            const transitionDuration = 500; // CSS transition time in ms
            const contentPadding = '16px'; 

            // 1. ëª¨ë“  ì¹´ë“œì˜ expanded í´ë˜ìŠ¤ ì œê±° (ë‹¤ë¥¸ ì¹´ë“œ ë‹«ê¸°)
            document.querySelectorAll('.book-card').forEach(c => {
                const otherToc = c.querySelector('.book-toc');
                // ë‹¤ë¥¸ ì¹´ë“œë¼ë©´ ë‹«ê³ , ì›€ì§ì„ ë³µêµ¬
                if (c !== card) {
                    c.classList.remove('expanded'); 
                    unfreezeGif(c); // ğŸ¯ ë‹¤ë¥¸ ì¹´ë“œëŠ” GIF ì¬ìƒ ì¬ê°œ

                    if (otherToc) {
                        otherToc.style.height = '0px'; 
                        otherToc.style.paddingTop = '0';
                        otherToc.style.paddingBottom = '0';
                        otherToc.classList.add('closed');
                    }
                }
            });
            
            // 2. í˜„ì¬ í´ë¦­ëœ ì¹´ë“œì˜ expanded ìƒíƒœ í† ê¸€
            card.classList.toggle('expanded', !isCurrentlyExpanded);

            // -------------------------------------------------------------
            // ğŸ¯ í•µì‹¬ ë¡œì§: í™•ì¥ë˜ë©´ ì •ì§€(ìº”ë²„ìŠ¤), ë‹«íˆë©´ ì¬ìƒ(ì´ë¯¸ì§€)
            // -------------------------------------------------------------
            if (!isCurrentlyExpanded) {
                // í¼ì³ì§€ëŠ” ìˆœê°„ -> ìº”ë²„ìŠ¤ë¡œ êµì²´í•˜ì—¬ ì •ì§€ëœ ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ í•¨
                freezeGif(card);
            } else {
                // ë‹«íˆëŠ” ìˆœê°„ -> ì›ë³¸ ì´ë¯¸ì§€ ë³µêµ¬
                unfreezeGif(card);
            }
            // -------------------------------------------------------------

            // 3. ëª©ì°¨ ë†’ì´ ì¡°ì ˆ
            if (!isCurrentlyExpanded && tocElement) {
                // í¼ì³ì§ˆ ë•Œ
                tocElement.classList.remove('closed');
                tocElement.style.paddingTop = contentPadding;
                tocElement.style.paddingBottom = contentPadding;
                
                tocElement.style.height = 'auto';
                
                const contentHeight = tocElement.scrollHeight; 
                
                tocElement.style.height = '0px';
                requestAnimationFrame(() => {
                    tocElement.style.height = `${contentHeight}px`;
                });

            } else if (isCurrentlyExpanded && tocElement) {
                // ë‹«í ë•Œ
                tocElement.style.height = `${tocElement.scrollHeight}px`;
                tocElement.style.paddingTop = contentPadding;
                tocElement.style.paddingBottom = contentPadding;

                requestAnimationFrame(() => {
                    tocElement.style.height = '0px';
                    tocElement.style.paddingTop = '0';
                    tocElement.style.paddingBottom = '0';

                    setTimeout(() => {
                        tocElement.classList.add('closed');
                    }, transitionDuration); 
                });
            }

            // 4. ìºëŸ¬ì…€ ìŠ¤í¬ë¡¤ ì´ë™
            if (!isCurrentlyExpanded) {
                const carousel = card.closest('.carousel');
                if (carousel) {
                    const cardLeft = card.offsetLeft;
                    const carouselWidth = carousel.clientWidth;
                    
                    let expandedCardWidth;
                    
                    if (window.innerWidth <= 640) {
                        expandedCardWidth = 250; 
                    } else {
                        expandedCardWidth = 300; 
                    }

                    const scrollTarget = cardLeft + (expandedCardWidth / 2) - (carouselWidth / 2);
                    
                    carousel.scrollTo({
                        left: scrollTarget,
                        behavior: 'smooth'
                    });
                }
            }
        });
      });
    })();
    </script>
  </body>
  </html>