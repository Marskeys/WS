<!DOCTYPE html>
<html class="dark" lang="<%= lang %>">
<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/assets/css/index.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bug Loop</title>
  <style>
    :root{
      --chrome-gap:50px;
      --panel-gap:16px;
      --radius:12px;
      --border:#2b2b2b;
      --bg:#1b1b1b;
      --panel:#121212;
      --panel-2:#0e0e0e;
      --ink:#eaeaea;
      --ink-2:#b7b7b7;
      --accent:#00f5d4;
      --primary:#217ee8;
      --primary-ink:#608b42;
    }

    html, body {
      height: 100%;
    }

    html:not(.dark){
      --border:#d9d9d9;
      --bg:#000000;
      --panel:#ffffff;
      --panel-2:#f3f3f6;
      --ink:#1f1f1f;
      --ink-2:#5a5a5a;
      --accent:#3c6df0;
      --primary:#217ee8;
      --primary-ink:#ffffff;
    }

    body.light, body.dark {
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell{
      padding: 16px 16px 16px calc(var(--chrome-gap) + 16px);
      padding-top: calc(50px + 16px);
      margin-top: 180px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    @media (max-width: 640px){
      .app-shell{
        padding-left: 16px;
        margin-top: 250px;
      }
    }

    .section-title {
      color: #fff;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
    }

    .statusbar{
      margin-top:12px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:8px 12px;
      display:flex;
      gap:12px;
      color:var(--ink-2);
      font-size:.9rem;
    }

    .hidden{ display:none !important; }

    .pjax-fade-enter {
      opacity: 0;
      transform: translateY(20px);
      will-change: transform, opacity;
    }
    .pjax-fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: transform .28s cubic-bezier(.22,1,.36,1), opacity .28s ease;
    }

    /* ğŸ”¹ ìºëŸ¬ì…€ */
    .carousel-section {
      margin-top: 60px;
    }

    .section-subtitle {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--ink);
    }

    .carousel-container {
      overflow-x: auto;
      display: flex;
      gap: 16px;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }

    .carousel {
      display: flex;
      gap: 16px;
    }

    .carousel-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 140px;
      flex-shrink: 0;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      scroll-snap-align: start;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .carousel-item:hover {
      transform: translateY(-6px);
      box-shadow: 0 4px 10px rgba(0,0,0,.3);
    }

    .carousel-item img {
      width: 100%;
      border-radius: var(--radius);
      height: 190px;
      object-fit: cover;
    }

    .carousel-item p {
      margin-top: 8px;
      font-size: .9rem;
      color: var(--ink-2);
    }

    /* ğŸ”¹ ëª©ì°¨ */
    .book-toc {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 20px;
      padding: 16px 20px;
      color: var(--ink);
      transition: all .3s ease;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }

    .book-toc.show {
      max-height: 500px;
      opacity: 1;
    }

    .book-toc h3 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .book-toc ul {
      margin: 0;
      padding-left: 16px;
      list-style: disc;
    }

    .book-toc li {
      margin-bottom: 6px;
      font-size: .95rem;
      color: var(--ink-2);
    }

  </style>
</head>

<body class="light">
  <div id="preloader"><div class="spinner"></div></div>

  <%- include('partials/header') %>

  <div id="panel-root" data-pjax-scope>
    <%- include('partials/panel') %>
  </div>

  <div class="app-shell">
    <h1 class="section-title">ì—°ì¬ ì¤‘ì¸ ê¸€</h1>
    <h2 style="font-weight:700; font-size:1.4rem;">Bug Loop</h2>
    <p style="color:var(--ink-2); margin-top:8px;">
      ì˜¨ë¼ì¸ ì—ë””í„° ê¸°ëŠ¥ì´ ì œê±°ëœ ê°„ê²°í•œ ë²„ì „ì…ë‹ˆë‹¤.
    </p>

    <!-- ğŸ”¹ ìºëŸ¬ì…€ ì‹œì‘ -->
    <div class="carousel-section">
      <h2 class="section-subtitle">ğŸ“š ì—°ì¬ ì¤‘ì¸ ì‹œë¦¬ì¦ˆ</h2>
      <div class="carousel-container">
        <div class="carousel">
          <div class="carousel-item" data-index="0">
            <img src="/assets/img/book1.jpg" alt="ê·€ì—¬ìš´ ìŒí–¥í•™">
            <p>ê·€ì—¬ìš´ ìŒí–¥í•™</p>
          </div>
          <div class="carousel-item" data-index="1">
            <img src="/assets/img/book2.jpg" alt="í”¼ì•„ë…¸ ì¹˜ëŠ” í”„ë¡œë“€ì„œ">
            <p>í”¼ì•„ë…¸ ì¹˜ëŠ” í”„ë¡œë“€ì„œ</p>
          </div>
          <div class="carousel-item" data-index="2">
            <img src="/assets/img/book3.jpg" alt="ë‹¹ì‹ ì˜ ê³ì—, ì•„ì£¼ ì‚¬ì ì¸ ë³µì§€ ê°€ì´ë“œ">
            <p>ë‹¹ì‹ ì˜ ê³ì—, ì•„ì£¼ ì‚¬ì ì¸ ë³µì§€ ê°€ì´ë“œ</p>
          </div>
        </div>
      </div>

      <!-- ğŸ”¹ í¼ì³ì§ˆ ëª©ì°¨ -->
      <div class="book-toc" id="toc-0">
        <h3>ê·€ì—¬ìš´ ìŒí–¥í•™ ëª©ì°¨</h3>
        <ul>
          <li>1ì¥. ì§„ë™ì˜ ë³¸ì§ˆ</li>
          <li>2ì¥. íŒŒë™ì˜ ì„±ì§ˆ</li>
          <li>3ì¥. ìŒí–¥í•™ê³¼ ê°ê°ì˜ ê´€ê³„</li>
        </ul>
      </div>

      <div class="book-toc" id="toc-1">
        <h3>í”¼ì•„ë…¸ ì¹˜ëŠ” í”„ë¡œë“€ì„œ ëª©ì°¨</h3>
        <ul>
          <li>1ì¥. ë°˜ì£¼ì˜ êµ¬ì¡° ì´í•´</li>
          <li>2ì¥. ì½”ë“œ ë³´ì´ì‹±ì˜ ì˜ˆìˆ </li>
          <li>3ì¥. ë¦¬ë“¬ì˜ ì„¤ê³„ì™€ ë‹¤ì´ë‚´ë¯¹</li>
        </ul>
      </div>

      <div class="book-toc" id="toc-2">
        <h3>ë‹¹ì‹ ì˜ ê³ì—, ì•„ì£¼ ì‚¬ì ì¸ ë³µì§€ ê°€ì´ë“œ ëª©ì°¨</h3>
        <ul>
          <li>1ì¥. ë³µì§€ì˜ ì–¸ì–´</li>
          <li>2ì¥. ì œë„ì˜ ì´ë©´ ì½ê¸°</li>
          <li>3ì¥. ì§„ì§œ â€˜ë„ì›€â€™ì´ë€ ë¬´ì—‡ì¸ê°€</li>
        </ul>
      </div>
    </div>
    <!-- ğŸ”¹ ìºëŸ¬ì…€ ë -->

  </div>

  <%- include('partials/scripts') %>

  <script>
  (() => {
    const panelRoot = document.getElementById('panel-root');
    const preloader = document.getElementById('preloader');

    // PJAX ê´€ë ¨ ì½”ë“œ ìœ ì§€
    (function patchHistory(){
      const _ps = history.pushState, _rs = history.replaceState;
      history.pushState = function(...args){ const r = _ps.apply(this, args); window.dispatchEvent(new Event('locationchange')); return r; }
      history.replaceState = function(...args){ const r = _rs.apply(this, args); window.dispatchEvent(new Event('locationchange')); return r; }
      window.addEventListener('popstate', ()=> window.dispatchEvent(new Event('locationchange')));
    })();

    document.addEventListener('click', onDocClick, true);
    function onDocClick(e){
      const a = e.target.closest('a[data-panel-link], .submenu a');
      if (!a) return;
      if (a.target === '_blank' || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
      const url = new URL(a.href, location.origin);
      if (url.origin !== location.origin || url.hash) return;
      e.preventDefault();
      navigateAndSwap(a.href, true);
    }

    window.addEventListener('locationchange', () => {
      swapPanel(location.href);
    });

    async function navigateAndSwap(url, push) {
      if (push) history.pushState({panel:true}, '', url);
      else history.replaceState(history.state, '', url);
    }

    async function swapPanel(url) {
      try {
        setLoading(true);
        const fURL = new URL(url, location.origin);
        fURL.searchParams.set('partial', '1');
        const res = await fetch(fURL.toString(), {
          headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/fragment, text/html;q=0.9' },
          credentials: 'same-origin',
          cache: 'no-cache'
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const html = await res.text();
        const frag = extractPanel(html);
        if (!frag) { location.replace(url); return; }

        panelRoot.replaceChildren(frag);
        runScripts(panelRoot);
      } catch (err) {
        console.error('[PJAX] swapPanel error:', err);
        location.replace(url);
      } finally {
        setLoading(false);
      }
    }

    function extractPanel(html) {
      if (!/<\/?html[\s>]/i.test(html)) {
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        const node = wrap.querySelector('#panel-root, [data-panel-fragment], .panel-root') || wrap;
        const df = document.createDocumentFragment();
        node.childNodes.forEach(n => df.appendChild(n.cloneNode(true)));
        return df;
      }
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const node = doc.querySelector('#panel-root, [data-panel-fragment], .panel-root');
      if (!node) return null;
      const df = document.createDocumentFragment();
      node.childNodes.forEach(n => df.appendChild(n.cloneNode(true)));
      return df;
    }

    function runScripts(root) {
      root.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        for (const {name, value} of [...old.attributes]) s.setAttribute(name, value);
        s.textContent = old.textContent;
        old.replaceWith(s);
      });
    }

    function setLoading(on) {
      if (!preloader) return;
      preloader.style.display = on ? 'block' : 'none';
    }

    // ğŸ”¹ ìºëŸ¬ì…€ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.carousel-item').forEach(item => {
      item.addEventListener('click', () => {
        const index = item.dataset.index;
        const toc = document.getElementById(`toc-${index}`);
        document.querySelectorAll('.book-toc').forEach(el => {
          if (el !== toc) el.classList.remove('show');
        });
        toc.classList.toggle('show');
      });
    });
  })();
  </script>

</body>
</html>
