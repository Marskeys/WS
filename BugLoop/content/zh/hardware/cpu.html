<div id="chapters-panel" class="chapters-panel" data-ready="0">
    <div class="chapters-toolbar">
      <label for="chapterSelect" class="sr-only">选择章节</label>
      <select id="chapterSelect" class="chapters-select" aria-label="选择章节">
        <option value="0">第0章. 计算机是一台计算器。</option>
        <option value="1">第1章 — (即将推出)</option>
        <option value="2">第2章 — (即将推出)</option>
        <option value="3">第3章 — (即将推出)</option>
      </select>
    </div>
  
    <div class="chapter-content" id="chapterContent" tabindex="-1">
      <section data-chapter="0" class="chapter-section active">
        <h2 class="chapter-title">第0章. 计算机是一台计算器。</h2>
        <p>对于不了解计算机的人来说，CPU 这个词太复杂了。因为它是一个缩写，所以对于不知道它代表什么的普通人来说，仅凭这个名字就无法猜测它的含义或作用。</p>
        <p>
          C: 计算机的<b>中</b>心部分 (<b>C</b>entral)<br/>
          P: <b>处</b>理运算 (<b>P</b>rocessing)<br/>
          U: <b>单</b>元 (<b>U</b>nit)
        </p>
        <p>计算机是一台非常快的计算器。<br/>
        它是一台带有存储功能的计算器。<br/>
        它不仅有存储功能，计算速度也飞快，而且它能以绚丽的色彩、形状和声音来显示结果，而不仅仅是简单的数字。<br/>
        它是一台超高速的计算器，利用沿着电路超快速移动的微小电粒子进行计算，而不是缓慢的手和脚的动作。<br/>
        电粒子移动得太快，以至于很容易产生摩擦热，因此它也是一台会随着时间而老化的计算器。<br/>
        它是一台灵活的计算器，可以根据用途创建、保存和加载特殊的计算器。</p>
        <p>而且……它是一台善良而能干的计算器，再次利用电能高速移动的特性，让远方的人们能够瞬间进行沟通。</p>
        <p>事实上，这个对计算机的简短日常描述，包含了理解计算机所需的几乎所有基本概念。</p>
        <p>在本 CPU 章节中，我们将探讨<b><u>作为计算器的计算机</u></b>，这与第一句话“计算机是一台非常快的计算器”相对应。</p>
      </section>
  
      <section data-chapter="1" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第1章 — (即将推出)</h2>
        <p>内容即将上线。</p>
      </section>
  
      <section data-chapter="2" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第2章 — (即将推出)</h2>
        <p>内容即将上线。</p>
      </section>
  
      <section data-chapter="3" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第3章 — (即将推出)</h2>
        <p>内容即将上线。</p>
      </section>
    </div>
  </div>
  
  <style>
    .chapters-panel { display: grid; gap: 12px; }
    .chapters-toolbar { display: flex; gap: 8px; align-items: center; }
    .chapters-select {
      padding: 8px 10px; border: 1px solid #e1e6ef; border-radius: 10px; font-size: .95rem; background: #fff;
    }
    .chapter-content { background: #fff; border: 1px solid #e1e6ef; border-radius: 14px; padding: 16px; }
  
    /* ✅ 抑制初始闪烁：在准备好之前隐藏内容（布局保持不变） */
    #chapters-panel[data-ready="0"] .chapter-content { visibility: hidden; }
    #chapters-panel[data-ready="1"] .chapter-content { visibility: visible; }
  
    .chapter-title { margin: 0 0 8px; font-size: 1.1rem; }
    .chapter-section { display: none; }
    .chapter-section.active { display: block; }
  
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
  </style>
  
  <script>
  /* ===== 单例引导：全局只引导/监听/绑定一次 ===== */
  (() => {
    if (!window.__ChapterBoot) {
      window.__ChapterBoot = {
        mo: null,
        initedRoots: new WeakSet(),
        initPanel(root, opts={}) {
          if (!root || this.initedRoots.has(root)) return;
          const select = root.querySelector('#chapterSelect');
          const container = root.querySelector('#chapterContent');
          if (!select || !container) return;
  
          this.initedRoots.add(root);
  
          const KEY = 'chapter.current';
          let isInitPhase = true; // 初始化期间不更新历史记录/存储
  
          const showChapter = (val, {silent=false}={}) => {
            const sections = container.querySelectorAll('.chapter-section');
            sections.forEach(sec => {
              const active = sec.dataset.chapter === String(val);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
  
            // 在初始化/静默模式下禁止触发路由
            if (!silent && !isInitPhase) {
              try { localStorage.setItem(KEY, String(val)); } catch {}
              try { history.replaceState(null, '', `#chapter=${val}`); } catch {}
            }
          };
  
          // 初始值：哈希 > localStorage > 选择框默认值
          const fromHash = (location.hash.match(/chapter=(\d+)/) || [])[1];
          let saved = null;
          try { saved = localStorage.getItem(KEY); } catch {}
          const initial = fromHash ?? saved ?? (select.value ?? '0');
  
          select.value = initial;
          showChapter(initial, {silent:true});
  
          // 准备就绪 → 显示
          root.setAttribute('data-ready', '1');
          isInitPhase = false;
  
          // 变更事件
          select.addEventListener('change', (e) => showChapter(e.target.value));
  
          // 主页按钮联动（全局委托在引导阶段安装一次。此处无需监听）
          document.addEventListener('panel:home', () => {
            try { localStorage.removeItem(KEY); } catch {}
            select.value = '0';
            showChapter(0);
          }, { once:false });
        },
        bootOnce() {
          // 全局主页按钮委托：一次
          if (!window.__ChapterBoot._homeBound) {
            document.addEventListener('click', (ev) => {
              const a = ev.target.closest('a.home-btn, a[href="/"], button.home-btn');
              if (!a) return;
              // 在这里保持默认导航，仅重置面板
              document.dispatchEvent(new CustomEvent('panel:home'));
            });
            window.__ChapterBoot._homeBound = true;
          }
  
          // MutationObserver：一次
          if (!this.mo) {
            this.mo = new MutationObserver((muts) => {
              for (const m of muts) {
                for (const node of m.addedNodes || []) {
                  if (node.nodeType !== 1) continue;
                  if (node.id === 'chapters-panel') this.initPanel(node);
                  const found = node.querySelector?.('#chapters-panel');
                  if (found) this.initPanel(found);
                }
              }
            });
            this.mo.observe(document.documentElement, { childList: true, subtree: true });
          }
  
          // 初始 DOM 扫描
          this.initPanel(document.getElementById('chapters-panel'));
        }
      };
  
      // 实际引导
      window.__ChapterBoot.bootOnce();
    } else {
      // 如果已引导，尝试仅初始化当前 DOM 中的面板
      window.__ChapterBoot.initPanel(document.getElementById('chapters-panel'));
    }
  })();
  </script>