<!-- panel.ejs : 드롭다운 기반 챕터 뷰어 (singleton boot + no-flicker + SPA 재장착 대응) -->
<div id="chapters-panel" class="chapters-panel" data-ready="0">
    <div class="chapters-toolbar">
      <label for="chapterSelect" class="sr-only">장 선택</label>
      <select id="chapterSelect" class="chapters-select" aria-label="장 선택">
        <option value="0">0장. 컴퓨터는 계산기이다.</option>
        <option value="1">1장. 아름다움은 한정된 자원의 무한한 조합에서 온다</option>
        <option value="2">2장 — (coming soon)</option>
        <option value="3">3장 — (coming soon)</option>
      </select>
    </div>
  
    <div class="chapter-content" id="chapterContent" tabindex="-1" aria-live="polite">
      <!-- 0장 -->
      <section data-chapter="0" class="chapter-section active">
        <h2 class="chapter-title">0장. 컴퓨터는 계산기이다.</h2>
        <p>CPU는 컴퓨터를 모르는 사람에겐 너무 복잡해보이는 단어다. 무언가의 약자라서, 그 무언가를 알 턱이 없는 일반인에겐 이름만 보고 그 의미나 역할을 추측한다는 게 불가능하다.</p>
        <p>
          C: 컴퓨터의 중심부에서 (<b>C</b>entral)<br/>
          P: 뼈 빠지게 계산하는 (<b>P</b>rocessing)<br/>
          U: 팀 (<b>U</b>nit)
        </p>
        <p>컴퓨터는 엄청 빠른 계산기다.<br/>
        그런데 저장 기능이 있는 계산기다.<br/>
        저장 기능도 있고 계산도 엄청 빠른데, 단순한 숫자가 아닌 화려한 색상과 형태, 그리고 소리로 결과를 보여주는 계산기다.<br/>
        느릿느릿한 손짓과 발짓이 아닌 회로를 따라 엄청 빠르게 움직이는 엄청 작은 전기 알맹이를 이용해 계산하는, 초스피드 계산기다.<br/>
        전기 알맹이가 너무 빨리 움직이는 나머지, 마찰열이 쉽게 발생하기도 하는, 그렇게 시간에 따라 늙기도 하는 계산기이다.<br/>
        용도에 맞는 특별한 계산기를 직접 만들어 저장했다가 불러오는 것이 가능한, 유연한 계산기이다.</p>
        <p>그리고… 속도가 매우 빠른, 전기라는 특성을 다시 한 번 이용해 아주 멀리 있는 사람과 순식간에 소통을 하게 해 주는, 친절하고도 유능한 계산기다.</p>
        <p>일상적으로 풀어 본 컴퓨터에 대한 이 짧한 묘사에는, 사실 컴퓨터를 이해하는 데에 필요한 거의 모든 기본 개념이 다 들어가 있다.</p>
        <p>이 CPU 장에서는, 가장 첫 문장, "컴퓨터는 엄청 빠른 계산기다"에 해당하는 <b><u>계산기로써의 컴퓨터</u></b>를 다룬다.</p>
      </section>
  
      <!-- 1장 (완성본) -->
      <section data-chapter="1" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">1장. 아름다움은 한정된 자원의 <b>무한한 조합</b>에서 온다 — 트랜지스터의 선행 지식</h2>
  
        <p class="lead">"가진 게 없어서 성공하지 못한다”라고 생각하는 사람들은 먼저 스스로를 돌아볼 필요가 있다.</p>
  
        <p>우리가 현실에서 마주하는 수많은 근사한 장면들은, <strong>무한한 재료를 쏟아부어서</strong> 만든 게 아니다. 오히려 <strong>한정된 자원 속에서 가장 아름다운 조합을 찾아낸</strong> 누군가의 노력으로 완성된 결실에 가깝다.</p>
  
        <p>아무리 재료가 많아도, 그 재료를 <mark>빛나게 만드는 조합</mark>을 찾지 못한다면 아무 소용이 없다. 그러니 “나는 가진 게 없어서 성공할 수 없어”라고 투덜대기보다, 내 성격이 되었든, 습관이 되었든, <strong>내가 가진 몇 안 되는 자원을 가장 아름답게 조합하는 것</strong>이 중요하다. 마치 처음부터 완벽한 존재였던 것처럼 자신을 세상 앞에 당당히 소개하는 것, 그게 내가 나에게 줄 수 있는 최고의 선물이다.</p>
  
        <h3>한정된 자원이 만드는 무한한 가능성</h3>
        <p>“CPU 이야기 하면서 왜 인생 얘기를 하냐”고 할 수도 있다. 하지만 이건 단순한 비유가 아니다. <strong>세상의 진리</strong>가 그렇고, <strong>컴퓨터도 그 진리 위에서 설계되었기 때문</strong>이다.</p>
        <p>세상의 자원은 한정적일 수밖에 없다. 그런데도 우리가 살아가는 세상이 <strong>무궁무진한 가능성</strong>으로 가득 차 보이는 이유는 바로 <strong>조합</strong>이라는 개념 덕분이다. 밀가루와 물이라는 단 두 가지 재료만 있어도, <em>어떻게 반죽하고, 성형하고, 조리하느냐</em>에 따라 수십, 수백 가지의 음식이 만들어질 수 있다. 컴퓨터도 마찬가지다.</p>
  
        <h3>0과 1로 만드는 핑크빛</h3>
        <p>컴퓨터는 메마른 은행 업무부터 해리포터의 장엄한 배경음악이 흐르는 판타지 영화 시청까지, 우리에게 무궁무진한 경험을 선사한다. 언뜻 보면 <strong>컴퓨터는 모든 세계를 창조하는 마법 상자</strong>처럼 보인다. 하지만 실체는 놀라울 만큼 단순하다. <strong>“스위치를 켜거나(1), 끄거나(0)”</strong> 단 두 가지 동작밖에 하지 못하는 무미건조한 계산기일 뿐이다. 우리가 흔히 “컴퓨터는 0과 1밖에 이해하지 못한다”고 말하는 이유다.</p>
  
        <figure class="code-figure">
          <figcaption>예시: 이진수로 표현한 색</figcaption>
          <pre class="code-block">11111111 11000000 11001011</pre>
        </figure>
  
        <p>이 단순한 이진수는 10진수로 각각 <strong>255, 192, 203</strong>을 의미한다. 이 세 숫자는 각각 <strong>빨강, 초록, 파랑의 빛의 세기</strong>를 나타낸다. 우리가 눈으로 보는 대부분의 색은 <strong>RGB(빨강·초록·파랑)의 조합</strong>으로 표현할 수 있기 때문이다.</p>
  
        <p><strong>OLED 모니터</strong>의 하나의 픽셀 안에는 빨강·초록·파랑 LED 소자가 각각 박혀 있다. 위의 이진수를 신호로 받으면, 빨강 LED는 255, 초록은 192, 파랑은 203의 밝기로 빛을 낸다. 그 빛들이 섞이면 우리의 눈엔 <strong>핑크빛</strong>으로 보인다. <em>“켜거나, 끄거나”뿐인</em> 바보 같은 계산기가 핑크빛의 아름다움을 만들어내는 순간이다.</p>
  
        <h3>스위치는 어떻게 그렇게 빨리 움직일까</h3>
        <p>컴퓨터는 0과 1만으로 연산을 <strong>엄청 빠르게, 엄청 많이</strong> 한다. 그런데 우리가 흔히 아는 스위치를 누르는 데만 0.5초는 걸리지 않나? 컴퓨터는 어떻게 그렇게 <strong>순간적으로 스위칭</strong>할 수 있을까?</p>
        <p>비밀은 바로 <strong>물리적 스위치가 아닌 전기적 스위치</strong>에 있다. 그리고 그 역할을 하는 초미세 도구가 바로 <strong>트랜지스터</strong>다.</p>
  
        <h3>트랜지스터를 이해하기 위한 작은 세계의 법칙</h3>
        <ol>
          <li>세상의 모든 물질은 <strong>원자</strong>라는 작은 알갱이로 이루어져 있다. 내 손도, 책상도, 돌멩이도 예외가 아니다.</li>
          <li>그런데도 세상이 모래처럼 흩어지지 않고 단단한 이유는, <strong>원자들이 서로 결합해 안정된 구조를 이루기 때문</strong>이다.</li>
          <li>원자는 <strong>+ 전하의 원자핵</strong>과, 그 주위를 돌며 <strong>- 전하를 띠는 전자</strong>로 이루어져 있다. 전자는 <em>양파 껍질처럼</em> 여러 겹의 껍질 궤도를 따라 배열된다.</li>
          <li>원자가 가진 <strong>전자 개수</strong>와 <strong>배열</strong>에 따라 서로 다른 성질의 원소가 된다. 금, 은, 철, 구리, 탄소, 산소 등, 지금까지 인간이 발견한 원소는 <strong>118종류</strong>다.</li>
          <li>결국 세상의 모든 물질은 단순하다. <strong>원자 속 전자의 개수와 배열이 다를 뿐</strong>인데, 그 작은 차이가 완전히 다른 세계를 만들어낸다.</li>
        </ol>
  
        <h3>실리콘, 그리고 다음 장</h3>
        <p>트랜지스터는 주로 <strong>실리콘(Si)</strong>이라는 원소를 기반으로 만들어진다. 실리콘 원자에는 <strong>총 14개의 전자</strong>가 있고, 그중 <strong>가장 바깥 껍질</strong>에는 <strong>4개</strong>의 전자가 있다. 이 바깥 껍질은 전자가 <strong>8개일 때 가장 안정적</strong>이므로, 실리콘은 주변 실리콘 원자들과 <strong>4개의 전자를 서로 나눠 갖는 공유결합</strong>을 형성한다. 마치 서로를 꼭 끌어안는 연인처럼, 부족한 전자를 채워 안정된 구조를 만드는 것이다.</p>
        <p>그런데 여기에 <b>아주 조금</b>의 다른 원소를 섞는 순간, 실리콘은 완전히 새로운 성질을 갖게 된다. 그리고 바로 이 원리가 트랜지스터의 핵심이다.</p>
  
        <p class="tbc">To be continued…</p>
      </section>
  
      <!-- coming soon 섹션들 -->
      <section data-chapter="2" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">2장 — (coming soon)</h2>
        <p>콘텐츠가 곧 올라옵니다.</p>
      </section>
  
      <section data-chapter="3" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">3장 — (coming soon)</h2>
        <p>콘텐츠가 곧 올라옵니다.</p>
      </section>
    </div>
  </div>
  
  <style>
    .chapters-panel { display: grid; gap: 12px; }
    .chapters-toolbar { display: flex; gap: 8px; align-items: center; }
    .chapters-select {
      padding: 8px 10px; border: 1px solid #e1e6ef; border-radius: 10px; font-size: .95rem; background: #fff;
    }
    .chapter-content {
      background: #fff; border: 1px solid #e1e6ef; border-radius: 14px; padding: 20px;
      /* 전환 시 레이아웃 점프 줄이기 */
      contain: content; content-visibility: auto; contain-intrinsic-size: 600px;
    }
  
    /* ✅ 초기 깜빡임 억제: 준비될 때까지 내용 비가시화 (레이아웃은 유지) */
    #chapters-panel[data-ready="0"] .chapter-content { visibility: hidden; }
    #chapters-panel[data-ready="1"] .chapter-content { visibility: visible; }
  
    .chapter-title { margin: 0 0 12px; font-size: 1.2rem; line-height: 1.35; }
    .chapter-section { display: none; }
    .chapter-section.active { display: block; }
  
    /* 타이포그래피 살짝 스타일링 */
    .lead { font-size: 1.05rem; line-height: 1.7; margin-top: 8px; }
    .dropcap {
      float: left; font-size: 2.6rem; line-height: 1; padding-right: .25rem; transform: translateY(.08em);
    }
    .code-figure { margin: 14px 0; }
    .code-figure figcaption { font-size: .85rem; color: #6b7280; margin-bottom: 6px; }
    .code-block {
      margin: 0; padding: 10px 12px; background: #0f172a; color: #e5e7eb; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; overflow-x: auto;
    }
    .tbc { margin-top: 12px; font-style: italic; color: #64748b; }
  
    /* 접근성 */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
  </style>
  
  <script>
  /* ===== Singleton boot: 전역 1회만 부팅/감시/바인딩 ===== */
  (() => {
    if (!window.__ChapterBoot) {
      window.__ChapterBoot = {
        mo: null,
        initedRoots: new WeakSet(),
        bootOpts: { UPDATE_URL: false }, // 🔧 라우터/해시 충돌로 인한 이중 렌더 방지: 기본 false
        initPanel(root, opts={}) {
          if (!root || this.initedRoots.has(root)) return;
          const select = root.querySelector('#chapterSelect');
          const container = root.querySelector('#chapterContent');
          if (!select || !container) return;
  
          this.initedRoots.add(root);
  
          const KEY = 'chapter.current';
          let isInitPhase = true; // 초기화 중에는 라우터/스토리지 갱신 안 함
          let switching = false;  // 전환 디바운스
  
          const freezeHeight = () => {
            container.style.minHeight = container.offsetHeight + 'px';
          };
          const releaseHeight = () => {
            // 다음 페인트 후 해제해 깜빡임 방지
            requestAnimationFrame(() => { container.style.minHeight = ''; });
          };
  
          const showChapter = (val, {silent=false}={}) => {
            if (switching) return;
            switching = true;
  
            // 현재 높이 고정 → 스왑 → 해제 (레이아웃 점프/깜빡임 감소)
            freezeHeight();
  
            const sections = container.querySelectorAll('.chapter-section');
            sections.forEach(sec => {
              const active = sec.dataset.chapter === String(val);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
  
            // 포커스 이동(접근성) - 과도한 스크롤 방지를 위해 살짝 지연
            setTimeout(() => {
              try { container.focus({ preventScroll: true }); } catch {}
            }, 0);
  
            if (!silent && !isInitPhase) {
              try { localStorage.setItem(KEY, String(val)); } catch {}
              // ⚠️ 기본은 URL 갱신 끔: 외부 라우터/해시 리스너에 의한 재그림 방지
              if (window.__ChapterBoot.bootOpts.UPDATE_URL) {
                try {
                  const u = new URL(location.href);
                  u.hash = ''; // 해시 사용 회피(원하면 바꿔도 됨)
                  u.searchParams.set('chapter', String(val));
                  history.replaceState(null, '', u.toString());
                } catch {}
              }
            }
  
            // 한 프레임 뒤 높이 해제
            releaseHeight();
            // 디바운스 해제
            setTimeout(() => { switching = false; }, 0);
          };
  
          // 초기값: URL(search: chapter) > 해시(#chapter=) > localStorage > select 기본값
          const fromSearch = (() => {
            try {
              const u = new URL(location.href);
              return u.searchParams.get('chapter');
            } catch { return null; }
          })();
          const fromHash = (location.hash.match(/chapter=(\d+)/) || [])[1];
          let saved = null;
          try { saved = localStorage.getItem(KEY); } catch {}
          const initial = fromSearch ?? fromHash ?? (select.value ?? '0');
  
          select.value = initial;
          showChapter(initial, {silent:true});
  
          // 준비 완료 → 표시
          root.setAttribute('data-ready', '1');
          isInitPhase = false;
  
          // 변경 이벤트
          select.addEventListener('change', (e) => showChapter(e.target.value));
  
          // 홈 버튼 연동(전역 위임은 부팅 단계에서 1회 설치됨. 여기선 리스너 불필요)
          document.addEventListener('panel:home', () => {
            try { localStorage.removeItem(KEY); } catch {}
            select.value = '0';
            showChapter(0);
          }, { once:false });
        },
        bootOnce() {
          // 전역 홈 버튼 위임: 1회만
          if (!window.__ChapterBoot._homeBound) {
            document.addEventListener('click', (ev) => {
              const a = ev.target.closest('a.home-btn, a[href="/"], button.home-btn');
              if (!a) return;
              // 여기서 기본 내비게이션은 그대로 두고, 패널만 리셋
              document.dispatchEvent(new CustomEvent('panel:home'));
            });
            window.__ChapterBoot._homeBound = true;
          }
  
          // MutationObserver: 1회만
          if (!this.mo) {
            this.mo = new MutationObserver((muts) => {
              for (const m of muts) {
                for (const node of m.addedNodes || []) {
                  if (node.nodeType !== 1) continue;
                  if (node.id === 'chapters-panel') this.initPanel(node);
                  const found = node.querySelector?.('#chapters-panel');
                  if (found) this.initPanel(found);
                }
              }
            });
            this.mo.observe(document.documentElement, { childList: true, subtree: true });
          }
  
          // 초기 DOM 스캔
          this.initPanel(document.getElementById('chapters-panel'));
        }
      };
  
      // 실제 부팅
      window.__ChapterBoot.bootOnce();
    } else {
      // 이미 부팅돼 있으면, 현재 DOM에 있는 패널만 초기화 시도
      window.__ChapterBoot.initPanel(document.getElementById('chapters-panel'));
    }
  })();
  </script>
  