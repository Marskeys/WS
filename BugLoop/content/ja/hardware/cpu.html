<div id="chapters-panel" class="chapters-panel" data-ready="0">
    <div class="chapters-toolbar">
      <label for="chapterSelect" class="sr-only">章を選択</label>
      <select id="chapterSelect" class="chapters-select" aria-label="章を選択">
        <option value="0">第0章. コンピューターは計算機である。</option>
        <option value="1">第1章 — (近日公開)</option>
        <option value="2">第2章 — (近日公開)</option>
        <option value="3">第3章 — (近日公開)</option>
      </select>
    </div>
  
    <div class="chapter-content" id="chapterContent" tabindex="-1">
      <section data-chapter="0" class="chapter-section active">
        <h2 class="chapter-title">第0章. コンピューターは計算機である。</h2>
        <p>CPUは、コンピューターを知らない人にとっては非常に複雑な単語です。何かの略語なので、その何かを知る由もない一般人には、名前だけでその意味や役割を推測することは不可能です。</p>
        <p>
          C: コンピューターの<b>中</b>心部で (<b>C</b>entral)<br/>
          P: 骨身を削って<b>処</b>理する (<b>P</b>rocessing)<br/>
          U: チーム (<b>U</b>nit)
        </p>
        <p>コンピューターはものすごく速い計算機です。<br/>
        しかも、保存機能がある計算機です。<br/>
        保存機能もあって計算もものすごく速い上に、単純な数字ではなく、華やかな色や形、そして音で結果を見せてくれる計算機です。<br/>
        ゆっくりとした手や足の動きではなく、回路に沿ってものすごく速く動く、ごく小さな電気の粒を使って計算する、超高速計算機です。<br/>
        電気の粒があまりに速く動くため、摩擦熱が発生しやすく、時間とともに老朽化もする計算機です。<br/>
        用途に合った特別な計算機を自分で作って保存し、呼び出すことが可能な、柔軟な計算機です。</p>
        <p>そして...速度が非常に速い、電気という特性をもう一度利用して、遠くにいる人と一瞬でコミュニケーションを取らせてくれる、親切で有能な計算機です。</p>
        <p>日常的な言葉で解きほぐしたコンピューターに関するこの短い描写には、実はコンピューターを理解するために必要なほぼすべての基本概念が含まれています。</p>
        <p>このCPUの章では、最初の文章「コンピューターはものすごく速い計算機だ」に該当する、<b><u>計算機としてのコンピューター</u></b>を扱います。</p>
      </section>
  
      <section data-chapter="1" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第1章 — (近日公開)</h2>
        <p>コンテンツは近日中に公開されます。</p>
      </section>
  
      <section data-chapter="2" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第2章 — (近日公開)</h2>
        <p>コンテンツは近日中に公開されます。</p>
      </section>
  
      <section data-chapter="3" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">第3章 — (近日公開)</h2>
        <p>コンテンツは近日中に公開されます。</p>
      </section>
    </div>
  </div>
  
  <style>
    .chapters-panel { display: grid; gap: 12px; }
    .chapters-toolbar { display: flex; gap: 8px; align-items: center; }
    .chapters-select {
      padding: 8px 10px; border: 1px solid #e1e6ef; border-radius: 10px; font-size: .95rem; background: #fff;
    }
    .chapter-content { background: #fff; border: 1px solid #e1e6ef; border-radius: 14px; padding: 16px; }
  
    /* ✅ 初期点滅の抑制：準備が整うまで内容を非表示にする（レイアウトは維持） */
    #chapters-panel[data-ready="0"] .chapter-content { visibility: hidden; }
    #chapters-panel[data-ready="1"] .chapter-content { visibility: visible; }
  
    .chapter-title { margin: 0 0 8px; font-size: 1.1rem; }
    .chapter-section { display: none; }
    .chapter-section.active { display: block; }
  
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
  </style>
  
  <script>
  /* ===== シングルトンブート：グローバルで一度だけ起動/監視/バインド ===== */
  (() => {
    if (!window.__ChapterBoot) {
      window.__ChapterBoot = {
        mo: null,
        initedRoots: new WeakSet(),
        initPanel(root, opts={}) {
          if (!root || this.initedRoots.has(root)) return;
          const select = root.querySelector('#chapterSelect');
          const container = root.querySelector('#chapterContent');
          if (!select || !container) return;
  
          this.initedRoots.add(root);
  
          const KEY = 'chapter.current';
          let isInitPhase = true; // 初期化中は履歴/ストレージを更新しない
  
          const showChapter = (val, {silent=false}={}) => {
            const sections = container.querySelectorAll('.chapter-section');
            sections.forEach(sec => {
              const active = sec.dataset.chapter === String(val);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
  
            // 初期化/サイレントモードではルーターを刺激しない
            if (!silent && !isInitPhase) {
              try { localStorage.setItem(KEY, String(val)); } catch {}
              try { history.replaceState(null, '', `#chapter=${val}`); } catch {}
            }
          };
  
          // 初期値：ハッシュ > localStorage > selectのデフォルト値
          const fromHash = (location.hash.match(/chapter=(\d+)/) || [])[1];
          let saved = null;
          try { saved = localStorage.getItem(KEY); } catch {}
          const initial = fromHash ?? saved ?? (select.value ?? '0');
  
          select.value = initial;
          showChapter(initial, {silent:true});
  
          // 準備完了 → 表示
          root.setAttribute('data-ready', '1');
          isInitPhase = false;
  
          // 変更イベント
          select.addEventListener('change', (e) => showChapter(e.target.value));
  
          // ホームボタン連携（グローバル委譲はブート段階で一度インストールされる。ここではリスナーは不要）
          document.addEventListener('panel:home', () => {
            try { localStorage.removeItem(KEY); } catch {}
            select.value = '0';
            showChapter(0);
          }, { once:false });
        },
        bootOnce() {
          // グローバルホームボタン委譲：一度だけ
          if (!window.__ChapterBoot._homeBound) {
            document.addEventListener('click', (ev) => {
              const a = ev.target.closest('a.home-btn, a[href="/"], button.home-btn');
              if (!a) return;
              // ここでは、デフォルトのナビゲーションはそのままにして、パネルだけをリセット
              document.dispatchEvent(new CustomEvent('panel:home'));
            });
            window.__ChapterBoot._homeBound = true;
          }
  
          // MutationObserver：一度だけ
          if (!this.mo) {
            this.mo = new MutationObserver((muts) => {
              for (const m of muts) {
                for (const node of m.addedNodes || []) {
                  if (node.nodeType !== 1) continue;
                  if (node.id === 'chapters-panel') this.initPanel(node);
                  const found = node.querySelector?.('#chapters-panel');
                  if (found) this.initPanel(found);
                }
              }
            });
            this.mo.observe(document.documentElement, { childList: true, subtree: true });
          }
  
          // 初期DOMスキャン
          this.initPanel(document.getElementById('chapters-panel'));
        }
      };
  
      // 実際のブート
      window.__ChapterBoot.bootOnce();
    } else {
      // すでにブートされている場合は、現在のDOMにあるパネルのみ初期化を試行
      window.__ChapterBoot.initPanel(document.getElementById('chapters-panel'));
    }
  })();
  </script>