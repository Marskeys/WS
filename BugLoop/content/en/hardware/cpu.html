<div id="chapters-panel" class="chapters-panel" data-ready="0">
    <div class="chapters-toolbar">
      <label for="chapterSelect" class="sr-only">Select Chapter</label>
      <select id="chapterSelect" class="chapters-select" aria-label="Select Chapter">
        <option value="0">Chapter 0. A computer is a calculator.</option>
        <option value="1">Chapter 1 — (coming soon)</option>
        <option value="2">Chapter 2 — (coming soon)</option>
        <option value="3">Chapter 3 — (coming soon)</option>
      </select>
    </div>
  
    <div class="chapter-content" id="chapterContent" tabindex="-1">
      <section data-chapter="0" class="chapter-section active">
        <h2 class="chapter-title">Chapter 0. A computer is a calculator.</h2>
        <p>For someone unfamiliar with computers, CPU is a very complex word. Because it's an acronym for something, it's impossible for a layperson who doesn't know what it stands for to guess its meaning or role just from the name.</p>
        <p>
          C: The <b>C</b>entral part of the computer<br/>
          P: <b>P</b>rocessing tirelessly<br/>
          U: <b>U</b>nit
        </p>
        <p>A computer is a very fast calculator.<br/>
        But it's a calculator with a storage function.<br/>
        It's a calculator with both storage and super-fast calculation, and it shows the results not as simple numbers, but with vibrant colors, shapes, and sounds.<br/>
        It's a super-speed calculator that calculates using tiny electric bits moving incredibly fast along circuits, not with slow hand and foot movements.<br/>
        It's a calculator where the electric bits move so fast that they easily generate frictional heat, causing it to age over time.<br/>
        It's a flexible calculator that can create and save special calculators for specific purposes and then load them again.</p>
        <p>And… it’s a kind and capable calculator that, by once again utilizing the property of electricity to move at high speed, allows people who are very far away to communicate in an instant.</p>
        <p>This short, everyday description of a computer, in fact, contains almost all the fundamental concepts needed to understand a computer.</p>
        <p>In this CPU chapter, we will cover <b><u>the computer as a calculator</u></b>, which corresponds to the first sentence, "A computer is a very fast calculator."</p>
      </section>
  
      <section data-chapter="1" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapter 1 — (coming soon)</h2>
        <p>Content will be uploaded soon.</p>
      </section>
  
      <section data-chapter="2" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapter 2 — (coming soon)</h2>
        <p>Content will be uploaded soon.</p>
      </section>
  
      <section data-chapter="3" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapter 3 — (coming soon)</h2>
        <p>Content will be uploaded soon.</p>
      </section>
    </div>
  </div>
  
  <style>
    .chapters-panel { display: grid; gap: 12px; }
    .chapters-toolbar { display: flex; gap: 8px; align-items: center; }
    .chapters-select {
      padding: 8px 10px; border: 1px solid #e1e6ef; border-radius: 10px; font-size: .95rem; background: #fff;
    }
    .chapter-content { background: #fff; border: 1px solid #e1e6ef; border-radius: 14px; padding: 16px; }
  
    /* ✅ Suppress initial flicker: hide content until ready (layout is maintained) */
    #chapters-panel[data-ready="0"] .chapter-content { visibility: hidden; }
    #chapters-panel[data-ready="1"] .chapter-content { visibility: visible; }
  
    .chapter-title { margin: 0 0 8px; font-size: 1.1rem; }
    .chapter-section { display: none; }
    .chapter-section.active { display: block; }
  
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
  </style>
  
  <script>
  /* ===== Singleton boot: boot/monitor/bind globally once ===== */
  (() => {
    if (!window.__ChapterBoot) {
      window.__ChapterBoot = {
        mo: null,
        initedRoots: new WeakSet(),
        initPanel(root, opts={}) {
          if (!root || this.initedRoots.has(root)) return;
          const select = root.querySelector('#chapterSelect');
          const container = root.querySelector('#chapterContent');
          if (!select || !container) return;
  
          this.initedRoots.add(root);
  
          const KEY = 'chapter.current';
          let isInitPhase = true; // Don't update history/storage during initialization
  
          const showChapter = (val, {silent=false}={}) => {
            const sections = container.querySelectorAll('.chapter-section');
            sections.forEach(sec => {
              const active = sec.dataset.chapter === String(val);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
  
            // Do not trigger the router during initialization/silent mode
            if (!silent && !isInitPhase) {
              try { localStorage.setItem(KEY, String(val)); } catch {}
              try { history.replaceState(null, '', `#chapter=${val}`); } catch {}
            }
          };
  
          // Initial value: hash > localStorage > select default value
          const fromHash = (location.hash.match(/chapter=(\d+)/) || [])[1];
          let saved = null;
          try { saved = localStorage.getItem(KEY); } catch {}
          const initial = fromHash ?? saved ?? (select.value ?? '0');
  
          select.value = initial;
          showChapter(initial, {silent:true});
  
          // Ready → display
          root.setAttribute('data-ready', '1');
          isInitPhase = false;
  
          // Change event
          select.addEventListener('change', (e) => showChapter(e.target.value));
  
          // Home button synchronization (global delegation is installed once at boot. No listener needed here)
          document.addEventListener('panel:home', () => {
            try { localStorage.removeItem(KEY); } catch {}
            select.value = '0';
            showChapter(0);
          }, { once:false });
        },
        bootOnce() {
          // Global home button delegation: once
          if (!window.__ChapterBoot._homeBound) {
            document.addEventListener('click', (ev) => {
              const a = ev.target.closest('a.home-btn, a[href="/"], button.home-btn');
              if (!a) return;
              // Here, keep the default navigation and just reset the panel
              document.dispatchEvent(new CustomEvent('panel:home'));
            });
            window.__ChapterBoot._homeBound = true;
          }
  
          // MutationObserver: once
          if (!this.mo) {
            this.mo = new MutationObserver((muts) => {
              for (const m of muts) {
                for (const node of m.addedNodes || []) {
                  if (node.nodeType !== 1) continue;
                  if (node.id === 'chapters-panel') this.initPanel(node);
                  const found = node.querySelector?.('#chapters-panel');
                  if (found) this.initPanel(found);
                }
              }
            });
            this.mo.observe(document.documentElement, { childList: true, subtree: true });
          }
  
          // Initial DOM scan
          this.initPanel(document.getElementById('chapters-panel'));
        }
      };
  
      // Actual boot
      window.__ChapterBoot.bootOnce();
    } else {
      // If already booted, try to initialize only the panel in the current DOM
      window.__ChapterBoot.initPanel(document.getElementById('chapters-panel'));
    }
  })();
  </script>