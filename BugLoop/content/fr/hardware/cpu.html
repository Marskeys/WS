<div id="chapters-panel" class="chapters-panel" data-ready="0">
    <div class="chapters-toolbar">
      <label for="chapterSelect" class="sr-only">Sélectionner un chapitre</label>
      <select id="chapterSelect" class="chapters-select" aria-label="Sélectionner un chapitre">
        <option value="0">Chapitre 0. Un ordinateur est une calculatrice.</option>
        <option value="1">Chapitre 1 — (à venir)</option>
        <option value="2">Chapitre 2 — (à venir)</option>
        <option value="3">Chapitre 3 — (à venir)</option>
      </select>
    </div>
  
    <div class="chapter-content" id="chapterContent" tabindex="-1">
      <section data-chapter="0" class="chapter-section active">
        <h2 class="chapter-title">Chapitre 0. Un ordinateur est une calculatrice.</h2>
        <p>Pour une personne qui ne connaît pas les ordinateurs, le mot CPU est très complexe. Parce que c'est un acronyme, il est impossible pour une personne ordinaire qui ne connaît pas ce qu'il signifie de deviner sa signification ou son rôle juste en voyant le nom.</p>
        <p>
          C: La partie <b>C</b>entrale de l'ordinateur<br/>
          P: Qui <b>P</b>rocesse inlassablement<br/>
          U: L'<b>U</b>nité
        </p>
        <p>Un ordinateur est une calculatrice très rapide.<br/>
        Mais c'est une calculatrice avec une fonction de stockage.<br/>
        C'est une calculatrice qui a à la fois une fonction de stockage et un calcul ultra-rapide, et qui montre les résultats non pas comme de simples chiffres, mais avec des couleurs vives, des formes et des sons.<br/>
        C'est une calculatrice ultra-rapide qui calcule en utilisant de minuscules morceaux d'électricité se déplaçant incroyablement vite le long des circuits, et non pas avec des mouvements lents de la main et du pied.<br/>
        C'est une calculatrice où les morceaux d'électricité se déplacent si vite qu'ils génèrent facilement de la chaleur par friction, ce qui la fait vieillir avec le temps.<br/>
        C'est une calculatrice flexible qui peut créer et sauvegarder des calculatrices spéciales pour des usages spécifiques, puis les charger à nouveau.</p>
        <p>Et... c'est une calculatrice bienveillante et capable qui, en utilisant à nouveau la propriété de l'électricité de se déplacer à grande vitesse, permet aux personnes très éloignées de communiquer en un instant.</p>
        <p>Cette courte description quotidienne d'un ordinateur contient en fait presque tous les concepts de base nécessaires pour comprendre un ordinateur.</p>
        <p>Dans ce chapitre sur le CPU, nous allons aborder <b><u>l'ordinateur en tant que calculatrice</u></b>, qui correspond à la première phrase : "Un ordinateur est une calculatrice très rapide."</p>
      </section>
  
      <section data-chapter="1" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapitre 1 — (à venir)</h2>
        <p>Le contenu sera bientôt mis en ligne.</p>
      </section>
  
      <section data-chapter="2" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapitre 2 — (à venir)</h2>
        <p>Le contenu sera bientôt mis en ligne.</p>
      </section>
  
      <section data-chapter="3" class="chapter-section" aria-hidden="true">
        <h2 class="chapter-title">Chapitre 3 — (à venir)</h2>
        <p>Le contenu sera bientôt mis en ligne.</p>
      </section>
    </div>
  </div>
  
  <style>
    .chapters-panel { display: grid; gap: 12px; }
    .chapters-toolbar { display: flex; gap: 8px; align-items: center; }
    .chapters-select {
      padding: 8px 10px; border: 1px solid #e1e6ef; border-radius: 10px; font-size: .95rem; background: #fff;
    }
    .chapter-content { background: #fff; border: 1px solid #e1e6ef; border-radius: 14px; padding: 16px; }
  
    /* ✅ Supprimer le scintillement initial : masquer le contenu jusqu'à ce qu'il soit prêt (la mise en page est maintenue) */
    #chapters-panel[data-ready="0"] .chapter-content { visibility: hidden; }
    #chapters-panel[data-ready="1"] .chapter-content { visibility: visible; }
  
    .chapter-title { margin: 0 0 8px; font-size: 1.1rem; }
    .chapter-section { display: none; }
    .chapter-section.active { display: block; }
  
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
  </style>
  
  <script>
  /* ===== Boot singleton : démarrer/surveiller/lier globalement une seule fois ===== */
  (() => {
    if (!window.__ChapterBoot) {
      window.__ChapterBoot = {
        mo: null,
        initedRoots: new WeakSet(),
        initPanel(root, opts={}) {
          if (!root || this.initedRoots.has(root)) return;
          const select = root.querySelector('#chapterSelect');
          const container = root.querySelector('#chapterContent');
          if (!select || !container) return;
  
          this.initedRoots.add(root);
  
          const KEY = 'chapter.current';
          let isInitPhase = true; // Ne pas mettre à jour l'historique/le stockage pendant l'initialisation
  
          const showChapter = (val, {silent=false}={}) => {
            const sections = container.querySelectorAll('.chapter-section');
            sections.forEach(sec => {
              const active = sec.dataset.chapter === String(val);
              sec.classList.toggle('active', active);
              sec.setAttribute('aria-hidden', active ? 'false' : 'true');
            });
  
            // Ne pas déclencher le routeur en mode initialisation/silencieux
            if (!silent && !isInitPhase) {
              try { localStorage.setItem(KEY, String(val)); } catch {}
              try { history.replaceState(null, '', `#chapter=${val}`); } catch {}
            }
          };
  
          // Valeur initiale : hash > localStorage > valeur par défaut de la sélection
          const fromHash = (location.hash.match(/chapter=(\d+)/) || [])[1];
          let saved = null;
          try { saved = localStorage.getItem(KEY); } catch {}
          const initial = fromHash ?? saved ?? (select.value ?? '0');
  
          select.value = initial;
          showChapter(initial, {silent:true});
  
          // Prêt → affichage
          root.setAttribute('data-ready', '1');
          isInitPhase = false;
  
          // Événement de changement
          select.addEventListener('change', (e) => showChapter(e.target.value));
  
          // Synchronisation du bouton d'accueil (la délégation globale est installée une seule fois au démarrage. Aucun écouteur n'est nécessaire ici)
          document.addEventListener('panel:home', () => {
            try { localStorage.removeItem(KEY); } catch {}
            select.value = '0';
            showChapter(0);
          }, { once:false });
        },
        bootOnce() {
          // Délégation globale du bouton d'accueil : une seule fois
          if (!window.__ChapterBoot._homeBound) {
            document.addEventListener('click', (ev) => {
              const a = ev.target.closest('a.home-btn, a[href="/"], button.home-btn');
              if (!a) return;
              // Ici, on garde la navigation par défaut et on réinitialise juste le panneau
              document.dispatchEvent(new CustomEvent('panel:home'));
            });
            window.__ChapterBoot._homeBound = true;
          }
  
          // MutationObserver : une seule fois
          if (!this.mo) {
            this.mo = new MutationObserver((muts) => {
              for (const m of muts) {
                for (const node of m.addedNodes || []) {
                  if (node.nodeType !== 1) continue;
                  if (node.id === 'chapters-panel') this.initPanel(node);
                  const found = node.querySelector?.('#chapters-panel');
                  if (found) this.initPanel(found);
                }
              }
            });
            this.mo.observe(document.documentElement, { childList: true, subtree: true });
          }
  
          // Scan initial du DOM
          this.initPanel(document.getElementById('chapters-panel'));
        }
      };
  
      // Démarrage effectif
      window.__ChapterBoot.bootOnce();
    } else {
      // Si déjà démarré, essayer d'initialiser uniquement le panneau dans le DOM actuel
      window.__ChapterBoot.initPanel(document.getElementById('chapters-panel'));
    }
  })();
  </script>